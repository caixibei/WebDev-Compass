# Zuul 服务网关

## 学习目标

![image-20251211141511205](assets/image-20251211141511205.png)

## 什么是 Zuul

Zuul 是从设备和网站到应用程序后端的所有请求的前门。作为边缘服务应用程序，Zuul 旨在实现动态路由，监视，弹性和安全性。Zuul 包含了对请求的路由和过滤两个最主要的功能。

Zuul 是 Netflix 开源的微服务网关，它可以和 Eureka、Ribbon 、Hystrix 等组件配合使用。Zuul 的核心是一系列的过滤器，这些过滤器可以完成以下功能：

- 身份认证与安全：识别每个资源的验证要求，并拒绝那些与要求不符的请求；
- 审查与监控：在边缘位置追踪有意义的数据和统计结果，从而带来精确的生产试图；
- 动态路由：动态的将请求路由到不同的后端集群；
- 压力测试：逐渐增加指向集群的流量，以了解性能；
- 负载分配：为每一种负载类型分配对应容量，并弃用超出限定值的请求；
- 静态响应处理：在边缘位置直接建立部分响应，从而避免转发到内部集群；
- 多区域弹性：跨越 AWS Region 进行请求路由，旨在实现 ELB 使用的多样化，以及让系统的边缘更贴近系统的使用者；

## 什么是服务网关

API Gateway （APIGW / API 网关），故名思义，是出现在系统边界山歌的一个面向 API 的、串行集中式的强管控服务，这里的边界是企业 IT 系统的边界，可以理解为企业级应用防火墙，主要起到隔离外部访问与内部系统的作用。在微服务概念的流行之前，API 网关就已经诞生了，例如银行、证券等领域常见的前置机系统，也是解决访问认证、报文转换、访问统计等问题的。

API 网关的流行，源于近几年来移动应用与企业间互联网需求的兴起。移动应用、企业互联，使得后台服务支持的对象，从以前单一的 Web 应用，扩展到多种应用场景，且每种使用场景对后台服务的要求都不尽相同。这不仅增加了后台服务的响应量，还增加了后台服务的复杂性。随着微服务架构概念的提出，API 网关成为了微服务架构的一个标配组件。

API 网关是一个服务器，是系统对外的唯一入口。API 网关封装了系统内部架构，为每个客户端提供定制的 API 。所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能。API 网关并不是微服务场景中必须的组件，如下图，不管有没有 API 网关，后端微服务都可以通过 API 很好的支持客户端的访问。

<img src="assets/image-20251220154549792.png" alt="image-20251220154549792" style="zoom:67%;" />

但对于服务数量众多，复杂度较高，规模比较大的业务来说，引入 API 网关也有一系列的好处：

- 聚合接口使得服务对调用者透明，客户端与后端的耦合度降低；
- 聚合后台服务，节省流量，提高性能，以提升用户体验；
- 提供安全、流控、过滤、缓存、计费、监控等 API 管理功能；

## 为什么要使用网关

Zuul 是 Netflix 开源的 API 网关，本质是一个 **反向代理 + 过滤器链** 的架构模式。它在不同架构中的价值体现有显著差异。

- 单体应用：浏览器发起请求到单体应用所在的机器，应用从数据库查询数据原路返回给浏览器，对于单体应用来说是不需要网关的。
- 微服务：微服务的应用可能部署在不同机房，不同地区，不同域名下。此时客户端（浏览器/手机/软件工具）想要请求对应的服务，都需要知道机器的具体 IP 地址 或者域名 URL，当微服务实例众多的时候，这是十分难以记忆的，对于客户端来说也太复杂难以维护。此时就有了网关，客户端相关的请求直接发送到网关，由网关根据请求标识解析判断出具体的微服务地址，再把请求转发到微服务实例。这其中的记忆功能就全部交给网关去操作了。

<img src="assets/image-20251220164718340.png" alt="image-20251220164718340" style="zoom:67%;" />



总的来说，如果让客户端直接与各微服务交互，会带来以下问题：

- 客户端会多次请求不同的微服务，增加了客户端的复杂性；
- 存在跨域请求问题，且在某些场景下处理相对复杂；
- 身份认证问题，每个微服务都需要独立的身份认证；
- 难以重构，随着项目的迭代，可能需要重新划分微服务；
- 某些微服务可能使用了防火墙/浏览器不友好的协议，直接访问存在一定的困难；

因此，为了解决这些问题，我们需要网关介于客户端与服务器之间的中间层，所有的外部请求率先经过微服务网关，客户端只需要与网关进行交互，只需要网关地址即可，这样便简化了开发且有以下优点。

- 易于监控，可在微服务网关收集监控数据并将其推送到外部系统进行分析；
- 易于认证，可在微服务网关上进行认证，然后再将请求转发到后端的微服务，从而无需在每个微服务中进行认证；
- 减少了客户端与各微服务之间的交互次数；

## 网关解决了什么问题

<img src="assets/image-20251220172914409.png" alt="image-20251220172914409" style="zoom:67%;" />

网关具有身份认证与安全、审查与监控、动态路由、负载均衡、缓存、请求分片与管理、静态响应处理等功能。当然最主要的职责还是 “与外界联系”。

总结来说，网关应该具有以下功能：

- 性能：API 高可用，负载均衡，容错机制；
- 安全：权限身份认证、脱敏、流量清洗、后端签名（保证全链路可信调用）、黑名单（非法调用限制）；
- 日志：日志记录，一旦设计分布式，全链路跟踪必不可少；
- 缓存：数据缓存；
- 监控：记录请求响应数据，API 耗时分析，性能监控；
- 限流：流量控制、错峰流控，可以定义多种限流规则；
- 灰度：线上灰度部署，可以减少风险；
- 路由：动态路由规则；

## 常用网关解决方案

### Nginx + Lua脚本

Nginx 是由 IgorSysoev 为俄罗斯访问量第二的 Rmbler.ru 站点开发的，一个高性能的 HTTP 和反向代理服务器，一方面可以做反向代理，另一方面可以做静态资源服务器。

🎯 Nginx 和 Zuul 有以下几个区别：

- Nginx 是 C 语言开发的，而 Zuul 是 Java 语言开发；
- Nginx 负载均衡实现是采用服务器实现负载均衡，而 Zuul 负载均衡的实现采用 Ribbon + Eureka 来实现本地负载均衡；
- Nginx 适合于服务器端负载均衡，Zuul 适合微服务中实现网关；
- Nginx 相比于 Zuul 功能会更加强大，因为 Nginx 可以整合一些脚本语言（Nginx + Lua 脚本）；
- Nginx 是一个高性能的 HTTP 和反向代理服务器，也是一个 IMAP / POP3 / SMIP 服务器。Zuul 是 Spring Cloud Netflix 中的开源的一个 API Gateway 服务器，本质上是一个 Servlet 应用，提供了动态路由、监控、弹性、安全等边缘服务的框架。Zuul 相当于是从设备到网站应用程序后端的所有请求的前门。

-   Nginx 适合做门户网关，是作为整个全局的网关，对外的处于最外层的那种；而 Zuul 属于业务网关，主要用来对应不同的客户端提供服务，用于聚合业务。各微服务独立部署，职责单一，对外提供服务的时候需要有一个东西将业务聚合起来；
-   Zuul 可以实现熔断、重试等功能，这是 Nginx 不具备的。

### Kong

Kong 是 Mashape 提供的一款 API 管理软件，本身是基于 Nginx + Lua 的，但比 Nginx 提供了更为简单的配置方式，数据采用了 ApacheCassandra / PostgreSQL 存储，并且提供了一些优秀的插件，比如验证，日志，调用频次限制等。Kong 非常诱人的地方就是提供了大量的插件来扩展应用，通过设置不同的插件可以为服务提供各种增强的功能。

🎯 具备以下优缺点：

-   优点：基于 Nginx 所以在性能和稳定性方面不会有问题。Kong 作为一款商业软件，在 Nginx 上做了很多的扩展性工作，并且还有很多付费使用的商业插件。Kong 本身也有付费的企业版，其中包括技术支持、使用培训服务以及 API 分析插件。
-   缺点：如果你使用 Spring Cloud , Kong 如何结合目前已有的服务治理体系？

### Traefik

Traefik 是一个开源的 Go 语言开发的，为了让微服务部署更加便捷而诞生的现代 HTTP 反向代理、负载均衡工具。它支持多种后台（Docker、Swarm、Kubernates、Marathon、Mesos、Consul、Etcd、Zookeeper、BoltDB、Rest API 等）来自动化、动态的应用他的配置文件设置，Traefik 拥有一个基于 AngularJS 编写的简单网站界面，支持 RestAPI，配置文件热更新，无需重启进程。高可用集群模式等。

🎯 相比 Spring Cloud 和 Kubernetes 而言，目前比较适合 Kubernetes 。

### SpringCloud Netflix Zuul

Zuul 是Netflix 公司开源的一个 API 网关组件，Spring Cloud 对其进行二次基于 Spring Boot 的注解式封装做到开箱即用。目前来说，结合 Spring Cloud 提供的服务治理体系，可以做到请求转发，根据配置或者默认的路由规则进行路由和负载均衡，无缝集成 Hystrix 。

虽然可以通过自定义 Filter 过滤器实现我们想要的功能，但是由于 Zuul 本身的涉及是基于 单线程的接收请求和转发处理，是阻塞 IO，不支持长连接。目前来看 Zuul 就显得很鸡肋，随着 Zuul 2.x 版本一致跳票 （2019年5月发布了 Zuul 2.0 版本），Spring Cloud 为了保险起见，推出了自己的 Spring Cloud Gateway。

<span style="color:darkgrey;font-size:12px;">大意就是：Zuul 已死，Spring Cloud Gateway 永生！🐶</span>

#### Zuul 1.0

<img src="./assets/image-20241210234005117.png" alt="架构图" style="zoom: 67%;" />

<img src="./assets/image-20241210234107613.png" alt="核心类图" style="zoom: 67%;" />

<img src="./assets/image-20241210234215051.png" alt="模型" style="zoom:95%;" />

#### Zuul 2.0

![image-20241210234349976](./assets/image-20241210234349976.png)

### SpringCloud Gateway

Spring Cloud Gateway 的工作原理：

![image-20241210234610441](./assets/image-20241210234610441.png)

客户端向 Spring Cloud Gateway 发出请求。如果网关处理程序映射确定请求与路由匹配，则会将其发送到网关 Web 处理程序。此处理程序通过特定于请求的筛选条件链运行请求。过滤器被虚线划分的原因是 filter 可以在发送代理请求之前和之后运行 logic。执行所有 “pre” filter logic。然后发出代理请求。发出代理请求后，将运行 “post” 筛选条件逻辑。

## Zuul 环境准备

我们新建一个微服务的项目，项目结构大致如下图所示。

![image-20251220195034652](assets/image-20251220195034652.png)

- Eureka 注册中心：提供服务发现和注册功能；
- Zuul 网关：提供动态路由功能；
- 模块 A：测试服务；
- 模块 B：测试服务；



