# Hystrix æœåŠ¡å®¹é”™

<img src="assets/image-20251223212958084.png" alt="image-20251223212958084" style="zoom:50%;" />

## å­¦ä¹ ç›®æ ‡

![image-20251223215701027](assets/image-20251223215701027.png)

## ä»€ä¹ˆæ˜¯ Hystrix

Hystrix æºè‡ª Netflix å›¢é˜Ÿäº 2011 å¹´å¼€å§‹ç ”å‘ï¼Œ2012 å¹´ Hystrix ä¸æ–­å‘å±•å’Œæˆç†Ÿï¼ŒNetflix å†…éƒ¨çš„è®¸å¤šå›¢é˜Ÿéƒ½é‡‡ç”¨äº†å®ƒã€‚å¦‚ä»Šï¼Œæ¯å¤©åœ¨ Netflix ä¸Šé€šè¿‡ Hystrix æ‰§è¡Œæ•°ç™¾äº¿ä¸ªçº¿ç¨‹éš”ç¦»å’Œæ•°åƒäº¿ä¸ªä¿¡å·éš”ç¦»çš„è°ƒç”¨ï¼Œæå¤§çš„æé«˜äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œä¸å¯é¿å…åœ°ä¼šæœ‰è®¸å¤šæœåŠ¡ä¾èµ–é¡¹ä¸­çš„æŸäº›æœåŠ¡å¤±è´¥è€Œå¯¼è‡´**é›ªå´©æ•ˆåº”**ï¼ŒHystrix æ˜¯ä¸€ä¸ªç»„ä»¶åº“ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ ç­‰å¾…æ—¶é—´å®¹é™å’Œå®¹é”™é€»è¾‘æ¥å¸®åŠ©æ‚¨æ§åˆ¶è¿™äº›åˆ†å¸ƒå¼æœåŠ¡ä¹‹é—´çš„è®¿é—®ç‚¹ï¼Œåœæ­¢æœåŠ¡ä¹‹é—´çš„çº§è”æ•…éšœå¹¶æä¾›åå¤‡é€‰é¡¹æ¥å®ç°æ­¤ç›®çš„ï¼Œæ‰€æœ‰è¿™äº›éƒ½å¯ä»¥æé«˜ç³»ç»Ÿçš„æ•´ä½“ç¨³å®šæ€§ã€‚

## é›ªå´©æ•ˆåº”

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚éœ€è¦è°ƒç”¨å¤šä¸ªæœåŠ¡æ˜¯ååˆ†å¸¸è§çš„ã€‚

å¦‚å®¢æˆ·ç«¯è®¿é—® A æœåŠ¡ï¼Œè€Œ A æœåŠ¡éœ€è¦è°ƒç”¨ B æœåŠ¡ï¼ŒB æœåŠ¡éœ€è¦è°ƒç”¨ C æœåŠ¡ï¼Œç”±äºç½‘ç»œæ³¢åŠ¨æˆ–æœåŠ¡è‡ªèº«çš„é—®é¢˜ï¼Œå¦‚æœ B æœåŠ¡æˆ–è€… C æœåŠ¡ä¸èƒ½åŠæ—¶å“åº”ï¼ŒA æœåŠ¡å°†å¤„äºè¯·æ±‚é˜»å¡çŠ¶æ€ï¼Œç›´åˆ° B æœåŠ¡/ C æœåŠ¡å“åº”ã€‚æ­¤æ—¶å¦‚æœæœ‰å¤§é‡çš„è¯·æ±‚æ¶Œå…¥ï¼Œå®¹å™¨çš„çº¿ç¨‹èµ„æºä¼šè¢«æ¶ˆè€—å®Œæ¯•ï¼Œå¯¼è‡´æœåŠ¡ç˜«ç—ªã€‚æœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–æ€§ï¼Œæ•…éšœä¼šä¼ æ’­ï¼Œé€ æˆè¿é”ååº”ï¼Œä¼šå¯¹æ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿé€ æˆç¾éš¾æ€§çš„ä¸¥é‡åæœï¼Œè¿™å°±æ˜¯æœåŠ¡æ•…éšœçš„â€œé›ªå´©â€æ•ˆåº”ã€‚

ä»¥ä¸‹å›¾ç¤ºå®Œç¾è§£é‡Šäº†ä»€ä¹ˆæ˜¯é›ªå´©æ•ˆåº”ï¼Œå½“æ‰€æœ‰æœåŠ¡æ­£å¸¸çš„æ—¶å€™ï¼Œè¯·æ±‚çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

<img src="assets/soa-1-640.png" alt="img" style="zoom:88%;" />

å½“å…¶ä¸­ä¸€ä¸ªæœåŠ¡æœ‰å»¶è¿Ÿæ—¶ï¼Œä»–å¯èƒ½é˜»å¡æ•´ä¸ªç”¨æˆ·è¯·æ±‚ï¼š

<img src="assets/soa-2-640.png" alt="img" style="zoom:88%;" />

åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæœåŠ¡çš„å»¶è¿Ÿå¯èƒ½å¯¼è‡´æ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰èµ„æºåœ¨æ•°ç§’å†…é¥±å’Œã€‚æ¯”èµ·æœåŠ¡æ•…éšœï¼Œæ›´ç³Ÿç³•çš„æ˜¯è¿™äº›åº”ç”¨ç¨‹åºè¿˜å¯èƒ½å¯¼è‡´æœåŠ¡ä¹‹é—´çš„å»¶è¿Ÿå¢åŠ ï¼Œä»è€Œå¤‡ä»½é˜Ÿåˆ—ï¼Œçº¿ç¨‹å’Œå…¶ä»–ç³»ç»Ÿèµ„æºï¼Œè¿›è€Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå‡ºç°æ›´å¤šçš„çº§è”æ•…éšœã€‚

<img src="assets/soa-3-640.png" alt="img" style="zoom:88%;" />

æ€»çš„æ¥è¯´ï¼Œé€ æˆé›ªå´©çš„åŸå› å¯ä»¥å½’ç»“ä¸ºä»¥ä¸‹ 3 ç‚¹ï¼š

- æœåŠ¡æä¾›è€…ä¸å¯ç”¨ï¼ˆç¡¬ä»¶æ•…éšœã€ç¨‹åº BUGã€ç¼“å­˜å‡»ç©¿ã€ç”¨æˆ·å¤§é‡è¯·æ±‚ç­‰ï¼‰ï¼›
- é‡è¯•åŠ å¤§æµé‡ï¼ˆç”¨æˆ·é‡è¯•ï¼Œä»£ç é€»è¾‘é‡è¯•ï¼‰ï¼›
- æœåŠ¡æ¶ˆè´¹è€…ä¸å¯ç”¨ï¼ˆåŒæ­¥ç­‰å¾…é€ æˆçš„èµ„æºè€—å°½ï¼‰ï¼›

æœ€ç»ˆçš„ç»“æœå°±æ˜¯ï¼šä¸€ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œå¯¼è‡´ä¸€ç³»åˆ—çš„æœåŠ¡ä¸å¯ç”¨ã€‚

## é›ªå´©æ•ˆåº”çš„è§£å†³æ–¹æ¡ˆ

é›ªå´©æ˜¯ç³»ç»Ÿä¸­çš„è´è¶æ•ˆåº”å¯¼è‡´ï¼Œå…¶å‘ç”Ÿçš„åŸå› å¤šç§å¤šæ ·ï¼Œä»æºå¤´æˆ‘ä»¬æ— æ³•å®Œå…¨æœç»é›ªå´©çš„å‘ç”Ÿï¼Œä½†æ˜¯é›ªå´©çš„æ ¹æœ¬åŸå› æ¥æºäºæœåŠ¡ä¹‹é—´çš„å¼ºä¾èµ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æå‰è¯„ä¼°åšå¥½æœåŠ¡å®¹é”™ã€‚è§£å†³æ–¹æ¡ˆå¤§æ¦‚å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š

- è¯·æ±‚ç¼“å­˜ï¼šæ”¯æŒå°†ä¸€ä¸ªè¯·æ±‚ä¸è¿”å›ç»“æœåšç¼“å­˜å¤„ç†ï¼›
- è¯·æ±‚åˆå¹¶ï¼šå°†ç›¸åŒçš„è¯·æ±‚è¿›è¡Œåˆå¹¶ç„¶åè°ƒç”¨æ‰¹å¤„ç†æ¥å£ï¼›
- æœåŠ¡éš”ç¦»ï¼šé™åˆ¶è°ƒç”¨åˆ†å¸ƒå¼æœåŠ¡çš„èµ„æºï¼ŒæŸä¸€ä¸ªè°ƒç”¨çš„æœåŠ¡å‡ºç°é—®é¢˜ä¸ä¼šå½±å“å…¶ä»–æœåŠ¡çš„è°ƒç”¨ï¼›
- æœåŠ¡ç†”æ–­ï¼šç‰ºç‰²å±€éƒ¨æœåŠ¡ï¼Œä¿å…¨æ•´ä½“ç³»ç»Ÿç¨³å®šæ€§çš„æªæ–½ï¼›
- æœåŠ¡é™çº§ï¼šæœåŠ¡ç†”æ–­ä¹‹åï¼Œå®¢æˆ·ç«¯è°ƒç”¨è‡ªå·±æœ¬åœ°æ–¹æ³•è¿”å›ç¼ºçœå€¼ï¼›

## æ¡ˆä¾‹ç¯å¢ƒå‡†å¤‡

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¾®æœåŠ¡çš„èšåˆé¡¹ç›®ï¼Œå¹¶ä¸”åˆ›å»ºä»¥ä¸‹å‡ ä¸ªè¾¹ç¼˜æœåŠ¡ï¼š

- æœåŠ¡æ³¨å†Œä¸­å¿ƒ
- æœåŠ¡æä¾›è€…
- æœåŠ¡æ¶ˆè´¹è€…

![image-20251223234037519](assets/image-20251223234037519.png)

<span style="color:darkred;font-size:11px">æ³¨ï¼šæˆ‘ä»¬çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…éƒ½æ²¡æœ‰ä½¿ç”¨æ•°æ®æºï¼Œä¸ºäº†èŠ‚çœæ—¶é—´ï¼Œè¿”å›çš„éƒ½æ˜¯é™æ€å‡æ•°æ®ã€‚</span>

## æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯

æœåŠ¡æä¾›è€…æ¥å£æ·»åŠ  `Thread.sleep(2000)` ï¼Œæ¨¡æ‹ŸæœåŠ¡å¤„ç†è¶…æ—¶ã€‚

```java
import com.autumnnook.api.SystemService;
import com.autumnnook.pojo.Menu;
import lombok.RequiredArgsConstructor;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;
import java.util.Arrays;
import java.util.List;
@RestController
@RequestMapping("/menu")
@RequiredArgsConstructor
public class MenuController {

    private final SystemService systemService;

    private final RestTemplate restTemplate;

    @GetMapping("/list")
    public List<Menu> getMenuList() throws InterruptedException {
        // ğŸ¯ æ¨¡æ‹ŸæœåŠ¡å¤„ç†è¶…æ—¶
        Thread.sleep(2000);
        return Arrays.asList(new Menu("1", "Espresso", "3.0"), new Menu("2", "Cappuccino", "4.0"),
            new Menu("3", "Latte", "4.5"));
    }

    @GetMapping("/getMenuById")
    public Menu getMenuById() throws InterruptedException {
        return new Menu("1", "Espresso", "3.0");
    }

    // ğŸ¯Feign çš„è°ƒç”¨æ–¹å¼ï¼Œåé¢ä¼šè¯´
    @GetMapping("/systemListFeign")
    public List<?> systemListFeign() {
        return systemService.getSystemList();
    }

    // ğŸ¯è¿™ä¸ªæ–¹æ³•é€šè¿‡ Ribbon è´Ÿè½½å‡è¡¡è°ƒç”¨
    @GetMapping("/systemList")
    public List<?> systemList() {
        String serviceName = "autumnnook-system";
        String url = "http://" + serviceName + "/system/list";
        ResponseEntity<List<?>> response =
            restTemplate.exchange(url, HttpMethod.GET, null, new ParameterizedTypeReference<List<?>>() {
            });
        return response.getBody();
    }

}
```

åŒæ—¶é™ä½ Tomcat çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬åç»­æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯ã€‚

```yml
server:
  tomcat:
    max-threads: 10 # æœ€å¤§çº¿ç¨‹æ•°ï¼Œé»˜è®¤ 200
```

### JMeter

<img src="assets/image-20251224000632325.png" alt="image-20251224000632325" style="zoom:33%;" />

Apache JMeter åº”ç”¨ç¨‹åºæ˜¯å¼€æºè½¯ä»¶ï¼Œ100% çº¯ Java åº”ç”¨ç¨‹åºè€Œè®¾è®¡çš„è´Ÿè½½å‡è¡¡æµ‹è¯•åŠŸèƒ½è¡Œä¸ºå’Œæµ‹é‡æ€§èƒ½ã€‚å®ƒæœ€åˆæ˜¯ä¸ºäº†æµ‹è¯• Web åº”ç”¨ç¨‹åºè€Œè®¾è®¡çš„ï¼Œä½†æ­¤åå·²ç»æ‰©å±•åˆ°å…¶ä»–æµ‹è¯•åŠŸèƒ½ã€‚

Apache JMeter å¯ç”¨äºæµ‹è¯•é™æ€å’ŒåŠ¨æ€èµ„æºã€Web åŠ¨æ€åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œå®ƒå¯ä»¥ç”¨äºæ¨¡æ‹ŸæœåŠ¡å™¨ã€æœåŠ¡å™¨ç»„ï¼Œç½‘ç»œæˆ–å¯¹è±¡ä¸Šç¹é‡è´Ÿè½½ï¼Œä»¥æµ‹è¯•å…¶å¼ºåº¦æˆ–åˆ†æä¸åŒè´Ÿè½½ç±»å‹ä¸‹çš„æ•´ä½“æ€§èƒ½ã€‚

#### å®‰è£…

å®˜ç½‘ https://jmeter.apache.org/ ä¸‹è½½å¯¹åº”æ“ä½œç³»ç»Ÿç‰ˆæœ¬çš„å®‰è£…åŒ…ã€‚

![image-20251224090812475](assets/image-20251224090812475.png)



![image-20251224090904810](assets/image-20251224090904810.png)

è§£å‹ `apache-jmeter-5.6.3.zip`ï¼Œè¿›å…¥ `bin` ç›®å½•è¿è¡Œ `jmeter.bat` å³å¯ï¼Œä½†æˆ‘ä»¬è¿è¡Œä¹‹å‰å…ˆä¿®æ”¹ä¸‹é…ç½®æ–‡ä»¶ï¼Œæ–¹ä¾¿æ›´å¥½çš„ä½¿ç”¨ã€‚

#### é…ç½®

è¿›å…¥ `bin` ç›®å½•ç¼–è¾‘ `jmeter.properties` æ–‡ä»¶ï¼Œä¿®æ”¹ 39 è¡Œå’Œ 1105 è¡Œä¸¤å¤„ä»£ç ï¼ˆä¸åŒçš„ç”µè„‘å¯èƒ½è¡Œæ•°ä¸ä¸€è‡´ï¼Œä¸è¿‡ä¸Šä¸‹å·®è·ä¸å¤§ï¼‰ã€‚

```properties
# è®¾ç½®ç•Œé¢æ˜¾ç¤ºä¸­æ–‡
# language=en
language=zh_CN

# ç¼–ç å­—ç¬¦é›†ä½¿ç”¨ UTF-8,ä» 5.6.1 å¼€å§‹é»˜è®¤å°±æ˜¯ UTF-8
sampleresult.default.encoding=UTF-8
```

#### è¿è¡Œ

è¿è¡Œ `/bin/jmeter.bat` æ–‡ä»¶ï¼Œç•Œé¢æ˜¾ç¤ºå¦‚ä¸‹ã€‚

<img src="assets/image-20251224091917347.png" alt="image-20251224091917347" style="zoom:80%;" />

åˆ›å»º **çº¿ç¨‹ç»„**ï¼Œåœ¨çº¿ç¨‹ç»„ä¸‹åˆ›å»º **HTTP è¯·æ±‚**ï¼Œåœ¨ HTTP è¯·æ±‚ä¸‹åˆ›å»º **æŸ¥çœ‹ç»“æœæ ‘**ï¼Œä¸”æŒ‰ç…§å¦‚ä¸‹é…ç½®ã€‚

![image-20251224093722376](assets/image-20251224093722376.png)

![image-20251224093820657](assets/image-20251224093820657.png)

æ¨¡æ‹Ÿé«˜å¹¶å‘è¿è¡Œï¼Œç‚¹å‡»æŸ¥çœ‹ç»“æœæ ‘å¯ä»¥çœ‹åˆ°å¤§éƒ¨åˆ†è¯·æ±‚å¤±è´¥

![image-20251224093950855](assets/image-20251224093950855.png)

## è¯·æ±‚ç¼“å­˜

Hystrix ä¸ºäº†é™ä½è®¿é—®æœåŠ¡çš„é¢‘ç‡ï¼Œæ”¯æŒå°†ä¸€ä¸ªè¯·æ±‚ä¸è¿”å›ç»“æœåšç¼“å­˜å¤„ç†ã€‚å¦‚æœå†æ¬¡è¯·æ±‚çš„ URL æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆ Hystrix ä¸ä¼šè¯·æ±‚æœåŠ¡ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜ä¸­å°†ç»“æœè¿”å›ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§é™ä½è®¿é—®æœåŠ¡çš„å‹åŠ›ã€‚

### å®‰è£… Redis

Hystrix è‡ªå¸¦ç¼“å­˜æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š

- æœ¬åœ°ç¼“å­˜ï¼Œé›†ç¾¤ç¯å¢ƒä¸‹ç¼“å­˜æ— æ³•åŒæ­¥ï¼›
- ä¸æ”¯æŒç¬¬ä¸‰æ–¹ç¼“å­˜å®¹å™¨ï¼Œå¦‚ï¼šredisã€memcacheï¼›

æœ¬æ–‡ä½¿ç”¨ Spring çš„ç¼“å­˜é›†æˆæ–¹æ¡ˆï¼ŒNoSQL ä½¿ç”¨ Redis å®ç°ï¼Œç‰ˆæœ¬æ˜¯ 8.4.0ã€‚

### æ·»åŠ ä¾èµ–

æœåŠ¡æ¶ˆè´¹è€… pom.xml æ·»åŠ  redis å’Œ commons-pools ä¾èµ–ã€‚

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<!--
Apache Commons Pool 2
ä½œç”¨ï¼šæä¾›å¯¹è±¡æ± å®ç°ï¼Œç”¨äºRedisè¿æ¥æ± ç®¡ç†
èƒŒæ™¯ï¼šSpring Boot 2.x é»˜è®¤ä½¿ç”¨Lettuceå®¢æˆ·ç«¯ï¼Œä½†Jediséœ€è¦æ­¤ä¾èµ–
ç”¨é€”ï¼šä¸ºJediså®¢æˆ·ç«¯æä¾›è¿æ¥æ± æ”¯æŒï¼Œæé«˜è¿æ¥å¤ç”¨å’Œæ€§èƒ½
-->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```

### é…ç½®æ–‡ä»¶

```yml
spring:
  redis:
    timeout: 10000 # è¿æ¥è¶…æ—¶æ—¶é—´
    host: 117.24.15.104 # redisæœåŠ¡åœ°å€
    port: 6379 # redisæœåŠ¡ç«¯å£
    password: redis_Fct28w # rediså¯†ç 
    database: 0 # é€‰æ‹©å“ªä¸€ä¸ªåº“ï¼Œé»˜è®¤0åº“
    lettuce:
      pool:
        max-active: 1024 # æœ€å¤§è¿æ¥æ•°
        max-wait: 10000 #æœ€å¤§è¿æ¥é˜»å¡ç­‰å¾…æ—¶é—´ï¼Œå•ä½ ms é»˜è®¤ -1
        max-idle: 200 # æœ€å¤§ç©ºé—²è¿æ¥
        min-idle: 5 # æœ€å°ç©ºé—²è¿æ¥
```

### åºåˆ—åŒ–é…ç½®

æ·»åŠ  Redis é…ç½®ç±»é‡å†™åºåˆ—åŒ–è§„åˆ™ã€‚

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.cache.RedisCacheConfiguration;
import org.springframework.data.redis.cache.RedisCacheManager;
import org.springframework.data.redis.cache.RedisCacheWriter;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.RedisSerializationContext;
import org.springframework.data.redis.serializer.StringRedisSerializer;
import java.time.Duration;
@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(factory);
        // ä¸º String ç±»å‹ key è®¾ç½®åºåˆ—åŒ–å™¨
        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();
        redisTemplate.setKeySerializer(stringRedisSerializer);
        redisTemplate.setHashKeySerializer(stringRedisSerializer);
        // ä¸º String ç±»å‹ value è®¾ç½®åºåˆ—åŒ–å™¨
        GenericJackson2JsonRedisSerializer genericJackson2JsonRedisSerializer = new GenericJackson2JsonRedisSerializer();
        redisTemplate.setValueSerializer(genericJackson2JsonRedisSerializer);
        // ä¸º Hash ç±»å‹ value è®¾ç½®åºåˆ—åŒ–å™¨
        redisTemplate.setHashValueSerializer(genericJackson2JsonRedisSerializer);
        redisTemplate.afterPropertiesSet();
        return redisTemplate;
    }

    @Bean
    public RedisCacheManager redisCacheManager(RedisTemplate redisTemplate) {
        RedisCacheWriter redisCacheWriter = RedisCacheWriter.nonLockingRedisCacheWriter(redisTemplate.getConnectionFactory());
        RedisCacheConfiguration redisCacheConfiguration = RedisCacheConfiguration.defaultCacheConfig()
            // 30 min è¿‡æœŸ
            .entryTtl(Duration.ofMinutes(30))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(redisTemplate.getValueSerializer()))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisTemplate.getKeySerializer()));
        return new RedisCacheManager(redisCacheWriter, redisCacheConfiguration);
    }
}
```

### å¯åŠ¨ç±»

å¯åŠ¨ç±»ä¸Šæ·»åŠ  `@EnableCaching` æ³¨è§£ã€‚

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.ApplicationContext;
import org.springframework.core.env.Environment;
@EnableCaching
@EnableFeignClients
@SpringBootApplication
public class SystemApplication {

    private static final Logger logger = LoggerFactory.getLogger(SystemApplication.class);

    public static void main(String[] args) {
        // å¯åŠ¨ Spring Boot åº”ç”¨ï¼Œè¿”å›åº”ç”¨ä¸Šä¸‹æ–‡
        ApplicationContext context = SpringApplication.run(SystemApplication.class, args);

        // è·å–ç¯å¢ƒé…ç½®ä¿¡æ¯
        Environment environment = context.getEnvironment();

        // ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–å…³é”®é…ç½®ä¿¡æ¯
        String port = environment.getProperty("server.port");
        String fetchRegistry = environment.getProperty("eureka.client.fetch-registry");
        String registryWithEureka = environment.getProperty("eureka.client.register-with-eureka");
        String defaultZone = environment.getProperty("eureka.client.service-url.defaultZone");
        String hostname = environment.getProperty("eureka.instance.hostname");
        String preferIpAddress = environment.getProperty("eureka.instance.prefer-ip-address");

        // è¾“å‡ºåº”ç”¨å¯åŠ¨æˆåŠŸä¿¡æ¯å’Œå…³é”®é…ç½®
        logger.info("========= AutumnNook System started successfully =========");
        logger.info("ğŸš€ æœåŠ¡ç«¯å£ï¼š{}", port);
        logger.info("ğŸ  å®ä¾‹åœ°å€ï¼š{}", hostname);
        logger.info("ğŸ“¥ æ˜¯å¦ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡ï¼š{}", fetchRegistry);
        logger.info("ğŸ“¤ æ˜¯å¦æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼š{}", registryWithEureka);
        logger.info("ğŸ”— æ³¨å†Œä¸­å¿ƒé›†ç¾¤åœ°å€ï¼š{}", defaultZone);
        logger.info("ğŸŒ æ˜¯å¦ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„IPåœ°å€ï¼š{}", preferIpAddress);
        logger.info("ğŸ“Š è®¿é—®åœ°å€ï¼šhttp://localhost:{}/", port);
        logger.info("ğŸ‘ï¸ ç›‘æ§ç«¯ç‚¹ï¼šhttp://localhost:{}/actuator", port);
        logger.info("========================================================");
    }

    static {
        // æ³¨å†Œ JVM å…³é—­é’©å­ï¼Œç¡®ä¿åº”ç”¨ä¼˜é›…å…³é—­
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            logger.info("===================Autumnnook System æ­£åœ¨å…³é—­===================");
            logger.info("æ­£åœ¨æ¸…ç†èµ„æº...");
            // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„èµ„æºæ¸…ç†é€»è¾‘ï¼Œå¦‚ï¼š
            // - å…³é—­æ•°æ®åº“è¿æ¥æ± 
            // - é‡Šæ”¾ Redis è¿æ¥
            // - ä»æ³¨å†Œä¸­å¿ƒæ³¨é”€æœåŠ¡
            // - åœæ­¢åå°çº¿ç¨‹ç­‰
            logger.info("èµ„æºæ¸…ç†å®Œæˆï¼ŒæœåŠ¡å·²å…³é—­");
        }));
    }
}
```

### ä¸šåŠ¡å±‚æ¥å£

æœåŠ¡æ¶ˆè´¹è€…ä¸šåŠ¡å±‚æ¥å£æ·»åŠ  `@Cacheable` æ³¨è§£å®šä¹‰å­˜å‚¨è§„åˆ™ã€‚

```java
@Cacheable(cacheNames = "autumnnookMenu:menu:getMenuListFeign", key = "#id")
@GetMapping("/getSystemById")
public System getSystemById(String id) {
    return new System("AutumnNook System" + id, "1.0.0", "Admin");
}

@Cacheable(cacheNames = "autumnnookMenu:menu:getMenuListFeign")
@GetMapping("/getMenuListFeign")
public List<?> getMenuListFeign() {
    return menuService.getMenuList();
}

@Cacheable(cacheNames = "autumnnookMenu:menu:getMenuList")
@GetMapping("/getMenuList")
public List<?> getMenuList() {
    String serviceName = "autumnnook-menu";
    String url = "http://" + serviceName + "/menu/list";
    ResponseEntity<List<?>> response =
        restTemplate.exchange(url, HttpMethod.GET, null, new ParameterizedTypeReference<List<?>>() {
        });
    return response.getBody();
}
```

### æµ‹è¯•æœåŠ¡

é€šè¿‡ JMeter å·¥å…·è¿›è¡Œæ¨¡æ‹Ÿé«˜å¹¶å‘æµ‹è¯•ï¼Œä¸ä¼šå‡ºç°ä¹‹å‰é‚£ç§è¯·æ±‚å¤±è´¥çš„åŸå› ã€‚

![image-20251224102023709](assets/image-20251224102023709.png)

## è¯·æ±‚åˆå¹¶

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªé¡¹ç›®æ‹†åˆ†æˆå¾ˆå¤šä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œè¿™äº›ç‹¬ç«‹çš„æ¨¡å—é€šè¿‡è¿œç¨‹è°ƒç”¨æ¥äº’ç›¸é…åˆå·¥ä½œã€‚ä½†æ˜¯ï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œé€šä¿¡æ¬¡æ•°çš„å¢åŠ ä¼šå¯¼è‡´æ€»çš„é€šä¿¡æ—¶é—´å¢åŠ ï¼ŒåŒæ—¶ï¼Œ**çº¿ç¨‹æ± çš„èµ„æºä¹Ÿæ˜¯æœ‰é™çš„**ï¼Œé«˜å¹¶å‘ç¯å¢ƒä¼šå¯¼è‡´æœ‰å¤§é‡çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè¿›è€Œå¯¼è‡´å“åº”å»¶è¿Ÿï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ¥äº†è§£ Hystrix çš„è¯·æ±‚åˆå¹¶ã€‚

<img src="assets/image-20251224110229274.png" alt="image-20251224110229274" style="zoom:70%;" />

ä¸ºäº†åŒºåˆ†è¯·æ±‚ç¼“å­˜ï¼Œæˆ‘ä»¬æ€ä¹ˆé€šä¿—çš„ç†è§£è¯·æ±‚åˆå¹¶æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ 10 ä¸ªç”¨æˆ·éƒ½éœ€è¦è°ƒç”¨æ¥å£ `getUserById`ï¼Œä»å¾®è§‚è§’åº¦ä¸Šçœ‹ï¼Œæˆ‘ä»¬è¯·æ±‚åˆå¹¶å¯ä»¥ç†è§£ä¸ºæä¾›ä¸€ä¸ª `getUserByIds` æ¥å£ï¼Œæ‰¹é‡æ‰§è¡ŒæŸ¥è¯¢ï¼Œä½†è¿™æ ·ä¼šæœ‰ä¸€ä¸ªç‰¹åˆ«å¤§çš„å¼Šç«¯ï¼Œç¬¬ä¸€ä¸ªæ¥çš„è¯·æ±‚éœ€è¦å»ç­‰å¾…æ‰¹é‡è¯·æ±‚çš„æ‰§è¡Œã€‚å°±å¥½æ¯”ä½ å»åè½¦ï¼Œæ¯è½¦éƒ½éœ€è¦å‡‘æ»¡å‘˜æ‰èƒ½èµ°ï¼Œæ‰€ä»¥æœ€å…ˆåˆ°çš„è¯·æ±‚éœ€è¦ç­‰å¾…æ‰¹é‡æ‰§è¡Œæ“ä½œã€‚

### å¼Šç«¯

è®¾ç½®è¯·æ±‚åˆå¹¶ä¹‹åï¼Œæœ¬æ¥ä¸€ä¸ªè¯·æ±‚å¯èƒ½ 5 ms å°±æå®šäº†ï¼Œä½†æ˜¯ç°åœ¨å¿…é¡»å†ç­‰ä¸€æ®µæ—¶é—´ï¼ˆå‡è®¾ 10 msï¼‰çœ‹çœ‹è¿˜æœ‰æ²¡æœ‰å…¶ä»–è¯·æ±‚ä¸€èµ·ï¼Œè¿™æ ·ä¸€ä¸ªè¯·æ±‚è€—æ—¶å°±ä» 5 ms å¢åŠ åˆ°äº† 15 msã€‚

å¦‚æœæˆ‘ä»¬éœ€è¦å‘èµ·çš„å‘½ä»¤æœ¬èº«å°±æ˜¯ä¸€ä¸ªé«˜å»¶è¿Ÿçš„å‘½ä»¤ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¯·æ±‚åˆå¹¶ï¼Œå› ä¸ºè¿™ä¸ªæ—¶é—´æ¶ˆè€—å°±æ˜¾å¾—æ— è¶³è½»é‡äº†ï¼Œå¦å¤–é«˜å¹¶å‘ä¹Ÿæ˜¯è¯·æ±‚åˆå¹¶çš„ä¸€ä¸ªéå¸¸é‡è¦çš„åœºæ™¯ã€‚

### æ·»åŠ ä¾èµ–

æœåŠ¡æ¶ˆè´¹è€…æ·»åŠ  hystrix ä¾èµ–ã€‚

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
</dependency>
```

 ### ä¸šåŠ¡å±‚

æœåŠ¡æä¾›è€…ä¸šåŠ¡å±‚ä»£ç æ·»åŠ è¯·æ±‚åˆå¹¶è§„åˆ™æ¥å£ã€‚

- SystemService

```java
import com.autumnnook.pojo.System;
import java.util.List;
import java.util.concurrent.Future;
public interface SystemService {
    
    Future<System> getSystemById(String id);

    List<System> getSystemList(List<String> ids);

}
```

- SystemServiceImpl

```java
import com.autumnnook.pojo.System;
import com.autumnnook.service.SystemService;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixCollapser;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.Future;
@Service
public class SystemServiceImpl implements SystemService {

    private static final Logger logger = LoggerFactory.getLogger(SystemServiceImpl.class);

    @Override
    @HystrixCollapser(
        // åˆå¹¶è¯·æ±‚æ–¹æ³•
        batchMethod = "getSystemList",
        // è¯·æ±‚æ–¹å¼
        scope = com.netflix.hystrix.HystrixCollapser.Scope.GLOBAL, collapserProperties = {
        // é—´éš”å¤šä¹…çš„è¯·æ±‚ä¼šè¿›è¡Œåˆå¹¶ï¼ˆé»˜è®¤ 10 msï¼‰
        @HystrixProperty(name = "timerDelayInMilliseconds", value = "100"),
        // æ‰¹å¤„ç†ä¸­ï¼Œå…è®¸çš„æœ€å¤§è¯·æ±‚æ•°
        @HystrixProperty(name = "maxRequestsInBatch", value = "10")})
    public Future<System> getSystemById(String id) {
        logger.info("ğŸ¯ ----getSystemById called with id: {}----", id);
        return null;// hystrix ä¼šè‡ªåŠ¨å®ç°è¯¥æ–¹æ³•
    }

    @Override
    @HystrixCommand
    public List<System> getSystemList(List<String> ids) {
        logger.info("ğŸ¯----getSystemList called with ids: {}----", ids);
        return Arrays.asList(new System("AutumnNook System", "1.0.0", "Admin"),
            new System("AutumnNook System", "1.1.0", "Admin"), new System("AutumnNook System", "1.2.0", "Admin"));
    }
}
```

`@HystrixCollapser` æ³¨è§£å„é¡¹å‚æ•°è¯´æ˜å¦‚ä¸‹ã€‚

|           å‚æ•°           |                             ä½œç”¨                             |      é»˜è®¤å€¼       | å¤‡æ³¨                                                         |
| :----------------------: | :----------------------------------------------------------: | :---------------: | :----------------------------------------------------------- |
|    @HystrixCollapser     |                                                              |                   | è¢« @HystrixCollapser æ ‡æ³¨çš„æ–¹æ³•ï¼Œè¿”å›å€¼ç±»å‹å¿…é¡»æ˜¯ `Future<?>` ï¼Œä½¿ç”¨å¼‚æ­¥æ–¹æ³•ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè¯·æ±‚åˆå¹¶ã€‚ |
|       batchMethod        |                        åˆå¹¶è¯·æ±‚çš„æ–¹æ³•                        |                   | æ–¹æ³•åªèƒ½æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå¦‚æœéœ€è¦ä¼ é€’å¤šä¸ªå‚æ•°ï¼Œè¯·å°†å…¶å°è£…ä¸ºç±»å‚æ•°ã€‚ |
|          scope           |                           è¯·æ±‚æ–¹å¼                           |      REQUEST      | è¯·æ±‚æ–¹å¼ï¼š<br />ğŸ§‡REQUESTï¼šåªå¯¹ä¸€ä¸ªè¯·æ±‚å†…çš„å¤šæ¬¡æœåŠ¡è¯·æ±‚è¿›è¡Œåˆå¹¶ï¼›<br />ğŸ§‡GLOBALï¼šå¤šå•ä¸ªåº”ç”¨ä¸­çš„æ‰€æœ‰çº¿ç¨‹çš„è¯·æ±‚ä¸­çš„å¤šæ¬¡æœåŠ¡è¯·æ±‚è¿›è¡Œåˆå¹¶<br /> |
| timerDelayInMilliseconds | è¯·æ±‚æ—¶é—´é—´éš”ï¼ˆå•ä½ï¼šmsï¼‰ï¼Œé»˜è®¤ 10ms ä¹‹å†…çš„è¯·æ±‚ä¼šè¢«åˆå¹¶ä¸ºä¸€ä¸ªè¯·æ±‚ |        10         | å»ºè®®å°½é‡è®¾ç½®çš„å°ä¸€ç‚¹ï¼Œå¦‚æœå¹¶å‘é‡ä¸å¤§çš„è¯ï¼Œå…¶å®ä¹Ÿæ²¡æœ‰å¿…è¦ä½¿ç”¨è¯·æ±‚åˆå¹¶å¤„ç†ã€‚ |
|    maxRequestsInBatch    |      è®¾ç½®è§¦å‘æ‰¹å¤„ç†æ‰§è¡Œä¹‹å‰ï¼Œåœ¨æ‰¹å¤„ç†ä¸­å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°      | Integer.MAX_VALUE |                                                              |

- SystemController

```java
import com.autumnnook.pojo.System;
import com.autumnnook.service.SystemService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import java.util.List;
import java.util.concurrent.ExecutionException;
@RestController
@RequestMapping("/system")
@RequiredArgsConstructor
public class SystemController {

    private final SystemService systemService;

    @PostMapping("/getSystemByIds")
    public List<?> getSystemByIds(@RequestBody List<String> ids) {
        return systemService.getSystemList(ids);
    }

    @GetMapping("/getSystemById/{id}")
    public System getSystemById(@PathVariable String id) throws ExecutionException, InterruptedException {
        return systemService.getSystemById(id).get();
    }
}
```

### å¯åŠ¨ç±»

å¯åŠ¨ç±»éœ€è¦æ·»åŠ  `@EnableCircuitBreaker` æˆ–è€… `@EnableHystrix` æ³¨è§£ã€‚

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.ApplicationContext;
import org.springframework.core.env.Environment;
@EnableFeignClients
@EnableCircuitBreaker
@SpringBootApplication
public class SystemApplication {

    private static final Logger logger = LoggerFactory.getLogger(SystemApplication.class);

    public static void main(String[] args) {
        // å¯åŠ¨ Spring Boot åº”ç”¨ï¼Œè¿”å›åº”ç”¨ä¸Šä¸‹æ–‡
        ApplicationContext context = SpringApplication.run(SystemApplication.class, args);

        // è·å–ç¯å¢ƒé…ç½®ä¿¡æ¯
        Environment environment = context.getEnvironment();

        // ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–å…³é”®é…ç½®ä¿¡æ¯
        String port = environment.getProperty("server.port");
        String fetchRegistry = environment.getProperty("eureka.client.fetch-registry");
        String registryWithEureka = environment.getProperty("eureka.client.register-with-eureka");
        String defaultZone = environment.getProperty("eureka.client.service-url.defaultZone");
        String hostname = environment.getProperty("eureka.instance.hostname");
        String preferIpAddress = environment.getProperty("eureka.instance.prefer-ip-address");

        // è¾“å‡ºåº”ç”¨å¯åŠ¨æˆåŠŸä¿¡æ¯å’Œå…³é”®é…ç½®
        logger.info("========= AutumnNook System started successfully =========");
        logger.info("ğŸš€ æœåŠ¡ç«¯å£ï¼š{}", port);
        logger.info("ğŸ  å®ä¾‹åœ°å€ï¼š{}", hostname);
        logger.info("ğŸ“¥ æ˜¯å¦ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡ï¼š{}", fetchRegistry);
        logger.info("ğŸ“¤ æ˜¯å¦æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼š{}", registryWithEureka);
        logger.info("ğŸ”— æ³¨å†Œä¸­å¿ƒé›†ç¾¤åœ°å€ï¼š{}", defaultZone);
        logger.info("ğŸŒ æ˜¯å¦ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„IPåœ°å€ï¼š{}", preferIpAddress);
        logger.info("ğŸ“Š è®¿é—®åœ°å€ï¼šhttp://localhost:{}/", port);
        logger.info("ğŸ‘ï¸ ç›‘æ§ç«¯ç‚¹ï¼šhttp://localhost:{}/actuator", port);
        logger.info("========================================================");
    }

    static {
        // æ³¨å†Œ JVM å…³é—­é’©å­ï¼Œç¡®ä¿åº”ç”¨ä¼˜é›…å…³é—­
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            logger.info("===================Autumnnook System æ­£åœ¨å…³é—­===================");
            logger.info("æ­£åœ¨æ¸…ç†èµ„æº...");
            // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„èµ„æºæ¸…ç†é€»è¾‘ï¼Œå¦‚ï¼š
            // - å…³é—­æ•°æ®åº“è¿æ¥æ± 
            // - é‡Šæ”¾ Redis è¿æ¥
            // - ä»æ³¨å†Œä¸­å¿ƒæ³¨é”€æœåŠ¡
            // - åœæ­¢åå°çº¿ç¨‹ç­‰
            logger.info("èµ„æºæ¸…ç†å®Œæˆï¼ŒæœåŠ¡å·²å…³é—­");
        }));
    }
}
```

### æ¶ˆè´¹è€…æ¨¡æ‹Ÿå¤šæ¬¡è°ƒç”¨

æœåŠ¡æ¶ˆè´¹è€…æˆ‘ä»¬é€šè¿‡ OpenFeign å»æ¨¡æ‹Ÿè°ƒç”¨æœåŠ¡æä¾›è€…çš„è¯·æ±‚åˆå¹¶æ¥å£ã€‚

- SystemService         `api`

```java
@FeignClient(name = "autumnnook-system")
public interface SystemService {
    @ResponseBody
    @GetMapping("/system/getSystemById/{id}")
    Object getSystemById(@PathVariable("id") String id);
}
```

- MenuController

```java
@GetMapping("/getSystemById")
public void getSystemById() throws ExecutionException, InterruptedException {
    // æ¨¡æ‹Ÿ 5 æ¬¡è°ƒç”¨
    for(int i = 1; i <= 5; i++) {
        Object o = systemService.getSystemById(String.valueOf(i));
        logger.info("ğŸ‘‰ ----getSystemById called with id: {}----", i);
    }
}
```

### æµ‹è¯•è§‚å¯Ÿ

![image-20251224150658061](assets/image-20251224150658061.png)

## æœåŠ¡éš”ç¦»

### çº¿ç¨‹æ± éš”ç¦»

æ²¡æœ‰çº¿ç¨‹æ± éš”ç¦»çš„é¡¹ç›®æ‰€æœ‰æ¥å£éƒ½è¿è¡Œåœ¨ä¸€ä¸ª `ThreadPool` ä¸­ï¼Œå½“æŸä¸€ä¸ªæ¥å£å‹åŠ›è¿‡å¤§æˆ–è€…å‡ºç°æ•…éšœæ—¶ï¼Œä¼šå¯¼è‡´èµ„æºè€—å°½ä»è€Œå½±å“åˆ°å…¶ä»–æ¥å£çš„è°ƒç”¨è€Œå¼•å‘æœåŠ¡é›ªå´©æ•ˆåº”ï¼Œæˆ‘ä»¬åœ¨æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯çš„æ—¶å€™ä¹Ÿæ¼”ç¤ºäº†è¯¥æ•ˆæœã€‚

é€šè¿‡æ¯æ¬¡éƒ½å¼€å¯ä¸€ä¸ªå•ç‹¬çº¿ç¨‹è¿è¡Œï¼Œä»–çš„éš”ç¦»æ˜¯é€šè¿‡çº¿ç¨‹æ± ï¼Œå³æ¯ä¸ªéš”ç¦»ç²’åº¦éƒ½æ˜¯ä¸ªçº¿ç¨‹æ± ï¼Œäº’ç›¸ä¸å¹²æ‰°ã€‚çº¿ç¨‹æ± éš”ç¦»æ–¹å¼ï¼Œç­‰äºå¤šäº†ä¸€å±‚çš„ä¿æŠ¤æªæ–½ï¼Œå¯ä»¥é€šè¿‡ hystrix ç›´æ¥è®¾ç½®è¶…æ—¶ï¼Œè¶…æ—¶åç›´æ¥è¿”å›ã€‚

- éš”ç¦»å‰

<img src="assets/image-20251224162751159.png" alt="image-20251224162751159" style="zoom:60%;" />

<img src="assets/image-20251224162816635.png" alt="image-20251224162816635" style="zoom:61%;" />

- éš”ç¦»å

<img src="assets/image-20251224163720061.png" alt="image-20251224163720061" style="zoom:65%;" />

<img src="assets/image-20251224212325564.png" alt="image-20251224212325564" style="zoom:103%;" />



**ä¼˜ç‚¹ï¼š**

- ä½¿ç”¨çº¿ç¨‹æ± éš”ç¦»å¯ä»¥å®‰å…¨éš”ç¦»ä¾èµ–çš„æœåŠ¡ï¼ˆä¾‹å¦‚å›¾ä¸­ Aã€Bã€Cã€D æœåŠ¡ï¼‰ï¼Œå‡å°‘æ‰€ä¾èµ–æœåŠ¡å‘ç”Ÿæ•…éšœæ—¶çš„å½±å“é¢ã€‚æ¯”å¦‚ A æœåŠ¡å‘ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´è¯·æ±‚å¤§é‡è¶…æ—¶æ—¶ï¼Œå¯¹åº”çš„çº¿ç¨‹æ± è¢«æ‰“æ»¡ï¼Œè¿™æ—¶å¹¶ä¸å½±å“ Cã€D æœåŠ¡çš„è°ƒç”¨ï¼›
- å½“å¤±è´¥çš„æœåŠ¡å˜å¾—å†æ¬¡å¯ç”¨æ—¶ï¼Œçº¿ç¨‹æ± å°†æ¸…ç†å¹¶ç«‹å³æ¢å¤ï¼Œè€Œä¸éœ€è¦ä¸€ä¸ªé•¿æ—¶é—´çš„æ¢å¤ï¼›
- ç‹¬ç«‹çš„çº¿ç¨‹æ± æé«˜äº†å¹¶å‘æ€§ï¼›

**ç¼ºç‚¹ï¼š**

- è¯·æ±‚åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œè‚¯å®šä¼šå¸¦æ¥ä»»åŠ¡è°ƒåº¦ã€æ’é˜Ÿå’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„ CPU å¼€é”€ï¼›
- å› ä¸ºæ¶‰åŠåˆ°è·¨çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±å­˜åœ¨ ThreadLocal æ•°æ®çš„ä¼ é€’é—®é¢˜ï¼Œæ¯”å¦‚åœ¨ä¸»çº¿ç¨‹åˆå§‹åŒ–çš„ ThreadLocal å˜é‡ï¼Œåœ¨çº¿ç¨‹æ± çº¿ç¨‹ä¸­æ— æ³•è·å–ï¼›

#### æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
</dependency>
```

#### ä¸šåŠ¡å±‚

- ä¸ä½¿ç”¨çº¿ç¨‹æ± éš”ç¦»çš„æƒ…å†µ

```java
import com.autumnnook.api.SystemService;
import com.autumnnook.pojo.Menu;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;
import java.util.Arrays;
import java.util.List;
@RestController
@RequestMapping("/menu")
@RequiredArgsConstructor
public class MenuController {

    private final SystemService systemService;

    private final RestTemplate restTemplate;

    private static final Logger logger = LoggerFactory.getLogger(MenuController.class);

    @GetMapping("/list")
    public List<Menu> list() throws InterruptedException {
        Thread.sleep(2000);
        logger.info("[list] å½“å‰çº¿ç¨‹ï¼š{}", Thread.currentThread().getName());
        return Arrays.asList(new Menu("1", "Espresso", "3.0"), new Menu("2", "Cappuccino", "4.0"),
            new Menu("3", "Latte", "4.5"));
    }

    @GetMapping("/getMenuById")
    public Menu getMenuById() {
        logger.info("[getMenuById] å½“å‰çº¿ç¨‹ï¼š{}", Thread.currentThread().getName());
        return new Menu("1", "Espresso", "3.0");
    }

}
```

æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨çº¿ç¨‹æ± éš”ç¦»ï¼Œç„¶åé€šè¿‡ JMeter å·¥å…·æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯ä¼šå¾—åˆ°ä»€ä¹ˆæƒ…å†µã€‚

<img src="assets/image-20251224221345308.png" alt="image-20251224221345308" style="zoom:80%;" />

å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ JMeter å·¥å…·ä¸­å¯¹ `/menu/list` è¯·æ±‚æ¨¡æ‹Ÿé«˜å¹¶å‘ï¼Œä¼šå½±å“åˆ° `/menu/getMenuById` è¯·æ±‚çš„å“åº”ã€‚

- ä½¿ç”¨çº¿ç¨‹æ± éš”ç¦»

```java
import com.autumnnook.api.SystemService;
import com.autumnnook.pojo.Menu;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;
import java.util.Arrays;
import java.util.List;
@RestController
@RequestMapping("/menu")
@RequiredArgsConstructor
public class MenuController {

    private final SystemService systemService;

    private final RestTemplate restTemplate;

    private static final Logger logger = LoggerFactory.getLogger(MenuController.class);

    @GetMapping("/list")
    @HystrixCommand(
        // å®šä¹‰å‘½ä»¤çš„ç»„ã€å‘½ä»¤å’Œçº¿ç¨‹æ± åç§°
        groupKey = "menu-list-group",
        // æ¯ä¸ªå‘½ä»¤çš„å”¯ä¸€æ ‡è¯†
        commandKey = "list",
        // çº¿ç¨‹æ± åç§°
        threadPoolKey = "menu-list-thread-pool",
        // å‘½ä»¤å±æ€§é…ç½®
        commandProperties = {
            // è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 1000 ms
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000"),
            // éš”ç¦»ç­–ç•¥ï¼Œé»˜è®¤ THREAD
            @HystrixProperty(name = "execution.isolation.strategy", value = "THREAD")},
        // çº¿ç¨‹æ± é…ç½®
        threadPoolProperties = {
            // çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé»˜è®¤ 10
            @HystrixProperty(name = "coreSize", value = "5"),
            // çº¿ç¨‹æ± é˜Ÿåˆ—ç­‰å¾…é˜ˆå€¼ï¼Œé»˜è®¤ -1ï¼Œè¡¨ç¤ºä¸ä½¿ç”¨é˜Ÿåˆ—
            @HystrixProperty(name = "maxQueueSize", value = "10"),
            // çº¿ç¨‹æ± é˜Ÿåˆ—æ‹’ç»é˜ˆå€¼ï¼Œé»˜è®¤ 5
            @HystrixProperty(name = "queueSizeRejectionThreshold", value = "8"),
            // çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼Œé»˜è®¤ 60000 ms
            @HystrixProperty(name = "keepAliveTimeMinutes", value = "2")})
    public List<Menu> list() throws InterruptedException {
        Thread.sleep(800);
        logger.info("[list] å½“å‰çº¿ç¨‹ï¼š{}", Thread.currentThread().getName());
        return Arrays.asList(new Menu("1", "Espresso", "3.0"), new Menu("2", "Cappuccino", "4.0"),
            new Menu("3", "Latte", "4.5"));
    }

    @GetMapping("/getMenuById")
    @HystrixCommand(
        // å®šä¹‰å‘½ä»¤çš„ç»„ã€å‘½ä»¤å’Œçº¿ç¨‹æ± åç§°
        groupKey = "menu-fetch-by-id-group",
        // æ¯ä¸ªå‘½ä»¤çš„å”¯ä¸€æ ‡è¯†ï¼Œé»˜è®¤æ–¹æ³•å
        commandKey = "getMenuById",
        // çº¿ç¨‹æ± åç§°
        threadPoolKey = "menu-fetch-by-id-thread-pool",
        // å‘½ä»¤å±æ€§é…ç½®
        commandProperties = {
            // è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 1000 ms
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "3000"),
            // éš”ç¦»ç­–ç•¥ï¼Œé»˜è®¤ THREAD
            @HystrixProperty(name = "execution.isolation.strategy", value = "THREAD")},
        // çº¿ç¨‹æ± é…ç½®
        threadPoolProperties = {
            // çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé»˜è®¤ 10
            @HystrixProperty(name = "coreSize", value = "5"),
            // çº¿ç¨‹æ± é˜Ÿåˆ—ç­‰å¾…é˜ˆå€¼ï¼Œé»˜è®¤ -1ï¼Œè¡¨ç¤ºä¸ä½¿ç”¨é˜Ÿåˆ—
            @HystrixProperty(name = "maxQueueSize", value = "10"),
            // çº¿ç¨‹æ± é˜Ÿåˆ—æ‹’ç»é˜ˆå€¼ï¼Œé»˜è®¤ 5
            @HystrixProperty(name = "queueSizeRejectionThreshold", value = "8"),
            // çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼Œé»˜è®¤ 60000 ms
            @HystrixProperty(name = "keepAliveTimeMinutes", value = "2")})
    public Menu getMenuById() {
        logger.info("[getMenuById] å½“å‰çº¿ç¨‹ï¼š{}", Thread.currentThread().getName());
        return new Menu("1", "Espresso", "3.0");
    }
}
```

å¦‚æœæˆ‘ä»¬å¼€å¯çº¿ç¨‹æ± éš”ç¦»ï¼ŒåŒæ ·çš„é€šè¿‡ JMeter æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯å¾—åˆ°çš„æƒ…å†µå¦‚ä¸‹ã€‚

![image-20251224223539771](assets/image-20251224223539771.png)

<img src="assets/image-20251224223617668.png" alt="image-20251224223617668" style="zoom:90%;" />

<span style="color:darkred;font-size:12px;">æ³¨ï¼šå¦‚æœä½ åœ¨ä½¿ç”¨ jmeter æ¨¡æ‹Ÿé«˜å¹¶å‘æµ‹è¯•çº¿ç¨‹æ± éš”ç¦»çš„æ—¶å€™å‘ç°æ˜æ˜å·²ç»çœ‹åˆ°æ—¥å¿—ä¸­å·²ç»ä½¿ç”¨äº†ä¸åŒçš„çº¿ç¨‹æ± ï¼Œä½†ä½ å‹æµ‹æ¥å£ a ä¼šå¯¼è‡´æ¥å£ c å“åº”å¾ˆæ…¢çš„æ—¶å€™ï¼Œè¯·å»æ£€æŸ¥ä¸‹ä½ åœ¨ JMeter æµ‹è¯•çš„çº¿ç¨‹æ•°æ˜¯ä¸æ˜¯è¶…è¿‡ä½ é…ç½®çš„ Tomcat æœ€å¤§çº¿ç¨‹æ•°ï¼ˆé»˜è®¤ 200 ä¸ªï¼‰ã€‚</span>

### ä¿¡å·é‡éš”ç¦»

æ¯æ¬¡è°ƒç”¨çº¿ç¨‹ï¼Œå½“è¯·æ±‚é€šè¿‡è®¡æ•°ä¿¡å·é‡è¿›è¡Œé™åˆ¶ï¼Œå½“ä¿¡å·é‡å¤§äºäº†æœ€å¤§è¯·æ±‚æ•° `maxConcurrentRequests` æ—¶ï¼Œè¿›è¡Œé™åˆ¶ï¼Œè°ƒç”¨ `fallback` æ¥å£å¿«é€Ÿè¿”å›ã€‚ä¿¡å·é‡çš„è°ƒç”¨æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½å¾—é˜»å¡è°ƒç”¨æ–¹çš„çº¿ç¨‹ï¼Œç›´åˆ°ç»“æœè¿”å›ã€‚è¿™æ ·å°±å¯¼è‡´äº†æ— æ³•å¯¹è®¿é—®åšè¶…æ—¶ï¼ˆåªèƒ½ä¾é è°ƒç”¨åè®®è¶…æ—¶ï¼Œæ— æ³•ä¸»åŠ¨é‡Šæ”¾ï¼‰ã€‚

<img src="assets/image-20251224232940755.png" alt="image-20251224232940755" style="zoom:56%;" />

#### æ·»åŠ ä¾èµ–

```xml
```



### çº¿ç¨‹æ± éš”ç¦» VS ä¿¡å·é‡éš”ç¦»





## æœåŠ¡ç†”æ–­



## æœåŠ¡é™çº§



## Feign é›ªå´©å¤„ç†

































































