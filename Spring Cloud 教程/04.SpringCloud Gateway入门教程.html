<!DOCTYPE html><html><head>
      <title>04.SpringCloud Gatewayå…¥é—¨æ•™ç¨‹</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\caixi\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="springcloud-gatewayæœåŠ¡ç½‘å…³">SpringCloud GatewayæœåŠ¡ç½‘å…³ </h1>
<h2 id="å­¦ä¹ ç›®æ ‡">å­¦ä¹ ç›®æ ‡ </h2>
<p><img src="assets/image-20251209090520581.png" alt="image-20251209090520581"></p>
<h2 id="æ¦‚è¿°">æ¦‚è¿° </h2>
<p>è¯¥é¡¹ç›®æä¾›äº†ä¸€ä¸ªåº“ï¼Œç”¨äºåœ¨ Spring WebFlux ä¸Šæ„å»º API ç½‘å…³ã€‚Spring Cloud Gateway æ—¨åœ¨æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•æ¥è·¯ç”±åˆ° APIï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚ï¼šå®‰å…¨æ€§ã€ç›‘æ§/æŒ‡æ ‡å’Œå¼¹æ€§ã€‚</p>
<p>Spring Cloud ç½‘å…³åŠŸèƒ½ï¼š</p>
<ul>
<li>åŸºäº Spring Framework 5 æ„å»ºï¼ŒProject Reactor å’Œ Spring Boot 2.0ï¼›</li>
<li>èƒ½å¤ŸåŒ¹é…ä»»ä½•è¯·æ±‚å±æ€§çš„è·¯ç”±ï¼›</li>
<li>è°“è¯å’Œç­›é€‰æ¡ä»¶ç‰¹å®šäºè·¯ç”±ï¼›</li>
<li>Hystrix Circuit Breaker é›†æˆï¼›</li>
<li>Spring Cloud DiscoveryClient é›†æˆï¼›</li>
<li>æ˜“äºç¼–å†™çš„è°“è¯å’Œè¿‡æ»¤å™¨ï¼›</li>
<li>è¯·æ±‚é€Ÿç‡é™åˆ¶ï¼›</li>
<li>è·¯å¾„é‡å†™ï¼›</li>
</ul>
<p>å¼€å§‹ï¼š</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DemogatewayApplication</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword keyword-public">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"path_route"</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://httpbin.org"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"host_route"</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">"*.myhost.org"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://httpbin.org"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"rewrite_route"</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">"*.rewrite.org"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">rewritePath</span><span class="token punctuation">(</span><span class="token string">"/foo/(?&lt;segment&gt;.*)"</span><span class="token punctuation">,</span> <span class="token string">"/${segment}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://httpbin.org"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"hystrix_route"</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">"*.hystrix.org"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">hystrix</span><span class="token punctuation">(</span>c <span class="token operator">-&gt;</span> c<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"slowcmd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://httpbin.org"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"hystrix_fallback_route"</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">"*.hystrixfallback.org"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">hystrix</span><span class="token punctuation">(</span>c <span class="token operator">-&gt;</span> c<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"slowcmd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFallbackUri</span><span class="token punctuation">(</span><span class="token string">"forward:/hystrixfallback"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://httpbin.org"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"limit_route"</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">"*.limited.org"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/anything/**"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">requestRateLimiter</span><span class="token punctuation">(</span>c <span class="token operator">-&gt;</span> c<span class="token punctuation">.</span><span class="token function">setRateLimiter</span><span class="token punctuation">(</span><span class="token function">redisRateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://httpbin.org"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>è¦è¿è¡Œä½ è‡ªå·±çš„ç½‘å…³ï¼Œè¯·ä½¿ç”¨   <code>spring-cloud-starter-gateway</code>   ä¾èµ–é¡¹ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯-springcloud-gateway">ä»€ä¹ˆæ˜¯ SpringCloud Gateway </h2>
<p>Spring Cloud Gateway ä½œä¸º Spring Cloud ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£ Netflix Zuulï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”è¿˜åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³çš„åŸºæœ¬åŠŸèƒ½ã€‚åœ¨è€ç‰ˆæœ¬çš„ Spring Cloud ä¸­å¼•ç”¨çš„è¿˜æ˜¯ Zuul 1.x ç‰ˆæœ¬ï¼Œè€Œè¿™ä¸ªç‰ˆæœ¬æ˜¯åŸºäºè¿‡æ»¤å™¨çš„ï¼Œæ˜¯é˜»å¡ IOï¼Œå¹¶ä¸æ”¯æŒé•¿è¿æ¥ã€‚</p>
<p><img src="./assets/image-20241209155015919.png" alt="image-20241209155015919"></p>
<p>ç”±äº Zuul 2.x ç‰ˆæœ¬ä¸€è‡´è·³ç¥¨ï¼Œ2019 å¹´ 5 æœˆï¼ŒNetflix ç»ˆäºå¼€æºäº†æ”¯æŒå¼‚æ­¥è°ƒç”¨æ¨¡å¼çš„ Zuul 2.0 ç‰ˆæœ¬ï¼Œå¯è°“åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ã€‚ä½†æ˜¯ Spring Cloud å·²ç»ä¸å†é›†æˆ Zuul 2.x äº†ï¼Œæ‰€ä»¥ Spring Cloud å¯¹ Gateway çš„æ”¯æŒæ¯” Zuul 2.xæ›´åŠ å‹å¥½ï¼Œå³ä½¿ Zuul 2.x å’Œ Gateway å¹¶æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„å·®åˆ«ã€‚</p>
<p>Spring Cloud Gateway æ˜¯åŸºäº Spring ç”Ÿæ€ç³»ç»Ÿä¹‹ä¸Šæ„å»ºçš„ API ç½‘å…³ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>Spring 5</li>
<li>Spring Boot 2</li>
<li>Project Reactor</li>
</ul>
<p>SpringCloud Gateway æ—¨åœ¨æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•æ¥è·¯ç”±åˆ° APIï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›è·¨é¢†åŸŸçš„å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚ï¼šå®‰å…¨æ€§ã€ç›‘è§†/æŒ‡æ ‡ã€é™æµç­‰ã€‚ç”±äº Spring 5.0 æ”¯æŒ Nettyã€HTTP2ï¼Œè€Œ Spring Boot 2.0 æ”¯æŒ Spring 5ï¼Œå› æ­¤ SpringCloud Gateway æ”¯æŒ Nettyã€HTTP2 é¡ºç†æˆç« ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘å…³">ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘å…³ </h2>
<p>API Gateway ï¼ˆAPIGW / API ç½‘å…³ï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯å‡ºç°åœ¨ç³»ç»Ÿè¾¹ç•Œä¸Šçš„ä¸€ä¸ªé¢å‘ API çš„ã€ä¸²è¡Œé›†ä¸­å¼çš„å¼ºç®¡æ§æœåŠ¡ï¼Œè¿™é‡Œçš„è¾¹ç•Œæ˜¯ä¼ä¸š IT ç³»ç»Ÿçš„è¾¹ç•Œï¼Œå¯ä»¥ç†è§£ä¸º<span style="color:#FF6000;">ä¼ä¸šçº§åº”ç”¨é˜²ç«å¢™</span>ï¼Œä¸»è¦èµ·åˆ°ä¸€ä¸ª<span style="color:#FF6000;">éš”ç¦»å¤–éƒ¨è®¿é—®ä¸å†…éƒ¨ç³»ç»Ÿçš„ä½œç”¨ã€‚</span></p>
<p>åœ¨å¾®æœåŠ¡æ¦‚å¿µçš„æµè¡Œä¹‹å‰ï¼ŒAPI ç½‘å…³å°±å·²ç»è¯ç”Ÿäº†ï¼Œä¾‹å¦‚é“¶è¡Œã€è¯åˆ¸ç­‰é¢†åŸŸå¸¸è§çš„å‰ç½®æœºç³»ç»Ÿï¼Œå®ƒä¹Ÿæ˜¯è§£å†³è®¿é—®è®¤è¯ã€æŠ¥æ–‡è½¬æ¢ã€è®¿é—®ç»Ÿè®¡ç­‰é—®é¢˜çš„ã€‚</p>
<p>API ç½‘å…³çš„æµè¡Œï¼Œæºäºè¿‘å‡ å¹´æ¥ç§»åŠ¨åº”ç”¨ä¸ä¼ä¸šé—´äº’è”éœ€æ±‚çš„å…´èµ·ã€‚ç§»åŠ¨åº”ç”¨ã€ä¼ä¸šäº’è”ï¼Œä½¿å¾—åå°æœåŠ¡æ”¯æ’‘çš„å¯¹è±¡ï¼Œä»å•ä¸€çš„ Web åº”ç”¨ï¼Œæ‰©å±•åˆ°å¤šç§ä½¿ç”¨åœºæ™¯ï¼Œä¸”æ¯ç§ä½¿ç”¨åœºæ™¯å¯¹åå°æœåŠ¡çš„è¦æ±‚éƒ½ä¸å°½ç›¸åŒã€‚è¿™ä¸ä»…å¢åŠ äº†åå°æœåŠ¡çš„å“åº”é‡ï¼Œè¿˜å¢åŠ äº†åå°æœåŠ¡çš„å¤æ‚æ€§ã€‚<span style="color:#ff6000;">éšç€å¾®æœåŠ¡æ¶æ„æ¦‚å¿µçš„å‰”é™¤ï¼ŒAPI ç½‘å…³æˆä¸ºäº†å¾®æœåŠ¡æ¶æ„çš„ä¸€ä¸ªæ ‡é…ç»„ä»¶ã€‚</span></p>
<p>API ç½‘å…³æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæ˜¯ç³»ç»Ÿå¯¹å¤–çš„å”¯ä¸€å…¥å£ã€‚API ç½‘å…³å°è£…äº†ç³»ç»Ÿå†…éƒ¨æ¶æ„ï¼Œä¸ºæ¯ä¸ªå®¢æˆ·ç«¯æä¾›å®šåˆ¶ APIã€‚æ‰€æœ‰çš„å®¢æˆ·ç«¯å’Œæ¶ˆè´¹ç«¯éƒ½é€šè¿‡ç»Ÿä¸€çš„ç½‘å…³æ¥å…¥å¾®æœåŠ¡ï¼Œåœ¨ç½‘å…³å±‚å¤„ç†æ‰€æœ‰çš„éä¸šåŠ¡åŠŸèƒ½ã€‚API ç½‘å…³å¹¶ä¸æ˜¯å¾®æœåŠ¡åœºæ™¯ä¸­æ‰€å¿…é¡»çš„ç»„ä»¶ã€‚å¦‚ä¸‹å›¾ï¼Œä¸ç®¡æœ‰æ²¡æœ‰ç½‘å…³ï¼Œåç«¯å¾®æœåŠ¡éƒ½å¯ä»¥é€šè¿‡ API å¾ˆå¥½çš„æ”¯æŒå®¢æˆ·ç«¯çš„è®¿é—®ã€‚</p>
<img src="./assets/image-20241210150108592.png" alt="image-20241210150108592" style="zoom:76%;">
<p>ä½†å¯¹äºæœåŠ¡æ•°é‡ä¼—å¤šã€å¤æ‚åº¦æ¯”è¾ƒé«˜ã€è§„æ¨¡æ¯”è¾ƒå¤§çš„ä¸šåŠ¡æ¥è¯´ï¼Œå¼•å…¥ API ç½‘å…³ä¹Ÿæœ‰ä»¥ä¸‹ä¸€ç³»åˆ—çš„å¥½å¤„ï¼š</p>
<ul>
<li>èšåˆæ¥å£ä½¿å¾—æœåŠ¡å¯¹è°ƒç”¨è€…é€æ˜ï¼Œå®¢æˆ·ç«¯ä¸åç«¯çš„è€¦åˆåº¦é™ä½</li>
<li>èšåˆåå°æœåŠ¡ï¼ŒèŠ‚çœæµé‡ï¼Œæé«˜æ€§èƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ</li>
<li>æä¾›å®‰å…¨ã€æµæ§ã€è¿‡æ»¤ã€ç¼“å­˜ã€è®¡è´¹ã€ç›‘æ§ç­‰ API ç®¡ç†åŠŸèƒ½</li>
</ul>
<h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æœåŠ¡ç½‘å…³">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æœåŠ¡ç½‘å…³ </h2>
<p>Spring Cloud Gatewayæ˜¯ä¸€ä¸ªçµæ´»ä¸”åŠŸèƒ½å¼ºå¤§çš„APIç½‘å…³è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚ç”¨äºå¾®æœåŠ¡æ¶æ„ä¸‹çš„ç³»ç»Ÿã€‚</p>
<p><strong>å•ä½“åº”ç”¨ï¼š</strong> æµè§ˆå™¨å‘èµ·è¯·æ±‚åˆ°å•ä½“åº”ç”¨æ‰€åœ¨çš„æœºå™¨ï¼Œåº”ç”¨ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®åŸè·¯è¿”å›ç»™æµè§ˆå™¨ï¼Œå¯¹äºå•ä½“åº”ç”¨æ¥è¯´æ˜¯ä¸éœ€è¦ç½‘å…³çš„ã€‚</p>
<p><strong>å¾®æœåŠ¡ï¼š</strong> å¾®æœåŠ¡çš„åº”ç”¨å¯èƒ½éƒ¨ç½²åœ¨ä¸åŒæœºæˆ¿ï¼Œä¸åŒåœ°åŒºï¼Œä¸åŒåŸŸåä¸‹ã€‚æ­¤æ—¶å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨/æ‰‹æœº/è½¯ä»¶å·¥å…·ï¼‰æƒ³è¦è¯·æ±‚å¯¹åº”çš„æœåŠ¡ï¼Œéƒ½è¦çŸ¥é“æœºå™¨çš„å…·ä½“ IP æˆ–è€…åŸŸå URLï¼Œå½“å¾®æœåŠ¡å®ä¾‹ä¼—å¤šæ—¶ï¼Œè¿™æ˜¯éå¸¸éš¾ä»¥è®°å¿†çš„ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ä¹Ÿå¤ªå¤æ‚éš¾ä»¥ç»´æŠ¤ã€‚æ­¤æ—¶å°±æœ‰äº†ç½‘å…³ï¼Œå®¢æˆ·ç«¯ç›¸å…³çš„è¯·æ±‚ç›´æ¥å‘é€åˆ°ç½‘å…³ï¼Œç”±ç½‘å…³æ ¹æ®è¯·æ±‚æ ‡è¯†è§£æåˆ¤æ–­å‡ºå…·ä½“çš„å¾®æœåŠ¡çš„åœ°å€ï¼Œå†æŠŠè¯·æ±‚è½¬å‘åˆ°å¾®æœåŠ¡å®ä¾‹ã€‚è¿™å…¶ä¸­çš„è®°å¿†åŠŸèƒ½å°±å…¨éƒ¨äº¤ç»™ç½‘å…³æ¥æ“ä½œäº†ã€‚</p>
<p><img src="./assets/image-20241210171829141.png" alt="image-20241210171829141"></p>
<p>æ€»ç»“æ¥è¯´ï¼Œå¦‚æœè®©å®¢æˆ·ç«¯ç›´æ¥å’Œå„ä¸ªå¾®æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯ä¼šå¤šæ¬¡è¯·æ±‚ä¸åŒçš„å¾®æœåŠ¡ï¼Œå¢åŠ äº†å®¢æˆ·ç«¯çš„å¤æ‚åº¦</li>
<li>å­˜åœ¨è·¨åŸŸè¯·æ±‚é—®é¢˜ï¼Œåœ¨ä¸€å®šåœºæ™¯ä¸‹å¤„ç†è·¨åŸŸç›¸å¯¹å¤æ‚</li>
<li>èº«ä»½è®¤è¯é—®é¢˜ï¼Œæ¯ä¸ªå¾®æœåŠ¡éœ€è¦ç‹¬ç«‹è¿›è¡Œèº«ä»½è®¤è¯</li>
<li>éš¾ä»¥é‡æ„ï¼Œéšç€é¡¹ç›®çš„è¿­ä»£ï¼Œå¯èƒ½éœ€è¦é‡æ–°åˆ’åˆ†å¾®æœåŠ¡</li>
<li>æŸäº›å¾®æœåŠ¡å¯èƒ½ä½¿ç”¨äº†é˜²ç«å¢™ / æµè§ˆå™¨ä¸å‹å¥½çš„åè®®ï¼Œç›´æ¥è®¿é—®å­˜åœ¨ä¸€å®šçš„å›°éš¾</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ç½‘å…³ä»‹äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸­é—´å±‚ï¼Œæ‰€æœ‰å¤–éƒ¨è¯·æ±‚ç‡å…ˆç»è¿‡å¾®æœåŠ¡ç½‘å…³ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å’Œç½‘å…³è¿›è¡Œäº¤äº’ï¼Œåªéœ€è¦çŸ¥é“ç½‘å…³åœ°å€ï¼Œè€Œä¸éœ€è¦çŸ¥é“å„ä¸ªæœåŠ¡çš„åœ°å€ï¼Œè¿™æ ·ä¸ä»…ç®€åŒ–äº†å¼€å‘ï¼Œè¿˜å…·æœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p>
<ul>
<li>æ˜“äºç›‘æ§ï¼Œå¯åœ¨å¾®æœåŠ¡ç½‘å…³æ”¶é›†ç›‘æ§æ•°æ®å¹¶å°†å…¶æ¨é€åˆ°å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œåˆ†æ</li>
<li>æ˜“ä¸è®¤è¯ï¼Œå¯åœ¨å¾®æœåŠ¡ç½‘å…³ä¸Šè¿›è¡Œè®¤è¯ï¼Œç„¶åå†å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¾®æœåŠ¡ï¼Œä»è€Œæ— éœ€åœ¨æ¯ä¸ªå¾®æœåŠ¡ä¸­è¿›è¡Œè®¤è¯</li>
<li>å‡å°‘å®¢æˆ·ç«¯ä¸å„ä¸ªå¾®æœåŠ¡ä¹‹é—´çš„äº¤äº’æ¬¡æ•°</li>
</ul>
<h2 id="ç½‘å…³è§£å†³äº†ä»€ä¹ˆé—®é¢˜">ç½‘å…³è§£å†³äº†ä»€ä¹ˆé—®é¢˜ </h2>
<p>ç½‘å…³çš„å¼•å…¥è§£å†³äº†å¾ˆå¤šå…·ä½“åœºæ™¯ä¸‹çš„é—®é¢˜ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<div style="width:100%;display:flex;justify-content:center;align-items: center;">
<img src="./assets/image-20241216230424372-17343614663431.gif" style="width:80%;display:block;margin:0 auto;">
</div>
<p>ç½‘å…³å…·æœ‰èº«ä»½è®¤è¯ä¸å®‰å…¨ã€å®¡æŸ¥ä¸ç›‘æ§ã€åŠ¨æ€è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€è¯·æ±‚åˆ†ç‰‡ä¸ç®¡ç†ã€é™æ€å“åº”å¤„ç†ç­‰åŠŸèƒ½ã€‚å½“ç„¶æœ€ä¸»è¦çš„è¿˜æ˜¯â€œä¸å¤–ç•Œè”ç³»â€ã€‚</p>
<p>æ€»ç»“ä»¥ä¸‹ï¼Œç½‘å…³åº”å½“å…·å¤‡ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>æ€§èƒ½ï¼šAPI é«˜å¯ç”¨ï¼Œè´Ÿè½½å‡è¡¡ï¼Œå®¹é”™æœºåˆ¶ã€‚</li>
<li>å®‰å…¨ï¼šæƒé™èº«ä»½è®¤è¯ã€è„±æ•ã€æµé‡æ¸…æ´—ï¼Œåç«¯ç­¾åï¼ˆä¿è¯å…¨é“¾è·¯å¯ä¿¡è°ƒç”¨ï¼‰ï¼Œé»‘åå•ï¼ˆéæ³•è°ƒç”¨é™åˆ¶ï¼‰ã€‚</li>
<li>æ—¥å¿—ï¼šæ—¥å¿—è®°å½•ï¼Œä¸€æ—¦æ¶‰åŠåˆ†å¸ƒå¼ï¼Œå…¨é“¾è·¯è·Ÿè¸ªå¿…ä¸å¯å°‘ã€‚</li>
<li>ç¼“å­˜ï¼šæ•°æ®ç¼“å­˜</li>
<li>ç›‘æ§ï¼šè®°å½•è¯·æ±‚å“åº”æ•°æ®ï¼ŒAPI è€—æ—¶åˆ†æï¼Œæ€§èƒ½ç›‘æ§</li>
<li>é™æµï¼šæµé‡æ§åˆ¶ï¼Œé”™å³°æµæ§ï¼Œå¯ä»¥å®šä¹‰å¤šç§é™æµè§„åˆ™</li>
<li>ç°åº¦ï¼šçº¿ä¸Šç°åº¦éƒ¨ç½²ï¼Œå¯ä»¥å‡å°‘é£é™©</li>
<li>è·¯ç”±ï¼šåŠ¨æ€è·¯ç”±è§„åˆ™</li>
</ul>
<h2 id="å¸¸ç”¨ç½‘å…³è§£å†³æ–¹æ¡ˆ">å¸¸ç”¨ç½‘å…³è§£å†³æ–¹æ¡ˆ </h2>
<h3 id="nginx--luaè„šæœ¬">Nginx + Luaè„šæœ¬ </h3>
<p>Nginx æ˜¯ç”± IgorSysoev ä¸ºä¿„ç½—æ–¯è®¿é—®é‡ç¬¬äºŒçš„ <a href="http://Rmbler.ru">Rmbler.ru</a> ç«™ç‚¹å¼€å‘çš„ï¼Œä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç†æœåŠ¡å™¨ã€‚Nginx ä¸€æ–¹é¢å¯ä»¥åšåå‘ä»£ç†ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥åšé™æ€èµ„æºæœåŠ¡å™¨ã€‚</p>
<blockquote>
<p>Nginx çš„åŠŸèƒ½å’Œ Gateway æœ‰ä»¥ä¸‹å‡ ä¸ªåŒºåˆ«ï¼š</p>
<ul>
<li>Nginx é€‚åˆåšé—¨æˆ·ç½‘å…³ï¼Œæ˜¯ä½œä¸ºæ•´ä¸ªå…¨å±€çš„ç½‘å…³ï¼Œå¯¹å¤–çš„å¤„äºæœ€å¤–å±‚çš„é‚£ç§ï¼›è€Œ Gateway å±äºä¸šåŠ¡ç½‘å…³ï¼Œä¸»è¦ç”¨æ¥å¯¹åº”ä¸åŒçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œç”¨äºèšåˆä¸šåŠ¡ã€‚å„å¾®æœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼ŒèŒè´£å•ä¸€ï¼Œå¯¹å¤–æä¾›æœåŠ¡çš„æ—¶å€™éœ€è¦æœ‰ä¸€ä¸ªä¸œè¥¿å°†ä¸šåŠ¡èšåˆèµ·æ¥ï¼›</li>
<li>Gateway å¯ä»¥å®ç°ç†”æ–­ã€é‡è¯•ç­‰åŠŸèƒ½ï¼Œè¿™æ˜¯ Nginx ä¸å…·å¤‡çš„ã€‚</li>
</ul>
</blockquote>
<h3 id="kong">Kong </h3>
<p>Kong æ˜¯ Mashape æä¾›çš„ä¸€æ¬¾ API ç®¡ç†è½¯ä»¶ï¼Œæœ¬èº«æ˜¯åŸºäº Nginx + Lua çš„ï¼Œä½†æ¯” Nginx æä¾›äº†æ›´ä¸ºç®€å•çš„é…ç½®æ–¹å¼ï¼Œæ•°æ®é‡‡ç”¨äº† ApacheCassandra / PostgreSQL å­˜å‚¨ï¼Œå¹¶ä¸”æä¾›äº†ä¸€äº›ä¼˜ç§€çš„æ’ä»¶ï¼Œæ¯”å¦‚éªŒè¯ï¼Œæ—¥å¿—ï¼Œè°ƒç”¨é¢‘æ¬¡é™åˆ¶ç­‰ã€‚Kong éå¸¸è¯±äººçš„åœ°æ–¹å°±æ˜¯æä¾›äº†å¤§é‡çš„æ’ä»¶æ¥æ‰©å±•åº”ç”¨ï¼Œé€šè¿‡è®¾ç½®ä¸åŒçš„æ’ä»¶å¯ä»¥ä¸ºæœåŠ¡æä¾›å„ç§å¢å¼ºçš„åŠŸèƒ½ã€‚</p>
<blockquote>
<p>å®ƒå…·å¤‡ä»¥ä¸‹ä¼˜ç¼ºç‚¹ï¼š</p>
<ul>
<li><strong>ä¼˜ç‚¹ï¼š</strong> åŸºäº Nginx æ‰€ä»¥åœ¨æ€§èƒ½å’Œç¨³å®šæ€§æ–¹é¢ä¸ä¼šæœ‰é—®é¢˜ã€‚Kong ä½œä¸ºä¸€æ¬¾å•†ä¸šè½¯ä»¶ï¼Œåœ¨ Nginx ä¸Šåšäº†å¾ˆå¤šçš„æ‰©å±•æ€§å·¥ä½œï¼Œå¹¶ä¸”è¿˜æœ‰å¾ˆå¤šä»˜è´¹ä½¿ç”¨çš„å•†ä¸šæ’ä»¶ã€‚Kong æœ¬èº«ä¹Ÿæœ‰ä»˜è´¹çš„ä¼ä¸šç‰ˆï¼Œå…¶ä¸­åŒ…æ‹¬æŠ€æœ¯æ”¯æŒã€ä½¿ç”¨åŸ¹è®­æœåŠ¡ä»¥åŠ API åˆ†ææ’ä»¶ã€‚</li>
<li><strong>ç¼ºç‚¹ï¼š</strong> å¦‚æœä½ ä½¿ç”¨ Spring Cloud , Kong å¦‚ä½•ç»“åˆç›®å‰å·²æœ‰çš„æœåŠ¡æ²»ç†ä½“ç³»ï¼Ÿ</li>
</ul>
</blockquote>
<h3 id="traefik">Traefik </h3>
<p>Traefik æ˜¯ä¸€ä¸ªå¼€æºçš„ Go è¯­è¨€å¼€å‘çš„ï¼Œä¸ºäº†è®©å¾®æœåŠ¡éƒ¨ç½²æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£ HTTP åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚å®ƒæ”¯æŒå¤šç§åå°ï¼ˆDockerã€Swarmã€Kubernatesã€Marathonã€Mesosã€Consulã€Etcdã€Zookeeperã€BoltDBã€Rest API ç­‰ï¼‰æ¥è‡ªåŠ¨åŒ–ã€åŠ¨æ€çš„åº”ç”¨ä»–çš„é…ç½®æ–‡ä»¶è®¾ç½®ï¼ŒTraefik æ‹¥æœ‰ä¸€ä¸ªåŸºäº AngularJS ç¼–å†™çš„ç®€å•ç½‘ç«™ç•Œé¢ï¼Œæ”¯æŒ RestAPIï¼Œé…ç½®æ–‡ä»¶çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯è¿›ç¨‹ã€‚é«˜å¯ç”¨é›†ç¾¤æ¨¡å¼ç­‰ã€‚</p>
<blockquote>
<p>ç›¸æ¯” Spring Cloud å’Œ Kubernetes è€Œè¨€ï¼Œç›®å‰æ¯”è¾ƒé€‚åˆ Kubernetes ã€‚</p>
</blockquote>
<h3 id="springcloud-netflix-zuul">SpringCloud Netflix Zuul </h3>
<p>Zuul æ˜¯Netflix å…¬å¸å¼€æºçš„ä¸€ä¸ª API ç½‘å…³ç»„ä»¶ï¼ŒSpring Cloud å¯¹å…¶è¿›è¡ŒäºŒæ¬¡åŸºäº Spring Boot çš„æ³¨è§£å¼å°è£…åšåˆ°å¼€ç®±å³ç”¨ã€‚ç›®å‰æ¥è¯´ï¼Œç»“åˆ Spring Cloud æä¾›çš„æœåŠ¡æ²»ç†ä½“ç³»ï¼Œå¯ä»¥åšåˆ°è¯·æ±‚è½¬å‘ï¼Œæ ¹æ®é…ç½®æˆ–è€…é»˜è®¤çš„è·¯ç”±è§„åˆ™è¿›è¡Œè·¯ç”±å’Œè´Ÿè½½å‡è¡¡ï¼Œæ— ç¼é›†æˆ Hystrix ã€‚</p>
<blockquote>
<p>è™½ç„¶å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ Filter è¿‡æ»¤å™¨å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äº Zuul æœ¬èº«çš„æ¶‰åŠæ˜¯åŸºäº å•çº¿ç¨‹çš„æ¥æ”¶è¯·æ±‚å’Œè½¬å‘å¤„ç†ï¼Œæ˜¯é˜»å¡ IOï¼Œä¸æ”¯æŒé•¿è¿æ¥ã€‚ç›®å‰æ¥çœ‹ Zuul å°±æ˜¾å¾—å¾ˆé¸¡è‚‹ï¼Œéšç€ Zuul 2.x ç‰ˆæœ¬ä¸€è‡´è·³ç¥¨ ï¼ˆ2019å¹´5æœˆå‘å¸ƒäº† Zuul 2.0 ç‰ˆæœ¬ï¼‰ï¼ŒSpring Cloud ä¸ºäº†ä¿é™©èµ·è§ï¼Œæ¨å‡ºäº†è‡ªå·±çš„ Spring Cloud Gatewayã€‚</p>
</blockquote>
<p><span style="color:rgb(9, 148, 221)">å¤§æ„å°±æ˜¯ï¼šZuul å·²æ­»ï¼ŒSpring Cloud Gateway æ°¸ç”Ÿï¼ğŸ¶</span></p>
<h4 id="zuul-10">Zuul 1.0 </h4>
<img src="./assets/image-20241210234005117.png" alt="æ¶æ„å›¾" style="zoom:100%;">
<img src="./assets/image-20241210234107613.png" alt="æ ¸å¿ƒç±»å›¾" style="zoom:100%;">
<img src="./assets/image-20241210234215051.png" alt="æ¨¡å‹" style="zoom:95%;">
<h4 id="zuul-20">Zuul 2.0 </h4>
<p><img src="./assets/image-20241210234349976.png" alt="image-20241210234349976"></p>
<h3 id="springcloud-gateway">SpringCloud Gateway </h3>
<blockquote>
<p>åœ¨æ²¡æœ‰ç«¯å£çš„è·¯ç”±ä¸­å®šä¹‰çš„ URI çš„ HTTP å’Œ HTTPS URI çš„é»˜è®¤ç«¯å£å€¼åˆ†åˆ«ä¸º 80 å’Œ 443ã€‚</p>
</blockquote>
<p>Spring Cloud Gateway çš„å·¥ä½œåŸç†ï¼š</p>
<p><img src="./assets/image-20241210234610441.png" alt="image-20241210234610441"></p>
<p>å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚å¦‚æœç½‘å…³å¤„ç†ç¨‹åºæ˜ å°„ç¡®å®šè¯·æ±‚ä¸è·¯ç”±åŒ¹é…ï¼Œåˆ™ä¼šå°†å…¶å‘é€åˆ°ç½‘å…³ Web å¤„ç†ç¨‹åºã€‚æ­¤å¤„ç†ç¨‹åºé€šè¿‡ç‰¹å®šäºè¯·æ±‚çš„ç­›é€‰æ¡ä»¶é“¾è¿è¡Œè¯·æ±‚ã€‚è¿‡æ»¤å™¨è¢«è™šçº¿åˆ’åˆ†çš„åŸå› æ˜¯ filter å¯ä»¥åœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰å’Œä¹‹åè¿è¡Œ logicã€‚æ‰§è¡Œæ‰€æœ‰ â€œpreâ€ filter logicã€‚ç„¶åå‘å‡ºä»£ç†è¯·æ±‚ã€‚å‘å‡ºä»£ç†è¯·æ±‚åï¼Œå°†è¿è¡Œ â€œpostâ€ ç­›é€‰æ¡ä»¶é€»è¾‘ã€‚</p>
<h2 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡ </h2>
<p>ä¹‹å‰å»ºé‡å¤çš„å¾®æœåŠ¡é¡¹ç›®æ˜¯ä¸ºäº†æ¨¡æ‹Ÿåˆ†å¸ƒå¼å¤šæœºéƒ¨ç½²ï¼ŒéªŒè¯è´Ÿè½½å‡è¡¡ç­–ç•¥ç­‰ç›®çš„ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€å„ä½¿ç”¨ä¸€ä¸ªç»„ä»¶å³å¯ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬åŒæ ·æ²¿ç”¨å­¦ä¹  Eurekaã€Ribbonã€Feign ç­‰å¾®æœåŠ¡ç»„ä»¶æ—¶çš„é¡¹ç›®éª¨æ¶ï¼Œå‡†å¤‡ä»¥ä¸‹æœåŠ¡ï¼š</p>
<p><img src="./assets/image-20241210234932811.png" alt="image-20241210234932811"></p>
<p>ä¾æ¬¡å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼ˆä¸»ï¼‰ã€æœåŠ¡æä¾›è€…ï¼ˆä¸»ï¼‰ã€æœåŠ¡æ¶ˆè´¹è€…ï¼ˆä¸»ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æ³¨å†Œä¸­å¿ƒåˆ—è¡¨æœ‰ä¸‹åˆ—å‡ ä¸ªæœåŠ¡ï¼š</p>
<p><img src="./assets/image-20241210235612055.png" alt="image-20241210235612055"></p>
<h2 id="nginxå®ç°apiç½‘å…³">Nginxå®ç°APIç½‘å…³ </h2>
<h3 id="ä¸‹è½½å®‰è£…">ä¸‹è½½å®‰è£… </h3>
<p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦å‰å¾€ <a href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a> ä¸‹è½½ Nginx æœåŠ¡å™¨è½¯ä»¶ï¼š</p>
<p><img src="./assets/image-20241211154334985.png" alt="image-20241211154334985"></p>
<p>ä¸‹è½½å®Œæˆåè§£å‹åˆ°æŒ‡å®šè·¯å¾„ä¸‹ <span style="color:#ff6e00;">ï¼ˆä¸è¦æ”¾ä¸­æ–‡è·¯å¾„ä¸‹ï¼ï¼ï¼ï¼‰</span>ï¼š</p>
<img src="./assets/image-20241211154456228.png" alt="image-20241211154456228" style="zoom:95%;">
<p>åŒå‡»å¯åŠ¨  <code>nginx.exe</code>  ç¨‹åºï¼Œç„¶åè®¿é—® <a href="http://127.0.0.1:80/">http://127.0.0.1:80/</a> ï¼Œå¦‚æœå¯åŠ¨æˆåŠŸï¼Œé¡µé¢å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="./assets/image-20241211154724058.png" alt="image-20241211154724058"></p>
<p>æ‰“å¼€é…ç½®æ–‡ä»¶  <code>conf\nginx.conf</code>  ï¼Œé»˜è®¤é…ç½®å¦‚ä¸‹ï¼š</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>
events <span class="token punctuation">{</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
http <span class="token punctuation">{</span>
    include       mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>
    sendfile        on<span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>
    server <span class="token punctuation">{</span>
    	<span class="token comment"># ç›‘å¬ç«¯å£ 80</span>
        listen       <span class="token number">80</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
        
        <span class="token comment"># èµ„æºè·¯å¾„</span>
        location / <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
            index  index.html index.htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="é…ç½®è·¯ç”±è§„åˆ™">é…ç½®è·¯ç”±è§„åˆ™ </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>
events <span class="token punctuation">{</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
http <span class="token punctuation">{</span>
    include       mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>
    sendfile        on<span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>
    server <span class="token punctuation">{</span>
    	<span class="token comment"># ç›‘å¬ç«¯å£ 80</span>
        listen       <span class="token number">80</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
        
        <span class="token comment"># èµ„æºè·¯å¾„</span>
        location / <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
            index  index.html index.htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment"># è·¯ç”±åˆ° bettytsai-system æ¨¡å—</span>
        location /api-system/ <span class="token punctuation">{</span>
        	proxy_pass http://127.0.0.1:9000/<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># è·¯ç”±åˆ° bettytsai-demo æ¨¡å—</span>
        location /api-demo/ <span class="token punctuation">{</span>
        	proxy_pass http://127.0.0.1:9004/<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ Eureka ä¸­æ³¨å†Œçš„æœåŠ¡åˆ—è¡¨ï¼Œå½“æˆ‘ä»¬è®¿é—®  <code>/api-system</code>  çš„æ—¶å€™ï¼Œå°±å°†å®ƒè·¯ç”±åˆ°  <code>http://127.0.0.1/9000/</code> ã€‚åŒæ ·çš„ï¼Œå½“æˆ‘ä»¬è®¿é—®  <code>/api-demo</code> çš„æ—¶å€™ï¼Œè·¯ç”±åˆ°  <code>http://127.0.0.1:9004/</code> ã€‚</p>
<p><img src="./assets/image-20241211160333850.png" alt="image-20241211160333850"></p>
<p>åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­å…³é—­ nginx è¿›ç¨‹åå†æ¬¡é‡å¯ï¼Œä»¥è®©é…ç½®æ–‡ä»¶ç”Ÿæ•ˆåï¼Œè®¿é—® <a href="http://127.0.0.1/api-system/system/getDefaultString">http://127.0.0.1/api-system/system/getDefaultString</a>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼ŒæˆåŠŸè®¿é—® bettytsai-system æ¨¡å—çš„æœåŠ¡ï¼Œè¯´æ˜è·¯ç”±è½¬å‘æˆåŠŸäº†ã€‚</p>
<p><img src="./assets/image-20241211162411471.png" alt="image-20241211162411471"></p>
<h2 id="gatewayæ ¸å¿ƒæ¦‚å¿µ">Gatewayæ ¸å¿ƒæ¦‚å¿µ </h2>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.spring.io/spring-cloud-gateway/docs/3.1.4/reference/html/">https://docs.spring.io/spring-cloud-gateway/docs/3.1.4/reference/html/</a></p>
</blockquote>
<h3 id="æ ¸å¿ƒæ¦‚å¿µ">æ ¸å¿ƒæ¦‚å¿µ </h3>
<p><strong>è·¯ç”±</strong> ï¼šè·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯ç”± IDã€ç›®æ ‡ URL ã€ä¸€ç»„æ–­è¨€å’Œä¸€ç»„è¿‡æ»¤å™¨ç»„æˆã€‚å¦‚æœæ–­è¨€è·¯ç”±ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚ URL å’Œé…ç½®åŒ¹é…ã€‚</p>
<p><strong>æ–­è¨€ï¼ˆPredicateï¼‰</strong> ï¼šJDK 8 å¼•å…¥çš„æ–­è¨€å‡½æ•°ã€‚SpringCloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯ Spring 5.0 ä¸­çš„  <code>ServerWebExchange</code> ã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é…æ¥è‡ª Http Request ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚</p>
<p><strong>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰</strong> : ä¸€ä¸ªæ ‡å‡†çš„ Spring Web è¿‡æ»¤å™¨ã€‚Spring Cloud Gateway ä¸­çš„è¿‡æ»¤å™¨åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ Gateway Filter å’Œ Global Filterã€‚è¿‡æ»¤å™¨ä¼šå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œå¤„ç†ã€‚</p>
<blockquote>
<p>Spring å®˜æ–¹è¯´æ˜ï¼š</p>
<ul>
<li>è·¯ç”±ï¼ˆRouteï¼‰ï¼šç½‘å…³çš„åŸºæœ¬æ„å»ºå—ã€‚å®ƒç”± IDã€ç›®æ ‡ URIã€è°“è¯é›†åˆå’Œè¿‡æ»¤å™¨é›†åˆå®šä¹‰ã€‚å¦‚æœèšåˆè°“è¯ä¸º trueï¼Œåˆ™åŒ¹é…è·¯ç”±ï¼›</li>
<li>æ–­è¨€ï¼ˆPredicateï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ª Java 8 Function Predicateã€‚input ç±»å‹æ˜¯ Spring æ¡†æ¶çš„ ServerWebExchangeã€‚è¿™æ ·ï¼Œæ‚¨å°±å¯ä»¥åŒ¹é… HTTP è¯·æ±‚ä¸­çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚æ ‡å¤´æˆ–å‚æ•°ï¼›</li>
<li>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ï¼šè¿™äº›æ˜¯ä½¿ç”¨ç‰¹å®šå·¥å‚æ„å»ºçš„ GatewayFilter å®ä¾‹ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥åœ¨å‘é€ä¸‹æ¸¸è¯·æ±‚ä¹‹å‰æˆ–ä¹‹åä¿®æ”¹è¯·æ±‚å’Œå“åº”ï¼›</li>
</ul>
</blockquote>
<h2 id="gatewayå·¥ä½œåŸç†">Gatewayå·¥ä½œåŸç† </h2>
<blockquote>
<p>åœ¨æ²¡æœ‰ç«¯å£çš„è·¯ç”±ä¸­å®šä¹‰çš„ URI çš„ HTTP å’Œ HTTPS URI çš„é»˜è®¤ç«¯å£å€¼åˆ†åˆ«ä¸º 80 å’Œ 443ã€‚</p>
</blockquote>
<p>ä¸‹å›¾ç®€è¦æ¦‚è¿°äº† Spring Cloud ç½‘å…³çš„å·¥ä½œåŸç†ï¼š</p>
<p><img src="./assets/image-20241211170513468.png" alt="image-20241211170513468"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®¢æˆ·ç«¯å‘  <em>Spring Cloud Gateway  ç½‘å…³</em> å‘å‡ºè¯·æ±‚ã€‚å¦‚æœç½‘å…³å¤„ç†ç¨‹åºæ˜ å°„*ï¼ˆGateway Handler Mappingï¼‰<em>ç¡®å®šè¯·æ±‚ä¸è·¯ç”±åŒ¹é…ï¼Œåˆ™ä¼šå°†å…¶å‘é€åˆ°ç½‘å…³ Web å¤„ç†ç¨‹åº</em>ï¼ˆGateway Web Handlerï¼‰<em>ã€‚æ­¤å¤„ç†ç¨‹åºé€šè¿‡ç‰¹å®šäºè¯·æ±‚çš„ç­›é€‰æ¡ä»¶é“¾</em>ï¼ˆè¿‡æ»¤å™¨é“¾ï¼‰*è¿è¡Œè¯·æ±‚ã€‚è¿‡æ»¤å™¨è¢«è™šçº¿åˆ’åˆ†çš„åŸå› æ˜¯è¿‡æ»¤å™¨å¯ä»¥åœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰å’Œä¹‹åè¿è¡Œã€‚æ‰§è¡Œæ‰€æœ‰ â€œpreâ€ å‰ç½®è¿‡æ»¤å™¨é€»è¾‘ï¼Œç„¶åå‘å‡ºä»£ç†è¯·æ±‚ã€‚å‘å‡ºä»£ç†è¯·æ±‚åï¼Œå°†è¿è¡Œ â€œpostâ€ è¿‡æ»¤å™¨é€»è¾‘ã€‚</p>
<h2 id="gatewayå®ç°apiç½‘å…³å…¥é—¨æ¡ˆä¾‹">Gatewayå®ç°APIç½‘å…³å…¥é—¨æ¡ˆä¾‹ </h2>
<h3 id="åˆ›å»ºé¡¹ç›®">åˆ›å»ºé¡¹ç›® </h3>
<p>åˆ›å»º bettytsai-gateway-master ç½‘å…³é¡¹ç›®ï¼š</p>
<p><img src="./assets/image-20241220160507623-17346819094621.png" alt="image-20241220160507623"></p>
<p>ç„¶åæˆ‘ä»¬æ·»åŠ ä¾èµ–  <code>spring-cloud-starter-gateway</code>  ç»„ä»¶ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token comment">&lt;!--æ—¥å¿—--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--æˆ‘è‡ªå·±å°è£…çš„ç»„ä»¶åº“--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tsaiframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tsai-spring-boot-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classifier</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classifier</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--eureka--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.inject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.inject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--ç½‘å…³--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>ä¾æ¬¡å¯åŠ¨ Eureka æ³¨å†Œä¸­å¿ƒé¡¹ç›®ã€ç½‘å…³ã€æœåŠ¡æä¾›è€…ï¼Œæ‰“å¼€æ³¨å†Œä¸­å¿ƒé¡µé¢æ£€æŸ¥ç½‘å…³æ˜¯å¦æ­£ç¡®çš„æ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒï¼š</p>
<p><img src="./assets/image-20241220162926504.png" alt="image-20241220162926504"></p>
<p>é‚£ç°åœ¨æˆ‘ä»¬è®¿é—® system æ¨¡å—æä¾›çš„æµ‹è¯•æ¥å£  <a href="http://127.0.0.1:9000/system/getDefaultString">http://127.0.0.1:9000/system/getDefaultString</a>  ï¼Œè¿”å›ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="./assets/image-20241220164651512.png" alt="image-20241220164651512"></p>
<h3 id="é…ç½®è·¯ç”±è§„åˆ™-1">é…ç½®è·¯ç”±è§„åˆ™ </h3>
<p><span style="color:#F47023">åœ¨ä¸Šé¢æˆ‘ä»¬é€šè¿‡ Nginx å®ç°çš„ API ç½‘å…³åŠŸèƒ½å¦‚ä½•é€šè¿‡ Spring Cloud Gateway å®ç°å‘¢ï¼Ÿ</span>åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦é€šè¿‡é…ç½®ç›¸åº”çš„è·¯ç”±è§„åˆ™å°†è¯·æ±‚é€šè¿‡ç½‘å…³åˆ†å‘åˆ°å…·ä½“çš„å¾®æœåŠ¡åº”ç”¨ä¸­å»ã€‚ä¸‹é¢æˆ‘ä»¬é…ç½®ä¸€ä¸ªæœ€åŸºç¡€çš„å…¥é—¨çš„è·¯ç”±è§„åˆ™å»å®ç°ï¼š</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
          <span class="token comment"># è·¯ç”±IDï¼Œå”¯ä¸€</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9000/
          <span class="token comment"># æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…å¯¹åº”URLçš„è¯·æ±‚ï¼Œå°†åŒ¹é…åˆ°çš„è¯·æ±‚è¿½åŠ åˆ°ç›®æ ‡URIä¹‹å</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
</code></pre><p>é…ç½®å®Œæˆåï¼Œé‡å¯ç½‘å…³æœåŠ¡ï¼Œè¿™æ—¶å€™è¯·æ±‚  <a href="http://127.0.0.1:30000/system/getDefaultString">http://127.0.0.1:30000/system/getDefaultString</a> å°†ä¼šè·¯ç”±åˆ° <a href="http://127.0.0.1:9000/system/getDefaultString%EF%BC%8C%E5%85%B7%E4%BD%93%E8%AF%B7%E6%B1%82%E6%83%85%E5%86%B5%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9000/system/getDefaultStringï¼Œå…·ä½“è¯·æ±‚æƒ…å†µå¦‚ä¸‹ï¼š</a></p>
<p><img src="./assets/image-20241220165717376-17346850384622.png" alt="image-20241220165717376"></p>
<h2 id="è·¯ç”±è§„åˆ™">è·¯ç”±è§„åˆ™ </h2>
<p>Spring Cloud Gateway åˆ›å»º Route å¯¹è±¡æ—¶ï¼Œä½¿ç”¨ RoutePredicateFactory åˆ›å»º Predicate å¯¹è±¡ï¼ŒPredicate å¯¹è±¡å¯ä»¥èµ‹å€¼ç»™ Route ã€‚</p>
<ul>
<li>Spring Cloud Gateway åŒ…å«è®¸å¤šå†…ç½®çš„ Route Predicate Factoriesã€‚</li>
<li>æ‰€æœ‰è¿™äº›æ–­è¨€éƒ½åŒ¹é… HTTP è¯·æ±‚çš„ä¸åŒå±æ€§ã€‚</li>
<li>å¤šä¸ª Route Predicate Factories å¯ä»¥é€šè¿‡é€»è¾‘ä¸ï¼ˆandï¼‰ ç»“åˆèµ·æ¥ä¸€èµ·ä½¿ç”¨ã€‚</li>
</ul>
<p>è·¯ç”±æ–­è¨€å·¥å‚ RoutePredicateFactory åŒ…å«çš„ä¸»è¦å®ç°ç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼ŒåŒ…æ‹¬ Datetime ã€è¯·æ±‚çš„è¿œç«¯åœ°å€ã€è·¯ç”±æƒé‡ã€è¯·æ±‚å¤´ã€Hoståœ°å€ã€è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚è·¯å¾„å’Œè¯·æ±‚å‚æ•°ç­‰ç±»å‹çš„è·¯ç”±æ–­è¨€ã€‚</p>
<p><img src="./assets/image-20241220170335337.png" alt="image-20241220170335337"></p>
<h3 id="path">Path </h3>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">output</span><span class="token punctuation">:</span>
    <span class="token key atrule">ansi</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> always
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token comment"># æ˜¯å¦å¯ç”¨é…ç½®æ•°æ®å¤„ç†æ—§æ¨¡å¼</span>
    <span class="token key atrule">use-legacy-processing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># è·¯ç”±è§„åˆ™</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
          <span class="token comment"># è·¯ç”±IDï¼Œå”¯ä¸€</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9000/
          <span class="token comment"># æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…å¯¹åº”URLçš„è¯·æ±‚ï¼Œå°†åŒ¹é…åˆ°çš„è¯·æ±‚è¿½åŠ åˆ°ç›®æ ‡URIä¹‹å</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
</code></pre><p>âœ¨ è¯·æ±‚&nbsp; <code>http://127.0.0.1:30000/system/getDefaultString</code> &nbsp;å°†ä¼šè·¯ç”±åˆ°  <code>http://127.0.0.1:9000/system/getDefaultString</code> ã€‚</p>
<h3 id="query">Query </h3>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># è·¯ç”±è§„åˆ™</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
          <span class="token comment"># è·¯ç”±IDï¼Œå”¯ä¸€</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9000/
          <span class="token comment"># æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token çš„è¯·æ±‚</span>
            <span class="token comment">#- Query=token</span>
            <span class="token comment"># åŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token å¹¶ä¸”å…¶å‚æ•°å€¼æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼ abcd. çš„è¯·æ±‚</span>
            <span class="token punctuation">-</span> Query=token<span class="token punctuation">,</span>abcd.
</code></pre><p>é…ç½®è·¯ç”±è§„åˆ™  <code>Query=token</code>  ï¼ŒåŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œå…·ä½“å¯¹æ¯”å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241220172238970.png" alt="image-20241220172238970"></p>
<p>é…ç½®è·¯ç”±è§„åˆ™  <code>Query=token,abcd.</code>  ï¼ŒåŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token å¹¶ä¸”å…¶å‚æ•°å€¼æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼  <code>abcd. </code>  çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œå…·ä½“å¯¹æ¯”å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241220172533489-17351897315271.png" alt="image-20241220172533489"></p>
<h3 id="method">Method </h3>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># è·¯ç”±è§„åˆ™</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
          <span class="token comment"># è·¯ç”±IDï¼Œå”¯ä¸€</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9000/
          <span class="token comment"># æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…ä»»æ„ GET è¯·æ±‚</span>
            <span class="token punctuation">-</span> Method=GET
</code></pre><p>é‡å¯ç½‘å…³æœåŠ¡ï¼Œç„¶åæˆ‘ä»¬ç»è¿‡æµ‹è¯•ï¼Œå…·ä½“è°ƒç”¨æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="./assets/image-20241220235052510-17351897358732.png" alt="image-20241220235052510"></p>
<h3 id="datetime">Datetime </h3>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># è·¯ç”±è§„åˆ™</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
          <span class="token comment"># è·¯ç”±IDï¼Œå”¯ä¸€</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9000/
          <span class="token comment"># æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…ä¸­å›½ä¸Šæµ·æ—¶é—´ 2024-12-21 00:00:00 ä¹‹åçš„è¯·æ±‚</span>
            <span class="token punctuation">-</span> After=2024<span class="token punctuation">-</span>12<span class="token punctuation">-</span>21T00<span class="token punctuation">:</span>00<span class="token punctuation">:</span>00.000+00<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre><p>é‡å¯ç½‘å…³æœåŠ¡ï¼Œä¸Šé¢çš„æµ‹è¯•æ—¶é—´ï¼Œä½ å¯ä»¥æ‰¾ä¸ªæ—¶é—´ç‚¹è¿›è¡Œæµ‹è¯•ã€‚ç»è¿‡éªŒè¯ï¼Œæˆ‘ä»¬è¯·æ±‚çš„å…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241221000111262.png" alt="image-20241221000111262"></p>
<h3 id="pxoteaddr">pxoteAddr </h3>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># è·¯ç”±è§„åˆ™</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
          <span class="token comment"># è·¯ç”±IDï¼Œå”¯ä¸€</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9000/
          <span class="token comment"># æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…æ¥è‡ªè¿œç¨‹åœ°å€ä¸º 192.168.100.101/0 çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œ0ä¸ºå­ç½‘æ©ç </span>
            <span class="token punctuation">-</span> pxoteAddr=192.168.100.101/0
</code></pre><p>ç›®å‰æˆ‘æ‰€ä½¿ç”¨çš„ç”µè„‘å½“æ—¶çš„ç½‘ç»œé…ç½®å¦‚ä¸‹ï¼Œæ‰€ä»¥  <code>pxoteAddr=192.168.100.101/0</code>  è¡¨ç¤ºåŒ¹é…æ¥è‡ªè¿œç¨‹åœ°å€ä¸º 192.168.100.101/0 çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œ0ä¸ºå­ç½‘æ©ç </p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>Windows IP é…ç½®
æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ æœ¬åœ°è¿æ¥* <span class="token number">1</span>:
   åª’ä½“çŠ¶æ€  <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> åª’ä½“å·²æ–­å¼€è¿æ¥
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ æœ¬åœ°è¿æ¥* <span class="token number">2</span>:
   åª’ä½“çŠ¶æ€  <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> åª’ä½“å·²æ–­å¼€è¿æ¥
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
ä»¥å¤ªç½‘é€‚é…å™¨ VMware Network Adapter VMnet1:
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> fe80::db14:99b3:a49a:2170%7
   IPv4 åœ°å€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> <span class="token number">192.168</span>.9.1
   å­ç½‘æ©ç   <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> <span class="token number">255.255</span>.255.0
   é»˜è®¤ç½‘å…³. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
ä»¥å¤ªç½‘é€‚é…å™¨ VMware Network Adapter VMnet8:
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> fe80::2df4:f368:1b8e:87b4%5
   IPv4 åœ°å€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> <span class="token number">192.168</span>.56.1
   å­ç½‘æ©ç   <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> <span class="token number">255.255</span>.255.0
   é»˜è®¤ç½‘å…³. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ WLAN:
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
   IPv6 åœ°å€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> 240e:878:b21:4dee:5ea6:9dc4:c7b9:2ba1
   ä¸´æ—¶ IPv6 åœ°å€. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> 240e:878:b21:4dee:8dfc:2efc:830d:f7a3
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> fe80::58cf:8c88:7ef6:8a19%28
   IPv4 åœ°å€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> <span class="token number">192.168</span>.100.101
   å­ç½‘æ©ç   <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> <span class="token number">255.255</span>.255.0
   é»˜è®¤ç½‘å…³. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> fe80::d49c:d1ff:fe4f:40c6%28
                                       <span class="token number">192.168</span>.100.1
ä»¥å¤ªç½‘é€‚é…å™¨ è“ç‰™ç½‘ç»œè¿æ¥:
   åª’ä½“çŠ¶æ€  <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> åª’ä½“å·²æ–­å¼€è¿æ¥
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
ä»¥å¤ªç½‘é€‚é…å™¨ vEthernet <span class="token punctuation">(</span>Default Switch<span class="token punctuation">)</span>:
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> fe80::32b2:c0c6:87ff:664e%31
   IPv4 åœ°å€ <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> <span class="token number">172.25</span>.112.1
   å­ç½‘æ©ç   <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span> <span class="token number">255.255</span>.240.0
   é»˜è®¤ç½‘å…³. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">:</span>
</code></pre><p>ç»è¿‡éªŒè¯ï¼Œå…·ä½“è¯·æ±‚æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="./assets/image-20241223142716133.png" alt="image-20241223142716133"></p>
<h3 id="header">Header </h3>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># è·¯ç”±è§„åˆ™</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
          <span class="token comment"># è·¯ç”±IDï¼Œå”¯ä¸€</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9000/
          <span class="token comment"># æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…è¯·æ±‚å¤´åŒ…å« X-Request-Id å¹¶ä¸”å®ƒçš„å€¼ä¸º \d+ ï¼ˆæ­£åˆ™ï¼šä»»æ„æ•°å€¼ï¼‰ çš„è¯·æ±‚</span>
            <span class="token punctuation">-</span> Header=X<span class="token punctuation">-</span>Request<span class="token punctuation">-</span>Id<span class="token punctuation">,</span> \d+
</code></pre><p><code>Header=X-Request-Id, \d+</code>  è¡¨ç¤ºåŒ¹é…è¯·æ±‚å¤´åŒ…å« X-Request-Id å¹¶ä¸”å®ƒçš„å€¼ä¸º \d+ ï¼ˆæ­£åˆ™ï¼šä»»æ„æ•°å€¼ï¼‰ çš„è¯·æ±‚ï¼Œå…·ä½“è¯·æ±‚æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="./assets/image-20241223143403071.png" alt="image-20241223143403071"></p>
<h2 id="åŠ¨æ€è·¯ç”±æœåŠ¡å‘ç°çš„è·¯ç”±è§„åˆ™">åŠ¨æ€è·¯ç”±ï¼ˆæœåŠ¡å‘ç°çš„è·¯ç”±è§„åˆ™ï¼‰ </h2>
<p>åŠ¨æ€è·¯ç”±å…¶å®å°±æ˜¯é¢å‘æœåŠ¡çš„è·¯ç”±ï¼ŒSpring Cloud Gateway æ”¯æŒä¸Eureka æ•´åˆå¼€å‘ï¼Œæ ¹æ® serviceId è‡ªåŠ¨ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åœ°å€å¹¶è½¬å‘è¯·æ±‚ï¼Œè¿™æ ·åšçš„å¥½å¤„ä¸ä»…å¯ä»¥é€šè¿‡å•ä¸ªç«¯ç‚¹æ¥è®¿é—®åº”ç”¨çš„æ‰€æœ‰æœåŠ¡ï¼Œè€Œä¸”åœ¨æ·»åŠ å’Œç§»é™¤æœåŠ¡å®ä¾‹æ—¶ä¸ç”¨ä¿®æ”¹ Gateway çš„è·¯ç”±é…ç½®ã€‚</p>
<h3 id="æ·»åŠ ä¾èµ–">æ·»åŠ ä¾èµ– </h3>
<blockquote>
<p>åœ¨å…¥é—¨æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å…¶å®å·²ç»æ·»åŠ è¿‡ netflix-eureka-client ä¾èµ–ï¼Œä½†æ˜¯å¹¶ä¸å½±å“æˆ‘ä»¬çš„å®è·µè¿‡ç¨‹ã€‚</p>
</blockquote>
<p>ä¸ºäº†å®ç°åŠ¨æ€è·¯ç”±ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ç»“åˆ Eureka æ¥å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ  Eureka çš„ä¾èµ–ï¼š</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token comment">&lt;!--netflix eureka client--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--è¿™ä¸ªæ˜¯å› ä¸ºæˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬ç¼ºå¤±è¯¥ç»„ä»¶ï¼Œè¯·è‡ªè¡Œåˆ¤æ–­æ˜¯å¦æ·»åŠ --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.inject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.inject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="åŠ¨æ€è·å–-uri">åŠ¨æ€è·å– URI </h3>
<h4 id="ä¸Šä¸‹æ–‡é…ç½®">ä¸Šä¸‹æ–‡é…ç½® </h4>
<p>é…ç½®æ³¨å†Œä¸­å¿ƒåŠåŠ¨æ€è·¯ç”±è§„åˆ™ï¼š</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">30000</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># è·¯ç”±è§„åˆ™</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
          <span class="token comment"># è·¯ç”±IDï¼Œå”¯ä¸€</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€</span>
          <span class="token comment">#uri: http://127.0.0.1:9000/</span>
          <span class="token comment"># lb:// æ ¹æ®æœåŠ¡åç§°ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡è¯·æ±‚åœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token comment"># æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment"># åŒ¹é…å¯¹åº”URLçš„è¯·æ±‚ï¼Œå°†åŒ¹é…åˆ°çš„è¯·æ±‚è¿½åŠ åˆ°ç›®æ ‡URIä¹‹å</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
            <span class="token comment"># åŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token çš„è¯·æ±‚</span>
            <span class="token comment">#- Query=token</span>
            <span class="token comment"># åŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token å¹¶ä¸”å…¶å‚æ•°å€¼æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼ abcd. çš„è¯·æ±‚</span>
            <span class="token comment">#- Query=token,abcd.</span>
            <span class="token comment"># åŒ¹é…ä»»æ„ GET è¯·æ±‚</span>
            <span class="token comment">#- Method=GET</span>
            <span class="token comment"># åŒ¹é…ä¸­å›½ä¸Šæµ·æ—¶é—´ 2024-12-21 00:00:00 ä¹‹åçš„è¯·æ±‚</span>
            <span class="token comment">#- After=2024-12-21T00:00:00.000+00:00[Asia/Shanghai]</span>
            <span class="token comment"># åŒ¹é…æ¥è‡ªè¿œç¨‹åœ°å€ä¸º 192.168.100.101/0 çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œ0ä¸ºå­ç½‘æ©ç </span>
            <span class="token comment">#- pxoteAddr=192.168.100.101/0</span>
            <span class="token comment"># åŒ¹é…è¯·æ±‚å¤´åŒ…å« X-Request-Id å¹¶ä¸”å®ƒçš„å€¼ä¸º \d+ ï¼ˆæ­£åˆ™ï¼šä»»æ„æ•°å€¼ï¼‰ çš„è¯·æ±‚</span>
            <span class="token comment">#- Header=X-Request-Id, \d+</span>

<span class="token comment"># é…ç½®æ³¨å†Œä¸­å¿ƒ</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># æŒ‡ç¤ºä» eureka æœåŠ¡å™¨è·å–æ³¨å†Œè¡¨ä¿¡æ¯çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚</span>
    <span class="token comment"># æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚</span>
    <span class="token comment"># é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</span>
    <span class="token comment"># ç¤ºä¾‹ï¼šhttps://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># è·å–è¦å‘ eureka æ³¨å†Œçš„æ­¤å®ä¾‹çš„å”¯ä¸€ IDï¼ˆåœ¨ appName èŒƒå›´å†…ï¼‰</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># æŒ‡ç¤º eureka å®¢æˆ·ç«¯éœ€è¦å‘ eureka æœåŠ¡å™¨å‘é€å¿ƒè·³ä»¥æŒ‡ç¤ºå®ƒä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</span>
    <span class="token comment"># å¦‚æœåœ¨ leaseExpirationDurationInSeconds ä¸­æŒ‡å®šçš„æ—¶é—´æ®µå†…æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ eureka æœåŠ¡å™¨å°†ä»å…¶è§†å›¾ä¸­åˆ é™¤è¯¥å®ä¾‹ï¼Œ</span>
    <span class="token comment"># ä»è€Œç¦æ­¢æµå‘æ­¤å®ä¾‹çš„æµé‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœå®ä¾‹å®ç° HealthCheckCallbackï¼Œç„¶åå†³å®šä½¿è‡ªèº«ä¸å¯ç”¨ï¼Œåˆ™å®ä¾‹ä»ç„¶æ— æ³•è·å–æµé‡ã€‚</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># å¿…é¡»ä¸Dockerå®¹å™¨åä¿æŒä¸€è‡´</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
</code></pre><h4 id="å¯åŠ¨ç±»">å¯åŠ¨ç±» </h4>
<p>ä¿®æ”¹æˆ‘ä»¬å¯åŠ¨ç±»ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">GatewayMasterApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayMasterApplication</span><span class="token punctuation">.</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Environment</span> environment <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> port <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">":::Gateway ç½‘å…³æœåŠ¡ï¼ˆä¸»æœåŠ¡ï¼‰å¯åŠ¨æˆåŠŸ....ç«¯å£å·::: %s"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>é‡å¯ç½‘å…³æœåŠ¡ï¼Œæ‰“å¼€ Eureka æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œæ£€æŸ¥ç½‘å…³æ˜¯å¦æˆåŠŸæ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒï¼š</p>
<p><img src="./assets/image-20241223145154305.png" alt="image-20241223145154305"></p>
<p>é€šè¿‡ Postman éªŒè¯æˆ‘ä»¬çš„è¯·æ±‚èƒ½å¦é€šè¿‡ç½‘å…³è¿›è¡Œè½¬å‘ï¼š</p>
<p><img src="./assets/image-20241223145236714.png" alt="image-20241223145236714"></p>
<h3 id="æœåŠ¡åç§°è½¬å‘">æœåŠ¡åç§°è½¬å‘ </h3>
<p>åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬æåˆ°é€šè¿‡  <code>lb:// </code>  æ ¹æ®æœåŠ¡åç§°ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡è¯·æ±‚åœ°å€çš„æ–¹å¼ï¼Œåœ¨å¾®æœåŠ¡å®ä¾‹å¢å‡çš„æ—¶å€™ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨çš„å»æ·»åŠ é…ç½®ï¼Œè¿˜æ˜¯å¾ˆä¸æ–¹ä¾¿çš„ï¼Œé‚£æˆ‘ä»¬è¿˜æ˜¯è¦å†™å¾ˆå¤šè·¯ç”±è§„åˆ™ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯éµå¾ª çº¦å®šå¤§äºé…ç½® çš„è§„åˆ™å»å®ç°é€šè¿‡æœåŠ¡åç§°è¿›è¡Œè½¬å‘çš„è·¯ç”±ã€‚</p>
<h4 id="ä¸Šä¸‹æ–‡é…ç½®-1">ä¸Šä¸‹æ–‡é…ç½® </h4>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">30000</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># æŒ‡ç¤ºä» eureka æœåŠ¡å™¨è·å–æ³¨å†Œè¡¨ä¿¡æ¯çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚</span>
    <span class="token comment"># æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚</span>
    <span class="token comment"># é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</span>
    <span class="token comment"># ç¤ºä¾‹ï¼šhttps://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># è·å–è¦å‘ eureka æ³¨å†Œçš„æ­¤å®ä¾‹çš„å”¯ä¸€ IDï¼ˆåœ¨ appName èŒƒå›´å†…ï¼‰</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># æŒ‡ç¤º eureka å®¢æˆ·ç«¯éœ€è¦å‘ eureka æœåŠ¡å™¨å‘é€å¿ƒè·³ä»¥æŒ‡ç¤ºå®ƒä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</span>
    <span class="token comment"># å¦‚æœåœ¨ leaseExpirationDurationInSeconds ä¸­æŒ‡å®šçš„æ—¶é—´æ®µå†…æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ eureka æœåŠ¡å™¨å°†ä»å…¶è§†å›¾ä¸­åˆ é™¤è¯¥å®ä¾‹ï¼Œ</span>
    <span class="token comment"># ä»è€Œç¦æ­¢æµå‘æ­¤å®ä¾‹çš„æµé‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœå®ä¾‹å®ç° HealthCheckCallbackï¼Œç„¶åå†³å®šä½¿è‡ªèº«ä¸å¯ç”¨ï¼Œåˆ™å®ä¾‹ä»ç„¶æ— æ³•è·å–æµé‡ã€‚</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># å¿…é¡»ä¸Dockerå®¹å™¨åä¿æŒä¸€è‡´</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
</code></pre><h4 id="å¯åŠ¨ç±»-1">å¯åŠ¨ç±» </h4>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">GatewayMasterApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayMasterApplication</span><span class="token punctuation">.</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Environment</span> environment <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> port <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">":::Gateway ç½‘å…³æœåŠ¡ï¼ˆä¸»æœåŠ¡ï¼‰å¯åŠ¨æˆåŠŸ....ç«¯å£å·::: %s"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>é‡æ–°å¯åŠ¨æˆ‘ä»¬çš„ç½‘å…³æœåŠ¡ï¼Œæˆ‘ä»¬å†é€šè¿‡ Postman éªŒè¯ä¸‹æˆ‘ä»¬çš„æœåŠ¡æ˜¯å¦å¯ç”¨ï¼š</p>
<p><img src="./assets/image-20241223150332692.png" alt="image-20241223150332692"></p>
<p>å¿ƒç»†çš„äººå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬è¯·æ±‚åœ°å€å‰å¤šäº†ä¸€æ®µ  <code>/bettytsai-system</code>  è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ï¼Œçº¦å®šå¤§äºé…ç½®ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å®ç°  <code>RouteDefinitionRepository </code> æ¥å£ï¼Œå°†è·¯ç”±å­˜åœ¨æ•°æ®åº“ä¸­ï¼ŒåŠ¨æ€çš„è·å–å¹¶ä¸”æ›´æ–°è·¯ç”±ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªåŠ¨æ€è·å–è·¯ç”±çš„ç¤ºä¾‹ä»£ç ï¼ˆéæ•°æ®åº“ï¼‰ï¼š</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">GatewayRoutesConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">routeLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RouteLocatorBuilder<span class="token punctuation">.</span>Builder</span> build <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> serviceIds <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> serviceId <span class="token operator">:</span> serviceIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> id <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">lowerCase</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                build<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> route <span class="token operator">-&gt;</span> route<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"lb://"</span><span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> build<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šä¸‹æ–‡é…ç½®ä¸­åªéœ€è¦æ·»åŠ ï¼š</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><p>å¼€å¯ Eureka è´Ÿè½½å‡è¡¡é…ç½®ï¼Œä½†è¿™æ ·ä»ç„¶å­˜åœ¨å¼Šç«¯ï¼Œæ¯å½“æœåŠ¡åˆ å‡æ—¶ï¼Œéœ€è¦é‡å¯ç½‘å…³æœåŠ¡å·²æ›´æ–°è·¯ç”±ã€‚å…³äºå¦‚ä½•ç»“åˆæ•°æ®åº“æ¥é…ç½®è·¯ç”±ï¼Œè¯·è‡ªè¡ŒæŸ¥æ‰¾èµ„æ–™ã€‚</p>
<h2 id="è¿‡æ»¤å™¨">è¿‡æ»¤å™¨ </h2>
<p>Spring Cloud Gateway æ ¹æ®ä½œç”¨èŒƒå›´åˆ’åˆ†ä¸º  <code>GatewayFilter</code>  å’Œ  <code>GlobalFilter</code> ï¼ŒäºŒè€…åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>GatewayFilter</code> ï¼šç½‘å…³è¿‡æ»¤å™¨ï¼Œéœ€è¦é€šè¿‡  <code>spring.cloud.routes.filters</code>  é…ç½®åœ¨å…·ä½“è·¯ç”±ä¸‹ï¼Œåªä½œç”¨åœ¨å½“å‰è·¯ç”±æˆ–é€šè¿‡  <code>spring.cloud.default-filters</code>  é…ç½®åœ¨å…¨å±€ï¼Œä½œç”¨åœ¨æ‰€æœ‰è·¯ç”±ä¸Šã€‚</li>
<li><code>GlobalFilter</code> ï¼šå…¨å±€è¿‡æ»¤å™¨ï¼Œä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œä½œç”¨åœ¨æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œæœ€ç»ˆé€šè¿‡  <code>GatewayFilterAdapter</code>  åŒ…è£…æˆ  <code>GatewayFilterChain</code>  å¯è¯†åˆ«çš„è¿‡æ»¤å™¨ï¼Œå®ƒä¸ºè¯·æ±‚ä¸šåŠ¡ä»¥åŠè·¯ç”±çš„ URI è½¬æ¢ä¸ºçœŸå®ä¸šåŠ¡æœåŠ¡è¯·æ±‚åœ°å€çš„æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œä¸éœ€è¦é…ç½®ç³»ç»Ÿåˆå§‹åŒ–æ—¶åŠ è½½ï¼Œå¹¶ä½œç”¨åœ¨æ¯ä¸ªè·¯ç”±ä¸Šã€‚</li>
</ul>
<h3 id="ç½‘å…³è¿‡æ»¤å™¨-gatewayfilter">ç½‘å…³è¿‡æ»¤å™¨ GatewayFilter </h3>
<p>ç½‘å…³è¿‡æ»¤å™¨ç”¨äºæ‹¦æˆªå¹¶é“¾å¼å¤„ç† Web è¯·æ±‚ï¼Œå¯ä»¥å®ç°æ¨ªåˆ‡ä¸åº”ç”¨æ— å…³çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šå®‰å…¨ã€è®¿é—®è¶…æ—¶çš„è®¾ç½®ã€ä¿®æ”¹ä¼ å…¥çš„ HTTP è¯·æ±‚æˆ–ä¼ å‡º HTTP å“åº”ã€‚Spring Cloud Gateway åŒ…å«è®¸å¤šå†…ç½®çš„ç½‘å…³è¿‡æ»¤å™¨å·¥å‚ï¼ˆä¸€å…±22ä¸ªï¼‰ï¼ŒåŒ…æ‹¬ï¼šå¤´éƒ¨è¿‡æ»¤å™¨ã€è·¯å¾„ç±»è¿‡æ»¤å™¨ã€Hystrixè¿‡æ»¤å™¨å’Œé‡å†™è¯·æ±‚ URL çš„è¿‡æ»¤å™¨ï¼Œä»¥åŠå‚æ•°å’ŒçŠ¶æ€ç ç­‰å…¶ä»–ç±»å‹çš„è¿‡æ»¤å™¨ã€‚æ ¹æ®è¿‡æ»¤å™¨å·¥å‚çš„ç”¨é€”æ¥åˆ’åˆ†ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼šHeaderã€Parameterã€Path ã€Bodyã€Statusã€Sessionã€Redirectã€Retryã€RateLimiterã€Hystrixã€‚</p>
<p><img src="./assets/image-20241224101250620.png" alt="image-20241224101250620"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ä¾‹è¯´æ˜å…¶ä¸­ä¸€éƒ¨åˆ†å¦‚ä½•ä½¿ç”¨ï¼Œå…¶ä½™ç­‰å·¥ä½œæˆ–å­¦ä¹ éœ€è¦æ—¶å†æŸ¥è¯¢èµ„æ–™ã€‚</p>
<h4 id="path-è·¯å¾„è¿‡æ»¤å™¨">Path è·¯å¾„è¿‡æ»¤å™¨ </h4>
<p>Path è·¯å¾„è¿‡æ»¤å™¨å¯ä»¥å®ç° URL é‡å†™ï¼Œé€šè¿‡é‡å†™ URL å¯ä»¥å®ç°éšè—å®é™…è·¯å¾„æé«˜å®‰å…¨æ€§ï¼Œæ˜“äºç”¨æˆ·è®°å¿†å’Œé”®å…¥ï¼Œæ˜“äºè¢«æœç´¢å¼•æ“æ”¶å½•ç­‰ä¼˜ç‚¹ï¼Œå®ç°æ–¹å¼å¦‚ä¸‹æ‰€è¿°ã€‚</p>
<h5 id="rewritepathgatewayfilterfactory">RewritePathGatewayFilterFactory </h5>
<p>RewritePath ç½‘å…³è¿‡æ»¤å™¨å·¥å‚é‡‡ç”¨è·¯å¾„æ­£åˆ™è¡¨è¾¾å¼å‚æ•°å’Œæ›¿æ¢å‚æ•°ï¼Œä½¿ç”¨ Java æ­£åˆ™è¡¨è¾¾å¼çµæ´»çš„é‡å†™è¯·æ±‚è·¯å¾„ã€‚</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span><span class="token punctuation">,</span>/api<span class="token punctuation">-</span>gateway/<span class="token important">**</span> 
          <span class="token comment"># ç½‘å…³è¿‡æ»¤å™¨</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># å°† /api-gateway/system/xx é‡å†™ä¸º /system/xx</span>
            <span class="token punctuation">-</span> RewritePath=/api<span class="token punctuation">-</span>gateway(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>/<span class="token punctuation">?</span>.<span class="token important">*)</span><span class="token punctuation">,</span>$\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
</code></pre><p>æ‰“å¼€ Postman è®¿é—®åœ°å€  <code>localhost:30000/api-gateway/system/getDefaultString</code> ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="./assets/image-20241223161025237.png" alt="image-20241223161025237"></p>
<h5 id="prefixpathgatewayfilterfactory">PrefixPathGatewayFilterFactory </h5>
<p>PrefixPath ç½‘å…³è¿‡æ»¤å™¨å·¥å‚ä¸ºåŒ¹é…çš„ URI æ·»åŠ æŒ‡å®šçš„å‰ç¼€ã€‚</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># å°† /** é‡å†™ä¸º /system/** </span>
            <span class="token punctuation">-</span> PrefixPath=/system
</code></pre><p>æ‰“å¼€ Postman è®¿é—®åœ°å€  <code>localhost:30000/getDefaultString</code> ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241223162004284.png" alt="image-20241223162004284"></p>
<h5 id="stripprefixgatewayfilterfactory">StripPrefixGatewayFilterFactory </h5>
<p>StripPrefix ç½‘å…³è¿‡æ»¤å™¨å·¥å‚é‡‡ç”¨ä¸€ä¸ªå‚æ•° StripPrefixï¼Œè¯¥å‚æ•°è¡¨ç¤ºåœ¨å°†è¯·æ±‚å‘é€åˆ°ä¸‹æ¸¸ä¹‹å‰ä»è¯·æ±‚ä¸­å‰¥ç¦»çš„è·¯å¾„ä¸ªæ•°ã€‚</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># åœ¨å°†è¯·æ±‚å‘é€åˆ°ä¸‹æ¸¸ä¹‹å‰ä»è¯·æ±‚ä¸­å‰¥ç¦»çš„è·¯å¾„ä¸ªæ•°</span>
            <span class="token punctuation">-</span> StripPrefix=2
</code></pre><p>æ‰“å¼€ Postman è®¿é—®åœ°å€  <code>localhost:30000/api/xxx/system/getDefaultString</code> ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241223163324080.png" alt="image-20241223163324080"></p>
<p><span style="font-size:12px;color:darkgrey;">æ³¨æ„ï¼šåœ¨ä¸Šè¿°æ¡ˆä¾‹ä¸­ï¼Œ<code>/api/xxx</code> å†™å•¥éƒ½è¡Œã€‚</span></p>
<h5 id="setpathgatewayfilterfactory">SetPathGatewayFilterFactory </h5>
<p>SetPath ç½‘å…³è¿‡æ»¤å™¨å·¥å‚é‡‡ç”¨è·¯å¾„æ¨¡æ¿å‚æ•°ï¼Œå®ƒæä¾›äº†ä¸€ç§é€šè¿‡çš„ç®€å•æ–¹æ³•ï¼Œä½¿ç”¨ Spring Framework ä¸­çš„ uri çš„æ¨¡æ¿ï¼Œå…è®¸å¤šä¸ªåŒ¹é…æ®µã€‚</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/api/system/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># å…è®¸æ¨¡æ¿åŒ–è·¯å¾„æ¥æ“ä½œè¯·æ±‚è·¯å¾„</span>
            <span class="token punctuation">-</span> SetPath=/system/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
</code></pre><p>æ‰“å¼€ Postman è®¿é—®åœ°å€  <code>localhost:30000/api/system/getDefaultString</code> ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241223163906651.png" alt="image-20241223163906651"></p>
<h4 id="parameter-å‚æ•°è¿‡æ»¤å™¨">Parameter å‚æ•°è¿‡æ»¤å™¨ </h4>
<p>AddRequestParameter ç½‘å…³è¿‡æ»¤å™¨å·¥å‚ä¼šå°†æŒ‡å®šå‚æ•°æ·»åŠ è‡³åŒ¹é…åˆ°çš„ä¸‹æ¸¸è¯·æ±‚ä¸­ã€‚</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># å°†æŒ‡å®šå‚æ•°æ·»åŠ è‡³åŒ¹é…åˆ°çš„ä¸‹æ¸¸è¯·æ±‚</span>
            <span class="token punctuation">-</span> AddRequestParameter=name<span class="token punctuation">,</span>pitter
</code></pre><p>è°ƒæ•´æˆ‘ä»¬çš„æœåŠ¡æä¾›è€…ä»£ç ï¼Œæ–¹ä¾¿æµ‹è¯•ï¼š</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/system"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">TestService</span> testService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getDefaultString"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> testService<span class="token punctuation">.</span><span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&gt;&gt;&gt;&gt; info::: "</span><span class="token operator">+</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰“å¼€ Postman è®¿é—®åœ°å€  <code>localhost:30000/system/getDefaultString</code> ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241223164716012.png" alt="image-20241223164716012"></p>
<h4 id="status-çŠ¶æ€è¿‡æ»¤å™¨">Status çŠ¶æ€è¿‡æ»¤å™¨ </h4>
<p>SetStatus ç½‘å…³è¿‡æ»¤å™¨å·¥å‚é‡‡ç”¨å•ä¸ªçŠ¶æ€å‚æ•°ï¼Œå®ƒå¿…é¡»æ˜¯æœ‰æ•ˆçš„ Spring HttpStatusã€‚å®ƒå¯ä»¥æ˜¯æ•´æ•° 404 æˆ–æšä¸¾  <code>NOT_FOUND</code>  çš„å­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># ä»»ä½•çŠ¶æ€ä¸‹ï¼Œå“åº”çš„ HTTP çŠ¶æ€éƒ½å°†è®¾ç½®ä¸º 404</span>
            <span class="token punctuation">-</span> SetStatus=404
</code></pre><p>æ‰“å¼€ Postman è®¿é—®åœ°å€  <code>localhost:30000/system/getDefaultString</code> ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241223165608524.png" alt="image-20241223165608524"></p>
<h3 id="å…¨å±€è¿‡æ»¤å™¨-globalfilter">å…¨å±€è¿‡æ»¤å™¨ GlobalFilter </h3>
<p>å…¨å±€è¿‡æ»¤å™¨ä¸éœ€è¦å†é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œä½œç”¨åœ¨æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œæœ€ç»ˆé€šè¿‡ GatewayFilterAdapter åŒ…è£…æˆ GatewayFilterChain å¯è¯†åˆ«çš„è¿‡æ»¤å™¨ï¼Œå®ƒæ˜¯è¯·æ±‚ä¸šåŠ¡åŠè·¯ç”±çš„ URI è½¬æ¢ä¸ºçœŸå®ä¸šåŠ¡è¯·æ±‚åœ°å€çš„æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œä¸éœ€è¦é…ç½®ç³»ç»Ÿåˆå§‹åŒ–æ—¶åŠ è½½ï¼Œå¹¶ä½œç”¨åœ¨æ¯ä¸ªè·¯ç”±ä¸Šã€‚</p>
<p><img src="./assets/image-20241223170407574.png" alt="image-20241223170407574"></p>
<h3 id="è‡ªå®šä¹‰è¿‡æ»¤å™¨">è‡ªå®šä¹‰è¿‡æ»¤å™¨ </h3>
<p>å³ä½¿ Spring Cloud Gateway è‡ªå¸¦è®¸å¤šéå¸¸å®ç”¨çš„ç½‘å…³è¿‡æ»¤å™¨å·¥å‚ã€ç½‘å…³è¿‡æ»¤å™¨å’Œå…¨å±€è¿‡æ»¤å™¨ï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å½¢ä¸‹æˆ‘ä»¬ä»ç„¶å¸Œæœ›å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„è¿‡æ»¤å™¨ï¼Œå®ç°ä¸€äº›æ¯”è¾ƒéªšğŸ˜„çš„æ“ä½œã€‚</p>
<h4 id="è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨">è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨ </h4>
<p>è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨éœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªæ¥å£ï¼š <code>GatewayFilter</code> ï¼Œ <code>Ordered</code> ã€‚</p>
<h5 id="åˆ›å»ºè¿‡æ»¤å™¨">åˆ›å»ºè¿‡æ»¤å™¨ </h5>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">CustomGatewayFilter</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpStatus</span> code <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-int">int</span> value <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>value<span class="token operator">!=</span><span class="token number">200</span> <span class="token operator">&amp;&amp;</span> value<span class="token operator">!=</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_GATEWAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-int">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šè¿°è¿‡æ»¤å™¨å¯ä»¥å¤„ç†è¯·æ±‚çŠ¶æ€ç é 200 æˆ– 500 ä¹‹å¤–çš„å…¶ä»–çŠ¶æ€ç ï¼Œç»Ÿä¸€è®¾ç½®ä¸º  <code>BAD_GATEWAY</code> ï¼Œå¤§è‡´æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241223173011380.png" alt="image-20241223173011380"></p>
<h5 id="æ³¨å†Œè¿‡æ»¤å™¨">æ³¨å†Œè¿‡æ»¤å™¨ </h5>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">GatewayRoutesConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">routeLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system"</span><span class="token punctuation">,</span>
                        r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/system/**"</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>spec <span class="token operator">-&gt;</span> spec<span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">CustomGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"lb://bettytsai-system"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><blockquote>
<p>å£°æ˜ï¼šä¸åŒç‰ˆæœ¬çš„ Spring Cloud Gateway é“¾å¼å†™æ³•ä¸ä¸€è‡´ï¼Œè¯·è‡ªè¡ŒæŸ¥è¯¢èµ„æ–™ã€‚</p>
</blockquote>
<h4 id="è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨">è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ </h4>
<p>è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨éœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªæ¥å£ï¼š <code>GlobalFilter</code>  ã€ <code>Ordered</code> ã€‚é€šè¿‡å…¨å±€è¿‡æ»¤å™¨å¯ä»¥å®ç°æƒé™æ ¡éªŒã€å®‰å…¨æ€§éªŒè¯ç­‰åŠŸèƒ½ã€‚</p>
<h5 id="åˆ›å»ºè¿‡æ»¤å™¨-1">åˆ›å»ºè¿‡æ»¤å™¨ </h5>
<p>å®ç°æŒ‡å®šæ¥å£ï¼Œæ·»åŠ   <code> @Component</code>  æ³¨è§£å³å¯ã€‚</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">CustomGlobalFilter</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"======&gt; è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-int">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="éªŒè¯è¿‡æ»¤å™¨">éªŒè¯è¿‡æ»¤å™¨ </h5>
<p><img src="./assets/image-20241223175819572.png" alt="image-20241223175819572"></p>
<h4 id="ç»Ÿä¸€é‰´æƒå®ç°">ç»Ÿä¸€é‰´æƒå®ç° </h4>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ç½‘å…³è¿‡æ»¤å™¨ä¸­é€šè¿‡ Token åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œå®Œæˆä¸€ä¸ªç»Ÿä¸€é‰´æƒçš„ â€œæ¡ˆä¾‹â€ã€‚</p>
<h5 id="åˆ›å»ºé‰´æƒè¿‡æ»¤å™¨">åˆ›å»ºé‰´æƒè¿‡æ»¤å™¨ </h5>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">AccessFilter</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Token not exist."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span><span class="token string">"application/json;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"{\"message\":\""</span><span class="token operator">+</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">.</span><span class="token function">getReasonPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\"}"</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBuffer</span> buffer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¯·æ±‚ç»ˆæ­¢ï¼Œä¸å†ç»§ç»­</span>
            <span class="token keyword keyword-return">return</span> response<span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"authorized successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-int">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>ä¸Šè¿°ä»£ç åªæ˜¯åšä¸ªæ¼”ç¤ºï¼Œå®é™…é¡¹ç›®ä¸­ä¸ä¼šè¿™æ ·å»å®ç°ï¼Œåªæ˜¯è¯´æ˜ï¼Œé‰´æƒæ“ä½œä¸€èˆ¬æ”¾åœ¨ç½‘å…³ä¸­å»å®ç°ã€‚</p>
<h5 id="éªŒè¯é‰´æƒè¿‡æ»¤å™¨">éªŒè¯é‰´æƒè¿‡æ»¤å™¨ </h5>
<p>é€šè¿‡è®¿é—®åœ°å€  <code>localhost:30000/system/getDefaultString</code>  ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”å‘ç°ï¼Œå¦‚æœå­˜åœ¨ æŒ‡å®š  <code>token</code>  å‚æ•°æ‰å¯ä»¥è¯·æ±‚é€šè¿‡ï¼š</p>
<p><img src="./assets/image-20241223204003228.png" alt="image-20241223204003228"></p>
<p><img src="./assets/image-20241223204141968.png" alt="image-20241223204141968"></p>
<h2 id="ç½‘å…³é™æµ">ç½‘å…³é™æµ </h2>
<p>é¡¾åæ€ä¹‰ï¼Œé™æµå°±æ˜¯é™åˆ¶æµé‡ï¼Œå°±åƒä½ å®½å¸¦åŒ…åªæœ‰ 1GB çš„æµé‡ï¼Œç”¨å®Œå°±æ²¡äº†ã€‚é€šè¿‡é™æµï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¥½çš„æ§åˆ¶ç³»ç»Ÿçš„ QPSï¼Œä»è€Œè¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦é™æµ">ä¸ºä»€ä¹ˆéœ€è¦é™æµ </h3>
<p>æ¯”å¦‚ Web æœåŠ¡ï¼Œå¯¹å¤– API ï¼Œè¿™ç§ç±»å‹çš„æœåŠ¡æœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½å¯¼è‡´æœºå™¨è¢«æ‹–å®ï¼š</p>
<ul>
<li>
<p>ç”¨æˆ·å¢é•¿è¿‡å¿«ï¼ˆè¿™æ˜¯å¥½äº‹ğŸ˜„ï¼‰</p>
</li>
<li>
<p>å› ä¸ºæŸä¸ªçƒ­ç‚¹äº‹ä»¶ï¼ˆæ¯”å¦‚å¾®åšçƒ­æœï¼‰</p>
</li>
<li>
<p>ç«äº‰å¯¹è±¡çˆ¬è™«</p>
</li>
<li>
<p>æ¶æ„è¯·æ±‚</p>
</li>
</ul>
<p>è¿™äº›æƒ…å†µéƒ½æ˜¯æ— æ³•é¢„çŸ¥çš„ï¼Œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šæœ‰ 10 å€ç”šè‡³ 20 å€çš„æµé‡æ‰“è¿›æ¥ï¼Œå¦‚æœçœŸç¢°ä¸Šè¿™ç§æƒ…å†µï¼Œæ‰©å®¹æ ¹æœ¬æ¥ä¸åŠã€‚</p>
<p><img src="./assets/image-20241223205037097.png" alt="image-20241223205037097"></p>
<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¯¹å†…è€Œè¨€ï¼šä¸Šæ¸¸çš„ Aã€B æœåŠ¡ç›´æ¥ä¾èµ–äº†ä¸‹æ¸¸çš„åŸºç¡€æœåŠ¡ Cï¼Œå¯¹äº Aã€B æœåŠ¡éƒ½ä¾èµ–çš„åŸºç¡€æœåŠ¡ C è¿™ç§åœºæ™¯ï¼ŒæœåŠ¡ A å’Œ B å…¶å®å¤„äºæŸç§ç«äº‰å…³ç³»ï¼Œå¦‚æœæœåŠ¡ A çš„å¹¶å‘é˜ˆå€¼è®¾ç½®è¿‡å¤§ï¼Œå½“æµé‡é«˜å³°æœŸåˆ°æ¥ï¼Œæœ‰å¯èƒ½ç›´æ¥æ‹–è·¨åŸºç¡€æœåŠ¡ C å¹¶å½±å“æœåŠ¡ Bï¼Œä¹Ÿå°±æ˜¯é€ æˆäº†<span style="color:#ff6e00;">é›ªå´©æ•ˆåº”</span>ã€‚</p>
<h3 id="é™æµç®—æ³•">é™æµç®—æ³• </h3>
<p>å¸¸è§çš„é™æµç®—æ³•æœ‰ï¼š</p>
<ul>
<li>
<p>è®¡æ•°å™¨ç®—æ³•</p>
</li>
<li>
<p>æ¼æ¡¶ï¼ˆLeaky Bucketï¼‰ç®—æ³•</p>
</li>
<li>
<p>ä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰ç®—æ³•</p>
</li>
</ul>
<h4 id="è®¡æ•°å™¨ç®—æ³•">è®¡æ•°å™¨ç®—æ³• </h4>
<p>è®¡æ•°å™¨ç®—æ³•æ˜¯é™æµç®—æ³•ä¸­æœ€ç®€å•ä¸”æœ€å®¹æ˜“å®ç°çš„ä¸€ç§ç®—æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬è§„å®šï¼Œå¯¹äº æ¥å£A æ¥è¯´ï¼Œæˆ‘ä»¬ 1 åˆ†é’Ÿå†…çš„è®¿é—®æ¬¡æ•°ä¸èƒ½è¶…è¿‡ 100 æ¬¡ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼šåœ¨ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ counterï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œcounter å°±åŠ  1ï¼Œå¦‚æœ counter çš„å€¼å¤§äº 100 å¹¶ä¸”è¯¥è¯·æ±‚ä¸ç¬¬ä¸€ä¸ªè¯·æ±‚çš„é—´éš”è¿˜åœ¨ 1 åˆ†é’Ÿä¹‹å†…ï¼Œé‚£ä¹ˆè§¦å‘é™æµï¼›å¦‚æœè¯¥è¯·æ±‚ä¸ç¬¬ä¸€ä¸ªè¯·æ±‚çš„é—´éš”å¤§äº 1 åˆ†é’Ÿï¼Œé‡ç½® counter é‡æ–°è®¡æ•°ï¼Œå…·ä½“ç®—æ³•çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<img src="./assets/image-20241223211750996.png" alt="image-20241223211750996" style="zoom:67%;">
<p>è¿™ä¸ªç®—æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªååˆ†è‡´å‘½çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸´ç•Œå€¼çš„é—®é¢˜ï¼Œæˆ‘ä»¬çœ‹ä¸‹å›¾ï¼š</p>
 <img src="./assets/image-20241223211823709.png" alt="image-20241223211823709" style="zoom: 50%;">
<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå‡è®¾å­˜åœ¨ä¸€ä¸ªæ¶æ„çš„ç”¨æˆ·ï¼Œåœ¨ç¬¬ 59 s çš„æ—¶å€™ï¼Œé€šè¿‡æŸç§æ‰‹æ®µï¼ˆæ¯”å¦‚ï¼šæ¸—é€æµ‹è¯•ï¼‰ç¬é—´å‘é€äº† 100 ä¸ªè¯·æ±‚ï¼Œåœ¨ ç¬¬ 60 s ï¼ˆè¿™ä¸ªæ—¶å€™è®¡æ•°å™¨å·²ç»è¢«é‡ç½®äº†ï¼‰çš„æ—¶å€™åˆå‘é€äº† 100ä¸ªè¯·æ±‚ï¼Œç›¸å½“äºè¿™ä¸ªç”¨æˆ·åœ¨ 1s æ—¶é—´å†…ï¼Œç¬é—´å‘é€äº† 200 ä¸ªè¯·æ±‚ã€‚ä¸€å¼€å§‹æˆ‘ä»¬è§„å®šçš„æ˜¯ 1 åˆ†é’Ÿå†…æœ€å¤š 100ä¸ªè¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’æœ€å¤§ 1.7 ä¸ªè¯·æ±‚ï¼Œç”¨æˆ·é€šè¿‡åœ¨æ—¶é—´çª—å£çš„é‡ç½®èŠ‚ç‚¹å¤„çªå‘å¤§é‡è¯·æ±‚ï¼Œå¯ä»¥ç¬é—´è¶…è¿‡æˆ‘ä»¬çš„é™æµé˜ˆå€¼ã€‚ç”¨æˆ·å¾ˆæœ‰å¯èƒ½é€šè¿‡ç®—æ³•çš„è¿™ä¸ªæ¼æ´ï¼Œç¬é—´å‹å®æˆ‘ä»¬çš„åº”ç”¨ã€‚</p>
<p>ä¸ä»…å¦‚æ­¤ï¼Œè¿˜å­˜åœ¨èµ„æºæµªè´¹çš„é—®é¢˜ï¼Œæˆ‘ä»¬çš„é¢„æƒ³ç®—æ³•æ˜¯å¸Œæœ› 100 ä¸ªè¯·æ±‚å‡åŒ€çš„åˆ†æ•£åœ¨ 1 åˆ†é’Ÿå†…ï¼Œå‡è®¾ 30s å†…æˆ‘ä»¬è¯·æ±‚å°±è¾¾åˆ°ä¸Šé™äº†ï¼Œå‰©ä¸‹çš„åŠåˆ†é’Ÿå†…ï¼ŒæœåŠ¡å™¨å°±å¤„äºé—²ç½®çŠ¶æ€ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼š</p>
<img src="./assets/image-20241223212658994.png" alt="image-20241223212658994" style="zoom: 50%;">
<h4 id="æ¼æ¡¶ç®—æ³•">æ¼æ¡¶ç®—æ³• </h4>
<p>æ¼æ¡¶ç®—æ³•å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥ç²—ç•¥çš„è®¤ä¸ºå°±æ˜¯æ³¨æ°´æ¼æ°´çš„è¿‡ç¨‹ä¸­ï¼Œå¾€æ¡¶ä¸­ä»¥ä»»æ„é€Ÿç‡æµå…¥ç¨ï¼Œä»¥ä¸€å®šé€Ÿç‡æµå‡ºæ°´ï¼Œå½“æ°´è¶…è¿‡æ¡¶æµé‡åˆ™ä¸¢å¼ƒï¼Œå› ä¸ºæ¡¶å®¹é‡ä¸å˜ï¼Œä¿è¯äº†æ•´ä½“çš„é€Ÿç‡ã€‚</p>
<img src="./assets/image-20241223221643027.png" alt="image-20241223221643027" style="zoom:77%;">
<p>æ¼æ¡¶ç®—æ³•é€šè¿‡é˜Ÿåˆ—æœºåˆ¶å®ç°ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<img src="./assets/image-20241223222215371.png" alt="image-20241223222215371" style="zoom:80%;">
<p>ä½†æ˜¯æ¼æ¡¶ç®—æ³•ä¹Ÿå­˜åœ¨è‡´å‘½çš„é—®é¢˜ï¼Œå½“å„æœåŠ¡å¤§é‡è¯·æ±‚æ‰“è¿›æ¥ï¼Œæ¡¶å†…æµé‡å †ç§¯ä¼šé€ æˆç½‘å…³å‹åŠ›å·¨å¤§ï¼Œä¸€æ—¦ç½‘å…³å®•æœºï¼Œæ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿå°†å´©æºƒã€‚</p>
<h4 id="ä»¤ç‰Œæ¡¶ç®—æ³•">ä»¤ç‰Œæ¡¶ç®—æ³• </h4>
<p>ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯å¯¹æ¼æ¡¶ç®—æ³•çš„ä¸€ç§æ”¹è¿›ï¼Œæ¼æ¡¶ç®—æ³•èƒ½å¤Ÿé™åˆ¶è¯·æ±‚è°ƒç”¨çš„é€Ÿç‡ï¼Œè€Œä»¤ç‰Œæ¡¶ç®—æ³•èƒ½å¤Ÿåœ¨é™åˆ¶è°ƒç”¨çš„å¹³å‡é€Ÿç‡çš„åŒæ—¶è¿˜å…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘è°ƒç”¨ã€‚åœ¨ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªæ¡¶ï¼Œç”¨æ¥å­˜æ”¾å›ºå®šæ•°é‡çš„ä»¤ç‰Œã€‚<span style="color:#ff6e00;">ç®—æ³•ä¸­å­˜åœ¨ä¸€ç§æœºåˆ¶ï¼Œä»¥ä¸€å®šé€Ÿç‡å¾€æ¡¶ä¸­æ”¾ä»¤ç‰Œï¼Œæ¯æ¬¡è°ƒç”¨è¯·æ±‚éœ€è¦å…ˆè·å–ä»¤ç‰Œï¼Œåªæœ‰æ‹¿åˆ°ä»¤ç‰Œï¼Œæ‰æœ‰æœºä¼šç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™é€‰æ‹©ç­‰å¾…å¯ç”¨çš„ä»¤ç‰Œã€æˆ–è€…ç›´æ¥æ‹’ç»ã€‚</span>æ”¾ä»¤ç‰Œçš„è¿™ä¸ªåŠ¨ä½œæ˜¯æŒç»­ä¸æ–­åœ°è¿›è¡Œçš„ï¼Œå¦‚æœæ¡¶ä¸­ä»¤ç‰Œè¾¾åˆ°ä¸Šé™ï¼Œå°±ä¸¢å¼ƒä»¤ç‰Œã€‚</p>
<blockquote>
<p><strong>âœ¨ åœºæ™¯ï¼š</strong></p>
<p>æ¡¶ä¸­ä¸€ç›´æœ‰å¤§é‡å¯ç”¨çš„ä»¤ç‰Œï¼Œè¿™æ—¶å€™è¿›æ¥çš„è¯·æ±‚èƒ½å¤Ÿç›´æ¥æ‹¿åˆ°ä»¤ç‰Œæ‰§è¡Œã€‚æ¯”å¦‚è®¾ç½® QPS ä¸º100/sï¼Œé‚£ä¹ˆé™æµå™¨åˆå§‹åŒ–å®Œæˆ 1 s åï¼Œæ¡¶å†…å°±å·²ç»æœ‰äº† 100 ä¸ªä»¤ç‰Œï¼Œç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆå¯¹å¤–æä¾›æœåŠ¡æ—¶ï¼Œè¯¥é™æµå™¨å¯ä»¥æŠµæŒ¡ç¬æ—¶ 100 ä¸ªè¯·æ±‚ã€‚å½“æ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œè¯·æ±‚ç»§ç»­ç­‰å¾…ï¼Œæœ€åç›¸å½“äºä»¥ä¸€å®šé€Ÿç‡æ‰§è¡Œã€‚</p>
</blockquote>
<p>Spring Cloud Gateway å†…éƒ¨ä½¿ç”¨çš„å°±æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå¤§æ¦‚æè¿°å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¯¹æ‰€æœ‰çš„è¯·æ±‚åœ¨å¤„ç†ä¹‹å‰éƒ½éœ€è¦æ‹¿åˆ°ä¸€ä¸ªå¯ç”¨çš„ä»¤ç‰Œæ‰ä¼šè¢«å¤„ç†ï¼›</li>
<li>æ ¹æ®é™æµå¤§å°ï¼Œè®¾ç½®æŒ‰ç…§ä¸€å®šçš„é€Ÿç‡å¾€æ¡¶é‡Œæ·»åŠ ä»¤ç‰Œï¼›</li>
<li>æ¡¶è®¾ç½®æœ€å¤§çš„æ”¾ç½®ä»¤ç‰Œé™åˆ¶ï¼Œæ¡¶æ»¡æ—¶ï¼Œæ–°æ·»åŠ çš„ä»¤ç‰Œç›´æ¥ä¸¢å¼ƒæˆ–è¢«æ‹’ç»ï¼›</li>
<li>è¯·æ±‚è¾¾åˆ°åé¦–å…ˆè¦è·å–ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œï¼Œæ‹¿ç€ä»¤ç‰Œæ‰å¯ä»¥è¿›è¡Œå…¶ä»–çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå¤„ç†å®Œä¸šåŠ¡é€»è¾‘ä¹‹åï¼Œå°†ä»¤ç‰Œç›´æ¥åˆ é™¤ï¼›</li>
<li><span style="color:#ff6e00;">ä»¤ç‰Œæ¡¶å­˜åœ¨æœ€ä½é™é¢ï¼Œå½“æ¡¶å†…ä»¤ç‰Œè¾¾åˆ°æœ€ä½é™é¢æ—¶ï¼Œè¯·æ±‚å¤„ç†å®Œåä¸ä¼šåˆ é™¤ä»¤ç‰Œï¼Œä»¥ä¿è¯è¶³å¤Ÿçš„é™æµï¼›</span></li>
</ul>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="./assets/image-20241223223610164.png" alt="image-20241223223610164" style="zoom:77%;">
<p>é€šè¿‡å¯¹æ¯”æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ¼æ¡¶ç®—æ³•ä¸»è¦ç”¨é€”åœ¨äºä¿æŠ¤å„ä¸ªå¾®æœåŠ¡ç»„ä»¶ï¼Œè€Œä»¤ç‰Œæ¡¶ç®—æ³•ä¸»è¦ç›®çš„åœ¨äºä¿æŠ¤ç½‘å…³æœ¬èº«ï¼Œå°†è¯·æ±‚çš„å‹åŠ›äº¤ç»™ç›®æ ‡æœåŠ¡è‡ªå·±å»å¤„ç†ã€‚å‡è®¾çªç„¶è¿›æ¥å¾ˆå¤šè¯·æ±‚ï¼Œåªæœ‰æ‹¿åˆ°ä»¤ç‰Œçš„è¯·æ±‚æ‰ä¼šç¬æ—¶è¢«å¤„ç†è°ƒç”¨ç›®æ ‡æœåŠ¡ã€‚</p>
<h3 id="gateway-é™æµ">Gateway é™æµ </h3>
<p>Spring Cloud Gateway å®˜æ–¹æä¾›äº†  <code>RequestRateLimiterGatewayFilterFactory</code>  è¿‡æ»¤å™¨å·¥å‚ï¼Œä½¿ç”¨ Redis å’Œ Lua è„šæœ¬å®ç°äº†ä»¤ç‰Œæ¡¶çš„æ–¹å¼ã€‚</p>
<p>âœ¨ å…·ä½“çš„å®ç°é€»è¾‘åœ¨  <code>RequestRateLimiterGatewayFilterFactory</code>  ç±»ä¸­ï¼ŒLua è„šæœ¬åœ¨å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æºç æ–‡ä»¶ä¸­ï¼š</p>
<p><img src="./assets/image-20241224095643143.png" alt="image-20241224095643143"></p>
<blockquote>
<p>ğŸ“– å®˜æ–¹æ–‡æ¡£ <a href="https://docs.spring.io/spring-cloud-gateway/docs/3.1.4/reference/html/#the-requestratelimiter-gatewayfilter-factory">spring.io</a> ä¸­çš„æ¦‚è¿°å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p>RequestRateLimiterGatewayFilter å·¥å‚ä½¿ç”¨  RateLimiter  å®ç°æ¥ç¡®å®šæ˜¯å¦å…è®¸å½“å‰è¯·æ±‚ç»§ç»­è¿›è¡Œã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿”å›  HTTP 429 - Too Many Requests  ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰ çš„çŠ¶æ€ã€‚æ­¤ç­›é€‰æ¡ä»¶é‡‡ç”¨å¯é€‰çš„  <code>keyResolver</code>  å‚æ•°å’Œç‰¹å®šäºé€Ÿç‡é™åˆ¶å™¨çš„å‚æ•°ã€‚</p>
</blockquote>
<p>keyResolver  æ˜¯å®ç°  <code>KeyResolver</code>  æ¥å£çš„ Beanã€‚ åœ¨é…ç½®ä¸­ï¼Œä½¿ç”¨ SPEL æŒ‰åç§°å¼•ç”¨ beanã€‚  <code>#{@myKeyResolver}</code>  æ˜¯ä¸€ä¸ª SPEL è¡¨è¾¾å¼ï¼Œå®ƒå¼•ç”¨ä¸€ä¸ªåä¸º  <code>myKeyResolver</code>  çš„ beanã€‚ä¸‹é¢çš„æ¸…å•æ˜¾ç¤ºäº†  <code>KeyResolver</code>  æ¥å£ï¼š</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">KeyResolver</span> <span class="token punctuation">{</span>
    <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>KeyResolver æ¥å£å…è®¸å¯æ’æ‹”ç­–ç•¥æ´¾ç”Ÿç”¨äºé™åˆ¶è¯·æ±‚çš„å¯†é’¥ï¼Œåœ¨æœªæ¥çš„é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä¸­ï¼Œå°†æœ‰ä¸€äº›  KeyResolver å®ç°ã€‚</p>
<p>KeyResolver çš„é»˜è®¤å®ç°æ˜¯  PrincipalNameKeyResolver ï¼Œå®ƒä» ServerWebExchange   æ£€ç´¢  Principal  å¹¶è°ƒç”¨ Principal.getName() ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœ  KeyResolver  æ‰¾ä¸åˆ°é”®ï¼Œåˆ™è¯·æ±‚å°†è¢«æ‹’ç»ã€‚æ‚¨å¯ä»¥é€šè¿‡è®¾ç½®  <code>spring.cloud.gateway.filter.request-rate-limiter.deny-empty-key</code>  å±æ€§ å’Œ  <code>spring.cloud.gateway.filter.request-rate-limiter.empty-key-status-code</code>  å±æ€§æ¥è°ƒæ•´æ­¤è¡Œä¸ºã€‚</p>
<p><code>RequestRateLimiter</code>  ä¸èƒ½ä½¿ç”¨ â€œshortcutâ€ è¡¨ç¤ºæ³•è¿›è¡Œé…ç½®ã€‚ä»¥ä¸‹ç¤ºä¾‹é…ç½®æ— æ•ˆï¼š</p>
<pre data-role="codeBlock" data-info="properties" class="language-properties properties"><code><span class="token comment"># æ— æ•ˆçš„ "shorcut" é…ç½®</span>
<span class="token key attr-name">spring.cloud.gateway.routes[0].filters[0]</span><span class="token punctuation">=</span><span class="token value attr-value">RequestRateLimiter=2, 2, #{@userkeyresolver}</span>
</code></pre><h4 id="é™æµè¿‡æ»¤å™¨-redisratelimiter">é™æµè¿‡æ»¤å™¨ RedisRateLimiter </h4>
<p>Redis å®ç°åŸºäº <a href="https://stripe.com/blog/rate-limiters">Stripe</a> æ‰€åšçš„å·¥ä½œã€‚å®ƒéœ€è¦ä½¿ç”¨  <code>spring-boot-starter-data-redis-reactive</code>  Spring Boot å¯åŠ¨å™¨ï¼Œä½¿ç”¨çš„ç®—æ³•æ˜¯ <a href="https://en.wikipedia.org/wiki/Token_bucket">Token Bucket Algorithm</a> ï¼ˆä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰ã€‚</p>
<p>ä¸‹é¢ä»‹ç»å¸¸ç”¨çš„å‡ ä¸ªé…ç½®å±æ€§ï¼š</p>
<ul>
<li>
<p><code>redis-rate-limiter.replenishRate</code>  å±æ€§æ˜¯æ‚¨å¸Œæœ›å…è®¸ç”¨æˆ·æ¯ç§’æ‰§è¡Œçš„è¯·æ±‚æ•°ï¼Œè€Œä¸ä¼šä¸¢å¼ƒä»»ä½•è¯·æ±‚ã€‚è¿™æ˜¯å¡«å……ä»¤ç‰Œæ¡¶çš„é€Ÿç‡ï¼›</p>
</li>
<li>
<p><code>redis-rate-limiter.burstCapacity</code>  å±æ€§æ˜¯å…è®¸ç”¨æˆ·åœ¨ä¸€ç§’é’Ÿå†…æ‰§è¡Œçš„æœ€å¤§è¯·æ±‚æ•°ã€‚è¿™æ˜¯ä»¤ç‰Œæ¡¶å¯ä»¥å®¹çº³çš„ä»¤ç‰Œæ•°é‡ã€‚å°†æ­¤å€¼è®¾ç½®ä¸º 0 ä¼šé˜»æ­¢æ‰€æœ‰è¯·æ±‚ï¼›</p>
</li>
<li>
<p><code>redis-rate-limiter.requestedTokens</code>  å±æ€§æ˜¯è¯·æ±‚èŠ±è´¹çš„ä»¤ç‰Œæ•°ã€‚è¿™æ˜¯æ¯ä¸ªè¯·æ±‚ä»å­˜å‚¨æ¡¶ä¸­è·å–çš„ä»¤ç‰Œæ•°ï¼Œé»˜è®¤ä¸º 1 ï¼›</p>
</li>
</ul>
<p>é€šè¿‡åœ¨  <code>replenishRate</code>  å’Œ  <code>burstCapacity</code>  ä¸­è®¾ç½®ç›¸åŒçš„å€¼æ¥å®ç°ç¨³å®šçš„é€Ÿç‡ã€‚é€šè¿‡å°†  <code>burstCapacity</code>  è®¾ç½®ä¸ºé«˜äº  <code>replenishRate</code>  æ¥å…è®¸ä¸´æ—¶çªå¢ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦åœ¨çªå¢ä¹‹é—´å…è®¸é€Ÿç‡é™åˆ¶å™¨æœ‰ä¸€æ®µæ—¶é—´ï¼ˆæ ¹æ®  <code>replenishRate</code> ï¼‰ï¼Œå› ä¸ºä¸¤ä¸ªè¿ç»­çš„çªå¢å°†å¯¼è‡´è¯·æ±‚è¢«ä¸¢å¼ƒï¼ˆ <code>HTTP 429 - è¯·æ±‚è¿‡å¤š</code> ï¼‰ã€‚ä¸‹é¢çš„æ¸…å•é…ç½®äº†  <code>redis-rate-limiter</code> ï¼š</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> requestratelimiter_route
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//example.org
        <span class="token key atrule">filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">20</span>
            <span class="token key atrule">redis-rate-limiter.requestedTokens</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre><p>é€šè¿‡å°†  <code>replenishRate</code>  è®¾ç½®ä¸ºæ‰€éœ€çš„è¯·æ±‚æ•°ï¼Œå°†  <code>requestedTokens</code>  è®¾ç½®ä¸º ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´è·¨åº¦ï¼Œå°†  <code>burstCapacity</code>  è®¾ç½®ä¸º  <code>replenishRate</code>  å’Œ  <code>requestedTokens</code>  çš„ä¹˜ç§¯ï¼Œä¾‹å¦‚ï¼Œè®¾ç½®  <code>replenishRate=1</code> ã€ <code>requestedTokens=60</code>  å’Œ  <code>burstCapacity=60</code>  å°†å¯¼è‡´ 1 ä¸ªè¯·æ±‚/åˆ†é’Ÿçš„é™åˆ¶ã€‚</p>
<h4 id="åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ç½‘å…³é™æµ">åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ç½‘å…³é™æµ </h4>
<p>æˆ‘ä»¬ä¸Šé¢ä¹Ÿæåˆ° Spring Cloud Gateway ç½‘å…³çš„ <span style="color:#ff6e00;">RequestRateLimiterGatewayFilterFactory</span> é™æµè¿‡æ»¤å™¨å·¥å‚æ˜¯åŸºäº Redis å’Œ Lua è„šæœ¬å®ç°çš„ï¼Œæˆ‘ä»¬å°±éœ€è¦å…ˆå‡†å¤‡å¥½ Redis çš„ç¯å¢ƒï¼Œè¿™é‡Œæˆ‘é€‰æ‹©æ”¾åœ¨æœåŠ¡å™¨ä¸Šè·‘ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224105652350.png" alt="image-20241224105652350"></p>
<h5 id="æ·»åŠ ä¾èµ–-1">æ·»åŠ ä¾èµ– </h5>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis-reactive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><h5 id="ä¸Šä¸‹æ–‡é…ç½®-2">ä¸Šä¸‹æ–‡é…ç½® </h5>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span> <span class="token comment"># è¿æ¥è¶…æ—¶æ—¶é—´</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 116.<span class="token important">*.*.132</span> <span class="token comment"># redisæœåŠ¡åœ°å€</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span> <span class="token comment"># redisæœåŠ¡ç«¯å£</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> Abcd123. <span class="token comment"># rediså¯†ç </span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># é€‰æ‹©å“ªä¸€ä¸ªåº“ï¼Œé»˜è®¤0åº“</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">1024</span> <span class="token comment"># æœ€å¤§è¿æ¥æ•°</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">10000</span> <span class="token comment">#æœ€å¤§è¿æ¥é˜»å¡ç­‰å¾…æ—¶é—´ï¼Œå•ä½ ms é»˜è®¤ -1</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">200</span> <span class="token comment"># æœ€å¤§ç©ºé—²è¿æ¥</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># æœ€å°ç©ºé—²è¿æ¥</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter              <span class="token comment"># é™æµè¿‡æ»¤å™¨</span>
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># ä»¤ç‰Œæ¡¶æ¯ç§’å¡«å……é€Ÿç‡</span>
                <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># ä»¤ç‰Œæ¡¶æ€»å®¹é‡ (æè¿™ä¹ˆå°ï¼Œçº¯å±ä¸ºäº†æµ‹è¯•)</span>
                <span class="token key atrule">redis-rate-limiter.requestedTokens</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># è¯·æ±‚èŠ±è´¹çš„ä»¤ç‰Œæ•°,æ¯ä¸ªè¯·æ±‚ä»å­˜å‚¨æ¡¶ä¸­è·å–çš„ä»¤ç‰Œæ•°ï¼Œé»˜è®¤ä¸º 1</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">"#{@pathKeyResolver}"</span> <span class="token comment"># ä½¿ç”¨ SpEL è¡¨è¾¾å¼æŒ‰åç§°å¼•ç”¨</span>
</code></pre><h5 id="é™æµè§„åˆ™--url-é™æµ">é™æµè§„åˆ™ â€” URL é™æµ </h5>
<p>æˆ‘ä»¬åœ¨ä¸Šé¢ä¹Ÿæåˆ°è¿‡ KeyResolver æ¥å£çš„ä½œç”¨ã€‚<span style="color:#ff6e00;">é€šä¿—ç‚¹æ¥è¯´ï¼ŒKeyResolver ç”¨äºæŒ‡å®šé™æµçš„æ–¹å¼ï¼Œå¯ä»¥åŸºäº IPé™æµã€é€šè¿‡ç”¨æˆ·é™æµã€é€šè¿‡æ¥å£é™æµç­‰ã€‚KeyResolverç”¨äºè®¡ç®—æŸä¸€ä¸ªç±»å‹çš„é™æµçš„Keyï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥é€šè¿‡KeyResolveræ¥æŒ‡å®šé™æµçš„Keyã€‚</span></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">KeyResolverConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">pathKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// return new KeyResolver() {</span>
        <span class="token comment">//     @Override</span>
        <span class="token comment">//     public Mono&lt;String&gt; resolve(ServerWebExchange exchange) {</span>
        <span class="token comment">//         return Mono.just(exchange.getRequest().getURI().getPath());</span>
        <span class="token comment">//     }</span>
        <span class="token comment">// };</span>
        <span class="token comment">// JDK 8+å†™æ³•</span>
        <span class="token keyword keyword-return">return</span> exchange <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>é‡å¯ç½‘å…³æœåŠ¡ï¼Œæ‰“å¼€ Postman å¤šæ¬¡è®¿é—®æœåŠ¡ï¼Œæ¨¡æ‹Ÿå¤§é‡è¯·æ±‚ï¼Œå°±ä¼šå‡ºç° HTTP 429 è¯·æ±‚å¤±è´¥çš„æƒ…å†µï¼š</p>
<p><img src="./assets/image-20241224140117204.png" alt="image-20241224140117204"></p>
<p>ç„¶åè§‚å¯Ÿ redis æ•°æ®åº“ä¸­å˜åŒ–ï¼š</p>
<p><img src="./assets/image-20241224140147277.png" alt="image-20241224140147277"></p>
<p>å¯ä»¥çœ‹åˆ°é”®å°±æ˜¯æˆ‘ä»¬çš„è¯·æ±‚ URI ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„åŸºäºä»¤ç‰Œæ¡¶æ–¹å¼çš„ URL é™æµã€‚</p>
<h5 id="é™æµè§„åˆ™--ipé™æµ">é™æµè§„åˆ™ â€” IPé™æµ </h5>
<p>åœ¨ä¸Šé¢æˆ‘ä»¬é€šè¿‡ åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°äº†URLé™æµï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹å¦‚ä½•é€šè¿‡ IP è¿›è¡Œé™æµã€‚</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">KeyResolverConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">pathKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// IP é™æµ</span>
        <span class="token keyword keyword-return">return</span> exchange <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getpxoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>åŒæ ·çš„æ‰“å¼€ Postman æ¨¡æ‹Ÿå¤§é‡è¯·æ±‚æ‰“è¿›æ¥ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224140813989.png" alt="image-20241224140813989"></p>
<p>Redisæƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224140912726.png" alt="image-20241224140912726"></p>
<h5 id="é™æµè§„åˆ™--å‚æ•°é™æµ">é™æµè§„åˆ™ â€” å‚æ•°é™æµ </h5>
<blockquote>
<p>å‚æ•°é™æµä¸€èˆ¬ç”¨äºæ ¹æ®ç”¨æˆ·åã€ç”¨æˆ·ID ç­‰æ ‡è¯†é’ˆå¯¹ç”¨æˆ·è¿›è¡Œé™æµã€‚</p>
</blockquote>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">KeyResolverConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">pathKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// å‚æ•°é™æµ ç”¨æˆ·idé™æµ</span>
        <span class="token keyword keyword-return">return</span> exchange <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰“å¼€ Postman ï¼Œæ¨¡æ‹Ÿå¤§é‡è¯·æ±‚ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224143935816.png" alt="image-20241224143935816"></p>
<p>Redisç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224144016209.png" alt="image-20241224144016209"></p>
<h5 id="è‡ªå®šä¹‰é™é€Ÿå™¨">è‡ªå®šä¹‰é™é€Ÿå™¨ </h5>
<p>åœ¨ä¸Šä¸‰èŠ‚é™æµè§„åˆ™æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ä¸Šä¸‹æ–‡é…ç½®éƒ½æ˜¯ä¸€æ ·çš„ï¼š</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter              <span class="token comment"># é™æµè¿‡æ»¤å™¨</span>
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># ä»¤ç‰Œæ¡¶æ¯ç§’å¡«å……é€Ÿç‡</span>
                <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># ä»¤ç‰Œæ¡¶æ€»å®¹é‡</span>
                <span class="token key atrule">redis-rate-limiter.requestedTokens</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># è¯·æ±‚èŠ±è´¹çš„ä»¤ç‰Œæ•°,æ¯ä¸ªè¯·æ±‚ä»å­˜å‚¨æ¡¶ä¸­è·å–çš„ä»¤ç‰Œæ•°ï¼Œé»˜è®¤ä¸º 1</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">"#{@keyResolver}"</span> <span class="token comment"># ä½¿ç”¨ SpEL è¡¨è¾¾å¼æŒ‰åç§°å¼•ç”¨</span>
</code></pre><p>åœ¨ Spring Cloud Gateway ä¸­ï¼Œæ”¯æŒå°†é€Ÿç‡é™åˆ¶å™¨å®šä¹‰ä¸ºå®ç°  <code>RateLimiter</code>  æ¥å£çš„ Beanã€‚</p>
<p>åœ¨é…ç½®ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ SpEL æŒ‰åç§°å¼•ç”¨ Beanã€‚ <code>#{@customRateLimiter}</code> æ˜¯ä¸€ä¸ªSpELè¡¨è¾¾å¼ï¼Œå®ƒå¼•ç”¨äº†ä¸€ä¸ªåä¸º  <code>rateLimiter</code>  çš„ Beanã€‚</p>
<p>å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter              <span class="token comment"># é™æµè¿‡æ»¤å™¨</span>
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">"#{@keyResolver}"</span>         <span class="token comment"># ä½¿ç”¨ SpEL è¡¨è¾¾å¼æŒ‰åç§°å¼•ç”¨</span>
                <span class="token key atrule">rate-limiter</span><span class="token punctuation">:</span> <span class="token string">"#{@customRateLimiter}"</span>   <span class="token comment"># ä½¿ç”¨ SpEL è¡¨è¾¾å¼æŒ‰åç§°å¼•ç”¨</span>
</code></pre><p>æ‚¨è¿˜å¯ä»¥å°†é€Ÿç‡é™åˆ¶å™¨å®šä¹‰ä¸ºå®ç°  <code>RateLimiter</code>  æ¥å£çš„ Beanã€‚ åœ¨é…ç½®ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ SpEL æŒ‰åç§°å¼•ç”¨ Beanã€‚  <code>#{@customRateLimiter}</code>  æ˜¯ä¸€ä¸ª SPEL è¡¨è¾¾å¼ï¼Œå®ƒå¼•ç”¨ä¸€ä¸ªåä¸º <code>customRateLimiter</code> çš„ Beanã€‚ä¸‹é¢çš„æ¸…å•å®šä¹‰äº†ä¸€ä¸ªé€Ÿç‡é™åˆ¶å™¨ï¼Œå®ƒä½¿ç”¨ä¸Šä¸€ä¸ªå°èŠ‚é‡Œå®šä¹‰çš„  <code>KeyResolver</code> ï¼š</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰é™é€Ÿå™¨å»å®ç°ï¼š</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">CustomRateLimiter</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">RateLimiter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CustomRateLimiter<span class="token punctuation">.</span>Config</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&gt;</span></span> <span class="token function">isAllowed</span><span class="token punctuation">(</span><span class="token class-name">String</span> routeId<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¸å¿ƒæ–¹æ³•...é™æµé€»è¾‘</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token punctuation">&gt;</span></span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Config</span><span class="token punctuation">&gt;</span></span> <span class="token function">getConfigClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">Config</span> <span class="token function">newConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-int">int</span> replenishRate<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Min</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-int">int</span> burstCapacity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-int">int</span> requestedTokens <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-int">int</span> <span class="token function">getReplenishRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> replenishRate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token class-name">Config</span> <span class="token function">setReplenishRate</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> replenishRate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>replenishRate <span class="token operator">=</span> replenishRate<span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-int">int</span> <span class="token function">getBurstCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> burstCapacity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token class-name">Config</span> <span class="token function">setBurstCapacity</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> burstCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>burstCapacity <span class="token operator">=</span> burstCapacity<span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-int">int</span> <span class="token function">getRequestedTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> requestedTokens<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token class-name">Config</span> <span class="token function">setRequestedTokens</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> requestedTokens<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>requestedTokens <span class="token operator">=</span> requestedTokens<span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">ToStringCreator</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"replenishRate"</span><span class="token punctuation">,</span> replenishRate<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"burstCapacity"</span><span class="token punctuation">,</span> burstCapacity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"requestedTokens"</span><span class="token punctuation">,</span> requestedTokens<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><span style="font-size:14px;color:darkgray;">æ³¨æ„ï¼šä»¥ä¸Šä»£ç å¹¶ä¸å®Œæ•´ï¼Œå…·ä½“é™æµé€»è¾‘è‡ªè¡ŒæŒ‰ä¸šåŠ¡éœ€æ±‚ç¼–å†™ã€‚</span></p>
<h3 id="sentinel-é™æµ">Sentinel é™æµ </h3>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel</a></p>
</blockquote>
<p>Sentinel æ”¯æŒå¯¹ Spring Cloud Gateway ã€NetFlix Zuul ç­‰ä¸»æµçš„ API Gateway è¿›è¡Œé™æµã€‚</p>
<p><img src="./assets/image-20241224155220773.png" alt="image-20241224155220773"></p>
<h4 id="å•ç‹¬ä½¿ç”¨">å•ç‹¬ä½¿ç”¨ </h4>
<p>Sentinel æä¾›äº†ä¸ Spring Cloud Gateway çš„é›†æˆæ¨¡å—ã€‚é›†æˆæ¨¡å—åŸºäº Sentinel Reactor é€‚é…å™¨ã€‚</p>
<p>åœ¨  <code>pom.xml</code>  ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–é¡¹ï¼ˆå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Mavenï¼‰ï¼š</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-spring-cloud-gateway-adapter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>ä¸Šä¸‹æ–‡é…ç½®ï¼š</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">30000</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//bettytsai<span class="token punctuation">-</span>system
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
            
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># æŒ‡ç¤ºä» eureka æœåŠ¡å™¨è·å–æ³¨å†Œè¡¨ä¿¡æ¯çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚</span>
    <span class="token comment"># æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚</span>
    <span class="token comment"># é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</span>
    <span class="token comment"># ç¤ºä¾‹ï¼šhttps://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># è·å–è¦å‘ eureka æ³¨å†Œçš„æ­¤å®ä¾‹çš„å”¯ä¸€ IDï¼ˆåœ¨ appName èŒƒå›´å†…ï¼‰</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># æŒ‡ç¤º eureka å®¢æˆ·ç«¯éœ€è¦å‘ eureka æœåŠ¡å™¨å‘é€å¿ƒè·³ä»¥æŒ‡ç¤ºå®ƒä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</span>
    <span class="token comment"># å¦‚æœåœ¨ leaseExpirationDurationInSeconds ä¸­æŒ‡å®šçš„æ—¶é—´æ®µå†…æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ eureka æœåŠ¡å™¨å°†ä»å…¶è§†å›¾ä¸­åˆ é™¤è¯¥å®ä¾‹ï¼Œ</span>
    <span class="token comment"># ä»è€Œç¦æ­¢æµå‘æ­¤å®ä¾‹çš„æµé‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœå®ä¾‹å®ç° HealthCheckCallbackï¼Œç„¶åå†³å®šä½¿è‡ªèº«ä¸å¯ç”¨ï¼Œåˆ™å®ä¾‹ä»ç„¶æ— æ³•è·å–æµé‡ã€‚</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># å¿…é¡»ä¸Dockerå®¹å™¨åä¿æŒä¸€è‡´</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
</code></pre><p>ç„¶åï¼Œæ‚¨åªéœ€åœ¨ Spring é…ç½®ä¸­æ³¨å…¥ç›¸åº”çš„  <code>SentinelGatewayFilter</code>  å’Œ  <code>SentinelGatewayBlockExceptionHandler</code>  å®ä¾‹å³å¯ã€‚ä¾‹å¦‚ï¼š</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">SentinelConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span></span> viewResolvers<span class="token punctuation">;</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token class-name">SentinelConfig</span><span class="token punctuation">(</span><span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> viewResolversProvider<span class="token punctuation">,</span>
                          <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>viewResolvers <span class="token operator">=</span> viewResolversProvider<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token operator">::</span><span class="token function">emptyList</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>serverCodecConfigurer <span class="token operator">=</span> serverCodecConfigurer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span> <span class="token function">sentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Register the block exception handler for Spring Cloud Gateway.</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span>viewResolvers<span class="token punctuation">,</span> serverCodecConfigurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">sentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">SentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">doInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// é™æµè§„åˆ™</span>
        <span class="token class-name">GatewayFlowRule</span> rule <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//èµ„æºåç§°æˆ–è€…æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„APIåˆ†ç»„åç§°</span>
        rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é™æµé˜ˆå€¼ï¼Œè¡¨ç¤ºåœ¨ç»Ÿè®¡æ—¶é—´çª—å£å†…ï¼Œè¶…è¿‡é™æµé˜ˆå€¼ï¼Œè¿”å› HTTP 429</span>
        rule<span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç»Ÿè®¡æ—¶é—´çª—å£ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤ 1 ç§’</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ è½½ç½‘å…³é™æµè§„åˆ™</span>
        <span class="token class-name">GatewayRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰“å¼€ Postman æ¨¡æ‹Ÿå¤§é‡è¯·æ±‚æµ‹è¯•åï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224170731441.png" alt="image-20241224170731441"></p>
<p>ç½‘å…³é€‚é…å™¨ä¼šå°†æ‰€æœ‰  <code>routeId</code> ï¼ˆåœ¨ Spring å±æ€§ä¸­å®šä¹‰ï¼‰å’Œæ‰€æœ‰è‡ªå®šä¹‰çš„ API å®šä¹‰ï¼ˆåœ¨æ¨¡å—çš„  <code>sentinel-api-gateway-adapter-common</code>  çš„ç±» <code>GatewayApiDefinitionManager</code>  ä¸­å®šä¹‰ï¼‰è§†ä¸ºèµ„æºã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨  <code>GatewayCallbackManager</code>  ä¸­æ³¨å†Œå„ç§è‡ªå®šä¹‰å›è°ƒï¼š</p>
<ul>
<li><code>setBlockHandler</code> ï¼šæ³¨å†Œä¸€ä¸ªè‡ªå®šä¹‰çš„  <code>BlockRequestHandler</code>  æ¥å¤„ç†è¢«æ‹¦æˆªçš„è¯·æ±‚ã€‚é»˜è®¤å®ç°æ˜¯  <code>DefaultBlockRequestHandler</code> ï¼Œå®ƒè¿”å›é»˜è®¤æ¶ˆæ¯ï¼Œå¦‚   <code>Blocked by Sentinel: FlowException</code>  ã€‚</li>
</ul>
<h4 id="ç»“åˆstartä½¿ç”¨æ¨è">ç»“åˆStartä½¿ç”¨ï¼ˆæ¨èï¼‰ </h4>
<blockquote>
<p>å¦‚æœéœ€è¦åœ¨ Sentinel æ§åˆ¶å°ç®¡ç† ç½‘å…³æ¨¡å—çš„é™æµï¼Œé‚£ä¹ˆæ¨èè¿™ç§é…ç½®æ–¹å¼ã€‚</p>
</blockquote>
<p>å¦‚æœè¦å°† Sentinel Starter ä¸ Spring Cloud Gateway ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™éœ€è¦æ·»åŠ   <code>spring-cloud-alibaba-sentinel-gateway</code>  ä¾èµ–é¡¹å¹¶æ·»åŠ   <code>spring-cloud-starter-gateway</code>  ä¾èµ–é¡¹ï¼Œä»¥ä½¿æ¨¡å—ä¸­çš„ Spring Cloud Gateway AutoConfiguration ç±»ç”Ÿæ•ˆï¼š</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-sentinel-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>åŒæ—¶è¯·å°†  <code>spring.cloud.sentinel.filter.enabled</code>  é…ç½®é¡¹ç½®ä¸º falseï¼ˆè‹¥åœ¨ç½‘å…³æµæ§æ§åˆ¶å°ä¸Šçœ‹åˆ°äº† URL èµ„æºï¼Œå°±æ˜¯æ­¤é…ç½®é¡¹æ²¡æœ‰ç½®ä¸º falseï¼‰ã€‚Sentinel ç½‘å…³æµæ§é»˜è®¤çš„ç²’åº¦æ˜¯ route ç»´åº¦ä»¥åŠè‡ªå®šä¹‰ API åˆ†ç»„ç»´åº¦ï¼Œé»˜è®¤ä¸æ”¯æŒ URL ç²’åº¦ã€‚å¦‚éœ€ç»†åŒ–åˆ° URL ç²’åº¦ï¼Œè¯·å‚è€ƒ <a href="https://sentinelguard.io/zh-cn/docs/api-gateway-flow-control.html">ç½‘å…³æµæ§æ–‡æ¡£</a> è‡ªå®šä¹‰ API åˆ†ç»„ã€‚</p>
<p><strong>æ³¨æ„</strong> ï¼šç½‘å…³æµæ§è§„åˆ™æ•°æ®æºç±»å‹æ˜¯  <code>gw-flow</code> ï¼Œè‹¥å°†ç½‘å…³æµæ§è§„åˆ™æ•°æ®æºæŒ‡å®šä¸º flow åˆ™ä¸ç”Ÿæ•ˆã€‚</p>
<p>å¦‚æœé€‰æ‹©é€šè¿‡Javaä»£ç å®ç°é…ç½®é™æµ-ç†”æ–­è§„åˆ™ï¼Œåˆ™æˆ‘ä»¬éœ€è¦ç¼–å†™é™æµé…ç½®ç±»ï¼š</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">SentinelConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">doInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// é™æµè§„åˆ™</span>
        <span class="token class-name">GatewayFlowRule</span> rule <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//èµ„æºåç§°æˆ–è€…æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„APIåˆ†ç»„åç§°</span>
        rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é™æµé˜ˆå€¼ï¼Œè¡¨ç¤ºåœ¨ç»Ÿè®¡æ—¶é—´çª—å£å†…ï¼Œè¶…è¿‡é™æµé˜ˆå€¼ï¼Œè¿”å› HTTP 429</span>
        rule<span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç»Ÿè®¡æ—¶é—´çª—å£ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤ 1 ç§’</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ è½½ç½‘å…³é™æµè§„åˆ™</span>
        <span class="token class-name">GatewayRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>å¦‚æœé€‰æ‹©ä½¿ç”¨ Sentinel æ§åˆ¶å°é…ç½®é™æµ-ç†”æ–­è§„åˆ™ï¼Œé‚£ä¹ˆè¿˜éœ€è¦åœ¨ gateway çš„é…ç½®æ–‡ä»¶ä¸­åšå‡ºå¦‚ä¸‹é…ç½®ï¼š</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment"># Sentinel æ§åˆ¶å°è¿æ¥é…ç½®</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
       <span class="token comment"># å½“å‰æœåŠ¡ä¸æ§åˆ¶å°äº¤äº’çš„ç«¯å£å·,é»˜è®¤ä¸º8719,åŒä¸€ä¸ªæœºå™¨ä¸Šè‹¥æœ‰å¤šä¸ªåº”ç”¨äºæ§åˆ¶å°äº¤äº’æ—¶éœ€è¦è®¾ç½®æˆä¸åŒçš„ç«¯å£</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8739</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 10.<span class="token important">*.*.77:</span><span class="token number">9090</span>
      <span class="token comment"># æœåŠ¡å¯åŠ¨æ—¶ç›´æ¥å»ºç«‹å¿ƒè·³è¿æ¥</span>
      <span class="token key atrule">eager</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># Sentinel å‚¨å­˜è§„åˆ™çš„æ•°æ®æºé…ç½®(ä½¿ç”¨çš„æ˜¯Nacosæ¥å­˜å‚¨Sentinelçš„é™æµè§„åˆ™)</span>
      <span class="token comment">#datasource:</span>
      <span class="token comment">#  ds:</span>
      <span class="token comment">#    nacos:</span>
            <span class="token comment"># Nacos æœåŠ¡åœ°å€ï¼ˆå¯é…ç½®å•ç‚¹ï¼Œæˆ–è€…é›†ç¾¤çš„VIPåœ°å€ï¼‰</span>
      <span class="token comment">#      server-addr: 10.1.3.76:8848</span>
      <span class="token comment">#      dataId: ${spring.application.name}-sentinel</span>
      <span class="token comment">#      groupId: DEFAULT_GROUP</span>
      <span class="token comment">#      namespace: sms-dev</span>
      <span class="token comment">#      rule-type: flow</span>
<span class="token comment"># Sentinel æ§åˆ¶å°é‰´æƒé…ç½®</span>
<span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
  <span class="token key atrule">dashboard</span><span class="token punctuation">:</span>
    <span class="token key atrule">auth</span><span class="token punctuation">:</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> sentinel
      <span class="token key atrule">password</span><span class="token punctuation">:</span> sentinel
</code></pre><h4 id="è‡ªå®šä¹‰é™æµå¼‚å¸¸å¤„ç†å™¨">è‡ªå®šä¹‰é™æµå¼‚å¸¸å¤„ç†å™¨ </h4>
<p>GatewayCallbackManager çš„  <code>setBlockHandler()</code>  æ³¨å†Œå‡½æ•°ç”¨äºå®ç°è‡ªå®šä¹‰å¼‚å¸¸çš„é€»è¾‘ï¼Œç”¨äºå¤„ç†è¢«é™æµçš„è¯·æ±‚ã€‚</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">SentinelConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span></span> viewResolvers<span class="token punctuation">;</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token class-name">SentinelConfig</span><span class="token punctuation">(</span><span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> viewResolversProvider<span class="token punctuation">,</span>
                                <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>viewResolvers <span class="token operator">=</span> viewResolversProvider<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token operator">::</span><span class="token function">emptyList</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>serverCodecConfigurer <span class="token operator">=</span> serverCodecConfigurer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span> <span class="token function">sentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Register the block exception handler for Spring Cloud Gateway.</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span>viewResolvers<span class="token punctuation">,</span> serverCodecConfigurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">sentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">SentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">doInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// é™æµè§„åˆ™</span>
        <span class="token class-name">GatewayFlowRule</span> rule <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//èµ„æºåç§°æˆ–è€…æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„APIåˆ†ç»„åç§°</span>
        rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é™æµé˜ˆå€¼ï¼Œè¡¨ç¤ºåœ¨ç»Ÿè®¡æ—¶é—´çª—å£å†…ï¼Œè¶…è¿‡é™æµé˜ˆå€¼ï¼Œè¿”å› HTTP 429</span>
        rule<span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç»Ÿè®¡æ—¶é—´çª—å£ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤ 1 ç§’</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ è½½ç½‘å…³é™æµè§„åˆ™</span>
        <span class="token class-name">GatewayRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">initBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// åŠ è½½è‡ªå®šä¹‰é™æµå¼‚å¸¸å¤„ç†å™¨</span>
        <span class="token class-name">GatewayCallbackManager</span><span class="token punctuation">.</span><span class="token function">setBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>serverWebExchange<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">.</span><span class="token function">getReasonPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"route"</span><span class="token punctuation">,</span> <span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">BodyInserters</span><span class="token punctuation">.</span><span class="token function">fromValue</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰“å¼€ Postman ï¼Œæ¨¡æ‹Ÿå¤§é‡è¯·æ±‚ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224173807552.png" alt="image-20241224173807552"></p>
<h4 id="åˆ†ç»„é™æµ">åˆ†ç»„é™æµ </h4>
<blockquote>
<p>Sentinel æ”¯æŒåˆ†ç»„é™æµé…ç½®ï¼Œä¸‹é¢ç®€å•æ¼”ç¤ºå¦‚ä½•è¿›è¡Œåˆ†ç»„é™æµã€‚</p>
</blockquote>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">SentinelConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span></span> viewResolvers<span class="token punctuation">;</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token class-name">SentinelConfig</span><span class="token punctuation">(</span><span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> viewResolversProvider<span class="token punctuation">,</span>
                          <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>viewResolvers <span class="token operator">=</span> viewResolversProvider<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token operator">::</span><span class="token function">emptyList</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>serverCodecConfigurer <span class="token operator">=</span> serverCodecConfigurer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span> <span class="token function">sentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Register the block exception handler for Spring Cloud Gateway.</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span>viewResolvers<span class="token punctuation">,</span> serverCodecConfigurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">sentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">SentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">doInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system-group"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token string">"bettytsai-test-group"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ è½½ç½‘å…³é™æµè§„åˆ™</span>
        <span class="token class-name">GatewayRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ è½½é™æµåˆ†ç»„</span>
        <span class="token function">initSentinelGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">initBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åŠ è½½è‡ªå®šä¹‰é™æµå¼‚å¸¸å¤„ç†å™¨</span>
        <span class="token class-name">GatewayCallbackManager</span><span class="token punctuation">.</span><span class="token function">setBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>serverWebExchange<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">.</span><span class="token function">getReasonPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"route"</span><span class="token punctuation">,</span> <span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">BodyInserters</span><span class="token punctuation">.</span><span class="token function">fromValue</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-void">void</span> <span class="token function">initSentinelGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiDefinition</span><span class="token punctuation">&gt;</span></span> definitions <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç»„ bettytsai-system-group</span>
        <span class="token class-name">ApiDefinition</span> api1 <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">ApiDefinition</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system-group"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPredicateItems</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiPredicateItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>
                    <span class="token comment">// åŒ¹é… /bettytsai-system/system/** ä»¥åŠå…¶å­è·¯å¾„çš„æ‰€æœ‰è¯·æ±‚</span>
                    <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">ApiPathPredicateItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPattern</span><span class="token punctuation">(</span><span class="token string">"/bettytsai-system/system/**"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setMatchStrategy</span><span class="token punctuation">(</span><span class="token class-name">SentinelGatewayConstants</span><span class="token punctuation">.</span><span class="token constant">URL_MATCH_STRATEGY_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç»„ bettytsai-test-group</span>
        <span class="token class-name">ApiDefinition</span> api2 <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">ApiDefinition</span><span class="token punctuation">(</span><span class="token string">"bettytsai-test-group"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPredicateItems</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiPredicateItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>
                    <span class="token comment">// åŒ¹é… /bettytsai-test/test/** ä»¥åŠå…¶å­è·¯å¾„çš„æ‰€æœ‰è¯·æ±‚</span>
                    <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">ApiPathPredicateItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPattern</span><span class="token punctuation">(</span><span class="token string">"/bettytsai-test/test/**"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setMatchStrategy</span><span class="token punctuation">(</span><span class="token class-name">SentinelGatewayConstants</span><span class="token punctuation">.</span><span class="token constant">URL_MATCH_STRATEGY_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        definitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        definitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ è½½é™æµåˆ†ç»„</span>
        <span class="token class-name">GatewayApiDefinitionManager</span><span class="token punctuation">.</span><span class="token function">loadApiDefinitions</span><span class="token punctuation">(</span>definitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>æ‰“å¼€ Postman æ¨¡æ‹Ÿå¤§é‡è¯·æ±‚è¿›æ¥ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224175358104.png" alt="image-20241224175358104"></p>
<h2 id="é«˜å¯ç”¨ç½‘å…³æ­å»º">é«˜å¯ç”¨ç½‘å…³æ­å»º </h2>
<p>ä¸šå†…é€šå¸¸ç”¨å¤šå°‘ä¸ª 9 æ¥è¡¡é‡ç½‘ç«™çš„å¯ç”¨æ€§ï¼Œä¾‹å¦‚ QQ çš„å¯ç”¨æ€§æ˜¯ 4 ä¸ª 9 ï¼Œå°±æ˜¯è¯´ QQ èƒ½å¤Ÿä¿è¯åœ¨ä¸€å¹´é‡Œï¼ŒæœåŠ¡åœ¨ 99.99% çš„æ—¶é—´æ˜¯å¯ç”¨çš„ï¼Œåªæœ‰ 0.01% çš„æ—¶é—´ä¸å¯ç”¨ï¼Œå¤§çº¦æœ€å¤š53åˆ†é’Ÿï¼Œè¿™æ˜¯ååˆ†ç‰›é€¼çš„ã€‚</p>
<p>å¯¹äºå¤§å¤šæ•°ç½‘ç«™æ¥è¯´ï¼Œ2ä¸ª 9 æ˜¯åŸºæœ¬å¯ç”¨ã€3 ä¸ª 9 å°±ä»£è¡¨é«˜å¯ç”¨ã€4 ä¸ª 9 å°±æ˜¯æ‹¥æœ‰è‡ªåŠ¨æ¢å¤èƒ½åŠ›çš„é«˜å¯ç”¨ã€‚</p>
<p>å®ç°é«˜å¯ç”¨çš„ä¸»è¦æ‰‹æ®µå°±æ˜¯ æ•°æ®çš„å†—ä½™å¤‡ä»½å’Œ æœåŠ¡æ•…éšœè½¬ç§»ï¼Œè¿™ä¸¤ä¸ªæ‰‹æ®µå…·ä½“å¯ä»¥æ€ä¹ˆåšï¼Œåœ¨ç½‘å…³ä¸­å¦‚ä½•å®ç°ï¼Ÿä¸»è¦é’ˆå¯¹ä»¥ä¸‹å‡ ä¸ªæ–¹å‘ï¼š</p>
<ul>
<li>é›†ç¾¤éƒ¨ç½²</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>å¥åº·æ£€æŸ¥</li>
<li>èŠ‚ç‚¹è‡ªåŠ¨é‡å¯</li>
<li>ç†”æ–­</li>
<li>æœåŠ¡é™çº§</li>
<li>æ¥å£é‡è¯•</li>
</ul>
<h3 id="nginx--ç½‘å…³é›†ç¾¤å®ç°é«˜å¯ç”¨ç½‘å…³">Nginx + ç½‘å…³é›†ç¾¤å®ç°é«˜å¯ç”¨ç½‘å…³ </h3>
<img src="./assets/image-20241224200645668.png" alt="image-20241224200645668" style="zoom:80%;">
<h4 id="ä¸‹è½½å®‰è£…-nginx">ä¸‹è½½å®‰è£… Nginx </h4>
<p>è¯¦è§ <a href="">ç¬¬ä¹ç«  Nginx å®ç°API ç½‘å…³</a>ã€‚</p>
<h4 id="é…ç½®ç½‘å…³é›†ç¾¤">é…ç½®ç½‘å…³é›†ç¾¤ </h4>
<p><em>nginx.conf</em></p>
<pre data-role="codeBlock" data-info="shell" class="language-shell shell"><code>worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>
events <span class="token punctuation">{</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{</span>
    include       mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>
    
    sendfile        on<span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>

    <span class="token comment"># é…ç½®ç½‘å…³é›†ç¾¤</span>
    upstream gateway <span class="token punctuation">{</span>
		server <span class="token number">127.0</span>.0.1:30000<span class="token punctuation">;</span>
		server <span class="token number">127.0</span>.0.1:30001<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    server <span class="token punctuation">{</span>
        listen       <span class="token number">80</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
        
        <span class="token comment"># nginx å°†è¯·æ±‚åˆ†å‘è‡³ç½‘å…³é›†ç¾¤</span>
        location / <span class="token punctuation">{</span>
			proxy_pass http://gateway<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="éªŒè¯é«˜å¯ç”¨ç½‘å…³">éªŒè¯é«˜å¯ç”¨ç½‘å…³ </h4>
<p>æˆ‘ä»¬æŠŠæˆ‘ä»¬çš„ç½‘å…³æœåŠ¡æ‰“æˆ  <code>jar</code>  åŒ…é€šè¿‡æ§åˆ¶å°ä¿®æ”¹å‚æ•°  <code>-Dserver.port</code>  å»å¯åŠ¨ï¼Œè¿™æ ·æˆ‘å°±ä¸éœ€è¦å†å»ºä¸€ä¸ªæ¨¡å—å»å‡‘é›†ç¾¤æœåŠ¡äº†ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224202710253.png" alt="image-20241224202710253"></p>
<p>ç„¶åæˆ‘ä»¬å†å¯åŠ¨ Nginx æœåŠ¡ï¼ŒIDEA ä¸­ä»…å¯åŠ¨ æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡æä¾›è€…ï¼š</p>
<p><img src="./assets/image-20241224202845465.png" alt="image-20241224202845465"></p>
<p>æ‰“å¼€ Postman è¿›è¡Œæµ‹è¯•ï¼Œæ¨¡æ‹Ÿå¤§é‡è¯·æ±‚è®¿é—®ï¼š</p>
<p><img src="./assets/image-20241224203008409.png" alt="image-20241224203008409"></p>
<p>è¯·æ±‚è½¬å‘æˆåŠŸçš„æƒ…å†µå¦‚ä¸Šæ‰€ç¤ºï¼Œè¯·æ±‚é™æµç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="./assets/image-20241224203056346.png" alt="image-20241224203056346"></p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>