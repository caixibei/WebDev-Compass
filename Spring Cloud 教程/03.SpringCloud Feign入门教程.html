<!DOCTYPE html><html><head>
      <title>03.SpringCloud Feign入门教程</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\caixi\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
	  </head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="springcloud-feign声明式服务调用">SpringCloud Feign声明式服务调用 </h1>
<div style="display:flex;">
    <div style="margin-left:auto;color:#3795f7;"><strong>作者：</strong>蔡熙贝</div>
</div>
<h2 id="学习目标">学习目标 </h2>
<p><img src="assets/image-20251220213422045.png" alt="image-20251220213422045"></p>
<h2 id="什么是feign">什么是Feign? </h2>
<p>Feign 是 Spring Cloud Netflix 组件中的一个轻量级 RESTful 的 HTTP 服务客户端，实现了负载均衡和 rest 调用的开源框架，封装了 Ribbon 和 RestTemplate ，实现了 WebService 的面向编程接口，进一步降低了项目的耦合度。</p>
<p>接下来，我们一起看下 Feign 的一些基本认知：</p>
<ul>
<li>Feign 内置了 Ribbon ，用来做客户端负载均衡调用服务注册中心的服务；</li>
<li>Feign 其本身并不支持 Spring MVC 的注解，他有一套自己的注解，为了更方便的使用，Spring Cloud 孵化了 OpenFeign；</li>
<li>Feign 是一种声明式、模块化的HTTP客户端（仅在 Consumer 中使用）；</li>
<li>Feign 支持的注解和用法可以在 <a href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a> 中查看文档；</li>
<li>Feign 的使用方式：使用 Feign 注解定义接口，调用这个接口，就可以调用服务注册中心的服务；</li>
</ul>
<h2 id="feign-解决什么问题">Feign 解决什么问题? </h2>
<p>Feign 旨在使编写 Java HTTP 客户端变得更加容易，Feign 简化了 RestTemplate 代码，实现了 Ribbon 负载均衡，使代码变得更加简洁，也少了客户端调用的代码，使用 Feign 实现负载均很是首选方案。只需要你创建一个接口，然后在上面添加注解即可。</p>
<p>Feign 作为声明式服务调用组件，其核心就是:  <span style="color:#FF8400;">像调用本地方法一样调用远程方法，无感知 HTTP 请求。</span></p>
<ul>
<li>解决了让开发者调用远程接口就像调用本地方法一样的体验，开发者完全感知不到这是远程方法，更感知不到这是个 HTTP请求。无需关注与远程的交互细节，更无需关注分布式环境开发。</li>
<li>同 Dubbo一样，Consumer 直接调用 Provider 接口方法，而不需要通过常规的 Http Client 构造请求再解析返回数据。</li>
</ul>
<h2 id="feign-vs-openfeign">Feign VS OpenFeign </h2>
<p>OpenFeign 是 Spring Cloud 在 Feign 的基础上支持了  Spring MVC 的注解，比如： <code>@RequestMapping</code> 、 <code>@PathVariable</code> 等。</p>
<p>OpenFeign 的  <code>@FeignClient</code>  可以解析 SpringMVC 的  <code>@RequestMapping</code>  注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用服务。</p>
<h2 id="feign-入门案例">Feign 入门案例 </h2>
<p>Feign 的使用主要分为以下几个步骤：</p>
<ol>
<li>服务消费者添加 Feign 依赖；</li>
<li>创建业务层接口，添加  <code>@FeignClient</code>  注解声明需要调用的服务；</li>
<li>业务层抽象方法使用 SpringMVC 注解配置服务地址及参数；</li>
<li>启动类添加  <code>@EnableFeignClients</code>  注解激活 Feign 组件；</li>
</ol>
<h3 id="创建项目">创建项目 </h3>
<blockquote>
<p>这里我们还是使用之前学习 Eureka 的项目继续创建子模块去演示，这里我们不展示之前学习过的模块配置，如需要，请自己按照顺序学习组件。</p>
</blockquote>
<p>无论服务消费者通过 Eureka 注册中心获取服务，或者 Ribbon 点对点直连模式都是可以直接使用 Feign 来实现的，所创建的项目的结构如下所示：</p>
<img src="./assets/image-20241203150229604.png" alt="image-20241203150229604" style="zoom:80%;">
<h4 id="服务提供者">服务提供者 </h4>
<p>这里我们使用  <code>bettytsai-system</code>  模块作为服务的提供者提供服务接口，具体配置情况如下所示。</p>
<ul>
<li>依赖配置</li>
</ul>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bettytsai-system-master<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.knowledgehub<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bettytsai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.inject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.inject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		
		<span class="token comment">&lt;!-- 我自己封装的私库依赖，未开放公共仓库，只是一些工具类 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tsaiframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tsai-spring-boot-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classifier</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classifier</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-boot.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fork</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fork</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includeSystemScope</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includeSystemScope</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>repackage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><ul>
<li>上下文配置</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>system
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token comment"># 是否启用配置数据处理旧模式</span>
    <span class="token key atrule">use-legacy-processing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">druid</span><span class="token punctuation">:</span>
      <span class="token key atrule">keep-alive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">20</span>
      <span class="token key atrule">initial-size</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">360000</span>
      <span class="token key atrule">use-unfair-lock</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">time-between-eviction-runs-millis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
      <span class="token key atrule">min-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">30000</span>
      <span class="token key atrule">max-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">180000</span>
      <span class="token key atrule">pool-prepared-statements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">max-open-prepared-statements</span><span class="token punctuation">:</span> <span class="token number">20</span>
      <span class="token key atrule">phy-timeout-millis</span><span class="token punctuation">:</span> <span class="token number">15000</span>
      <span class="token key atrule">pxove-abandoned</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">pxove-abandoned-timeout</span><span class="token punctuation">:</span> <span class="token number">180</span>
      <span class="token key atrule">test-while-idle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">test-on-borrow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">test-on-return</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">filter</span><span class="token punctuation">:</span>
        <span class="token key atrule">wall</span><span class="token punctuation">:</span>
          <span class="token key atrule">config</span><span class="token punctuation">:</span>
            <span class="token key atrule">multi-statement-allow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">drop-table-allow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">stat</span><span class="token punctuation">:</span>
          <span class="token key atrule">log-slow-sql</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">slow-sql-millis</span><span class="token punctuation">:</span> <span class="token number">1000</span>
          <span class="token key atrule">merge-sql</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">web-stat-filter</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">url-pattern</span><span class="token punctuation">:</span> /*
        <span class="token key atrule">exclusions</span><span class="token punctuation">:</span> /<span class="token important">*.js</span><span class="token punctuation">,</span>/<span class="token important">*.gif</span><span class="token punctuation">,</span>/<span class="token important">*.jpg</span><span class="token punctuation">,</span>/<span class="token important">*.bmp</span><span class="token punctuation">,</span>/<span class="token important">*.png</span><span class="token punctuation">,</span>/<span class="token important">*.css</span><span class="token punctuation">,</span>/<span class="token important">*.ico</span><span class="token punctuation">,</span>/druid/*
        <span class="token key atrule">session-stat-enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">profile-enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">stat-view-servlet</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">allow</span><span class="token punctuation">:</span>
        <span class="token key atrule">reset-enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">login-username</span><span class="token punctuation">:</span> soaadmin
        <span class="token key atrule">login-password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
        <span class="token key atrule">url-pattern</span><span class="token punctuation">:</span> /druid/*
    <span class="token key atrule">dynamic</span><span class="token punctuation">:</span>
      <span class="token key atrule">primary</span><span class="token punctuation">:</span> db2
      <span class="token key atrule">strict</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token key atrule">db2</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
          <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.ibm.db2.jcc.DB2Driver
          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>db2<span class="token punctuation">:</span>//sjcj<span class="token punctuation">-</span>mydb2<span class="token punctuation">:</span>50000/USERID<span class="token punctuation">:</span>currentSchema=USERID;
          <span class="token key atrule">username</span><span class="token punctuation">:</span> db2inst1
          <span class="token key atrule">password</span><span class="token punctuation">:</span> db2admin
          <span class="token key atrule">druid</span><span class="token punctuation">:</span>
            <span class="token key atrule">initial-size</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">20</span>
            <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">360000</span>
            <span class="token key atrule">use-unfair-lock</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">min-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">30000</span>
            <span class="token key atrule">max-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">180000</span>
            <span class="token key atrule">time-between-eviction-runs-millis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
            <span class="token key atrule">validation-query</span><span class="token punctuation">:</span> select current date from sysibm.sysdummy1
            <span class="token key atrule">validation-query-timeout</span><span class="token punctuation">:</span> <span class="token number">-1</span>
            <span class="token key atrule">test-on-borrow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token key atrule">test-on-return</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token key atrule">test-while-idle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">pool-prepared-statements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat<span class="token punctuation">,</span>wall
            <span class="token key atrule">share-prepared-statements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
          <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//sjcj<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span>3306/hr<span class="token punctuation">-</span>sjcj<span class="token punctuation">?</span>allowMultiQueries=true<span class="token important">&amp;characterEncoding=utf8&amp;nullCatalogMeansCurrent=true</span>
          <span class="token key atrule">username</span><span class="token punctuation">:</span> root
          <span class="token key atrule">password</span><span class="token punctuation">:</span> hr123
          <span class="token key atrule">druid</span><span class="token punctuation">:</span>
            <span class="token key atrule">initial-size</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">20</span>
            <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">360000</span>
            <span class="token key atrule">use-unfair-lock</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">min-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">30000</span>
            <span class="token key atrule">max-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">180000</span>
            <span class="token key atrule">time-between-eviction-runs-millis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
            <span class="token key atrule">validation-query</span><span class="token punctuation">:</span> select 1
            <span class="token key atrule">validation-query-timeout</span><span class="token punctuation">:</span> <span class="token number">-1</span>
            <span class="token key atrule">test-on-borrow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token key atrule">test-on-return</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token key atrule">test-while-idle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">pool-prepared-statements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat<span class="token punctuation">,</span>wall
            <span class="token key atrule">share-prepared-statements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tlogs/$<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># 指示此客户端是否应从 eureka 服务器获取 eureka 注册表信息。</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示此实例是否应将其信息注册到 eureka 服务器以供其他人发现。在某些情况下，您不希望发现您的实例，而您只想发现其他实例。</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示从 eureka 服务器获取注册表信息的频率（以秒为单位）。</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># 将可用区映射到用于与 eureka 服务器通信的完全限定 URL 列表。</span>
    <span class="token comment"># 每个值可以是单个 URL 或逗号分隔的备用位置列表。</span>
    <span class="token comment"># 通常，eureka 服务器 URL 携带协议、主机、端口、上下文和版本信息（如果有）。</span>
    <span class="token comment"># 示例：https://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># 更改在运行时在 eurekaServiceUrlPollIntervalSeconds 指定的下一个服务 url 刷新周期生效。</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8762/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># 标志表示，在猜测主机名时，应优先使用服务器的 IP 地址，而不是操作系统报告的主机名。</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 获取要向 eureka 注册的此实例的唯一 ID（在 appName 范围内）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 指示 eureka 客户端需要向 eureka 服务器发送心跳以指示它仍然处于活动状态的频率（以秒为单位）。</span>
    <span class="token comment"># 如果在 leaseExpirationDurationInSeconds 中指定的时间段内未收到心跳，则 eureka 服务器将从其视图中删除该实例，</span>
    <span class="token comment"># 从而禁止流向此实例的流量。请注意，如果实例实现 HealthCheckCallback，然后决定使自身不可用，则实例仍然无法获取流量。</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># 必须与Docker容器名保持一致</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
<span class="token comment"># 度量指标监控与健康检查</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> info<span class="token punctuation">,</span>shutdown
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">shutdown</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-packages</span><span class="token punctuation">:</span> io.knowledgehub.bettytsai.<span class="token important">**.mapper</span>
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/mapper/<span class="token important">*-mapper.xml</span>
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
    <span class="token key atrule">db-config</span><span class="token punctuation">:</span>
      <span class="token key atrule">id-type</span><span class="token punctuation">:</span> assign_uuid
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">log-impl</span><span class="token punctuation">:</span> org.apache.ibatis.logging.stdout.StdOutImpl
</code></pre><p>部分配置是需要适配我自己封装的工具类才能用，但大部分不受影响。同时，我们只是为了测试 Feign 的功能，并不需要添加数据库的配置，涉及 <code>ORM</code> 框架的问题，我们暂时不做出解释。</p>
<ul>
<li>创建服务接口</li>
</ul>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 获取默认标签
     * <span class="token keyword keyword-@return">@return</span> <span class="token punctuation">{</span><span class="token keyword keyword-@link">@link</span> <span class="token reference"><span class="token class-name">String</span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token class-name">String</span> <span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token comment">// 主</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">TestServiceImpl</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===============&gt; system-master...{}"</span><span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token string">"hello eureka,I'm system master module."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>为了后期区分出来负载均衡调用的差别，所以我们从服务写的测试服务接口改动了几个字，其他配置基本一致，我们再给出从服务的接口：</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token comment">// 从</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">TestServiceImpl</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===============&gt; system-slave...{}"</span><span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token string">"hello eureka,I'm system slave module."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/system/test"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token class-name">WarningsConstants</span><span class="token punctuation">.</span><span class="token constant">SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">TestService</span> testService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getDefaultString"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> testService<span class="token punctuation">.</span><span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="测试服务接口">测试服务接口 </h4>
<p>依次启动注册中心及服务，打开  <code>http://127.0.0.1:8761/</code> 访问页面，具体所示如下：</p>
<p><img src="./assets/image-20241205143951382-17351894680231.png" alt="image-20241205143951382"></p>
<p>调用服务接口，接口访问成功，具体如图所示：</p>
<p><img src="./assets/image-20241205144136201.png" alt="image-20241205144136201"></p>
<h4 id="服务消费者">服务消费者 </h4>
<p>到这里为止，我们的一系列准备工作基本完成，现在我们来一起通过简单的使用案例来学习下 Feign 。</p>
<ul>
<li>依赖配置</li>
</ul>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bettytsai-demo-master<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.knowledgehub<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bettytsai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		
        <span class="token comment">&lt;!--提供spring mvc一系列的注解支持 openfeign--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		
        <span class="token comment">&lt;!--依旧需要通过注册中心拉取服务列表--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.inject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.inject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        
		<span class="token comment">&lt;!--添加openfeign依赖--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tsaiframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tsai-spring-boot-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classifier</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classifier</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-boot.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fork</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fork</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includeSystemScope</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includeSystemScope</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>repackage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><ul>
<li>上下文配置</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9004</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 应用名称</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>demo
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># 指示此客户端是否应从 eureka 服务器获取 eureka 注册表信息。</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示此实例是否应将其信息注册到 eureka 服务器以供其他人发现。在某些情况下，您不希望发现您的实例，而您只想发现其他实例。</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示从 eureka 服务器获取注册表信息的频率（以秒为单位）。</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># 将可用区映射到用于与 eureka 服务器通信的完全限定 URL 列表。</span>
    <span class="token comment"># 每个值可以是单个 URL 或逗号分隔的备用位置列表。</span>
    <span class="token comment"># 通常，eureka 服务器 URL 携带协议、主机、端口、上下文和版本信息（如果有）。</span>
    <span class="token comment"># 示例：https://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># 更改在运行时在 eurekaServiceUrlPollIntervalSeconds 指定的下一个服务 url 刷新周期生效。</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8762/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># 标志表示，在猜测主机名时，应优先使用服务器的 IP 地址，而不是操作系统报告的主机名。</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 获取要向 eureka 注册的此实例的唯一 ID（在 appName 范围内）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 指示 eureka 客户端需要向 eureka 服务器发送心跳以指示它仍然处于活动状态的频率（以秒为单位）。</span>
    <span class="token comment"># 如果在 leaseExpirationDurationInSeconds 中指定的时间段内未收到心跳，则 eureka 服务器将从其视图中删除该实例，</span>
    <span class="token comment"># 从而禁止流向此实例的流量。请注意，如果实例实现 HealthCheckCallback，然后决定使自身不可用，则实例仍然无法获取流量。</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># 必须与Docker容器名保持一致</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token comment"># 日志文件名称前缀</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 日志的存放路径</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tlogs/$<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
</code></pre><ul>
<li>服务消费接口</li>
</ul>
<p><em>DemoService.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">DemoService</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><p><em>DemoServiceImpl.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DemoServiceImpl</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">DemoService</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><p><em>SystemService.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token comment">// 声明需要调用的微服务模块</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">SystemService</span> <span class="token punctuation">{</span>
	
    <span class="token comment">// 调用的微服务模块的指向接口是哪个</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/system/test/getDefaultString"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>DemoController.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/demo"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token class-name">WarningsConstants</span><span class="token punctuation">.</span><span class="token constant">SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">DemoService</span> demoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">SystemService</span> systemService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getSystemString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 直接调用 bettytsai-system 模块服务</span>
        <span class="token keyword keyword-return">return</span> systemService<span class="token punctuation">.</span><span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><em>DemoMasterApplication.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token comment">// 启动类主要是为了加这个注解</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DemoSlaveApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">DemoSlaveApplication</span><span class="token punctuation">.</span><span class="token keyword keyword-class">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Environment</span> environment <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> port <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">":::系统启动成功....端口号::: %s"</span><span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="测试消费服务">测试消费服务 </h4>
<p>访问注册中心页面，检查服务是否已经注册成功，具体如图所示：</p>
<p><img src="./assets/image-20241205152934647.png" alt="image-20241205152934647"></p>
<p>调用服务  <code>http://http://192.168.56.1:9004/demo/test</code> 接口，成功访问，具体如图所示：</p>
<p><img src="./assets/image-20241205153029152.png" alt="image-20241205153029152"></p>
<p>细心的人可能会发现，经过多次测试，会发现是轮询策略哦。关于负载均衡，我们将在后续章节学习。</p>
<h2 id="feign-负载均衡">Feign 负载均衡 </h2>
<p>Feign 既然封装了 Ribbon 自然而然也就具备了负载均衡的功能。默认采用轮询策略，那么如何切换负载均衡策略呢？与之前 Ribbon 的学习中的配置基本一致。</p>
<h3 id="全局设置ribbon">全局设置（Ribbon） </h3>
<blockquote>
<p>Spring Cloud 2020 版本以后，默认移除了对 Netflix 的依赖，其中就包括 Ribbon，官方默认推荐使用 Spring Cloud Loadbalancer 正式替换 Ribbon，并成为了Spring Cloud 负载均衡器的唯一实现。</p>
</blockquote>
<p>这里为了学习 Ribbon 负载均衡，所以我们还是统一将版本设置为 <span style="color:rgba(247, 167, 184)">Spring Cloud 2020.0.0</span> 之前的版本：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--...其他组件版本版本号不展示--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-boot.version</span><span class="token punctuation">&gt;</span></span>2.3.3.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-boot.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Hoxton.SR12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud-alibaba.version</span><span class="token punctuation">&gt;</span></span>2.2.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud-alibaba.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>然后在启动类或者配置类中注入负载均衡策略对象。所有服务请求均使用该策略。</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword keyword-public">public</span> <span class="token class-name">IRule</span> <span class="token function">randomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">IRule</span> rule<span class="token punctuation">;</span>
    <span class="token comment">// 轮询策略（默认）</span>
    rule <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 随机策略</span>
    <span class="token comment">// rule = new RandomRule();</span>
    <span class="token comment">// 权重轮询策略</span>
    <span class="token comment">// rule = new WeightedResponseTimeRule();</span>
    <span class="token comment">// 最少并发策略</span>
    <span class="token comment">// rule = new BestAvailableRule();</span>
    <span class="token comment">// 重试策略</span>
    <span class="token comment">// rule = new RetryRule();</span>
    <span class="token comment">// 可用敏感性策略</span>
    <span class="token comment">// rule = new AvailabilityFilteringRule();</span>
    <span class="token comment">// 区域敏感性策略</span>
    <span class="token comment">// rule = new ZoneAvoidanceRule();</span>
    <span class="token keyword keyword-return">return</span> rule<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>启动我们的消费者服务，我们通过多次访问接口 <a href="http://127.0.0.1:9002/test/test/test2">http://127.0.0.1:9002/test/test/test2</a> 进行测试，可以看到控制台输出内容如下所示，由此可见，默认是采用的随机策略。</p>
<p><img src="./assets/image-20241022145002537-17295798042602.png" alt="image-20241022145002537"></p>
<h3 id="局部设置ribbon">局部设置（Ribbon） </h3>
<p>删除全局配置，然后修改配置文件，指定所调用的某一个服务的负载均衡策略。格式：<span style="color:#FEA60B">服务应用名.ribbon.NFLoadBalancerRuleClassName</span></p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml yml"><code><span class="token comment"># 负载均衡策略</span>
<span class="token comment"># bettytsai-system 为所调用的服务名称</span>
<span class="token key atrule">bettytsai-system</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule
</code></pre><p>启动我们的消费者服务，我们通过多次访问接口 <a href="http://127.0.0.1:9002/test/test/test2">http://127.0.0.1:9002/test/test/test2</a> 进行测试，可以看到控制台输出内容如下所示，由此可见，默认是采用的随机策略。</p>
<h3 id="替代配置loadbalancer">替代配置（LoadBalancer） </h3>
<p>随着微服务架构越来越流行，在不同服务器上运行多个服务变得越来越普遍。Ribbon 作为早期的客户端负载均衡工具，在 Spring Cloud 2020.0.0 版本之后已经被移除了，取而代之的是 Spring Cloud LoadBalancer，而且 Ribbon 也已经不再维护，所以它也是 Spring 官方推荐的负载均衡解决方案。</p>
<p>同时，Spring Cloud Balancer还有着一些其他的优势：</p>
<ul>
<li>更好的兼容性：LoadBalancer就像一个全新的配件，它与Spring Cloud的其他组件搭配得更好。</li>
<li>支持响应式编程：现在编程界有一种新的编程方式叫做“响应式编程”，LoadBalancer能很好地支持这种现代编程风格。</li>
<li>易于使用和维护：LoadBalancer的设计易于拼装和修改，这对于开发者来说，维护和定制起来更加方便。</li>
<li>多功能：LoadBalancer有很多内置功能，比如自动帮你挑选服务器，就像购物网站帮你推荐商品一样聪明。</li>
</ul>
<p>正因为自 Spring Cloud 2020.0.0 版本之后的 Ribbon 移除，那么我们就不能使用 Ribbon 的配置去切换负载均衡策略。下面我们一起看看如何切换负载均衡策略算法。自 2020.0.0 版本之后， Spring Cloud 提供了自己的客户端负载均衡器抽象和实现。对于负载均衡机制，添加了  <code>ReactiveLoadBalancer</code>  接口，并为其提供了基于 Round-Robin 和  Random 的实现。为了从响应式  <code>ServiceInstanceListSupplier</code>  中获取要选择的实例 被使用。目前，我们支持基于服务发现的  <code>ServiceInstanceListSupplier</code>  实现 ，它使用 Classpath 中可用的 Discovery Client 从 Service Discovery 中检索可用实例。</p>
<blockquote>
<p>可以通过将值 spring.cloud.loadbalancer.enabled 设置为 false 来禁用 Spring Cloud LoadBalancer。</p>
</blockquote>
<p>默认情况下使用的  <code>ReactiveLoadBalancer</code>  实现是  <code>RoundRobinLoadBalancer</code> 。要切换到其他实现，无论是针对所选服务还是所有服务，您可以使用<a href="https://docs.spring.io/spring-cloud-commons/docs/3.1.5/reference/html/#custom-loadbalancer-configuration">自定义 LoadBalancer 配置机制</a>。例如，可以通过  <code>@LoadBalancerClient</code>  注解传递以下配置，以切换到使用  <code>RandomLoadBalancer</code> ：</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">LoadBalancerRule</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">ReactorLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">randomLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">,</span> <span class="token class-name">LoadBalancerClientFactory</span> loadBalancerClientFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClientFactory</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">RandomLoadBalancer</span><span class="token punctuation">(</span>loadBalancerClientFactory<span class="token punctuation">.</span><span class="token function">getLazyProvider</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">.</span><span class="token keyword keyword-class">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>作为 <code>@LoadBalancerClient</code> 、 <code>@LoadBalancerClients</code> 注解的配置参数传递的类不应被 <code>@Configuration</code> 注解所标注，更不应该超出组件的扫描范围。</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@LoadBalancerClients</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token annotation punctuation">@LoadBalancerClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"bettytsai-system"</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">LoadBalancerRule</span><span class="token punctuation">.</span><span class="token keyword keyword-class">class</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">LoadBalancerConfiguration</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="feign-请求传参">Feign 请求传参 </h2>
<h3 id="get-请求">Get 请求 </h3>
<p>使用 <code>@PathVariable</code>  或者  <code>@RequestParam</code>  传参，下面我们通过一个案例演示下怎么通过 <code> </code>@PathVariable<code>  </code>注解进行传参。</p>
<ul>
<li>服务提供者</li>
</ul>
<p><em>TestService.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 获取默认标签
     * <span class="token keyword keyword-@return">@return</span> <span class="token punctuation">{</span><span class="token keyword keyword-@link">@link</span> <span class="token reference"><span class="token class-name">String</span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token class-name">String</span> <span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 根据id查询标签
     * <span class="token keyword keyword-@param">@param</span> <span class="token parameter">id</span> id
     * <span class="token keyword keyword-@return">@return</span> <span class="token punctuation">{</span><span class="token keyword keyword-@link">@link</span> <span class="token reference"><span class="token class-name">String</span></span><span class="token punctuation">}</span> 标签字符串
     */</span>
    <span class="token class-name">String</span> <span class="token function">getLabelById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>TestServiceImpl.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">TestServiceImpl</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===============&gt; system-master...{}"</span><span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token string">"hello eureka,I'm system master module."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"id:::{}"</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 对应的标签"</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><em>TestController.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/system"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token class-name">WarningsConstants</span><span class="token punctuation">.</span><span class="token constant">SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">TestService</span> testService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getDefaultString"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> testService<span class="token punctuation">.</span><span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getLabelById/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> testService<span class="token punctuation">.</span><span class="token function">getLabelById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li>服务消费者</li>
</ul>
<p><em>SystemService.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">SystemService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/system/getDefaultString"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/system/getLabelById/{id}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">getLabelById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>DemoController.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/demo"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token class-name">WarningsConstants</span><span class="token punctuation">.</span><span class="token constant">SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">DemoService</span> demoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">SystemService</span> systemService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getSystemString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> systemService<span class="token punctuation">.</span><span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===========&gt;{}"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getSystemLabelById/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getSystemLabelById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> systemService<span class="token punctuation">.</span><span class="token function">getLabelById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===========&gt;{}"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li>验证服务</li>
</ul>
<p>依次启动 Eureka 服务、服务提供者、消费者，页面访问  <code>http://127.0.0.1/demo/getSystemLabelById/{id}</code>  可以看到：</p>
<p><img src="./assets/image-20241206143948622.png" alt="image-20241206143948622"></p>
<h3 id="post-请求">Post 请求 </h3>
<p>使用 <code>@RequestBody</code> 传参，下面我们通过一个案例演示下怎么通过 该注解进行传参。</p>
<ul>
<li>服务提供者</li>
</ul>
<p><em>TestService.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 获取默认标签
     * <span class="token keyword keyword-@return">@return</span> <span class="token punctuation">{</span><span class="token keyword keyword-@link">@link</span> <span class="token reference"><span class="token class-name">String</span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token class-name">String</span> <span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 根据id查询标签
     * <span class="token keyword keyword-@param">@param</span> <span class="token parameter">id</span> id
     * <span class="token keyword keyword-@return">@return</span> <span class="token punctuation">{</span><span class="token keyword keyword-@link">@link</span> <span class="token reference"><span class="token class-name">String</span></span><span class="token punctuation">}</span> 标签字符串
     */</span>
    <span class="token class-name">String</span> <span class="token function">getLabelById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 根据 map 查询标签
     * <span class="token keyword keyword-@param">@param</span> <span class="token parameter">map</span> 查询参数
     * <span class="token keyword keyword-@return">@return</span> <span class="token punctuation">{</span><span class="token keyword keyword-@link">@link</span> <span class="token reference"><span class="token class-name">String</span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>TestServiceImpl.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">TestServiceImpl</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===============&gt; system-master...{}"</span><span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token string">"hello eureka,I'm system master module."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"id:::{}"</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 对应的标签"</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"id:::{}"</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 对应的标签"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><em>TestController.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/system"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token class-name">WarningsConstants</span><span class="token punctuation">.</span><span class="token constant">SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">TestService</span> testService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getDefaultString"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> testService<span class="token punctuation">.</span><span class="token function">getDefaultLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getLabelById/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> testService<span class="token punctuation">.</span><span class="token function">getLabelById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getLabelByMap"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> testService<span class="token punctuation">.</span><span class="token function">getLabelByMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li>服务消费者</li>
</ul>
<p><em>SystemService.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">SystemService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/system/getDefaultString"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/system/getLabelById/{id}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">getLabelById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/system/getLabelByMap"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>DemoController.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/demo"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token class-name">WarningsConstants</span><span class="token punctuation">.</span><span class="token constant">SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">DemoService</span> demoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">SystemService</span> systemService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getSystemString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> systemService<span class="token punctuation">.</span><span class="token function">getDefaultString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===========&gt;{}"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getSystemLabelById/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getSystemLabelById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> systemService<span class="token punctuation">.</span><span class="token function">getLabelById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===========&gt;{}"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/getLabelByMap"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> systemService<span class="token punctuation">.</span><span class="token function">getLabelByMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===========&gt;{}"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li>验证服务</li>
</ul>
<p>依次启动注册中心、服务提供者、消费者使用 Postman 等接口测试软件，访问服务接口，如下图所示：</p>
<p><img src="./assets/image-20241206150134494.png" alt="image-20241206150134494"></p>
<h2 id="feign-性能优化">Feign 性能优化 </h2>
<h3>Gzip 压缩</h3>
<h4 id="gzip-介绍">Gzip 介绍 </h4>
<p>GZIP是一种数据格式，采用  <code>deflate</code>  算法压缩数据。gzip 是一种非常流行的文件压缩算法，应用十分广泛，尤其是在 Linux 平台。</p>
<h4 id="gzip-能力">Gzip 能力 </h4>
<p>当 Gzip 压缩一个纯文本文件时，效果是非常明显的，大约能够减少 70% 以上的文件大小。</p>
<h4 id="gzip-作用">Gzip 作用 </h4>
<p>网络数据经过压缩后实际降低了网络传输的字节数，最明显的好处就是可以加快网页加载的速度，网页加载速度快的好处不言而喻，除了节省流量，改善用户的体验外，另一个潜在的好处就是 Gzip 与搜索引擎的抓取工具有着更好的关系。例如 Google 就可以直接通过直接读取 Gzip 文件来比普通手工抓取更快的检索网页。</p>
<img src="./assets/image-20241206152120579.png" alt="image-20241206152120579" style="zoom:95%;">
<h3 id="http-协议关于压缩传输的规定">HTTP 协议关于压缩传输的规定 </h3>
<p>在浏览器中，压缩传输网络数据需要遵循以下规定：</p>
<ul>
<li>客户端向服务端请求中带有  <code>Accept-Encoding:gzip</code> 、 <code>deflate</code>  字段，向服务器表示客户端支持的压缩格式（gzip 或 deflate），如果不发送该消息头，服务端默认是不会压缩的。</li>
<li>服务端在收到请求之后，如果发现请求头中含有  <code>Accept-Encoding</code>  字段，并且支持该类型压缩，就会对响应报文压缩之后返回客户端，并且携带  <code>Content-Encoding: gzip</code>  消息头，表示响应报文是根据该类型格式进行压缩的。</li>
<li>客户端接收到请求后，先判断是否存在  <code>Content-Encoding</code>  消息头，如果有，按照该格式解压报文，否则按照正常报文处理。</li>
</ul>
<h3 id="gzip-压缩案例">Gzip 压缩案例 </h3>
<h4 id="全局">全局 </h4>
<p>配置全局请求相应的 Gzip 压缩。</p>
<p><em>application.yaml</em> <span style="color:#D96602;"> 消费者</span></p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9004</span>
  <span class="token comment"># 配置全局请求 Gzip 压缩</span>
  <span class="token key atrule">compression</span><span class="token punctuation">:</span>
      <span class="token comment"># 请求是否开启 gzip 压缩</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># 配置压缩支持的 MIME Type</span>
      <span class="token key atrule">mime-types</span><span class="token punctuation">:</span> application/json<span class="token punctuation">,</span>application/xml<span class="token punctuation">,</span>text/xml<span class="token punctuation">,</span>text/plain<span class="token punctuation">,</span>text/html
      <span class="token comment"># 配置压缩数据大小的最小阈值，默认为 2kb，这里为了测试，所以写成了0kb</span>
      <span class="token key atrule">min-response-size</span><span class="token punctuation">:</span> 0KB

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 应用名称</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>demo

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># 指示此客户端是否应从 eureka 服务器获取 eureka 注册表信息。</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示此实例是否应将其信息注册到 eureka 服务器以供其他人发现。在某些情况下，您不希望发现您的实例，而您只想发现其他实例。</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示从 eureka 服务器获取注册表信息的频率（以秒为单位）。</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># 将可用区映射到用于与 eureka 服务器通信的完全限定 URL 列表。</span>
    <span class="token comment"># 每个值可以是单个 URL 或逗号分隔的备用位置列表。</span>
    <span class="token comment"># 通常，eureka 服务器 URL 携带协议、主机、端口、上下文和版本信息（如果有）。</span>
    <span class="token comment"># 示例：https://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># 更改在运行时在 eurekaServiceUrlPollIntervalSeconds 指定的下一个服务 url 刷新周期生效。</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8762/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># 标志表示，在猜测主机名时，应优先使用服务器的 IP 地址，而不是操作系统报告的主机名。</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 获取要向 eureka 注册的此实例的唯一 ID（在 appName 范围内）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 指示 eureka 客户端需要向 eureka 服务器发送心跳以指示它仍然处于活动状态的频率（以秒为单位）。</span>
    <span class="token comment"># 如果在 leaseExpirationDurationInSeconds 中指定的时间段内未收到心跳，则 eureka 服务器将从其视图中删除该实例，</span>
    <span class="token comment"># 从而禁止流向此实例的流量。请注意，如果实例实现 HealthCheckCallback，然后决定使自身不可用，则实例仍然无法获取流量。</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># 必须与Docker容器名保持一致</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token comment"># 日志文件名称前缀</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 日志的存放路径</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tlogs/$<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>

<span class="token comment">#feign:</span>
<span class="token comment">#  # 配置 Feign 请求的 Gzip 压缩</span>
<span class="token comment">#  compression:</span>
<span class="token comment">#    request:</span>
<span class="token comment">#      # 配置压缩支持的 MIME Type</span>
<span class="token comment">#      mime-types: text/xml,application/xml,application/json,text/plain</span>
<span class="token comment">#      # 配置压缩数据大小的最小阈值，默认为 2048</span>
<span class="token comment">#      min-request-size: 512</span>
<span class="token comment">#      # 请求是否开启 gzip 压缩</span>
<span class="token comment">#      enabled: true</span>
<span class="token comment">#    response:</span>
<span class="token comment">#      # 响应是否开启 gzip 压缩</span>
<span class="token comment">#      enabled: true</span>
</code></pre><ul>
<li>验证服务</li>
</ul>
<p>请求我们的服务地址，打开浏览器 F12 工具，具体情况如下所示：</p>
<p><img src="./assets/image-20241206162230987.png" alt="image-20241206162230987"></p>
<h4 id="局部">局部 </h4>
<p>只配置服务消费者通过 Feign 到 服务提供者的请求与相应的 Gzip 压缩。</p>
<p><em>application.yaml</em> <span style="color:#D96602;"> 消费者</span></p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9004</span>
<span class="token comment">#  # 配置全局请求 Gzip 压缩</span>
<span class="token comment">#  compression:</span>
<span class="token comment">#      # 请求是否开启 gzip 压缩</span>
<span class="token comment">#      enabled: true</span>
<span class="token comment">#      # 配置压缩支持的 MIME Type</span>
<span class="token comment">#      mime-types: application/json,application/xml,text/xml,text/plain,text/html</span>
<span class="token comment">#      # 配置压缩数据大小的最小阈值，默认为 2kb</span>
<span class="token comment">#      min-response-size: 0KB</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 应用名称</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>demo

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># 指示此客户端是否应从 eureka 服务器获取 eureka 注册表信息。</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示此实例是否应将其信息注册到 eureka 服务器以供其他人发现。在某些情况下，您不希望发现您的实例，而您只想发现其他实例。</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示从 eureka 服务器获取注册表信息的频率（以秒为单位）。</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># 将可用区映射到用于与 eureka 服务器通信的完全限定 URL 列表。</span>
    <span class="token comment"># 每个值可以是单个 URL 或逗号分隔的备用位置列表。</span>
    <span class="token comment"># 通常，eureka 服务器 URL 携带协议、主机、端口、上下文和版本信息（如果有）。</span>
    <span class="token comment"># 示例：https://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># 更改在运行时在 eurekaServiceUrlPollIntervalSeconds 指定的下一个服务 url 刷新周期生效。</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8762/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># 标志表示，在猜测主机名时，应优先使用服务器的 IP 地址，而不是操作系统报告的主机名。</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 获取要向 eureka 注册的此实例的唯一 ID（在 appName 范围内）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 指示 eureka 客户端需要向 eureka 服务器发送心跳以指示它仍然处于活动状态的频率（以秒为单位）。</span>
    <span class="token comment"># 如果在 leaseExpirationDurationInSeconds 中指定的时间段内未收到心跳，则 eureka 服务器将从其视图中删除该实例，</span>
    <span class="token comment"># 从而禁止流向此实例的流量。请注意，如果实例实现 HealthCheckCallback，然后决定使自身不可用，则实例仍然无法获取流量。</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># 必须与Docker容器名保持一致</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token comment"># 日志文件名称前缀</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 日志的存放路径</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tlogs/$<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>

<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token comment"># 配置 Feign 请求的 Gzip 压缩</span>
  <span class="token key atrule">compression</span><span class="token punctuation">:</span>
    <span class="token key atrule">request</span><span class="token punctuation">:</span>
      <span class="token comment"># 请求是否开启 gzip 压缩</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># 配置压缩支持的 MIME Type</span>
      <span class="token key atrule">mime-types</span><span class="token punctuation">:</span> application/json<span class="token punctuation">,</span>application/xml<span class="token punctuation">,</span>text/xml<span class="token punctuation">,</span>text/plain<span class="token punctuation">,</span>text/html
      <span class="token comment"># 配置压缩数据大小的最小阈值，默认为 2048</span>
      <span class="token key atrule">min-request-size</span><span class="token punctuation">:</span> <span class="token number">1024</span>
    <span class="token key atrule">response</span><span class="token punctuation">:</span>
      <span class="token comment"># 响应是否开启 gzip 压缩</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><p>因为 Feign 请求内部调用的，所以我们如果不通过日志分析，看不出来请求压缩没压缩。</p>
<h3 id="http-连接池">HTTP 连接池 </h3>
<blockquote>
<p>为什么 HTTP 连接池能够提升性能？</p>
</blockquote>
<h4 id="http-连接池的背景">HTTP 连接池的背景 </h4>
<p>两台服务器建立 HTTP 连接的过程是一个十分复杂的过程，涉及到多个数据包的交换，很耗时间。HTTP 连接所需要的三次、四次握手开销十分大，这一开销对于大量的比较小的 HTTP 消息来说更大。</p>
<h4 id="解决方案">解决方案 </h4>
<p>采用 HTTP 连接池，可以节约大量的三次、四次握手，这样可以大大的提升吞吐量。</p>
<p>Feign 的 HTTP 客户端支持 3 种框架：</p>
<ul>
<li>HttpURLConnection （默认）</li>
<li>HttpClient</li>
<li>OkHttp</li>
</ul>
<p>默认使用 HttpURLConnection ，通过查看源码  <code>org.springframework.openfeign.ribbon.FeignRibbonClientAutoConfiguration.java</code>  得知。</p>
<ul>
<li>传统的 HttpURLConnection 是 JDK 所提供的，并不支持连接池，如果要实现连接池的机制，还需要自己管理连接对象。对于网络请求这种底层相对复杂的操作，如果存在可用的其他方案，没有必要自己去管理连接对象。</li>
<li>HttpClient 相比传统 JDK 所提供的 HttpURLConnection , 它封装了访问 HTTP 的请求头，参数，内容体，响应等等；不仅使客户端发送 HTTP 请求变得容易，而且也方便了开发人员测试接口（基于 HTTP 协议的），既提高了开发的效率，又提高了代码的健壮性；另外高并发大量的网络请求的时候，也是用"连接池"提升吞吐量。</li>
</ul>
<h4 id="httpclient">HttpClient </h4>
<p>将 Feign 的客户端工具修改为  <code>HttpClient</code> 。</p>
<h5 id="添加依赖">添加依赖 </h5>
<p>修改服务消费者，添加以下两个依赖：（服务提供者也要添加依赖）</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token comment">&lt;!-- 当前eureka client版本已经包含了这个依赖，所以我这里不添加此依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.5.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>10.7.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><h5 id="配置文件">配置文件 </h5>
<p>需要在配置文件中配置启用  <code>feign-httpclient</code> 的声明：（服务提供者也要添加该配置）</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9005</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 应用名称</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>demo

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># 指示此客户端是否应从 eureka 服务器获取 eureka 注册表信息。</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示此实例是否应将其信息注册到 eureka 服务器以供其他人发现。在某些情况下，您不希望发现您的实例，而您只想发现其他实例。</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示从 eureka 服务器获取注册表信息的频率（以秒为单位）。</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># 将可用区映射到用于与 eureka 服务器通信的完全限定 URL 列表。</span>
    <span class="token comment"># 每个值可以是单个 URL 或逗号分隔的备用位置列表。</span>
    <span class="token comment"># 通常，eureka 服务器 URL 携带协议、主机、端口、上下文和版本信息（如果有）。</span>
    <span class="token comment"># 示例：https://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># 更改在运行时在 eurekaServiceUrlPollIntervalSeconds 指定的下一个服务 url 刷新周期生效。</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8762/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># 标志表示，在猜测主机名时，应优先使用服务器的 IP 地址，而不是操作系统报告的主机名。</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 获取要向 eureka 注册的此实例的唯一 ID（在 appName 范围内）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 指示 eureka 客户端需要向 eureka 服务器发送心跳以指示它仍然处于活动状态的频率（以秒为单位）。</span>
    <span class="token comment"># 如果在 leaseExpirationDurationInSeconds 中指定的时间段内未收到心跳，则 eureka 服务器将从其视图中删除该实例，</span>
    <span class="token comment"># 从而禁止流向此实例的流量。请注意，如果实例实现 HealthCheckCallback，然后决定使自身不可用，则实例仍然无法获取流量。</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># 必须与Docker容器名保持一致</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token comment"># 日志文件名称前缀</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 日志的存放路径</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tlogs/$<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>

<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token comment"># 配置打开 httpclient 连接池</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token comment">#  # 配置 Feign 请求的 Gzip 压缩</span>
<span class="token comment">#  compression:</span>
<span class="token comment">#    request:</span>
<span class="token comment">#      # 请求是否开启 gzip 压缩</span>
<span class="token comment">#      enabled: true</span>
<span class="token comment">#      # 配置压缩支持的 MIME Type</span>
<span class="token comment">#      mime-types: application/json,application/xml,text/xml,text/plain,text/html</span>
<span class="token comment">#      # 配置压缩数据大小的最小阈值，默认为 2048</span>
<span class="token comment">#      min-request-size: 1024</span>
<span class="token comment">#    response:</span>
<span class="token comment">#      # 响应是否开启 gzip 压缩</span>
<span class="token comment">#      enabled: true</span>
</code></pre><p>⚠️ 这里有一个需要注意的问题，就是如果使用了  <code>HttpClient</code>  作为 Feign 的客户端工具。那么在定义接口上的注解需要格外注意。如果传递的参数是一个自定义对象（例如：JSONObject 格式传递），需要配置参数类型，例如： <code>@GetMapping(value="/xxx",consumes=MediaType.APPLICATION_JSON_VALUE)</code> 。当然，有一些 Spring Cloud 的版本不需要配置。并且使用了 HttpClient 客户端后，我们还可以通过 GET 请求传递对象参数。</p>
<h5 id="服务提供者-1">服务提供者 </h5>
<p>这里主要就是为了演示 GET 请求如何传递对象类型参数，Post 请求的方式代码无需任何改变。</p>
<p><em>TestService.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token doc-comment comment">/**
 * 根据 map 查询标签
 * <span class="token keyword keyword-@param">@param</span> <span class="token parameter">map</span> 查询参数
 * <span class="token keyword keyword-@return">@return</span> <span class="token punctuation">{</span><span class="token keyword keyword-@link">@link</span> <span class="token reference"><span class="token class-name">String</span></span><span class="token punctuation">}</span>
 */</span>
<span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><em>TestServiceImpl.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"id:::{}"</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 对应的标签"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>TestController.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/getLabelByMap"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> map<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> testService<span class="token punctuation">.</span><span class="token function">getLabelByMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="服务消费者-1">服务消费者 </h5>
<p><em>SystemService.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"bettytsai-system"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">SystemService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/system/getLabelByMap"</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><em>DemoController.java</em></p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">DemoService</span> demoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name">SystemService</span> systemService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getLabelByMap"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-public">public</span> <span class="token class-name">String</span> <span class="token function">getLabelByMap</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> map<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> systemService<span class="token punctuation">.</span><span class="token function">getLabelByMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===========&gt;{}"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="测试服务">测试服务 </h5>
<p><img src="./assets/image-20241207191750374.png" alt="image-20241207191750374"></p>
<h3 id="状态查看">状态查看 </h3>
<blockquote>
<p>浏览器发起的请求我们可以借助 F12 开发模式查看请求和响应信息。对于微服务中每个接口我们又该如何查看 URL、状态码和耗时消息？我们可以通过配置日志的方式进行查看。</p>
</blockquote>
<h4 id="logbackxml">logback.xml </h4>
<p>服务消费者添加  <code>logback.xml</code> 日志文件，内容如下（logback日志输出级别需要是  <code>DEBUG</code> 级别） ：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--引入默认配置--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org/springframework/boot/logging/logback/defaults.xml<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 定义全局变量，日志文件路径和格式，数据源配置（从yml配置加载） --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProperty</span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>context<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>log.path<span class="token punctuation">"</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logging.file.path<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProperty</span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>context<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>log.name<span class="token punctuation">"</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logging.file.name<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 注释配置为输出数据库配置 --&gt;</span>
    <span class="token comment">&lt;!--&lt;springProperty scope="context" name="log.db.driver" source="logging.db.driverClass"/&gt;
    &lt;springProperty scope="context" name="log.db.url" source="logging.db.url"/&gt;
    &lt;springProperty scope="context" name="log.db.username" source="logging.db.username"/&gt;
    &lt;springProperty scope="context" name="log.db.password" source="logging.db.password"/&gt;--&gt;</span>

    <span class="token comment">&lt;!--数据库输出配置--&gt;</span>
    <span class="token comment">&lt;!--&lt;appender name="WARN_DB" class="ch.qos.logback.classic.db.DBAppender"&gt;
        &lt;connectionSource class="ch.qos.logback.core.db.DataSourceConnectionSource"&gt;
            &lt;dataSource class="com.alibaba.druid.pool.DruidDataSource"&gt;
                &lt;url&gt;jdbc:mysql://192.168.161.104:33066/JXGL&lt;/url&gt;
                &lt;username&gt;jxgl&lt;/username&gt;
                &lt;password&gt;jxgl123456!&lt;/password&gt;
            &lt;/dataSource&gt;
        &lt;/connectionSource&gt;
        &lt;filter class="ch.qos.logback.classic.filter.LevelFilter"&gt;
            &lt;level&gt;INFO&lt;/level&gt;
            &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;
            &lt;onMismatch&gt;ACCEPT&lt;/onMismatch&gt;
        &lt;/filter&gt;
    &lt;/appender&gt;--&gt;</span>

    <span class="token comment">&lt;!--彩色日志依赖渲染类（这里我没用这个）--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conversionRule</span> <span class="token attr-name">conversionWord</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr<span class="token punctuation">"</span></span> <span class="token attr-name">converterClass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.boot.logging.logback.ColorConverter<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conversionRule</span> <span class="token attr-name">conversionWord</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wex<span class="token punctuation">"</span></span> <span class="token attr-name">converterClass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.boot.logging.logback.WhitespaceThrowableProxyConverter<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conversionRule</span> <span class="token attr-name">conversionWord</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wEx<span class="token punctuation">"</span></span> <span class="token attr-name">converterClass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.boot.logging.logback.ExtendedWhitespaceThrowableProxyConverter<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!--自定义日志文件路径和格式（ CONSOLE_LOG_PATTERN 为默认配置变量）--&gt;</span>
    <span class="token comment">&lt;!--无颜色--&gt;</span>
    <span class="token comment">&lt;!--&lt;property scope="context" name="CONSOLE_LOG_PATTERN" value="%d{HH:mm:ss.SSS} [%thread] %-5level %logger{20} - [%method,%line] - %msg%n"/&gt;--&gt;</span>
    <span class="token comment">&lt;!--彩色--&gt;</span>
    <span class="token comment">&lt;!--&lt;property scope="context" name="CONSOLE_LOG_PATTERN" value="%clr(%date{yyyy-MM-dd HH:mm:ss}) %highlight(%-5level) %red([%thread]) %boldMagenta(%logger{50}) %wEx(%msg%n)"/&gt;--&gt;</span>

    <span class="token comment">&lt;!-- 控制台输出配置 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>STDOUT<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>${CONSOLE_LOG_PATTERN}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 只输出DEBUG级别及以上的日志 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.filter.ThresholdFilter<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>DEBUG<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 文件输出配置 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INFO_FILE<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>${log.path}/${log.name}.info.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>${CONSOLE_LOG_PATTERN}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 只输出INFO级别的日志 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.filter.LevelFilter<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>INFO<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMatch</span><span class="token punctuation">&gt;</span></span>ACCEPT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMatch</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMismatch</span><span class="token punctuation">&gt;</span></span>DENY<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMismatch</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>${log.path}/%d{yyyy-MM-dd}/${log.name}.info.%d{yyyy-MM-dd}-%i.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 每个文件最大2MB --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxFileSize</span><span class="token punctuation">&gt;</span></span>2MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxFileSize</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 最多保留30天的历史记录 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxHistory</span><span class="token punctuation">&gt;</span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxHistory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 文件输出配置 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ERROR_FILE<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>${log.path}/${log.name}.error.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>${CONSOLE_LOG_PATTERN}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 只输出ERROR级别的日志 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.filter.LevelFilter<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>ERROR<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMatch</span><span class="token punctuation">&gt;</span></span>ACCEPT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMatch</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMismatch</span><span class="token punctuation">&gt;</span></span>DENY<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMismatch</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>${log.path}/%d{yyyy-MM-dd}/${log.name}.error.%d{yyyy-MM-dd}-%i.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 每个文件最大2MB --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxFileSize</span><span class="token punctuation">&gt;</span></span>2MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxFileSize</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 最多保留30天的历史记录 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxHistory</span><span class="token punctuation">&gt;</span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxHistory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 文件输出配置 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>WARNING_FILE<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>${log.path}/${log.name}.warning.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>${CONSOLE_LOG_PATTERN}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 只输出WARNING级别的日志 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.classic.filter.LevelFilter<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>WARN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMatch</span><span class="token punctuation">&gt;</span></span>ACCEPT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMatch</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMismatch</span><span class="token punctuation">&gt;</span></span>DENY<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMismatch</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>${log.path}/%d{yyyy-MM-dd}/${log.name}.warning.%d{yyyy-MM-dd}-%i.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 每个文件最大2MB --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxFileSize</span><span class="token punctuation">&gt;</span></span>2MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxFileSize</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 最多保留30天的历史记录 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxHistory</span><span class="token punctuation">&gt;</span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxHistory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DEBUG<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>STDOUT<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INFO_FILE<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ERROR_FILE<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>WARNING_FILE<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!--&lt;appender-ref ref="WARN_DB"/&gt;--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre><blockquote>
<p>关于日志输出没有颜色，请配置：spring.output.ansi.enabled=detect 。</p>
</blockquote>
<p>然后我们发起请求之后，可以看到具体的请求日志：</p>
<p><img src="./assets/image-20241207205112012.png" alt="image-20241207205112012"></p>
<p>具体日志如下：</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell shell"><code><span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.963 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> o.a.http.impl.execchain.MainClientExec   <span class="token builtin class-name">:</span> Opening connection <span class="token punctuation">{</span><span class="token punctuation">}</span>-<span class="token operator">&gt;</span>http://192.168.56.1:9001
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.963 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> .i.c.DefaultHttpClientConnectionOperator <span class="token builtin class-name">:</span> Connecting to /192.168.56.1:9001
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.963 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> .i.c.DefaultHttpClientConnectionOperator <span class="token builtin class-name">:</span> Connection established <span class="token number">192.168</span>.56.1:1128<span class="token operator"><span class="token file-descriptor important">8</span>&lt;</span>-<span class="token operator">&gt;</span><span class="token number">192.168</span>.56.1:9001
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> h.i.c.DefaultManagedHttpClientConnection <span class="token builtin class-name">:</span> http-outgoing-2: <span class="token builtin class-name">set</span> socket <span class="token function">timeout</span> to <span class="token number">60000</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> o.a.http.impl.execchain.MainClientExec   <span class="token builtin class-name">:</span> Executing request GET /system/getLabelByMap HTTP/1.1
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> o.a.http.impl.execchain.MainClientExec   <span class="token builtin class-name">:</span> Target auth state: UNCHALLENGED
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> o.a.http.impl.execchain.MainClientExec   <span class="token builtin class-name">:</span> Proxy auth state: UNCHALLENGED
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> GET /system/getLabelByMap HTTP/1.1
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> Content-Type: application/json
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> Accept: */*
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> Content-Length: <span class="token number">41</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> Host: <span class="token number">192.168</span>.56.1:9001
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> Connection: Keep-Alive
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> User-Agent: Apache-HttpClient/4.5.13 <span class="token punctuation">(</span>Java/1.8.0_152<span class="token punctuation">)</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"GET /system/getLabelByMap HTTP/1.1[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"Content-Type: application/json[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"Accept: */*[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"Content-Length: 41[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"Host: 192.168.56.1:9001[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"Connection: Keep-Alive[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"User-Agent: Apache-HttpClient/4.5.13 (Java/1.8.0_152)[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:19.964 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&gt;&gt;</span> <span class="token string">"{"</span><span class="token function">id</span><span class="token string">":null,"</span>name<span class="token string">":"</span>caixibei<span class="token string">","</span>code<span class="token string">":null}"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> <span class="token string">"HTTP/1.1 200 [<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> <span class="token string">"Content-Type: text/plain;charset=UTF-8[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> <span class="token string">"Content-Length: 55[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> <span class="token string">"Date: Sat, 07 Dec 2024 12:48:20 GMT[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> <span class="token string">"Keep-Alive: timeout=60[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> <span class="token string">"Connection: keep-alive[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> <span class="token string">"[<span class="token entity" title="\r">\r</span>][<span class="token entity" title="\n">\n</span>]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.wire                     <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> <span class="token string">"Demo(id=null, name=caixibei, code=null) [0xe5][0xaf][0xb9][0xe5][0xba][0x94][0xe7][0x9a][0x84][0xe6][0xa0][0x87][0xe7][0xad][0xbe]"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> HTTP/1.1 <span class="token number">200</span> 
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> Content-Type: text/plain<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> Content-Length: <span class="token number">55</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> Date: Sat, 07 Dec <span class="token number">2024</span> <span class="token number">12</span>:48:20 GMT
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> Keep-Alive: <span class="token assign-left variable">timeout</span><span class="token operator">=</span><span class="token number">60</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> org.apache.http.headers                  <span class="token builtin class-name">:</span> http-outgoing-2 <span class="token operator">&lt;&lt;</span> Connection: keep-alive
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.118 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> o.a.http.impl.execchain.MainClientExec   <span class="token builtin class-name">:</span> Connection can be kept alive <span class="token keyword keyword-for">for</span> <span class="token number">60000</span> MILLISECONDS
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.131 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> o.s.w.c.HttpMessageConverterExtractor    <span class="token builtin class-name">:</span> Reading to <span class="token punctuation">[</span>java.lang.String<span class="token punctuation">]</span> as <span class="token string">"text/plain;charset=UTF-8"</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.132 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> h.i.c.PoolingHttpClientConnectionManager <span class="token builtin class-name">:</span> Connection <span class="token punctuation">[</span>id: <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>route: <span class="token punctuation">{</span><span class="token punctuation">}</span>-<span class="token operator">&gt;</span>http://192.168.56.1:9001<span class="token punctuation">]</span> can be kept alive <span class="token keyword keyword-for">for</span> <span class="token number">60.0</span> seconds
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.132 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> h.i.c.DefaultManagedHttpClientConnection <span class="token builtin class-name">:</span> http-outgoing-2: <span class="token builtin class-name">set</span> socket <span class="token function">timeout</span> to <span class="token number">0</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.132 DEBUG <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> h.i.c.PoolingHttpClientConnectionManager <span class="token builtin class-name">:</span> Connection released: <span class="token punctuation">[</span>id: <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>route: <span class="token punctuation">{</span><span class="token punctuation">}</span>-<span class="token operator">&gt;</span>http://192.168.56.1:9001<span class="token punctuation">]</span><span class="token punctuation">[</span>total available: <span class="token number">1</span><span class="token punctuation">;</span> route allocated: <span class="token number">1</span> of <span class="token number">50</span><span class="token punctuation">;</span> total allocated: <span class="token number">1</span> of <span class="token number">200</span><span class="token punctuation">]</span>
<span class="token number">2024</span>-12-07 <span class="token number">20</span>:48:20.132  INFO <span class="token number">17780</span> --- <span class="token punctuation">[</span>nio-9004-exec-2<span class="token punctuation">]</span> i.k.b.demo.controller.DemoController     <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span>Demo<span class="token punctuation">(</span>id<span class="token operator">=</span>null, <span class="token assign-left variable">name</span><span class="token operator">=</span>caixibei, <span class="token assign-left variable">code</span><span class="token operator">=</span>null<span class="token punctuation">)</span> 对应的标签
</code></pre><h4 id="全局-1">全局 </h4>
<p>服务消费者启动类注入 Feign 的  <code>Logger</code> 对象。</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword keyword-public">public</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLogLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// return Logger.Level.NONE;    // 不记录，默认</span>
    <span class="token comment">// return Logger.Level.BASIC;   // 记录请求方法，请求URL，状态码和用时</span>
    <span class="token comment">// return Logger.Level.HEADERS; // 在 BASIC 的基础上额外记录一些常用信息</span>
    <span class="token comment">// return Logger.Level.FULL;    // 记录请求和响应的所有信息</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">FULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="局部-1">局部 </h4>
<p>服务消费者上下文配置中指定记录日志的服务。</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9004</span>
  <span class="token comment"># 配置全局请求 Gzip 压缩</span>
  <span class="token key atrule">compression</span><span class="token punctuation">:</span>
      <span class="token comment"># 请求是否开启 gzip 压缩</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># 配置压缩支持的 MIME Type</span>
      <span class="token key atrule">mime-types</span><span class="token punctuation">:</span> application/json<span class="token punctuation">,</span>application/xml<span class="token punctuation">,</span>text/xml<span class="token punctuation">,</span>text/plain<span class="token punctuation">,</span>text/html
      <span class="token comment"># 配置压缩数据大小的最小阈值，默认为 2kb</span>
      <span class="token key atrule">min-response-size</span><span class="token punctuation">:</span> 0KB

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 应用名称</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> bettytsai<span class="token punctuation">-</span>demo
  <span class="token key atrule">output</span><span class="token punctuation">:</span>
    <span class="token key atrule">ansi</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> detect

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># 指示此客户端是否应从 eureka 服务器获取 eureka 注册表信息。</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示此实例是否应将其信息注册到 eureka 服务器以供其他人发现。在某些情况下，您不希望发现您的实例，而您只想发现其他实例。</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 指示从 eureka 服务器获取注册表信息的频率（以秒为单位）。</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token comment"># 将可用区映射到用于与 eureka 服务器通信的完全限定 URL 列表。</span>
    <span class="token comment"># 每个值可以是单个 URL 或逗号分隔的备用位置列表。</span>
    <span class="token comment"># 通常，eureka 服务器 URL 携带协议、主机、端口、上下文和版本信息（如果有）。</span>
    <span class="token comment"># 示例：https://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/</span>
    <span class="token comment"># 更改在运行时在 eurekaServiceUrlPollIntervalSeconds 指定的下一个服务 url 刷新周期生效。</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//admin<span class="token punctuation">:</span>123456@127.0.0.1<span class="token punctuation">:</span>8762/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># 标志表示，在猜测主机名时，应优先使用服务器的 IP 地址，而不是操作系统报告的主机名。</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 获取要向 eureka 注册的此实例的唯一 ID（在 appName 范围内）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 指示 eureka 客户端需要向 eureka 服务器发送心跳以指示它仍然处于活动状态的频率（以秒为单位）。</span>
    <span class="token comment"># 如果在 leaseExpirationDurationInSeconds 中指定的时间段内未收到心跳，则 eureka 服务器将从其视图中删除该实例，</span>
    <span class="token comment"># 从而禁止流向此实例的流量。请注意，如果实例实现 HealthCheckCallback，然后决定使自身不可用，则实例仍然无法获取流量。</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token comment"># 必须与Docker容器名保持一致</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token comment"># 日志文件名称前缀</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    <span class="token comment"># 日志的存放路径</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tlogs/$<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>

<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token comment"># 配置打开 httpclient 连接池</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token comment"># 👉开启服务名称为 bettytsai-system 的调用日志</span>
      <span class="token key atrule">bettytsai-system</span><span class="token punctuation">:</span>
        <span class="token key atrule">logger-level</span><span class="token punctuation">:</span> FULL
<span class="token comment">#  # 配置 Feign 请求的 Gzip 压缩</span>
<span class="token comment">#  compression:</span>
<span class="token comment">#    request:</span>
<span class="token comment">#      # 请求是否开启 gzip 压缩</span>
<span class="token comment">#      enabled: true</span>
<span class="token comment">#      # 配置压缩支持的 MIME Type</span>
<span class="token comment">#      mime-types: application/json,application/xml,text/xml,text/plain,text/html</span>
<span class="token comment">#      # 配置压缩数据大小的最小阈值，默认为 2048</span>
<span class="token comment">#      min-request-size: 1024</span>
<span class="token comment">#    response:</span>
<span class="token comment">#      # 响应是否开启 gzip 压缩</span>
<span class="token comment">#      enabled: true</span>
</code></pre><h3 id="请求超时">请求超时 </h3>
<p>Feign 的负载均衡底层用的就是 Ribbon，所以这里的请求超时配置其实就是配置 Ribbon。在分布式项目中，服务压力比较大情况下，可能处理服务的过程需要花费一定的时间，而默认情况下请求超时的配置是 1s ，所以我们需要调整该配置延长请求超时时间。</p>
<h4 id="全局-2">全局 </h4>
<p>服务消费者上下文配置请求超时的处理。</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token comment"># 请求连接的超时时间，默认的时间为1s</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span> 
  <span class="token comment"># 请求处理的超时时间</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre><p>注意：以上配置仅针对 Spring Cloud 2020.0.0 之前的版本。对于 Spring Cloud 2020.0.0 之后版本，负载均衡所使用的替代方案是  <code>Loadbalancer</code> ，所以对于此版本之后，我们可以在默认客户端和命名客户端上配置超时。OpenFeign 使用两个超时参数：</p>
<ul>
<li><code>connectTimeout</code>  ：可防止由于服务器处理时间较长而阻止调用方；</li>
<li><code>readTimeout</code>  ：从建立连接时开始应用，并在返回响应时间过长时触发；</li>
</ul>
<blockquote>
<p>如果服务器未运行或不可用，则数据包会导致 <i>连接被拒绝</i> 。通信以错误消息或回退结束。如果 connectTimeout 设置得非常低，则可能会在 connectTimeout 之前发生这种情况。执行查找和接收此类数据包所花费的时间会导致此延迟的很大一部分。它可能会根据涉及 DNS 查找的远程主机而更改。</p>
</blockquote>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token comment"># 覆盖默认的全局的请求超时、处理超时时间</span>
      <span class="token key atrule">defalut</span><span class="token punctuation">:</span>
        <span class="token key atrule">connect-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">read-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
      <span class="token comment"># 开启服务名称为 bettytsai-system 的调用日志</span>
      <span class="token key atrule">bettytsai-system</span><span class="token punctuation">:</span>
        <span class="token key atrule">logger-level</span><span class="token punctuation">:</span> FULL
</code></pre><h4 id="局部-2">局部 </h4>
<p>同样的在Spring Cloud 2020.0.0 版本之前，我们所使用的负载均衡组件用的还是 Ribbon，所以此版本之前的局部配置为：</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">bettytsai-system</span><span class="token punctuation">:</span> <span class="token comment"># bettytsai-system 是微服务的名称，指向 ${spring.application.name}</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token comment"># 请求处理超时时间</span>
    <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
    <span class="token comment"># 请求连接超时时间</span>
    <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
    <span class="token comment"># 当前实例的重试次数</span>
    <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token comment"># 切换实例的重试次数</span>
    <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token comment"># 对所有请求开启重试</span>
    <span class="token key atrule">OkToRetryOnAllOperations</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 负载均衡策略</span>
    <span class="token key atrule">NFLoadbalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule
</code></pre><p>而在 Spring Cloud 2020.0.0 版本之后的配置如下，具体其他配置参数，同样在官方文档中能够找到。</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token comment"># 开启服务名称为 bettytsai-system 的调用日志</span>
      <span class="token comment"># 针对局部某个微服务开启的请求超时、处理超时时间</span>
      <span class="token key atrule">bettytsai-system</span><span class="token punctuation">:</span>
        <span class="token key atrule">logger-level</span><span class="token punctuation">:</span> FULL
        <span class="token key atrule">connect-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">read-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>