<div style="width:100%;display:flex;"><img src="assets/640.gif" alt="640" style="width:200px;margin-left:auto;" /></div>

# SpringCloud GatewayæœåŠ¡ç½‘å…³

## 1 å­¦ä¹ ç›®æ ‡

![image-20241209152345681](./assets/image-20241209152345681.png)

## 2 æ¦‚è¿°

è¯¥é¡¹ç›®æä¾›äº†ä¸€ä¸ªåº“ï¼Œç”¨äºåœ¨ Spring WebFlux ä¸Šæ„å»º API ç½‘å…³ã€‚Spring Cloud Gateway æ—¨åœ¨æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•æ¥è·¯ç”±åˆ° APIï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚ï¼šå®‰å…¨æ€§ã€ç›‘æ§/æŒ‡æ ‡å’Œå¼¹æ€§ã€‚

Spring Cloud ç½‘å…³åŠŸèƒ½ï¼š

- åŸºäº Spring Framework 5 æ„å»ºï¼ŒProject Reactor å’Œ Spring Boot 2.0ï¼›
- èƒ½å¤ŸåŒ¹é…ä»»ä½•è¯·æ±‚å±æ€§çš„è·¯ç”±ï¼›
- è°“è¯å’Œç­›é€‰æ¡ä»¶ç‰¹å®šäºè·¯ç”±ï¼›
- Hystrix Circuit Breaker é›†æˆï¼›
- Spring Cloud DiscoveryClient é›†æˆï¼›
- æ˜“äºç¼–å†™çš„è°“è¯å’Œè¿‡æ»¤å™¨ï¼›
- è¯·æ±‚é€Ÿç‡é™åˆ¶ï¼›
- è·¯å¾„é‡å†™ï¼›

å¼€å§‹ï¼š

```java
@SpringBootApplication
public class DemogatewayApplication {
	@Bean
	public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes().route("path_route", r -> r.path("/get").uri("http://httpbin.org"))
                .route("host_route", r -> r.host("*.myhost.org").uri("http://httpbin.org"))
                .route("rewrite_route", r -> r.host("*.rewrite.org")
                        .filters(f -> f.rewritePath("/foo/(?<segment>.*)", "/${segment}"))
                        .uri("http://httpbin.org")).route("hystrix_route", r -> r.host("*.hystrix.org")
                        .filters(f -> f.hystrix(c -> c.setName("slowcmd"))).uri("http://httpbin.org"))
                .route("hystrix_fallback_route", r -> r.host("*.hystrixfallback.org")
                        .filters(f -> f.hystrix(c -> c.setName("slowcmd").setFallbackUri("forward:/hystrixfallback")))
                        .uri("http://httpbin.org")).route("limit_route", r -> r.host("*.limited.org")
                        .and()
                        .path("/anything/**")
                        .filters(f -> f.requestRateLimiter(c -> c.setRateLimiter(redisRateLimiter())))
                        .uri("http://httpbin.org"))
                .build();
    }
}
```

è¦è¿è¡Œä½ è‡ªå·±çš„ç½‘å…³ï¼Œè¯·ä½¿ç”¨   `spring-cloud-starter-gateway`   ä¾èµ–é¡¹ã€‚

## 3 ä»€ä¹ˆæ˜¯ SpringCloud Gateway

Spring Cloud Gateway ä½œä¸º Spring Cloud ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£ Netflix Zuulï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”è¿˜åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³çš„åŸºæœ¬åŠŸèƒ½ã€‚åœ¨è€ç‰ˆæœ¬çš„ Spring Cloud ä¸­å¼•ç”¨çš„è¿˜æ˜¯ Zuul 1.x ç‰ˆæœ¬ï¼Œè€Œè¿™ä¸ªç‰ˆæœ¬æ˜¯åŸºäºè¿‡æ»¤å™¨çš„ï¼Œæ˜¯é˜»å¡ IOï¼Œå¹¶ä¸æ”¯æŒé•¿è¿æ¥ã€‚

![image-20241209155015919](./assets/image-20241209155015919.png)

ç”±äº Zuul 2.x ç‰ˆæœ¬ä¸€è‡´è·³ç¥¨ï¼Œ2019 å¹´ 5 æœˆï¼ŒNetflix ç»ˆäºå¼€æºäº†æ”¯æŒå¼‚æ­¥è°ƒç”¨æ¨¡å¼çš„ Zuul 2.0 ç‰ˆæœ¬ï¼Œå¯è°“åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ã€‚ä½†æ˜¯ Spring Cloud å·²ç»ä¸å†é›†æˆ Zuul 2.x äº†ï¼Œæ‰€ä»¥ Spring Cloud å¯¹ Gateway çš„æ”¯æŒæ¯” Zuul 2.xæ›´åŠ å‹å¥½ï¼Œå³ä½¿ Zuul 2.x å’Œ Gateway å¹¶æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„å·®åˆ«ã€‚

Spring Cloud Gateway æ˜¯åŸºäº Spring ç”Ÿæ€ç³»ç»Ÿä¹‹ä¸Šæ„å»ºçš„ API ç½‘å…³ï¼ŒåŒ…æ‹¬ï¼š

-  Spring 5
- Spring Boot 2
- Project Reactor

SpringCloud Gateway æ—¨åœ¨æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•æ¥è·¯ç”±åˆ° APIï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›è·¨é¢†åŸŸçš„å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚ï¼šå®‰å…¨æ€§ã€ç›‘è§†/æŒ‡æ ‡ã€é™æµç­‰ã€‚ç”±äº Spring 5.0 æ”¯æŒ Nettyã€HTTP2ï¼Œè€Œ Spring Boot 2.0 æ”¯æŒ Spring 5ï¼Œå› æ­¤ SpringCloud Gateway æ”¯æŒ Nettyã€HTTP2 é¡ºç†æˆç« ã€‚

## 4 ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘å…³

API Gateway ï¼ˆAPIGW / API ç½‘å…³ï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯å‡ºç°åœ¨ç³»ç»Ÿè¾¹ç•Œä¸Šçš„ä¸€ä¸ªé¢å‘ API çš„ã€ä¸²è¡Œé›†ä¸­å¼çš„å¼ºç®¡æ§æœåŠ¡ï¼Œè¿™é‡Œçš„è¾¹ç•Œæ˜¯ä¼ä¸š IT ç³»ç»Ÿçš„è¾¹ç•Œï¼Œå¯ä»¥ç†è§£ä¸º<span style="color:#FF6000;">ä¼ä¸šçº§åº”ç”¨é˜²ç«å¢™</span>ï¼Œä¸»è¦èµ·åˆ°ä¸€ä¸ª<span style="color:#FF6000;">éš”ç¦»å¤–éƒ¨è®¿é—®ä¸å†…éƒ¨ç³»ç»Ÿçš„ä½œç”¨ã€‚</span>

åœ¨å¾®æœåŠ¡æ¦‚å¿µçš„æµè¡Œä¹‹å‰ï¼ŒAPI ç½‘å…³å°±å·²ç»è¯ç”Ÿäº†ï¼Œä¾‹å¦‚é“¶è¡Œã€è¯åˆ¸ç­‰é¢†åŸŸå¸¸è§çš„å‰ç½®æœºç³»ç»Ÿï¼Œå®ƒä¹Ÿæ˜¯è§£å†³è®¿é—®è®¤è¯ã€æŠ¥æ–‡è½¬æ¢ã€è®¿é—®ç»Ÿè®¡ç­‰é—®é¢˜çš„ã€‚

API ç½‘å…³çš„æµè¡Œï¼Œæºäºè¿‘å‡ å¹´æ¥ç§»åŠ¨åº”ç”¨ä¸ä¼ä¸šé—´äº’è”éœ€æ±‚çš„å…´èµ·ã€‚ç§»åŠ¨åº”ç”¨ã€ä¼ä¸šäº’è”ï¼Œä½¿å¾—åå°æœåŠ¡æ”¯æ’‘çš„å¯¹è±¡ï¼Œä»å•ä¸€çš„ Web åº”ç”¨ï¼Œæ‰©å±•åˆ°å¤šç§ä½¿ç”¨åœºæ™¯ï¼Œä¸”æ¯ç§ä½¿ç”¨åœºæ™¯å¯¹åå°æœåŠ¡çš„è¦æ±‚éƒ½ä¸å°½ç›¸åŒã€‚è¿™ä¸ä»…å¢åŠ äº†åå°æœåŠ¡çš„å“åº”é‡ï¼Œè¿˜å¢åŠ äº†åå°æœåŠ¡çš„å¤æ‚æ€§ã€‚<span style="color:#ff6000;">éšç€å¾®æœåŠ¡æ¶æ„æ¦‚å¿µçš„å‰”é™¤ï¼ŒAPI ç½‘å…³æˆä¸ºäº†å¾®æœåŠ¡æ¶æ„çš„ä¸€ä¸ªæ ‡é…ç»„ä»¶ã€‚</span>

API ç½‘å…³æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæ˜¯ç³»ç»Ÿå¯¹å¤–çš„å”¯ä¸€å…¥å£ã€‚API ç½‘å…³å°è£…äº†ç³»ç»Ÿå†…éƒ¨æ¶æ„ï¼Œä¸ºæ¯ä¸ªå®¢æˆ·ç«¯æä¾›å®šåˆ¶ APIã€‚æ‰€æœ‰çš„å®¢æˆ·ç«¯å’Œæ¶ˆè´¹ç«¯éƒ½é€šè¿‡ç»Ÿä¸€çš„ç½‘å…³æ¥å…¥å¾®æœåŠ¡ï¼Œåœ¨ç½‘å…³å±‚å¤„ç†æ‰€æœ‰çš„éä¸šåŠ¡åŠŸèƒ½ã€‚API ç½‘å…³å¹¶ä¸æ˜¯å¾®æœåŠ¡åœºæ™¯ä¸­æ‰€å¿…é¡»çš„ç»„ä»¶ã€‚å¦‚ä¸‹å›¾ï¼Œä¸ç®¡æœ‰æ²¡æœ‰ç½‘å…³ï¼Œåç«¯å¾®æœåŠ¡éƒ½å¯ä»¥é€šè¿‡ API å¾ˆå¥½çš„æ”¯æŒå®¢æˆ·ç«¯çš„è®¿é—®ã€‚

<img src="./assets/image-20241210150108592.png" alt="image-20241210150108592" style="zoom:76%;" />

ä½†å¯¹äºæœåŠ¡æ•°é‡ä¼—å¤šã€å¤æ‚åº¦æ¯”è¾ƒé«˜ã€è§„æ¨¡æ¯”è¾ƒå¤§çš„ä¸šåŠ¡æ¥è¯´ï¼Œå¼•å…¥ API ç½‘å…³ä¹Ÿæœ‰ä»¥ä¸‹ä¸€ç³»åˆ—çš„å¥½å¤„ï¼š

- èšåˆæ¥å£ä½¿å¾—æœåŠ¡å¯¹è°ƒç”¨è€…é€æ˜ï¼Œå®¢æˆ·ç«¯ä¸åç«¯çš„è€¦åˆåº¦é™ä½
- èšåˆåå°æœåŠ¡ï¼ŒèŠ‚çœæµé‡ï¼Œæé«˜æ€§èƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- æä¾›å®‰å…¨ã€æµæ§ã€è¿‡æ»¤ã€ç¼“å­˜ã€è®¡è´¹ã€ç›‘æ§ç­‰ API ç®¡ç†åŠŸèƒ½

## 5 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æœåŠ¡ç½‘å…³

Spring Cloud Gatewayæ˜¯ä¸€ä¸ªçµæ´»ä¸”åŠŸèƒ½å¼ºå¤§çš„APIç½‘å…³è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚ç”¨äºå¾®æœåŠ¡æ¶æ„ä¸‹çš„ç³»ç»Ÿã€‚

**å•ä½“åº”ç”¨ï¼š** æµè§ˆå™¨å‘èµ·è¯·æ±‚åˆ°å•ä½“åº”ç”¨æ‰€åœ¨çš„æœºå™¨ï¼Œåº”ç”¨ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®åŸè·¯è¿”å›ç»™æµè§ˆå™¨ï¼Œå¯¹äºå•ä½“åº”ç”¨æ¥è¯´æ˜¯ä¸éœ€è¦ç½‘å…³çš„ã€‚

**å¾®æœåŠ¡ï¼š** å¾®æœåŠ¡çš„åº”ç”¨å¯èƒ½éƒ¨ç½²åœ¨ä¸åŒæœºæˆ¿ï¼Œä¸åŒåœ°åŒºï¼Œä¸åŒåŸŸåä¸‹ã€‚æ­¤æ—¶å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨/æ‰‹æœº/è½¯ä»¶å·¥å…·ï¼‰æƒ³è¦è¯·æ±‚å¯¹åº”çš„æœåŠ¡ï¼Œéƒ½è¦çŸ¥é“æœºå™¨çš„å…·ä½“ IP æˆ–è€…åŸŸå URLï¼Œå½“å¾®æœåŠ¡å®ä¾‹ä¼—å¤šæ—¶ï¼Œè¿™æ˜¯éå¸¸éš¾ä»¥è®°å¿†çš„ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ä¹Ÿå¤ªå¤æ‚éš¾ä»¥ç»´æŠ¤ã€‚æ­¤æ—¶å°±æœ‰äº†ç½‘å…³ï¼Œå®¢æˆ·ç«¯ç›¸å…³çš„è¯·æ±‚ç›´æ¥å‘é€åˆ°ç½‘å…³ï¼Œç”±ç½‘å…³æ ¹æ®è¯·æ±‚æ ‡è¯†è§£æåˆ¤æ–­å‡ºå…·ä½“çš„å¾®æœåŠ¡çš„åœ°å€ï¼Œå†æŠŠè¯·æ±‚è½¬å‘åˆ°å¾®æœåŠ¡å®ä¾‹ã€‚è¿™å…¶ä¸­çš„è®°å¿†åŠŸèƒ½å°±å…¨éƒ¨äº¤ç»™ç½‘å…³æ¥æ“ä½œäº†ã€‚

![image-20241210171829141](./assets/image-20241210171829141.png)

æ€»ç»“æ¥è¯´ï¼Œå¦‚æœè®©å®¢æˆ·ç«¯ç›´æ¥å’Œå„ä¸ªå¾®æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä»¥ä¸‹é—®é¢˜ï¼š

- å®¢æˆ·ç«¯ä¼šå¤šæ¬¡è¯·æ±‚ä¸åŒçš„å¾®æœåŠ¡ï¼Œå¢åŠ äº†å®¢æˆ·ç«¯çš„å¤æ‚åº¦
- å­˜åœ¨è·¨åŸŸè¯·æ±‚é—®é¢˜ï¼Œåœ¨ä¸€å®šåœºæ™¯ä¸‹å¤„ç†è·¨åŸŸç›¸å¯¹å¤æ‚
- èº«ä»½è®¤è¯é—®é¢˜ï¼Œæ¯ä¸ªå¾®æœåŠ¡éœ€è¦ç‹¬ç«‹è¿›è¡Œèº«ä»½è®¤è¯
- éš¾ä»¥é‡æ„ï¼Œéšç€é¡¹ç›®çš„è¿­ä»£ï¼Œå¯èƒ½éœ€è¦é‡æ–°åˆ’åˆ†å¾®æœåŠ¡
- æŸäº›å¾®æœåŠ¡å¯èƒ½ä½¿ç”¨äº†é˜²ç«å¢™ / æµè§ˆå™¨ä¸å‹å¥½çš„åè®®ï¼Œç›´æ¥è®¿é—®å­˜åœ¨ä¸€å®šçš„å›°éš¾

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ç½‘å…³ä»‹äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸­é—´å±‚ï¼Œæ‰€æœ‰å¤–éƒ¨è¯·æ±‚ç‡å…ˆç»è¿‡å¾®æœåŠ¡ç½‘å…³ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å’Œç½‘å…³è¿›è¡Œäº¤äº’ï¼Œåªéœ€è¦çŸ¥é“ç½‘å…³åœ°å€ï¼Œè€Œä¸éœ€è¦çŸ¥é“å„ä¸ªæœåŠ¡çš„åœ°å€ï¼Œè¿™æ ·ä¸ä»…ç®€åŒ–äº†å¼€å‘ï¼Œè¿˜å…·æœ‰ä»¥ä¸‹å¥½å¤„ï¼š

- æ˜“äºç›‘æ§ï¼Œå¯åœ¨å¾®æœåŠ¡ç½‘å…³æ”¶é›†ç›‘æ§æ•°æ®å¹¶å°†å…¶æ¨é€åˆ°å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œåˆ†æ
- æ˜“ä¸è®¤è¯ï¼Œå¯åœ¨å¾®æœåŠ¡ç½‘å…³ä¸Šè¿›è¡Œè®¤è¯ï¼Œç„¶åå†å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¾®æœåŠ¡ï¼Œä»è€Œæ— éœ€åœ¨æ¯ä¸ªå¾®æœåŠ¡ä¸­è¿›è¡Œè®¤è¯
- å‡å°‘å®¢æˆ·ç«¯ä¸å„ä¸ªå¾®æœåŠ¡ä¹‹é—´çš„äº¤äº’æ¬¡æ•°

## 6 ç½‘å…³è§£å†³äº†ä»€ä¹ˆé—®é¢˜

ç½‘å…³çš„å¼•å…¥è§£å†³äº†å¾ˆå¤šå…·ä½“åœºæ™¯ä¸‹çš„é—®é¢˜ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<div style="width:100%;display:flex;justify-content:center;align-items: center;">
<img src="./assets/image-20241216230424372-17343614663431.gif" style="width:80%;display:block;margin:0 auto;"/>
</div>


ç½‘å…³å…·æœ‰èº«ä»½è®¤è¯ä¸å®‰å…¨ã€å®¡æŸ¥ä¸ç›‘æ§ã€åŠ¨æ€è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€è¯·æ±‚åˆ†ç‰‡ä¸ç®¡ç†ã€é™æ€å“åº”å¤„ç†ç­‰åŠŸèƒ½ã€‚å½“ç„¶æœ€ä¸»è¦çš„è¿˜æ˜¯â€œä¸å¤–ç•Œè”ç³»â€ã€‚

æ€»ç»“ä»¥ä¸‹ï¼Œç½‘å…³åº”å½“å…·å¤‡ä»¥ä¸‹åŠŸèƒ½ï¼š

- æ€§èƒ½ï¼šAPI é«˜å¯ç”¨ï¼Œè´Ÿè½½å‡è¡¡ï¼Œå®¹é”™æœºåˆ¶ã€‚
- å®‰å…¨ï¼šæƒé™èº«ä»½è®¤è¯ã€è„±æ•ã€æµé‡æ¸…æ´—ï¼Œåç«¯ç­¾åï¼ˆä¿è¯å…¨é“¾è·¯å¯ä¿¡è°ƒç”¨ï¼‰ï¼Œé»‘åå•ï¼ˆéæ³•è°ƒç”¨é™åˆ¶ï¼‰ã€‚
- æ—¥å¿—ï¼šæ—¥å¿—è®°å½•ï¼Œä¸€æ—¦æ¶‰åŠåˆ†å¸ƒå¼ï¼Œå…¨é“¾è·¯è·Ÿè¸ªå¿…ä¸å¯å°‘ã€‚
- ç¼“å­˜ï¼šæ•°æ®ç¼“å­˜
- ç›‘æ§ï¼šè®°å½•è¯·æ±‚å“åº”æ•°æ®ï¼ŒAPI è€—æ—¶åˆ†æï¼Œæ€§èƒ½ç›‘æ§
- é™æµï¼šæµé‡æ§åˆ¶ï¼Œé”™å³°æµæ§ï¼Œå¯ä»¥å®šä¹‰å¤šç§é™æµè§„åˆ™
- ç°åº¦ï¼šçº¿ä¸Šç°åº¦éƒ¨ç½²ï¼Œå¯ä»¥å‡å°‘é£é™©
- è·¯ç”±ï¼šåŠ¨æ€è·¯ç”±è§„åˆ™

## 7 å¸¸ç”¨ç½‘å…³è§£å†³æ–¹æ¡ˆ

### 7.1 Nginx + Luaè„šæœ¬

Nginx æ˜¯ç”± IgorSysoev ä¸ºä¿„ç½—æ–¯è®¿é—®é‡ç¬¬äºŒçš„ Rmbler.ru ç«™ç‚¹å¼€å‘çš„ï¼Œä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç†æœåŠ¡å™¨ã€‚Nginx ä¸€æ–¹é¢å¯ä»¥åšåå‘ä»£ç†ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥åšé™æ€èµ„æºæœåŠ¡å™¨ã€‚

>   Nginx çš„åŠŸèƒ½å’Œ Gateway æœ‰ä»¥ä¸‹å‡ ä¸ªåŒºåˆ«ï¼š
>
>   -   Nginx é€‚åˆåšé—¨æˆ·ç½‘å…³ï¼Œæ˜¯ä½œä¸ºæ•´ä¸ªå…¨å±€çš„ç½‘å…³ï¼Œå¯¹å¤–çš„å¤„äºæœ€å¤–å±‚çš„é‚£ç§ï¼›è€Œ Gateway å±äºä¸šåŠ¡ç½‘å…³ï¼Œä¸»è¦ç”¨æ¥å¯¹åº”ä¸åŒçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œç”¨äºèšåˆä¸šåŠ¡ã€‚å„å¾®æœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼ŒèŒè´£å•ä¸€ï¼Œå¯¹å¤–æä¾›æœåŠ¡çš„æ—¶å€™éœ€è¦æœ‰ä¸€ä¸ªä¸œè¥¿å°†ä¸šåŠ¡èšåˆèµ·æ¥ï¼›
>   -   Gateway å¯ä»¥å®ç°ç†”æ–­ã€é‡è¯•ç­‰åŠŸèƒ½ï¼Œè¿™æ˜¯ Nginx ä¸å…·å¤‡çš„ã€‚

### 7.2 Kong

Kong æ˜¯ Mashape æä¾›çš„ä¸€æ¬¾ API ç®¡ç†è½¯ä»¶ï¼Œæœ¬èº«æ˜¯åŸºäº Nginx + Lua çš„ï¼Œä½†æ¯” Nginx æä¾›äº†æ›´ä¸ºç®€å•çš„é…ç½®æ–¹å¼ï¼Œæ•°æ®é‡‡ç”¨äº† ApacheCassandra / PostgreSQL å­˜å‚¨ï¼Œå¹¶ä¸”æä¾›äº†ä¸€äº›ä¼˜ç§€çš„æ’ä»¶ï¼Œæ¯”å¦‚éªŒè¯ï¼Œæ—¥å¿—ï¼Œè°ƒç”¨é¢‘æ¬¡é™åˆ¶ç­‰ã€‚Kong éå¸¸è¯±äººçš„åœ°æ–¹å°±æ˜¯æä¾›äº†å¤§é‡çš„æ’ä»¶æ¥æ‰©å±•åº”ç”¨ï¼Œé€šè¿‡è®¾ç½®ä¸åŒçš„æ’ä»¶å¯ä»¥ä¸ºæœåŠ¡æä¾›å„ç§å¢å¼ºçš„åŠŸèƒ½ã€‚

>   å®ƒå…·å¤‡ä»¥ä¸‹ä¼˜ç¼ºç‚¹ï¼š
>
>   -   **ä¼˜ç‚¹ï¼š** åŸºäº Nginx æ‰€ä»¥åœ¨æ€§èƒ½å’Œç¨³å®šæ€§æ–¹é¢ä¸ä¼šæœ‰é—®é¢˜ã€‚Kong ä½œä¸ºä¸€æ¬¾å•†ä¸šè½¯ä»¶ï¼Œåœ¨ Nginx ä¸Šåšäº†å¾ˆå¤šçš„æ‰©å±•æ€§å·¥ä½œï¼Œå¹¶ä¸”è¿˜æœ‰å¾ˆå¤šä»˜è´¹ä½¿ç”¨çš„å•†ä¸šæ’ä»¶ã€‚Kong æœ¬èº«ä¹Ÿæœ‰ä»˜è´¹çš„ä¼ä¸šç‰ˆï¼Œå…¶ä¸­åŒ…æ‹¬æŠ€æœ¯æ”¯æŒã€ä½¿ç”¨åŸ¹è®­æœåŠ¡ä»¥åŠ API åˆ†ææ’ä»¶ã€‚
>   -   **ç¼ºç‚¹ï¼š** å¦‚æœä½ ä½¿ç”¨ Spring Cloud , Kong å¦‚ä½•ç»“åˆç›®å‰å·²æœ‰çš„æœåŠ¡æ²»ç†ä½“ç³»ï¼Ÿ

### 7.3 Traefik

Traefik æ˜¯ä¸€ä¸ªå¼€æºçš„ Go è¯­è¨€å¼€å‘çš„ï¼Œä¸ºäº†è®©å¾®æœåŠ¡éƒ¨ç½²æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£ HTTP åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚å®ƒæ”¯æŒå¤šç§åå°ï¼ˆDockerã€Swarmã€Kubernatesã€Marathonã€Mesosã€Consulã€Etcdã€Zookeeperã€BoltDBã€Rest API ç­‰ï¼‰æ¥è‡ªåŠ¨åŒ–ã€åŠ¨æ€çš„åº”ç”¨ä»–çš„é…ç½®æ–‡ä»¶è®¾ç½®ï¼ŒTraefik æ‹¥æœ‰ä¸€ä¸ªåŸºäº AngularJS ç¼–å†™çš„ç®€å•ç½‘ç«™ç•Œé¢ï¼Œæ”¯æŒ RestAPIï¼Œé…ç½®æ–‡ä»¶çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯è¿›ç¨‹ã€‚é«˜å¯ç”¨é›†ç¾¤æ¨¡å¼ç­‰ã€‚

>   ç›¸æ¯” Spring Cloud å’Œ Kubernetes è€Œè¨€ï¼Œç›®å‰æ¯”è¾ƒé€‚åˆ Kubernetes ã€‚

### 7.4 SpringCloud Netflix Zuul

Zuul æ˜¯Netflix å…¬å¸å¼€æºçš„ä¸€ä¸ª API ç½‘å…³ç»„ä»¶ï¼ŒSpring Cloud å¯¹å…¶è¿›è¡ŒäºŒæ¬¡åŸºäº Spring Boot çš„æ³¨è§£å¼å°è£…åšåˆ°å¼€ç®±å³ç”¨ã€‚ç›®å‰æ¥è¯´ï¼Œç»“åˆ Spring Cloud æä¾›çš„æœåŠ¡æ²»ç†ä½“ç³»ï¼Œå¯ä»¥åšåˆ°è¯·æ±‚è½¬å‘ï¼Œæ ¹æ®é…ç½®æˆ–è€…é»˜è®¤çš„è·¯ç”±è§„åˆ™è¿›è¡Œè·¯ç”±å’Œè´Ÿè½½å‡è¡¡ï¼Œæ— ç¼é›†æˆ Hystrix ã€‚

>   è™½ç„¶å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ Filter è¿‡æ»¤å™¨å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äº Zuul æœ¬èº«çš„æ¶‰åŠæ˜¯åŸºäº å•çº¿ç¨‹çš„æ¥æ”¶è¯·æ±‚å’Œè½¬å‘å¤„ç†ï¼Œæ˜¯é˜»å¡ IOï¼Œä¸æ”¯æŒé•¿è¿æ¥ã€‚ç›®å‰æ¥çœ‹ Zuul å°±æ˜¾å¾—å¾ˆé¸¡è‚‹ï¼Œéšç€ Zuul 2.x ç‰ˆæœ¬ä¸€è‡´è·³ç¥¨ ï¼ˆ2019å¹´5æœˆå‘å¸ƒäº† Zuul 2.0 ç‰ˆæœ¬ï¼‰ï¼ŒSpring Cloud ä¸ºäº†ä¿é™©èµ·è§ï¼Œæ¨å‡ºäº†è‡ªå·±çš„ Spring Cloud Gatewayã€‚

<span style="color:rgb(159, 197, 234)">å¤§æ„å°±æ˜¯ï¼šZuul å·²æ­»ï¼ŒSpring Cloud Gateway æ°¸ç”Ÿï¼ğŸ¶</span>

#### 7.4.1 Zuul 1.0

<img src="./assets/image-20241210234005117.png" alt="æ¶æ„å›¾" style="zoom:100%;" />

<img src="./assets/image-20241210234107613.png" alt="æ ¸å¿ƒç±»å›¾" style="zoom:100%;" />

<img src="./assets/image-20241210234215051.png" alt="æ¨¡å‹" style="zoom:95%;" />

#### 7.4.2 Zuul 2.0

![image-20241210234349976](./assets/image-20241210234349976.png)

### 7.5 SpringCloud Gateway

Spring Cloud Gateway çš„å·¥ä½œåŸç†ï¼š

![image-20241210234610441](./assets/image-20241210234610441.png)

å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚å¦‚æœç½‘å…³å¤„ç†ç¨‹åºæ˜ å°„ç¡®å®šè¯·æ±‚ä¸è·¯ç”±åŒ¹é…ï¼Œåˆ™ä¼šå°†å…¶å‘é€åˆ°ç½‘å…³ Web å¤„ç†ç¨‹åºã€‚æ­¤å¤„ç†ç¨‹åºé€šè¿‡ç‰¹å®šäºè¯·æ±‚çš„ç­›é€‰æ¡ä»¶é“¾è¿è¡Œè¯·æ±‚ã€‚è¿‡æ»¤å™¨è¢«è™šçº¿åˆ’åˆ†çš„åŸå› æ˜¯ filter å¯ä»¥åœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰å’Œä¹‹åè¿è¡Œ logicã€‚æ‰§è¡Œæ‰€æœ‰ â€œpreâ€ filter logicã€‚ç„¶åå‘å‡ºä»£ç†è¯·æ±‚ã€‚å‘å‡ºä»£ç†è¯·æ±‚åï¼Œå°†è¿è¡Œ â€œpostâ€ ç­›é€‰æ¡ä»¶é€»è¾‘ã€‚

<div style="border: 1px solid rgba(254, 40, 87,.1);
    padding: 10px;
    border-left: 5px solid rgba(254, 40, 87);
    background: rgba(254, 40, 87,.1);
    border-radius: 0 3px 3px 0;
    color:rgba(254, 40, 87);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" style="flex-shrink: 0;" width="14px" height="14px" fill="none" xmlns="http://www.w3.org/2000/svg" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-8l52ux" focusable="false" aria-hidden="true" data-testid="ErrorIcon"><path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <span style="line-height: 16px;">åœ¨æ²¡æœ‰ç«¯å£çš„è·¯ç”±ä¸­å®šä¹‰çš„ URI çš„ HTTP å’Œ HTTPS URI çš„é»˜è®¤ç«¯å£å€¼åˆ†åˆ«ä¸º 80 å’Œ 443ã€‚</span>
</div>

## 8 ç¯å¢ƒå‡†å¤‡



ä¹‹å‰å»ºé‡å¤çš„å¾®æœåŠ¡é¡¹ç›®æ˜¯ä¸ºäº†æ¨¡æ‹Ÿåˆ†å¸ƒå¼å¤šæœºéƒ¨ç½²ï¼ŒéªŒè¯è´Ÿè½½å‡è¡¡ç­–ç•¥ç­‰ç›®çš„ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€å„ä½¿ç”¨ä¸€ä¸ªç»„ä»¶å³å¯ã€‚

é¦–å…ˆæˆ‘ä»¬åŒæ ·æ²¿ç”¨å­¦ä¹  Eurekaã€Ribbonã€Feign ç­‰å¾®æœåŠ¡ç»„ä»¶æ—¶çš„é¡¹ç›®éª¨æ¶ï¼Œå‡†å¤‡ä»¥ä¸‹æœåŠ¡ï¼š

![image-20241210234932811](./assets/image-20241210234932811.png)

ä¾æ¬¡å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼ˆä¸»ï¼‰ã€æœåŠ¡æä¾›è€…ï¼ˆä¸»ï¼‰ã€æœåŠ¡æ¶ˆè´¹è€…ï¼ˆä¸»ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æ³¨å†Œä¸­å¿ƒåˆ—è¡¨æœ‰ä¸‹åˆ—å‡ ä¸ªæœåŠ¡ï¼š

![image-20241210235612055](./assets/image-20241210235612055.png)

## 9 Nginxå®ç°APIç½‘å…³

### 9.1 ä¸‹è½½å®‰è£…

åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦å‰å¾€ [https://nginx.org/en/download.html](https://nginx.org/en/download.html) ä¸‹è½½ Nginx æœåŠ¡å™¨è½¯ä»¶ï¼š

![image-20241211154334985](./assets/image-20241211154334985.png)

ä¸‹è½½å®Œæˆåè§£å‹åˆ°æŒ‡å®šè·¯å¾„ä¸‹ <span style="color:#ff6e00;">ï¼ˆä¸è¦æ”¾ä¸­æ–‡è·¯å¾„ä¸‹ï¼ï¼ï¼ï¼‰</span>ï¼š

<img src="./assets/image-20241211154456228.png" alt="image-20241211154456228" style="zoom:95%;" />

åŒå‡»å¯åŠ¨  `nginx.exe`  ç¨‹åºï¼Œç„¶åè®¿é—® [http://127.0.0.1:80/](http://127.0.0.1:80/) ï¼Œå¦‚æœå¯åŠ¨æˆåŠŸï¼Œé¡µé¢å¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20241211154724058](./assets/image-20241211154724058.png)

æ‰“å¼€é…ç½®æ–‡ä»¶  `conf\nginx.conf`  ï¼Œé»˜è®¤é…ç½®å¦‚ä¸‹ï¼š

```bash
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
    	# ç›‘å¬ç«¯å£ 80
        listen       80;
        server_name  localhost;
        
        # èµ„æºè·¯å¾„
        location / {
            root   html;
            index  index.html index.htm;
        }
        
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
```

### 9.2 é…ç½®è·¯ç”±è§„åˆ™

```bash
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
    	# ç›‘å¬ç«¯å£ 80
        listen       80;
        server_name  localhost;
        
        # èµ„æºè·¯å¾„
        location / {
            root   html;
            index  index.html index.htm;
        }
        
        # è·¯ç”±åˆ° bettytsai-system æ¨¡å—
        location /api-system/ {
        	proxy_pass http://127.0.0.1:9000/;
        }

        # è·¯ç”±åˆ° bettytsai-demo æ¨¡å—
        location /api-demo/ {
        	proxy_pass http://127.0.0.1:9004/;
        }
        
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
```

æˆ‘ä»¬æ¥çœ‹ä¸‹ Eureka ä¸­æ³¨å†Œçš„æœåŠ¡åˆ—è¡¨ï¼Œå½“æˆ‘ä»¬è®¿é—®  `/api-system`  çš„æ—¶å€™ï¼Œå°±å°†å®ƒè·¯ç”±åˆ°  `http://127.0.0.1/9000/` ã€‚åŒæ ·çš„ï¼Œå½“æˆ‘ä»¬è®¿é—®  `/api-demo` çš„æ—¶å€™ï¼Œè·¯ç”±åˆ°  `http://127.0.0.1:9004/` ã€‚

![image-20241211160333850](./assets/image-20241211160333850.png)

åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­å…³é—­ nginx è¿›ç¨‹åå†æ¬¡é‡å¯ï¼Œä»¥è®©é…ç½®æ–‡ä»¶ç”Ÿæ•ˆåï¼Œè®¿é—® [http://127.0.0.1/api-system/system/getDefaultString](http://127.0.0.1/api-system/system/getDefaultString)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼ŒæˆåŠŸè®¿é—® bettytsai-system æ¨¡å—çš„æœåŠ¡ï¼Œè¯´æ˜è·¯ç”±è½¬å‘æˆåŠŸäº†ã€‚

![image-20241211162411471](./assets/image-20241211162411471.png)

## 10 Gatewayæ ¸å¿ƒæ¦‚å¿µ

<div style="border: 1px solid #1d63edb5;
    padding: 10px;
    border-left: 5px solid #1d63edb5;
    background: #bed2fa63;
    border-radius: 0 3px 3px 0;
    color: #1d63ed;
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" style="flex-shrink: 0;" width="14px" height="14px" fill="none" xmlns="http://www.w3.org/2000/svg" class="MuiSvgIcon-root MuiSvgIcon-colorInfo MuiSvgIcon-fontSizeSmall css-1bqouqa" focusable="false" aria-hidden="true" data-testid="InfoCircleIcon"><path d="M12 16V12M12 8H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <span style="line-height: 16px;">å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/3.1.4/reference/html/</span>
</div>

### 10.1 æ ¸å¿ƒæ¦‚å¿µ

**è·¯ç”±** ï¼šè·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯ç”± IDã€ç›®æ ‡ URL ã€ä¸€ç»„æ–­è¨€å’Œä¸€ç»„è¿‡æ»¤å™¨ç»„æˆã€‚å¦‚æœæ–­è¨€è·¯ç”±ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚ URL å’Œé…ç½®åŒ¹é…ã€‚

**æ–­è¨€ï¼ˆPredicateï¼‰** ï¼šJDK 8 å¼•å…¥çš„æ–­è¨€å‡½æ•°ã€‚SpringCloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯ Spring 5.0 ä¸­çš„  `ServerWebExchange` ã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é…æ¥è‡ª Http Request ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚

**è¿‡æ»¤å™¨ï¼ˆFilterï¼‰** : ä¸€ä¸ªæ ‡å‡†çš„ Spring Web è¿‡æ»¤å™¨ã€‚Spring Cloud Gateway ä¸­çš„è¿‡æ»¤å™¨åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ Gateway Filter å’Œ Global Filterã€‚è¿‡æ»¤å™¨ä¼šå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œå¤„ç†ã€‚

>   **ğŸ“– Spring å®˜æ–¹è¯´æ˜ï¼š** 
>
>   -   è·¯ç”±ï¼ˆRouteï¼‰ï¼šç½‘å…³çš„åŸºæœ¬æ„å»ºå—ã€‚å®ƒç”± IDã€ç›®æ ‡ URIã€è°“è¯é›†åˆå’Œè¿‡æ»¤å™¨é›†åˆå®šä¹‰ã€‚å¦‚æœèšåˆè°“è¯ä¸º trueï¼Œåˆ™åŒ¹é…è·¯ç”±ã€‚
>   -   æ–­è¨€ï¼ˆPredicateï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ª Java 8 Function Predicateã€‚input ç±»å‹æ˜¯ Spring æ¡†æ¶ çš„ ServerWebExchangeã€‚è¿™æ ·ï¼Œæ‚¨å°±å¯ä»¥åŒ¹é… HTTP è¯·æ±‚ä¸­çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚æ ‡å¤´æˆ–å‚æ•°ã€‚
>   -   è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ï¼šè¿™äº›æ˜¯ä½¿ç”¨ç‰¹å®šå·¥å‚æ„å»ºçš„ GatewayFilter å®ä¾‹ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥åœ¨å‘é€ä¸‹æ¸¸è¯·æ±‚ä¹‹å‰æˆ–ä¹‹åä¿®æ”¹è¯·æ±‚å’Œå“åº”ã€‚

## 11 Gatewayå·¥ä½œåŸç†

ä¸‹å›¾ç®€è¦æ¦‚è¿°äº† Spring Cloud ç½‘å…³çš„å·¥ä½œåŸç†ï¼š

![image-20241211170513468](./assets/image-20241211170513468.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®¢æˆ·ç«¯å‘  *Spring Cloud Gateway  ç½‘å…³* å‘å‡ºè¯·æ±‚ã€‚å¦‚æœç½‘å…³å¤„ç†ç¨‹åºæ˜ å°„*ï¼ˆGateway Handler Mappingï¼‰*ç¡®å®šè¯·æ±‚ä¸è·¯ç”±åŒ¹é…ï¼Œåˆ™ä¼šå°†å…¶å‘é€åˆ°ç½‘å…³ Web å¤„ç†ç¨‹åº*ï¼ˆGateway Web Handlerï¼‰*ã€‚æ­¤å¤„ç†ç¨‹åºé€šè¿‡ç‰¹å®šäºè¯·æ±‚çš„ç­›é€‰æ¡ä»¶é“¾*ï¼ˆè¿‡æ»¤å™¨é“¾ï¼‰*è¿è¡Œè¯·æ±‚ã€‚è¿‡æ»¤å™¨è¢«è™šçº¿åˆ’åˆ†çš„åŸå› æ˜¯è¿‡æ»¤å™¨å¯ä»¥åœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰å’Œä¹‹åè¿è¡Œã€‚æ‰§è¡Œæ‰€æœ‰ â€œpreâ€ å‰ç½®è¿‡æ»¤å™¨é€»è¾‘ï¼Œç„¶åå‘å‡ºä»£ç†è¯·æ±‚ã€‚å‘å‡ºä»£ç†è¯·æ±‚åï¼Œå°†è¿è¡Œ â€œpostâ€ è¿‡æ»¤å™¨é€»è¾‘ã€‚

<div style="border: 1px solid rgba(254, 40, 87,.1);
    padding: 10px;
    border-left: 5px solid rgba(254, 40, 87);
    background: rgba(254, 40, 87,.1);
    border-radius: 0 3px 3px 0;
    color:rgba(254, 40, 87);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" style="flex-shrink: 0;" width="14px" height="14px" fill="none" xmlns="http://www.w3.org/2000/svg" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-8l52ux" focusable="false" aria-hidden="true" data-testid="ErrorIcon"><path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <span style="line-height: 16px;">åœ¨æ²¡æœ‰ç«¯å£çš„è·¯ç”±ä¸­å®šä¹‰çš„ URI çš„ HTTP å’Œ HTTPS URI çš„é»˜è®¤ç«¯å£å€¼åˆ†åˆ«ä¸º 80 å’Œ 443ã€‚</span>
</div>

## 12 Gatewayå®ç°APIç½‘å…³å…¥é—¨æ¡ˆä¾‹

### 12.1 åˆ›å»ºé¡¹ç›®

åˆ›å»º bettytsai-gateway-master ç½‘å…³é¡¹ç›®ï¼š

![image-20241220160507623](./assets/image-20241220160507623-17346819094621.png)

ç„¶åæˆ‘ä»¬æ·»åŠ ä¾èµ–  `spring-cloud-starter-gateway`  ç»„ä»¶ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

```xml
<!--æ—¥å¿—-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-logging</artifactId>
</dependency>
<!--æˆ‘è‡ªå·±å°è£…çš„ç»„ä»¶åº“-->
<dependency>
    <groupId>com.tsaiframework.boot</groupId>
    <artifactId>tsai-spring-boot-core</artifactId>
    <classifier>jar-with-dependencies</classifier>
</dependency>
<!--eureka-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
<dependency>
    <groupId>javax.inject</groupId>
    <artifactId>javax.inject</artifactId>
</dependency>
<!--ç½‘å…³-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

ä¾æ¬¡å¯åŠ¨ Eureka æ³¨å†Œä¸­å¿ƒé¡¹ç›®ã€ç½‘å…³ã€æœåŠ¡æä¾›è€…ï¼Œæ‰“å¼€æ³¨å†Œä¸­å¿ƒé¡µé¢æ£€æŸ¥ç½‘å…³æ˜¯å¦æ­£ç¡®çš„æ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒï¼š

![image-20241220162926504](./assets/image-20241220162926504.png)

é‚£ç°åœ¨æˆ‘ä»¬è®¿é—® system æ¨¡å—æä¾›çš„æµ‹è¯•æ¥å£  http://127.0.0.1:9000/system/getDefaultString  ï¼Œè¿”å›ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20241220164651512](./assets/image-20241220164651512.png)

### 12.2 é…ç½®è·¯ç”±è§„åˆ™

<span style="color:#F47023">åœ¨ä¸Šé¢æˆ‘ä»¬é€šè¿‡ Nginx å®ç°çš„ API ç½‘å…³åŠŸèƒ½å¦‚ä½•é€šè¿‡ Spring Cloud Gateway å®ç°å‘¢ï¼Ÿ</span>åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦é€šè¿‡é…ç½®ç›¸åº”çš„è·¯ç”±è§„åˆ™å°†è¯·æ±‚é€šè¿‡ç½‘å…³åˆ†å‘åˆ°å…·ä½“çš„å¾®æœåŠ¡åº”ç”¨ä¸­å»ã€‚ä¸‹é¢æˆ‘ä»¬é…ç½®ä¸€ä¸ªæœ€åŸºç¡€çš„å…¥é—¨çš„è·¯ç”±è§„åˆ™å»å®ç°ï¼š

```yaml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      routes: 
          # è·¯ç”±IDï¼Œå”¯ä¸€
        - id: bettytsai-system
          # ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€
          uri: http://127.0.0.1:9000/
          # æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰
          predicates:
            # åŒ¹é…å¯¹åº”URLçš„è¯·æ±‚ï¼Œå°†åŒ¹é…åˆ°çš„è¯·æ±‚è¿½åŠ åˆ°ç›®æ ‡URIä¹‹å
            - Path=/system/**
```

é…ç½®å®Œæˆåï¼Œé‡å¯ç½‘å…³æœåŠ¡ï¼Œè¿™æ—¶å€™è¯·æ±‚  http://127.0.0.1:30000/system/getDefaultString å°†ä¼šè·¯ç”±åˆ° http://127.0.0.1:9000/system/getDefaultStringï¼Œå…·ä½“è¯·æ±‚æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241220165717376](./assets/image-20241220165717376-17346850384622.png)

## 13 è·¯ç”±è§„åˆ™

Spring Cloud Gateway åˆ›å»º Route å¯¹è±¡æ—¶ï¼Œä½¿ç”¨ RoutePredicateFactory åˆ›å»º Predicate å¯¹è±¡ï¼ŒPredicate å¯¹è±¡å¯ä»¥èµ‹å€¼ç»™ Route ã€‚

- Spring Cloud Gateway åŒ…å«è®¸å¤šå†…ç½®çš„ Route Predicate Factoriesã€‚
- æ‰€æœ‰è¿™äº›æ–­è¨€éƒ½åŒ¹é… HTTP è¯·æ±‚çš„ä¸åŒå±æ€§ã€‚
- å¤šä¸ª Route Predicate Factories å¯ä»¥é€šè¿‡é€»è¾‘ä¸ï¼ˆandï¼‰ ç»“åˆèµ·æ¥ä¸€èµ·ä½¿ç”¨ã€‚

è·¯ç”±æ–­è¨€å·¥å‚ RoutePredicateFactory åŒ…å«çš„ä¸»è¦å®ç°ç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼ŒåŒ…æ‹¬ Datetime ã€è¯·æ±‚çš„è¿œç«¯åœ°å€ã€è·¯ç”±æƒé‡ã€è¯·æ±‚å¤´ã€Hoståœ°å€ã€è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚è·¯å¾„å’Œè¯·æ±‚å‚æ•°ç­‰ç±»å‹çš„è·¯ç”±æ–­è¨€ã€‚

![image-20241220170335337](./assets/image-20241220170335337.png)

### 13.1 Path 

```yml
spring:
  application:
    name: bettytsai-gateway
  output:
    ansi:
      enabled: always
  config:
    # æ˜¯å¦å¯ç”¨é…ç½®æ•°æ®å¤„ç†æ—§æ¨¡å¼
    use-legacy-processing: true
  cloud:
    gateway:
      # è·¯ç”±è§„åˆ™
      routes:
          # è·¯ç”±IDï¼Œå”¯ä¸€
        - id: bettytsai-system
          # ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€
          uri: http://127.0.0.1:9000/
          # æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰
          predicates:
            # åŒ¹é…å¯¹åº”URLçš„è¯·æ±‚ï¼Œå°†åŒ¹é…åˆ°çš„è¯·æ±‚è¿½åŠ åˆ°ç›®æ ‡URIä¹‹å
            - Path=/system/**
```

âœ¨ è¯·æ±‚Â  `http://127.0.0.1:30000/system/getDefaultString` Â å°†ä¼šè·¯ç”±åˆ°  `http://127.0.0.1:9000/system/getDefaultString` ã€‚

### 13.2 Query

```yaml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      # è·¯ç”±è§„åˆ™
      routes:
          # è·¯ç”±IDï¼Œå”¯ä¸€
        - id: bettytsai-system
          # ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€
          uri: http://127.0.0.1:9000/
          # æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰
          predicates:
            # åŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token çš„è¯·æ±‚
            #- Query=token
            # åŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token å¹¶ä¸”å…¶å‚æ•°å€¼æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼ abcd. çš„è¯·æ±‚
            - Query=token,abcd.
```

é…ç½®è·¯ç”±è§„åˆ™  `Query=token`  ï¼ŒåŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œå…·ä½“å¯¹æ¯”å›¾å¦‚ä¸‹ï¼š

![image-20241220172238970](./assets/image-20241220172238970.png)

é…ç½®è·¯ç”±è§„åˆ™  `Query=token,abcd.`  ï¼ŒåŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token å¹¶ä¸”å…¶å‚æ•°å€¼æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼  `abcd. `  çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œå…·ä½“å¯¹æ¯”å›¾å¦‚ä¸‹ï¼š

![image-20241220172533489](./assets/image-20241220172533489-17351897315271.png)

### 13.3 Method

```yaml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      # è·¯ç”±è§„åˆ™
      routes:
          # è·¯ç”±IDï¼Œå”¯ä¸€
        - id: bettytsai-system
          # ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€
          uri: http://127.0.0.1:9000/
          # æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰
          predicates:
            # åŒ¹é…ä»»æ„ GET è¯·æ±‚
            - Method=GET
```

é‡å¯ç½‘å…³æœåŠ¡ï¼Œç„¶åæˆ‘ä»¬ç»è¿‡æµ‹è¯•ï¼Œå…·ä½“è°ƒç”¨æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20241220235052510](./assets/image-20241220235052510-17351897358732.png)

### 13.4 Datetime

```yaml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      # è·¯ç”±è§„åˆ™
      routes:
          # è·¯ç”±IDï¼Œå”¯ä¸€
        - id: bettytsai-system
          # ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€
          uri: http://127.0.0.1:9000/
          # æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰
          predicates:
            # åŒ¹é…ä¸­å›½ä¸Šæµ·æ—¶é—´ 2024-12-21 00:00:00 ä¹‹åçš„è¯·æ±‚
            - After=2024-12-21T00:00:00.000+00:00[Asia/Shanghai]
```

é‡å¯ç½‘å…³æœåŠ¡ï¼Œä¸Šé¢çš„æµ‹è¯•æ—¶é—´ï¼Œä½ å¯ä»¥æ‰¾ä¸ªæ—¶é—´ç‚¹è¿›è¡Œæµ‹è¯•ã€‚ç»è¿‡éªŒè¯ï¼Œæˆ‘ä»¬è¯·æ±‚çš„å…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241221000111262](./assets/image-20241221000111262.png)

### 13.5 pxoteAddr

```yaml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      # è·¯ç”±è§„åˆ™
      routes:
          # è·¯ç”±IDï¼Œå”¯ä¸€
        - id: bettytsai-system
          # ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€
          uri: http://127.0.0.1:9000/
          # æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰
          predicates:
            # åŒ¹é…æ¥è‡ªè¿œç¨‹åœ°å€ä¸º 192.168.100.101/0 çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œ0ä¸ºå­ç½‘æ©ç 
            - pxoteAddr=192.168.100.101/0
```

ç›®å‰æˆ‘æ‰€ä½¿ç”¨çš„ç”µè„‘å½“æ—¶çš„ç½‘ç»œé…ç½®å¦‚ä¸‹ï¼Œæ‰€ä»¥  `pxoteAddr=192.168.100.101/0`  è¡¨ç¤ºåŒ¹é…æ¥è‡ªè¿œç¨‹åœ°å€ä¸º 192.168.100.101/0 çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œ0ä¸ºå­ç½‘æ©ç 

```bash
Windows IP é…ç½®
æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ æœ¬åœ°è¿æ¥* 1:
   åª’ä½“çŠ¶æ€  . . . . . . . . . . . . : åª’ä½“å·²æ–­å¼€è¿æ¥
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . :
æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ æœ¬åœ°è¿æ¥* 2:
   åª’ä½“çŠ¶æ€  . . . . . . . . . . . . : åª’ä½“å·²æ–­å¼€è¿æ¥
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . :
ä»¥å¤ªç½‘é€‚é…å™¨ VMware Network Adapter VMnet1:
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . :
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. . . . . . . . : fe80::db14:99b3:a49a:2170%7
   IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.9.1
   å­ç½‘æ©ç   . . . . . . . . . . . . : 255.255.255.0
   é»˜è®¤ç½‘å…³. . . . . . . . . . . . . :
ä»¥å¤ªç½‘é€‚é…å™¨ VMware Network Adapter VMnet8:
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . :
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. . . . . . . . : fe80::2df4:f368:1b8e:87b4%5
   IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.56.1
   å­ç½‘æ©ç   . . . . . . . . . . . . : 255.255.255.0
   é»˜è®¤ç½‘å…³. . . . . . . . . . . . . :
æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ WLAN:
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . :
   IPv6 åœ°å€ . . . . . . . . . . . . : 240e:878:b21:4dee:5ea6:9dc4:c7b9:2ba1
   ä¸´æ—¶ IPv6 åœ°å€. . . . . . . . . . : 240e:878:b21:4dee:8dfc:2efc:830d:f7a3
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. . . . . . . . : fe80::58cf:8c88:7ef6:8a19%28
   IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.100.101
   å­ç½‘æ©ç   . . . . . . . . . . . . : 255.255.255.0
   é»˜è®¤ç½‘å…³. . . . . . . . . . . . . : fe80::d49c:d1ff:fe4f:40c6%28
                                       192.168.100.1
ä»¥å¤ªç½‘é€‚é…å™¨ è“ç‰™ç½‘ç»œè¿æ¥:
   åª’ä½“çŠ¶æ€  . . . . . . . . . . . . : åª’ä½“å·²æ–­å¼€è¿æ¥
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . :
ä»¥å¤ªç½‘é€‚é…å™¨ vEthernet (Default Switch):
   è¿æ¥ç‰¹å®šçš„ DNS åç¼€ . . . . . . . :
   æœ¬åœ°é“¾æ¥ IPv6 åœ°å€. . . . . . . . : fe80::32b2:c0c6:87ff:664e%31
   IPv4 åœ°å€ . . . . . . . . . . . . : 172.25.112.1
   å­ç½‘æ©ç   . . . . . . . . . . . . : 255.255.240.0
   é»˜è®¤ç½‘å…³. . . . . . . . . . . . . :
```

ç»è¿‡éªŒè¯ï¼Œå…·ä½“è¯·æ±‚æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20241223142716133](./assets/image-20241223142716133.png)

### 13.6 Header

```yml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      # è·¯ç”±è§„åˆ™
      routes:
          # è·¯ç”±IDï¼Œå”¯ä¸€
        - id: bettytsai-system
          # ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€
          uri: http://127.0.0.1:9000/
          # æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰
          predicates:
            # åŒ¹é…è¯·æ±‚å¤´åŒ…å« X-Request-Id å¹¶ä¸”å®ƒçš„å€¼ä¸º \d+ ï¼ˆæ­£åˆ™ï¼šä»»æ„æ•°å€¼ï¼‰ çš„è¯·æ±‚
            - Header=X-Request-Id, \d+
```

 `Header=X-Request-Id, \d+`  è¡¨ç¤ºåŒ¹é…è¯·æ±‚å¤´åŒ…å« X-Request-Id å¹¶ä¸”å®ƒçš„å€¼ä¸º \d+ ï¼ˆæ­£åˆ™ï¼šä»»æ„æ•°å€¼ï¼‰ çš„è¯·æ±‚ï¼Œå…·ä½“è¯·æ±‚æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20241223143403071](./assets/image-20241223143403071.png)

## 14 åŠ¨æ€è·¯ç”±ï¼ˆæœåŠ¡å‘ç°çš„è·¯ç”±è§„åˆ™ï¼‰

åŠ¨æ€è·¯ç”±å…¶å®å°±æ˜¯é¢å‘æœåŠ¡çš„è·¯ç”±ï¼ŒSpring Cloud Gateway æ”¯æŒä¸Eureka æ•´åˆå¼€å‘ï¼Œæ ¹æ® serviceId è‡ªåŠ¨ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åœ°å€å¹¶è½¬å‘è¯·æ±‚ï¼Œè¿™æ ·åšçš„å¥½å¤„ä¸ä»…å¯ä»¥é€šè¿‡å•ä¸ªç«¯ç‚¹æ¥è®¿é—®åº”ç”¨çš„æ‰€æœ‰æœåŠ¡ï¼Œè€Œä¸”åœ¨æ·»åŠ å’Œç§»é™¤æœåŠ¡å®ä¾‹æ—¶ä¸ç”¨ä¿®æ”¹ Gateway çš„è·¯ç”±é…ç½®ã€‚

### 14.1 æ·»åŠ ä¾èµ–

ä¸ºäº†å®ç°åŠ¨æ€è·¯ç”±ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ç»“åˆ Eureka æ¥å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ  Eureka çš„ä¾èµ–ï¼š

```xml
<!--netflix eureka client-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
<!--è¿™ä¸ªæ˜¯å› ä¸ºæˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬ç¼ºå¤±è¯¥ç»„ä»¶ï¼Œè¯·è‡ªè¡Œåˆ¤æ–­æ˜¯å¦æ·»åŠ -->
<dependency>
    <groupId>javax.inject</groupId>
    <artifactId>javax.inject</artifactId>
</dependency>
```

<div style="border: 1px solid rgba(254, 40, 87,.1);
    padding: 10px;
    border-left: 5px solid rgba(254, 40, 87);
    background: rgba(254, 40, 87,.1);
    border-radius: 0 3px 3px 0;
    color:rgba(254, 40, 87);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" style="flex-shrink: 0;" width="14px" height="14px" fill="none" xmlns="http://www.w3.org/2000/svg" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-8l52ux" focusable="false" aria-hidden="true" data-testid="ErrorIcon"><path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <span style="line-height: 16px;">åœ¨å…¥é—¨æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å…¶å®å·²ç»æ·»åŠ è¿‡ netflix-eureka-client ä¾èµ–ï¼Œä½†æ˜¯å¹¶ä¸å½±å“æˆ‘ä»¬çš„å®è·µè¿‡ç¨‹ã€‚</span>
</div>

### 14.2 åŠ¨æ€è·å– URI 

#### 14.2.1 ä¸Šä¸‹æ–‡é…ç½®

é…ç½®æ³¨å†Œä¸­å¿ƒåŠåŠ¨æ€è·¯ç”±è§„åˆ™ï¼š

```yaml
server:
  port: 30000

spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      # è·¯ç”±è§„åˆ™
      routes:
          # è·¯ç”±IDï¼Œå”¯ä¸€
        - id: bettytsai-system
          # ç›®æ ‡URLï¼Œè·¯ç”±åˆ°å¾®æœåŠ¡çš„åœ°å€
          #uri: http://127.0.0.1:9000/
          # lb:// æ ¹æ®æœåŠ¡åç§°ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡è¯·æ±‚åœ°å€
          uri: lb://bettytsai-system
          # æ–­è¨€ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰
          predicates:
            # åŒ¹é…å¯¹åº”URLçš„è¯·æ±‚ï¼Œå°†åŒ¹é…åˆ°çš„è¯·æ±‚è¿½åŠ åˆ°ç›®æ ‡URIä¹‹å
            - Path=/system/**
            # åŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token çš„è¯·æ±‚
            #- Query=token
            # åŒ¹é…è¯·æ±‚å‚æ•°ä¸­åŒ…å« token å¹¶ä¸”å…¶å‚æ•°å€¼æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼ abcd. çš„è¯·æ±‚
            #- Query=token,abcd.
            # åŒ¹é…ä»»æ„ GET è¯·æ±‚
            #- Method=GET
            # åŒ¹é…ä¸­å›½ä¸Šæµ·æ—¶é—´ 2024-12-21 00:00:00 ä¹‹åçš„è¯·æ±‚
            #- After=2024-12-21T00:00:00.000+00:00[Asia/Shanghai]
            # åŒ¹é…æ¥è‡ªè¿œç¨‹åœ°å€ä¸º 192.168.100.101/0 çš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œ0ä¸ºå­ç½‘æ©ç 
            #- pxoteAddr=192.168.100.101/0
            # åŒ¹é…è¯·æ±‚å¤´åŒ…å« X-Request-Id å¹¶ä¸”å®ƒçš„å€¼ä¸º \d+ ï¼ˆæ­£åˆ™ï¼šä»»æ„æ•°å€¼ï¼‰ çš„è¯·æ±‚
            #- Header=X-Request-Id, \d+

# é…ç½®æ³¨å†Œä¸­å¿ƒ
eureka:
  client:
    # æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚
    fetch-registry: true
    # æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚
    register-with-eureka: true
    # æŒ‡ç¤ºä» eureka æœåŠ¡å™¨è·å–æ³¨å†Œè¡¨ä¿¡æ¯çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    registry-fetch-interval-seconds: 30
    # å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚
    # æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚
    # é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
    # ç¤ºä¾‹ï¼šhttps://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/
    # æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚
    service-url:
      defaultZone: http://admin:123456@127.0.0.1:8761/eureka/
  instance:
    # æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚
    prefer-ip-address: true
    # è·å–è¦å‘ eureka æ³¨å†Œçš„æ­¤å®ä¾‹çš„å”¯ä¸€ IDï¼ˆåœ¨ appName èŒƒå›´å†…ï¼‰
    instance-id: ${spring.cloud.client.ip-address}:${server.port}
    # æŒ‡ç¤º eureka å®¢æˆ·ç«¯éœ€è¦å‘ eureka æœåŠ¡å™¨å‘é€å¿ƒè·³ä»¥æŒ‡ç¤ºå®ƒä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    # å¦‚æœåœ¨ leaseExpirationDurationInSeconds ä¸­æŒ‡å®šçš„æ—¶é—´æ®µå†…æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ eureka æœåŠ¡å™¨å°†ä»å…¶è§†å›¾ä¸­åˆ é™¤è¯¥å®ä¾‹ï¼Œ
    # ä»è€Œç¦æ­¢æµå‘æ­¤å®ä¾‹çš„æµé‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœå®ä¾‹å®ç° HealthCheckCallbackï¼Œç„¶åå†³å®šä½¿è‡ªèº«ä¸å¯ç”¨ï¼Œåˆ™å®ä¾‹ä»ç„¶æ— æ³•è·å–æµé‡ã€‚
    lease-renewal-interval-in-seconds: 10
    # å¿…é¡»ä¸Dockerå®¹å™¨åä¿æŒä¸€è‡´
    hostname: ${spring.application.name}
```

#### 14.2.2 å¯åŠ¨ç±»

ä¿®æ”¹æˆ‘ä»¬å¯åŠ¨ç±»ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

```java
@Slf4j
@SpringBootApplication
public class GatewayMasterApplication {
    public static void main(String[] args) {
        ApplicationContext context = SpringApplication.run(GatewayMasterApplication.class, args);
        Environment environment = context.getEnvironment();
        String port = environment.getProperty("server.port");
        log.info(String.format(":::Gateway ç½‘å…³æœåŠ¡ï¼ˆä¸»æœåŠ¡ï¼‰å¯åŠ¨æˆåŠŸ....ç«¯å£å·::: %s", port));
    }
}
```

é‡å¯ç½‘å…³æœåŠ¡ï¼Œæ‰“å¼€ Eureka æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œæ£€æŸ¥ç½‘å…³æ˜¯å¦æˆåŠŸæ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒï¼š

![image-20241223145154305](./assets/image-20241223145154305.png) 

é€šè¿‡ Postman éªŒè¯æˆ‘ä»¬çš„è¯·æ±‚èƒ½å¦é€šè¿‡ç½‘å…³è¿›è¡Œè½¬å‘ï¼š

![image-20241223145236714](./assets/image-20241223145236714.png)

### 14.3 æœåŠ¡åç§°è½¬å‘

åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬æåˆ°é€šè¿‡  `lb:// `  æ ¹æ®æœåŠ¡åç§°ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡è¯·æ±‚åœ°å€çš„æ–¹å¼ï¼Œåœ¨å¾®æœåŠ¡å®ä¾‹å¢å‡çš„æ—¶å€™ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨çš„å»æ·»åŠ é…ç½®ï¼Œè¿˜æ˜¯å¾ˆä¸æ–¹ä¾¿çš„ï¼Œé‚£æˆ‘ä»¬è¿˜æ˜¯è¦å†™å¾ˆå¤šè·¯ç”±è§„åˆ™ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯éµå¾ª çº¦å®šå¤§äºé…ç½® çš„è§„åˆ™å»å®ç°é€šè¿‡æœåŠ¡åç§°è¿›è¡Œè½¬å‘çš„è·¯ç”±ã€‚

#### 14.3.1 ä¸Šä¸‹æ–‡é…ç½®

```yaml
server:
  port: 30000

spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

eureka:
  client:
    # æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚
    fetch-registry: true
    # æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚
    register-with-eureka: true
    # æŒ‡ç¤ºä» eureka æœåŠ¡å™¨è·å–æ³¨å†Œè¡¨ä¿¡æ¯çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    registry-fetch-interval-seconds: 30
    # å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚
    # æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚
    # é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
    # ç¤ºä¾‹ï¼šhttps://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/
    # æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚
    service-url:
      defaultZone: http://admin:123456@127.0.0.1:8761/eureka/
  instance:
    # æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚
    prefer-ip-address: true
    # è·å–è¦å‘ eureka æ³¨å†Œçš„æ­¤å®ä¾‹çš„å”¯ä¸€ IDï¼ˆåœ¨ appName èŒƒå›´å†…ï¼‰
    instance-id: ${spring.cloud.client.ip-address}:${server.port}
    # æŒ‡ç¤º eureka å®¢æˆ·ç«¯éœ€è¦å‘ eureka æœåŠ¡å™¨å‘é€å¿ƒè·³ä»¥æŒ‡ç¤ºå®ƒä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    # å¦‚æœåœ¨ leaseExpirationDurationInSeconds ä¸­æŒ‡å®šçš„æ—¶é—´æ®µå†…æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ eureka æœåŠ¡å™¨å°†ä»å…¶è§†å›¾ä¸­åˆ é™¤è¯¥å®ä¾‹ï¼Œ
    # ä»è€Œç¦æ­¢æµå‘æ­¤å®ä¾‹çš„æµé‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœå®ä¾‹å®ç° HealthCheckCallbackï¼Œç„¶åå†³å®šä½¿è‡ªèº«ä¸å¯ç”¨ï¼Œåˆ™å®ä¾‹ä»ç„¶æ— æ³•è·å–æµé‡ã€‚
    lease-renewal-interval-in-seconds: 10
    # å¿…é¡»ä¸Dockerå®¹å™¨åä¿æŒä¸€è‡´
    hostname: ${spring.application.name}
```

#### 14.3.2 å¯åŠ¨ç±»

```java
@Slf4j
@SpringBootApplication
public class GatewayMasterApplication {
    public static void main(String[] args) {
        ApplicationContext context = SpringApplication.run(GatewayMasterApplication.class, args);
        Environment environment = context.getEnvironment();
        String port = environment.getProperty("server.port");
        log.info(String.format(":::Gateway ç½‘å…³æœåŠ¡ï¼ˆä¸»æœåŠ¡ï¼‰å¯åŠ¨æˆåŠŸ....ç«¯å£å·::: %s", port));
    }
}
```

é‡æ–°å¯åŠ¨æˆ‘ä»¬çš„ç½‘å…³æœåŠ¡ï¼Œæˆ‘ä»¬å†é€šè¿‡ Postman éªŒè¯ä¸‹æˆ‘ä»¬çš„æœåŠ¡æ˜¯å¦å¯ç”¨ï¼š

![image-20241223150332692](./assets/image-20241223150332692.png)

å¿ƒç»†çš„äººå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬è¯·æ±‚åœ°å€å‰å¤šäº†ä¸€æ®µ  `/bettytsai-system`  è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ï¼Œçº¦å®šå¤§äºé…ç½®ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å®ç°  `RouteDefinitionRepository ` æ¥å£ï¼Œå°†è·¯ç”±å­˜åœ¨æ•°æ®åº“ä¸­ï¼ŒåŠ¨æ€çš„è·å–å¹¶ä¸”æ›´æ–°è·¯ç”±ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªåŠ¨æ€è·å–è·¯ç”±çš„ç¤ºä¾‹ä»£ç ï¼ˆéæ•°æ®åº“ï¼‰ï¼š

```java
@Configuration
public class GatewayRoutesConfig {

    @Resource
    private DiscoveryClient discoveryClient;

    @Bean
    public RouteLocator routeLocator(RouteLocatorBuilder builder) {
        RouteLocatorBuilder.Builder build = builder.routes();
        List<String> serviceIds = discoveryClient.getServices();
        for (String serviceId : serviceIds) {
            List<ServiceInstance> instances = discoveryClient.getInstances(serviceId);
            for (ServiceInstance instance : instances) {
                String id = StringUtils.lowerCase(instance.getServiceId());
                build.route(id, route -> route.query("service",id).uri("lb://"+ id));
            }
        }
        return build.build();
    }
}
```

ä¸Šä¸‹æ–‡é…ç½®ä¸­åªéœ€è¦æ·»åŠ ï¼š

```yml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
```

å¼€å¯ Eureka è´Ÿè½½å‡è¡¡é…ç½®ï¼Œä½†è¿™æ ·ä»ç„¶å­˜åœ¨å¼Šç«¯ï¼Œæ¯å½“æœåŠ¡åˆ å‡æ—¶ï¼Œéœ€è¦é‡å¯ç½‘å…³æœåŠ¡å·²æ›´æ–°è·¯ç”±ã€‚å…³äºå¦‚ä½•ç»“åˆæ•°æ®åº“æ¥é…ç½®è·¯ç”±ï¼Œè¯·è‡ªè¡ŒæŸ¥æ‰¾èµ„æ–™ã€‚

## 15 è¿‡æ»¤å™¨

Spring Cloud Gateway æ ¹æ®ä½œç”¨èŒƒå›´åˆ’åˆ†ä¸º  `GatewayFilter`  å’Œ  `GlobalFilter` ï¼ŒäºŒè€…åŒºåˆ«å¦‚ä¸‹ï¼š

-  `GatewayFilter` ï¼šç½‘å…³è¿‡æ»¤å™¨ï¼Œéœ€è¦é€šè¿‡  `spring.cloud.routes.filters`  é…ç½®åœ¨å…·ä½“è·¯ç”±ä¸‹ï¼Œåªä½œç”¨åœ¨å½“å‰è·¯ç”±æˆ–é€šè¿‡  `spring.cloud.default-filters`  é…ç½®åœ¨å…¨å±€ï¼Œä½œç”¨åœ¨æ‰€æœ‰è·¯ç”±ä¸Šã€‚
-  `GlobalFilter` ï¼šå…¨å±€è¿‡æ»¤å™¨ï¼Œä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œä½œç”¨åœ¨æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œæœ€ç»ˆé€šè¿‡  `GatewayFilterAdapter`  åŒ…è£…æˆ  `GatewayFilterChain`  å¯è¯†åˆ«çš„è¿‡æ»¤å™¨ï¼Œå®ƒä¸ºè¯·æ±‚ä¸šåŠ¡ä»¥åŠè·¯ç”±çš„ URI è½¬æ¢ä¸ºçœŸå®ä¸šåŠ¡æœåŠ¡è¯·æ±‚åœ°å€çš„æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œä¸éœ€è¦é…ç½®ç³»ç»Ÿåˆå§‹åŒ–æ—¶åŠ è½½ï¼Œå¹¶ä½œç”¨åœ¨æ¯ä¸ªè·¯ç”±ä¸Šã€‚

### 15.1 ç½‘å…³è¿‡æ»¤å™¨ GatewayFilter 

ç½‘å…³è¿‡æ»¤å™¨ç”¨äºæ‹¦æˆªå¹¶é“¾å¼å¤„ç† Web è¯·æ±‚ï¼Œå¯ä»¥å®ç°æ¨ªåˆ‡ä¸åº”ç”¨æ— å…³çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šå®‰å…¨ã€è®¿é—®è¶…æ—¶çš„è®¾ç½®ã€ä¿®æ”¹ä¼ å…¥çš„ HTTP è¯·æ±‚æˆ–ä¼ å‡º HTTP å“åº”ã€‚Spring Cloud Gateway åŒ…å«è®¸å¤šå†…ç½®çš„ç½‘å…³è¿‡æ»¤å™¨å·¥å‚ï¼ˆä¸€å…±22ä¸ªï¼‰ï¼ŒåŒ…æ‹¬ï¼šå¤´éƒ¨è¿‡æ»¤å™¨ã€è·¯å¾„ç±»è¿‡æ»¤å™¨ã€Hystrixè¿‡æ»¤å™¨å’Œé‡å†™è¯·æ±‚ URL çš„è¿‡æ»¤å™¨ï¼Œä»¥åŠå‚æ•°å’ŒçŠ¶æ€ç ç­‰å…¶ä»–ç±»å‹çš„è¿‡æ»¤å™¨ã€‚æ ¹æ®è¿‡æ»¤å™¨å·¥å‚çš„ç”¨é€”æ¥åˆ’åˆ†ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼šHeaderã€Parameterã€Path ã€Bodyã€Statusã€Sessionã€Redirectã€Retryã€RateLimiterã€Hystrixã€‚

![image-20241224101250620](./assets/image-20241224101250620.png)

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ä¾‹è¯´æ˜å…¶ä¸­ä¸€éƒ¨åˆ†å¦‚ä½•ä½¿ç”¨ï¼Œå…¶ä½™ç­‰å·¥ä½œæˆ–å­¦ä¹ éœ€è¦æ—¶å†æŸ¥è¯¢èµ„æ–™ã€‚

#### 15.1.1 Path è·¯å¾„è¿‡æ»¤å™¨

Path è·¯å¾„è¿‡æ»¤å™¨å¯ä»¥å®ç° URL é‡å†™ï¼Œé€šè¿‡é‡å†™ URL å¯ä»¥å®ç°éšè—å®é™…è·¯å¾„æé«˜å®‰å…¨æ€§ï¼Œæ˜“äºç”¨æˆ·è®°å¿†å’Œé”®å…¥ï¼Œæ˜“äºè¢«æœç´¢å¼•æ“æ”¶å½•ç­‰ä¼˜ç‚¹ï¼Œå®ç°æ–¹å¼å¦‚ä¸‹æ‰€è¿°ã€‚

##### 15.1.1.1 RewritePathGatewayFilterFactory

RewritePath ç½‘å…³è¿‡æ»¤å™¨å·¥å‚é‡‡ç”¨è·¯å¾„æ­£åˆ™è¡¨è¾¾å¼å‚æ•°å’Œæ›¿æ¢å‚æ•°ï¼Œä½¿ç”¨ Java æ­£åˆ™è¡¨è¾¾å¼çµæ´»çš„é‡å†™è¯·æ±‚è·¯å¾„ã€‚

```yml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/system/**,/api-gateway/** 
          # ç½‘å…³è¿‡æ»¤å™¨
          filters:
            # å°† /api-gateway/system/xx é‡å†™ä¸º /system/xx
            - RewritePath=/api-gateway(?<segment>/?.*),$\{segment}
```

æ‰“å¼€ Postman è®¿é—®åœ°å€  `localhost:30000/api-gateway/system/getDefaultString` ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š

 ![image-20241223161025237](./assets/image-20241223161025237.png)

##### 15.1.1.2 PrefixPathGatewayFilterFactory

PrefixPath ç½‘å…³è¿‡æ»¤å™¨å·¥å‚ä¸ºåŒ¹é…çš„ URI æ·»åŠ æŒ‡å®šçš„å‰ç¼€ã€‚

```yml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/**
          filters:
            # å°† /** é‡å†™ä¸º /system/** 
            - PrefixPath=/system
```

æ‰“å¼€ Postman è®¿é—®åœ°å€  `localhost:30000/getDefaultString` ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241223162004284](./assets/image-20241223162004284.png)

##### 15.1.1.3 StripPrefixGatewayFilterFactory

StripPrefix ç½‘å…³è¿‡æ»¤å™¨å·¥å‚é‡‡ç”¨ä¸€ä¸ªå‚æ•° StripPrefixï¼Œè¯¥å‚æ•°è¡¨ç¤ºåœ¨å°†è¯·æ±‚å‘é€åˆ°ä¸‹æ¸¸ä¹‹å‰ä»è¯·æ±‚ä¸­å‰¥ç¦»çš„è·¯å¾„ä¸ªæ•°ã€‚

```yml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/**
          filters:
            # åœ¨å°†è¯·æ±‚å‘é€åˆ°ä¸‹æ¸¸ä¹‹å‰ä»è¯·æ±‚ä¸­å‰¥ç¦»çš„è·¯å¾„ä¸ªæ•°
            - StripPrefix=2
```

æ‰“å¼€ Postman è®¿é—®åœ°å€  `localhost:30000/api/xxx/system/getDefaultString` ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241223163324080](./assets/image-20241223163324080.png)

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;">åœ¨ä¸Šè¿°æ¡ˆä¾‹ä¸­ï¼Œ/api/xxx å†™å•¥éƒ½è¡Œã€‚</span>
</div>

##### 15.1.1.4 SetPathGatewayFilterFactory

SetPath ç½‘å…³è¿‡æ»¤å™¨å·¥å‚é‡‡ç”¨è·¯å¾„æ¨¡æ¿å‚æ•°ï¼Œå®ƒæä¾›äº†ä¸€ç§é€šè¿‡çš„ç®€å•æ–¹æ³•ï¼Œä½¿ç”¨ Spring Framework ä¸­çš„ uri çš„æ¨¡æ¿ï¼Œå…è®¸å¤šä¸ªåŒ¹é…æ®µã€‚

```yml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/api/system/{segment}
          filters:
            # å…è®¸æ¨¡æ¿åŒ–è·¯å¾„æ¥æ“ä½œè¯·æ±‚è·¯å¾„
            - SetPath=/system/{segment}
```

æ‰“å¼€ Postman è®¿é—®åœ°å€  `localhost:30000/api/system/getDefaultString` ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241223163906651](./assets/image-20241223163906651.png)

#### 15.1.2 Parameter å‚æ•°è¿‡æ»¤å™¨

AddRequestParameter ç½‘å…³è¿‡æ»¤å™¨å·¥å‚ä¼šå°†æŒ‡å®šå‚æ•°æ·»åŠ è‡³åŒ¹é…åˆ°çš„ä¸‹æ¸¸è¯·æ±‚ä¸­ã€‚

```yaml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/system/**
          filters:
            # å°†æŒ‡å®šå‚æ•°æ·»åŠ è‡³åŒ¹é…åˆ°çš„ä¸‹æ¸¸è¯·æ±‚
            - AddRequestParameter=name,pitter
```

è°ƒæ•´æˆ‘ä»¬çš„æœåŠ¡æä¾›è€…ä»£ç ï¼Œæ–¹ä¾¿æµ‹è¯•ï¼š

```java
@Slf4j
@RestController
@RequestMapping(value = "/system")
public class TestController {
    @Autowired
    private TestService testService;

    @GetMapping(value = "/getDefaultString")
    public String getDefaultString(@RequestParam("name") String name) {
        return testService.getDefaultLabel() + ">>>> info::: "+ name;
    }
}
```

æ‰“å¼€ Postman è®¿é—®åœ°å€  `localhost:30000/system/getDefaultString` ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241223164716012](./assets/image-20241223164716012.png)

#### 15.1.3 Status çŠ¶æ€è¿‡æ»¤å™¨

SetStatus ç½‘å…³è¿‡æ»¤å™¨å·¥å‚é‡‡ç”¨å•ä¸ªçŠ¶æ€å‚æ•°ï¼Œå®ƒå¿…é¡»æ˜¯æœ‰æ•ˆçš„ Spring HttpStatusã€‚å®ƒå¯ä»¥æ˜¯æ•´æ•° 404 æˆ–æšä¸¾  `NOT_FOUND`  çš„å­—ç¬¦ä¸²è¡¨ç¤ºã€‚

```yaml
spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/system/**
          filters:
            # ä»»ä½•çŠ¶æ€ä¸‹ï¼Œå“åº”çš„ HTTP çŠ¶æ€éƒ½å°†è®¾ç½®ä¸º 404
            - SetStatus=404
```

æ‰“å¼€ Postman è®¿é—®åœ°å€  `localhost:30000/system/getDefaultString` ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241223165608524](./assets/image-20241223165608524.png)

### 15.2 å…¨å±€è¿‡æ»¤å™¨ GlobalFilter

å…¨å±€è¿‡æ»¤å™¨ä¸éœ€è¦å†é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œä½œç”¨åœ¨æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œæœ€ç»ˆé€šè¿‡ GatewayFilterAdapter åŒ…è£…æˆ GatewayFilterChain å¯è¯†åˆ«çš„è¿‡æ»¤å™¨ï¼Œå®ƒæ˜¯è¯·æ±‚ä¸šåŠ¡åŠè·¯ç”±çš„ URI è½¬æ¢ä¸ºçœŸå®ä¸šåŠ¡è¯·æ±‚åœ°å€çš„æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œä¸éœ€è¦é…ç½®ç³»ç»Ÿåˆå§‹åŒ–æ—¶åŠ è½½ï¼Œå¹¶ä½œç”¨åœ¨æ¯ä¸ªè·¯ç”±ä¸Šã€‚

![image-20241223170407574](./assets/image-20241223170407574.png)

### 15.3 è‡ªå®šä¹‰è¿‡æ»¤å™¨

å³ä½¿ Spring Cloud Gateway è‡ªå¸¦è®¸å¤šéå¸¸å®ç”¨çš„ç½‘å…³è¿‡æ»¤å™¨å·¥å‚ã€ç½‘å…³è¿‡æ»¤å™¨å’Œå…¨å±€è¿‡æ»¤å™¨ï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å½¢ä¸‹æˆ‘ä»¬ä»ç„¶å¸Œæœ›å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„è¿‡æ»¤å™¨ï¼Œå®ç°ä¸€äº›æ¯”è¾ƒéªšğŸ˜„çš„æ“ä½œã€‚

#### 15.3.1 è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨

è‡ªå®šä¹‰ç½‘å…³è¿‡æ»¤å™¨éœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªæ¥å£ï¼š `GatewayFilter` ï¼Œ `Ordered` ã€‚

##### 15.3.1.1 åˆ›å»ºè¿‡æ»¤å™¨

```java
public class CustomGatewayFilter implements GatewayFilter, Ordered {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpResponse response = exchange.getResponse();
        HttpStatus code = response.getStatusCode();
        int value = code.value();
        if(value!=200 && value!=500) {
            response.setStatusCode(HttpStatus.BAD_GATEWAY);
        }
        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

ä¸Šè¿°è¿‡æ»¤å™¨å¯ä»¥å¤„ç†è¯·æ±‚çŠ¶æ€ç é 200 æˆ– 500 ä¹‹å¤–çš„å…¶ä»–çŠ¶æ€ç ï¼Œç»Ÿä¸€è®¾ç½®ä¸º  `BAD_GATEWAY` ï¼Œå¤§è‡´æ•ˆæœå¦‚ä¸‹ï¼š

![image-20241223173011380](./assets/image-20241223173011380.png)

##### 15.3.1.2 æ³¨å†Œè¿‡æ»¤å™¨

```java
@Configuration
public class GatewayRoutesConfig {

    @Bean
    public RouteLocator routeLocator(RouteLocatorBuilder builder) {
        return builder.routes()
                .route("bettytsai-system",
                        r -> r.path("/system/**")
                                .filters(spec -> spec.filters(new CustomGatewayFilter()))
                                .uri("lb://bettytsai-system"))
                .build();
    }

}
```

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;">å£°æ˜ï¼šä¸åŒç‰ˆæœ¬çš„ Spring Cloud Gateway é“¾å¼å†™æ³•ä¸ä¸€è‡´ï¼Œè¯·è‡ªè¡ŒæŸ¥è¯¢èµ„æ–™ã€‚</span>
</div>

#### 15.3.2 è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨

è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨éœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªæ¥å£ï¼š `GlobalFilter`  ã€ `Ordered` ã€‚é€šè¿‡å…¨å±€è¿‡æ»¤å™¨å¯ä»¥å®ç°æƒé™æ ¡éªŒã€å®‰å…¨æ€§éªŒè¯ç­‰åŠŸèƒ½ã€‚

##### 15.3.2.1 åˆ›å»ºè¿‡æ»¤å™¨

å®ç°æŒ‡å®šæ¥å£ï¼Œæ·»åŠ   ` @Component`  æ³¨è§£å³å¯ã€‚

```java
@Slf4j
@Component
public class CustomGlobalFilter implements GlobalFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
       log.info("======> è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨!");
        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

##### 15.3.2.2 éªŒè¯è¿‡æ»¤å™¨

![image-20241223175819572](./assets/image-20241223175819572.png)

#### 15.3.3 ç»Ÿä¸€é‰´æƒå®ç°

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ç½‘å…³è¿‡æ»¤å™¨ä¸­é€šè¿‡ Token åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œå®Œæˆä¸€ä¸ªç»Ÿä¸€é‰´æƒçš„ â€œæ¡ˆä¾‹â€ã€‚

##### 15.3.3.1 åˆ›å»ºé‰´æƒè¿‡æ»¤å™¨

```java
@Slf4j
@Component
public class AccessFilter implements GlobalFilter, Ordered {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        MultiValueMap<String, String> params = exchange.getRequest().getQueryParams();
        String token = params.getFirst("token");
        if(StringUtils.isBlank(token)){
            log.error("Token not exist.");
            ServerHttpResponse response = exchange.getResponse();
            response.getHeaders().add("Content-Type","application/json;charset=utf-8");
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            String message = "{\"message\":\""+HttpStatus.UNAUTHORIZED.getReasonPhrase()+"\"}";
            DataBuffer buffer = response.bufferFactory().wrap(message.getBytes());
            // è¯·æ±‚ç»ˆæ­¢ï¼Œä¸å†ç»§ç»­
            return response.writeWith(Mono.just(buffer));
        }
        log.info("authorized successfully");
        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return 1;
    }
}
```

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;">ä¸Šè¿°ä»£ç åªæ˜¯åšä¸ªæ¼”ç¤ºï¼Œå®é™…é¡¹ç›®ä¸­ä¸ä¼šè¿™æ ·å»å®ç°ã€‚åªæ˜¯è¯´æ˜ï¼Œé‰´æƒæ“ä½œä¸€èˆ¬æ”¾åœ¨ç½‘å…³ä¸­å»å®ç°ã€‚</span>
</div>

##### 15.3.3.2 éªŒè¯é‰´æƒè¿‡æ»¤å™¨

é€šè¿‡è®¿é—®åœ°å€  `localhost:30000/system/getDefaultString`  ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”å‘ç°ï¼Œå¦‚æœå­˜åœ¨ æŒ‡å®š  `token`  å‚æ•°æ‰å¯ä»¥è¯·æ±‚é€šè¿‡ï¼š

![image-20241223204003228](./assets/image-20241223204003228.png)

![image-20241223204141968](./assets/image-20241223204141968.png)

## 16 ç½‘å…³é™æµ

é¡¾åæ€ä¹‰ï¼Œé™æµå°±æ˜¯é™åˆ¶æµé‡ï¼Œå°±åƒä½ å®½å¸¦åŒ…åªæœ‰ 1GB çš„æµé‡ï¼Œç”¨å®Œå°±æ²¡äº†ã€‚é€šè¿‡é™æµï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¥½çš„æ§åˆ¶ç³»ç»Ÿçš„ QPSï¼Œä»è€Œè¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ã€‚

### 16.1 ä¸ºä»€ä¹ˆéœ€è¦é™æµ

æ¯”å¦‚ Web æœåŠ¡ï¼Œå¯¹å¤– API ï¼Œè¿™ç§ç±»å‹çš„æœåŠ¡æœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½å¯¼è‡´æœºå™¨è¢«æ‹–å®ï¼š

- ç”¨æˆ·å¢é•¿è¿‡å¿«ï¼ˆè¿™æ˜¯å¥½äº‹ğŸ˜„ï¼‰

- å› ä¸ºæŸä¸ªçƒ­ç‚¹äº‹ä»¶ï¼ˆæ¯”å¦‚å¾®åšçƒ­æœï¼‰

- ç«äº‰å¯¹è±¡çˆ¬è™«
- æ¶æ„è¯·æ±‚

è¿™äº›æƒ…å†µéƒ½æ˜¯æ— æ³•é¢„çŸ¥çš„ï¼Œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šæœ‰ 10 å€ç”šè‡³ 20 å€çš„æµé‡æ‰“è¿›æ¥ï¼Œå¦‚æœçœŸç¢°ä¸Šè¿™ç§æƒ…å†µï¼Œæ‰©å®¹æ ¹æœ¬æ¥ä¸åŠã€‚

![image-20241223205037097](./assets/image-20241223205037097.png)

ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¯¹å†…è€Œè¨€ï¼šä¸Šæ¸¸çš„ Aã€B æœåŠ¡ç›´æ¥ä¾èµ–äº†ä¸‹æ¸¸çš„åŸºç¡€æœåŠ¡ Cï¼Œå¯¹äº Aã€B æœåŠ¡éƒ½ä¾èµ–çš„åŸºç¡€æœåŠ¡ C è¿™ç§åœºæ™¯ï¼ŒæœåŠ¡ A å’Œ B å…¶å®å¤„äºæŸç§ç«äº‰å…³ç³»ï¼Œå¦‚æœæœåŠ¡ A çš„å¹¶å‘é˜ˆå€¼è®¾ç½®è¿‡å¤§ï¼Œå½“æµé‡é«˜å³°æœŸåˆ°æ¥ï¼Œæœ‰å¯èƒ½ç›´æ¥æ‹–è·¨åŸºç¡€æœåŠ¡ C å¹¶å½±å“æœåŠ¡ Bï¼Œä¹Ÿå°±æ˜¯é€ æˆäº†<span style="color:#ff6e00;">é›ªå´©æ•ˆåº”</span>ã€‚

### 16.2 é™æµç®—æ³•

å¸¸è§çš„é™æµç®—æ³•æœ‰ï¼š

- è®¡æ•°å™¨ç®—æ³•
- æ¼æ¡¶ï¼ˆLeaky Bucketï¼‰ç®—æ³•

- ä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰ç®—æ³•

#### 16.2.1 è®¡æ•°å™¨ç®—æ³•

è®¡æ•°å™¨ç®—æ³•æ˜¯é™æµç®—æ³•ä¸­æœ€ç®€å•ä¸”æœ€å®¹æ˜“å®ç°çš„ä¸€ç§ç®—æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬è§„å®šï¼Œå¯¹äº æ¥å£A æ¥è¯´ï¼Œæˆ‘ä»¬ 1 åˆ†é’Ÿå†…çš„è®¿é—®æ¬¡æ•°ä¸èƒ½è¶…è¿‡ 100 æ¬¡ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼šåœ¨ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ counterï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œcounter å°±åŠ  1ï¼Œå¦‚æœ counter çš„å€¼å¤§äº 100 å¹¶ä¸”è¯¥è¯·æ±‚ä¸ç¬¬ä¸€ä¸ªè¯·æ±‚çš„é—´éš”è¿˜åœ¨ 1 åˆ†é’Ÿä¹‹å†…ï¼Œé‚£ä¹ˆè§¦å‘é™æµï¼›å¦‚æœè¯¥è¯·æ±‚ä¸ç¬¬ä¸€ä¸ªè¯·æ±‚çš„é—´éš”å¤§äº 1 åˆ†é’Ÿï¼Œé‡ç½® counter é‡æ–°è®¡æ•°ï¼Œå…·ä½“ç®—æ³•çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

<img src="./assets/image-20241223211750996.png" alt="image-20241223211750996" style="zoom:67%;" />

è¿™ä¸ªç®—æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªååˆ†è‡´å‘½çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸´ç•Œå€¼çš„é—®é¢˜ï¼Œæˆ‘ä»¬çœ‹ä¸‹å›¾ï¼š

 <img src="./assets/image-20241223211823709.png" alt="image-20241223211823709" style="zoom: 50%;" />

ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå‡è®¾å­˜åœ¨ä¸€ä¸ªæ¶æ„çš„ç”¨æˆ·ï¼Œåœ¨ç¬¬ 59 s çš„æ—¶å€™ï¼Œé€šè¿‡æŸç§æ‰‹æ®µï¼ˆæ¯”å¦‚ï¼šæ¸—é€æµ‹è¯•ï¼‰ç¬é—´å‘é€äº† 100 ä¸ªè¯·æ±‚ï¼Œåœ¨ ç¬¬ 60 s ï¼ˆè¿™ä¸ªæ—¶å€™è®¡æ•°å™¨å·²ç»è¢«é‡ç½®äº†ï¼‰çš„æ—¶å€™åˆå‘é€äº† 100ä¸ªè¯·æ±‚ï¼Œç›¸å½“äºè¿™ä¸ªç”¨æˆ·åœ¨ 1s æ—¶é—´å†…ï¼Œç¬é—´å‘é€äº† 200 ä¸ªè¯·æ±‚ã€‚ä¸€å¼€å§‹æˆ‘ä»¬è§„å®šçš„æ˜¯ 1 åˆ†é’Ÿå†…æœ€å¤š 100ä¸ªè¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’æœ€å¤§ 1.7 ä¸ªè¯·æ±‚ï¼Œç”¨æˆ·é€šè¿‡åœ¨æ—¶é—´çª—å£çš„é‡ç½®èŠ‚ç‚¹å¤„çªå‘å¤§é‡è¯·æ±‚ï¼Œå¯ä»¥ç¬é—´è¶…è¿‡æˆ‘ä»¬çš„é™æµé˜ˆå€¼ã€‚ç”¨æˆ·å¾ˆæœ‰å¯èƒ½é€šè¿‡ç®—æ³•çš„è¿™ä¸ªæ¼æ´ï¼Œç¬é—´å‹å®æˆ‘ä»¬çš„åº”ç”¨ã€‚



ä¸ä»…å¦‚æ­¤ï¼Œè¿˜å­˜åœ¨èµ„æºæµªè´¹çš„é—®é¢˜ï¼Œæˆ‘ä»¬çš„é¢„æƒ³ç®—æ³•æ˜¯å¸Œæœ› 100 ä¸ªè¯·æ±‚å‡åŒ€çš„åˆ†æ•£åœ¨ 1 åˆ†é’Ÿå†…ï¼Œå‡è®¾ 30s å†…æˆ‘ä»¬è¯·æ±‚å°±è¾¾åˆ°ä¸Šé™äº†ï¼Œå‰©ä¸‹çš„åŠåˆ†é’Ÿå†…ï¼ŒæœåŠ¡å™¨å°±å¤„äºé—²ç½®çŠ¶æ€ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼š

<img src="./assets/image-20241223212658994.png" alt="image-20241223212658994" style="zoom: 50%;" />

#### 16.2.2 æ¼æ¡¶ç®—æ³•

æ¼æ¡¶ç®—æ³•å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥ç²—ç•¥çš„è®¤ä¸ºå°±æ˜¯æ³¨æ°´æ¼æ°´çš„è¿‡ç¨‹ä¸­ï¼Œå¾€æ¡¶ä¸­ä»¥ä»»æ„é€Ÿç‡æµå…¥ç¨ï¼Œä»¥ä¸€å®šé€Ÿç‡æµå‡ºæ°´ï¼Œå½“æ°´è¶…è¿‡æ¡¶æµé‡åˆ™ä¸¢å¼ƒï¼Œå› ä¸ºæ¡¶å®¹é‡ä¸å˜ï¼Œä¿è¯äº†æ•´ä½“çš„é€Ÿç‡ã€‚

<img src="./assets/image-20241223221643027.png" alt="image-20241223221643027" style="zoom:77%;" />

æ¼æ¡¶ç®—æ³•é€šè¿‡é˜Ÿåˆ—æœºåˆ¶å®ç°ï¼Œå¦‚ä¸‹å›¾ï¼š

<img src="./assets/image-20241223222215371.png" alt="image-20241223222215371" style="zoom:80%;" />

ä½†æ˜¯æ¼æ¡¶ç®—æ³•ä¹Ÿå­˜åœ¨è‡´å‘½çš„é—®é¢˜ï¼Œå½“å„æœåŠ¡å¤§é‡è¯·æ±‚æ‰“è¿›æ¥ï¼Œæ¡¶å†…æµé‡å †ç§¯ä¼šé€ æˆç½‘å…³å‹åŠ›å·¨å¤§ï¼Œä¸€æ—¦ç½‘å…³å®•æœºï¼Œæ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿå°†å´©æºƒã€‚

#### 16.2.3 ä»¤ç‰Œæ¡¶ç®—æ³•

ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯å¯¹æ¼æ¡¶ç®—æ³•çš„ä¸€ç§æ”¹è¿›ï¼Œæ¼æ¡¶ç®—æ³•èƒ½å¤Ÿé™åˆ¶è¯·æ±‚è°ƒç”¨çš„é€Ÿç‡ï¼Œè€Œä»¤ç‰Œæ¡¶ç®—æ³•èƒ½å¤Ÿåœ¨é™åˆ¶è°ƒç”¨çš„å¹³å‡é€Ÿç‡çš„åŒæ—¶è¿˜å…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘è°ƒç”¨ã€‚åœ¨ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªæ¡¶ï¼Œç”¨æ¥å­˜æ”¾å›ºå®šæ•°é‡çš„ä»¤ç‰Œã€‚<span style="color:#ff6e00;">ç®—æ³•ä¸­å­˜åœ¨ä¸€ç§æœºåˆ¶ï¼Œä»¥ä¸€å®šé€Ÿç‡å¾€æ¡¶ä¸­æ”¾ä»¤ç‰Œï¼Œæ¯æ¬¡è°ƒç”¨è¯·æ±‚éœ€è¦å…ˆè·å–ä»¤ç‰Œï¼Œåªæœ‰æ‹¿åˆ°ä»¤ç‰Œï¼Œæ‰æœ‰æœºä¼šç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™é€‰æ‹©ç­‰å¾…å¯ç”¨çš„ä»¤ç‰Œã€æˆ–è€…ç›´æ¥æ‹’ç»ã€‚</span>æ”¾ä»¤ç‰Œçš„è¿™ä¸ªåŠ¨ä½œæ˜¯æŒç»­ä¸æ–­åœ°è¿›è¡Œçš„ï¼Œå¦‚æœæ¡¶ä¸­ä»¤ç‰Œè¾¾åˆ°ä¸Šé™ï¼Œå°±ä¸¢å¼ƒä»¤ç‰Œã€‚

> **âœ¨ åœºæ™¯ï¼š** 
>
> æ¡¶ä¸­ä¸€ç›´æœ‰å¤§é‡å¯ç”¨çš„ä»¤ç‰Œï¼Œè¿™æ—¶å€™è¿›æ¥çš„è¯·æ±‚èƒ½å¤Ÿç›´æ¥æ‹¿åˆ°ä»¤ç‰Œæ‰§è¡Œã€‚æ¯”å¦‚è®¾ç½® QPS ä¸º100/sï¼Œé‚£ä¹ˆé™æµå™¨åˆå§‹åŒ–å®Œæˆ 1 s åï¼Œæ¡¶å†…å°±å·²ç»æœ‰äº† 100 ä¸ªä»¤ç‰Œï¼Œç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆå¯¹å¤–æä¾›æœåŠ¡æ—¶ï¼Œè¯¥é™æµå™¨å¯ä»¥æŠµæŒ¡ç¬æ—¶ 100 ä¸ªè¯·æ±‚ã€‚å½“æ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œè¯·æ±‚ç»§ç»­ç­‰å¾…ï¼Œæœ€åç›¸å½“äºä»¥ä¸€å®šé€Ÿç‡æ‰§è¡Œã€‚

Spring Cloud Gateway å†…éƒ¨ä½¿ç”¨çš„å°±æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå¤§æ¦‚æè¿°å¦‚ä¸‹ï¼š

- å¯¹æ‰€æœ‰çš„è¯·æ±‚åœ¨å¤„ç†ä¹‹å‰éƒ½éœ€è¦æ‹¿åˆ°ä¸€ä¸ªå¯ç”¨çš„ä»¤ç‰Œæ‰ä¼šè¢«å¤„ç†ï¼›
- æ ¹æ®é™æµå¤§å°ï¼Œè®¾ç½®æŒ‰ç…§ä¸€å®šçš„é€Ÿç‡å¾€æ¡¶é‡Œæ·»åŠ ä»¤ç‰Œï¼›
- æ¡¶è®¾ç½®æœ€å¤§çš„æ”¾ç½®ä»¤ç‰Œé™åˆ¶ï¼Œæ¡¶æ»¡æ—¶ï¼Œæ–°æ·»åŠ çš„ä»¤ç‰Œç›´æ¥ä¸¢å¼ƒæˆ–è¢«æ‹’ç»ï¼›
- è¯·æ±‚è¾¾åˆ°åé¦–å…ˆè¦è·å–ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œï¼Œæ‹¿ç€ä»¤ç‰Œæ‰å¯ä»¥è¿›è¡Œå…¶ä»–çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå¤„ç†å®Œä¸šåŠ¡é€»è¾‘ä¹‹åï¼Œå°†ä»¤ç‰Œç›´æ¥åˆ é™¤ï¼›
- <span style="color:#ff6e00;">ä»¤ç‰Œæ¡¶å­˜åœ¨æœ€ä½é™é¢ï¼Œå½“æ¡¶å†…ä»¤ç‰Œè¾¾åˆ°æœ€ä½é™é¢æ—¶ï¼Œè¯·æ±‚å¤„ç†å®Œåä¸ä¼šåˆ é™¤ä»¤ç‰Œï¼Œä»¥ä¿è¯è¶³å¤Ÿçš„é™æµï¼›</span>

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="./assets/image-20241223223610164.png" alt="image-20241223223610164" style="zoom:77%;" />

é€šè¿‡å¯¹æ¯”æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ¼æ¡¶ç®—æ³•ä¸»è¦ç”¨é€”åœ¨äºä¿æŠ¤å„ä¸ªå¾®æœåŠ¡ç»„ä»¶ï¼Œè€Œä»¤ç‰Œæ¡¶ç®—æ³•ä¸»è¦ç›®çš„åœ¨äºä¿æŠ¤ç½‘å…³æœ¬èº«ï¼Œå°†è¯·æ±‚çš„å‹åŠ›äº¤ç»™ç›®æ ‡æœåŠ¡è‡ªå·±å»å¤„ç†ã€‚å‡è®¾çªç„¶è¿›æ¥å¾ˆå¤šè¯·æ±‚ï¼Œåªæœ‰æ‹¿åˆ°ä»¤ç‰Œçš„è¯·æ±‚æ‰ä¼šç¬æ—¶è¢«å¤„ç†è°ƒç”¨ç›®æ ‡æœåŠ¡ã€‚

### 16.3 Gateway é™æµ

Spring Cloud Gateway å®˜æ–¹æä¾›äº†  `RequestRateLimiterGatewayFilterFactory`  è¿‡æ»¤å™¨å·¥å‚ï¼Œä½¿ç”¨ Redis å’Œ Lua è„šæœ¬å®ç°äº†ä»¤ç‰Œæ¡¶çš„æ–¹å¼ã€‚

âœ¨ å…·ä½“çš„å®ç°é€»è¾‘åœ¨  `RequestRateLimiterGatewayFilterFactory`  ç±»ä¸­ï¼ŒLua è„šæœ¬åœ¨å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æºç æ–‡ä»¶ä¸­ï¼š

![image-20241224095643143](./assets/image-20241224095643143.png)

>   ğŸ“– å®˜æ–¹æ–‡æ¡£ [spring.io](https://docs.spring.io/spring-cloud-gateway/docs/3.1.4/reference/html/#the-requestratelimiter-gatewayfilter-factory) ä¸­çš„æ¦‚è¿°å¤§è‡´å¦‚ä¸‹ï¼š
>
>   RequestRateLimiterGatewayFilter å·¥å‚ä½¿ç”¨  RateLimiter  å®ç°æ¥ç¡®å®šæ˜¯å¦å…è®¸å½“å‰è¯·æ±‚ç»§ç»­è¿›è¡Œã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿”å›  HTTP 429 - Too Many Requests  ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰ çš„çŠ¶æ€ã€‚æ­¤ç­›é€‰æ¡ä»¶é‡‡ç”¨å¯é€‰çš„  `keyResolver`  å‚æ•°å’Œç‰¹å®šäºé€Ÿç‡é™åˆ¶å™¨çš„å‚æ•°ã€‚

keyResolver  æ˜¯å®ç°  `KeyResolver`  æ¥å£çš„ Beanã€‚ åœ¨é…ç½®ä¸­ï¼Œä½¿ç”¨ SPEL æŒ‰åç§°å¼•ç”¨ beanã€‚  `#{@myKeyResolver}`  æ˜¯ä¸€ä¸ª SPEL è¡¨è¾¾å¼ï¼Œå®ƒå¼•ç”¨ä¸€ä¸ªåä¸º  `myKeyResolver`  çš„ beanã€‚ä¸‹é¢çš„æ¸…å•æ˜¾ç¤ºäº†  `KeyResolver`  æ¥å£ï¼š

```java
public interface KeyResolver {
    Mono<String> resolve(ServerWebExchange exchange);
}
```

KeyResolver æ¥å£å…è®¸å¯æ’æ‹”ç­–ç•¥æ´¾ç”Ÿç”¨äºé™åˆ¶è¯·æ±‚çš„å¯†é’¥ï¼Œåœ¨æœªæ¥çš„é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä¸­ï¼Œå°†æœ‰ä¸€äº›  KeyResolver å®ç°ã€‚

KeyResolver çš„é»˜è®¤å®ç°æ˜¯  PrincipalNameKeyResolver ï¼Œå®ƒä» ServerWebExchange   æ£€ç´¢  Principal  å¹¶è°ƒç”¨ Principal.getName() ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœ  KeyResolver  æ‰¾ä¸åˆ°é”®ï¼Œåˆ™è¯·æ±‚å°†è¢«æ‹’ç»ã€‚æ‚¨å¯ä»¥é€šè¿‡è®¾ç½®  `spring.cloud.gateway.filter.request-rate-limiter.deny-empty-key`  å±æ€§ å’Œ  `spring.cloud.gateway.filter.request-rate-limiter.empty-key-status-code`  å±æ€§æ¥è°ƒæ•´æ­¤è¡Œä¸ºã€‚

 `RequestRateLimiter`  ä¸èƒ½ä½¿ç”¨ â€œshortcutâ€ è¡¨ç¤ºæ³•è¿›è¡Œé…ç½®ã€‚ä»¥ä¸‹ç¤ºä¾‹é…ç½®æ— æ•ˆï¼š

```properties
# æ— æ•ˆçš„ "shorcut" é…ç½®
spring.cloud.gateway.routes[0].filters[0]=RequestRateLimiter=2, 2, #{@userkeyresolver}
```

#### 16.3.1 é™æµè¿‡æ»¤å™¨ Redis RateLimiter

Redis å®ç°åŸºäº [Stripe](https://stripe.com/blog/rate-limiters) æ‰€åšçš„å·¥ä½œã€‚å®ƒéœ€è¦ä½¿ç”¨  `spring-boot-starter-data-redis-reactive`  Spring Boot å¯åŠ¨å™¨ï¼Œä½¿ç”¨çš„ç®—æ³•æ˜¯ [Token Bucket Algorithm](https://en.wikipedia.org/wiki/Token_bucket) ï¼ˆä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰ã€‚

ä¸‹é¢ä»‹ç»å¸¸ç”¨çš„å‡ ä¸ªé…ç½®å±æ€§ï¼š

-  `redis-rate-limiter.replenishRate`  å±æ€§æ˜¯æ‚¨å¸Œæœ›å…è®¸ç”¨æˆ·æ¯ç§’æ‰§è¡Œçš„è¯·æ±‚æ•°ï¼Œè€Œä¸ä¼šä¸¢å¼ƒä»»ä½•è¯·æ±‚ã€‚è¿™æ˜¯å¡«å……ä»¤ç‰Œæ¡¶çš„é€Ÿç‡ï¼›

-  `redis-rate-limiter.burstCapacity`  å±æ€§æ˜¯å…è®¸ç”¨æˆ·åœ¨ä¸€ç§’é’Ÿå†…æ‰§è¡Œçš„æœ€å¤§è¯·æ±‚æ•°ã€‚è¿™æ˜¯ä»¤ç‰Œæ¡¶å¯ä»¥å®¹çº³çš„ä»¤ç‰Œæ•°é‡ã€‚å°†æ­¤å€¼è®¾ç½®ä¸º 0 ä¼šé˜»æ­¢æ‰€æœ‰è¯·æ±‚ï¼›

-  `redis-rate-limiter.requestedTokens`  å±æ€§æ˜¯è¯·æ±‚èŠ±è´¹çš„ä»¤ç‰Œæ•°ã€‚è¿™æ˜¯æ¯ä¸ªè¯·æ±‚ä»å­˜å‚¨æ¡¶ä¸­è·å–çš„ä»¤ç‰Œæ•°ï¼Œé»˜è®¤ä¸º 1 ï¼›

é€šè¿‡åœ¨  `replenishRate`  å’Œ  `burstCapacity`  ä¸­è®¾ç½®ç›¸åŒçš„å€¼æ¥å®ç°ç¨³å®šçš„é€Ÿç‡ã€‚é€šè¿‡å°†  `burstCapacity`  è®¾ç½®ä¸ºé«˜äº  `replenishRate`  æ¥å…è®¸ä¸´æ—¶çªå¢ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦åœ¨çªå¢ä¹‹é—´å…è®¸é€Ÿç‡é™åˆ¶å™¨æœ‰ä¸€æ®µæ—¶é—´ï¼ˆæ ¹æ®  `replenishRate` ï¼‰ï¼Œå› ä¸ºä¸¤ä¸ªè¿ç»­çš„çªå¢å°†å¯¼è‡´è¯·æ±‚è¢«ä¸¢å¼ƒï¼ˆ `HTTP 429 - è¯·æ±‚è¿‡å¤š` ï¼‰ã€‚ä¸‹é¢çš„æ¸…å•é…ç½®äº†  `redis-rate-limiter` ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: requestratelimiter_route
        uri: https://example.org
        filters:
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 10
            redis-rate-limiter.burstCapacity: 20
            redis-rate-limiter.requestedTokens: 1
```

é€šè¿‡å°†  `replenishRate`  è®¾ç½®ä¸ºæ‰€éœ€çš„è¯·æ±‚æ•°ï¼Œå°†  `requestedTokens`  è®¾ç½®ä¸º ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´è·¨åº¦ï¼Œå°†  `burstCapacity`  è®¾ç½®ä¸º  `replenishRate`  å’Œ  `requestedTokens`  çš„ä¹˜ç§¯ï¼Œä¾‹å¦‚ï¼Œè®¾ç½®  `replenishRate=1` ã€ `requestedTokens=60`  å’Œ  `burstCapacity=60`  å°†å¯¼è‡´ 1 ä¸ªè¯·æ±‚/åˆ†é’Ÿçš„é™åˆ¶ã€‚

#### 16.3.2 åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ç½‘å…³é™æµ

æˆ‘ä»¬ä¸Šé¢ä¹Ÿæåˆ° Spring Cloud Gateway ç½‘å…³çš„ <span style="color:#ff6e00;">RequestRateLimiterGatewayFilterFactory</span> é™æµè¿‡æ»¤å™¨å·¥å‚æ˜¯åŸºäº Redis å’Œ Lua è„šæœ¬å®ç°çš„ï¼Œæˆ‘ä»¬å°±éœ€è¦å…ˆå‡†å¤‡å¥½ Redis çš„ç¯å¢ƒï¼Œè¿™é‡Œæˆ‘é€‰æ‹©æ”¾åœ¨æœåŠ¡å™¨ä¸Šè·‘ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

![image-20241224105652350](./assets/image-20241224105652350.png)

##### 16.3.2.1 æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
</dependency>
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```

##### 16.3.2.2 ä¸Šä¸‹æ–‡é…ç½®

```yaml
spring:
  application:
    name: bettytsai-gateway
  redis:
    timeout: 10000 # è¿æ¥è¶…æ—¶æ—¶é—´
    host: 116.*.*.132 # redisæœåŠ¡åœ°å€
    port: 6379 # redisæœåŠ¡ç«¯å£
    password: Abcd123. # rediså¯†ç 
    database: 0 # é€‰æ‹©å“ªä¸€ä¸ªåº“ï¼Œé»˜è®¤0åº“
    lettuce:
      pool:
        max-active: 1024 # æœ€å¤§è¿æ¥æ•°
        max-wait: 10000 #æœ€å¤§è¿æ¥é˜»å¡ç­‰å¾…æ—¶é—´ï¼Œå•ä½ ms é»˜è®¤ -1
        max-idle: 200 # æœ€å¤§ç©ºé—²è¿æ¥
        min-idle: 5 # æœ€å°ç©ºé—²è¿æ¥
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/system/**
          filters:
            - name: RequestRateLimiter              # é™æµè¿‡æ»¤å™¨
              args:
                redis-rate-limiter.replenishRate: 1 # ä»¤ç‰Œæ¡¶æ¯ç§’å¡«å……é€Ÿç‡
                redis-rate-limiter.burstCapacity: 2 # ä»¤ç‰Œæ¡¶æ€»å®¹é‡ (æè¿™ä¹ˆå°ï¼Œçº¯å±ä¸ºäº†æµ‹è¯•)
                redis-rate-limiter.requestedTokens: 1 # è¯·æ±‚èŠ±è´¹çš„ä»¤ç‰Œæ•°,æ¯ä¸ªè¯·æ±‚ä»å­˜å‚¨æ¡¶ä¸­è·å–çš„ä»¤ç‰Œæ•°ï¼Œé»˜è®¤ä¸º 1
                key-resolver: "#{@pathKeyResolver}" # ä½¿ç”¨ SpEL è¡¨è¾¾å¼æŒ‰åç§°å¼•ç”¨
```

##### 16.3.2.3 é™æµè§„åˆ™ â€” URL é™æµ

æˆ‘ä»¬åœ¨ä¸Šé¢ä¹Ÿæåˆ°è¿‡ KeyResolver æ¥å£çš„ä½œç”¨ã€‚<span style="color:#ff6e00;">é€šä¿—ç‚¹æ¥è¯´ï¼ŒKeyResolver ç”¨äºæŒ‡å®šé™æµçš„æ–¹å¼ï¼Œå¯ä»¥åŸºäº IPé™æµã€é€šè¿‡ç”¨æˆ·é™æµã€é€šè¿‡æ¥å£é™æµç­‰ã€‚KeyResolverç”¨äºè®¡ç®—æŸä¸€ä¸ªç±»å‹çš„é™æµçš„Keyï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥é€šè¿‡KeyResolveræ¥æŒ‡å®šé™æµçš„Keyã€‚</span>

```java
@Configuration
public class KeyResolverConfig {
    @Bean
    public KeyResolver pathKeyResolver(){
        // return new KeyResolver() {
        //     @Override
        //     public Mono<String> resolve(ServerWebExchange exchange) {
        //         return Mono.just(exchange.getRequest().getURI().getPath());
        //     }
        // };
        // JDK 8+å†™æ³•
        return exchange -> Mono.just(exchange.getRequest().getURI().getPath());
    }
}
```

é‡å¯ç½‘å…³æœåŠ¡ï¼Œæ‰“å¼€ Postman å¤šæ¬¡è®¿é—®æœåŠ¡ï¼Œæ¨¡æ‹Ÿå¤§é‡è¯·æ±‚ï¼Œå°±ä¼šå‡ºç° HTTP 429 è¯·æ±‚å¤±è´¥çš„æƒ…å†µï¼š

![image-20241224140117204](./assets/image-20241224140117204.png)

ç„¶åè§‚å¯Ÿ redis æ•°æ®åº“ä¸­å˜åŒ–ï¼š

![image-20241224140147277](./assets/image-20241224140147277.png)

å¯ä»¥çœ‹åˆ°é”®å°±æ˜¯æˆ‘ä»¬çš„è¯·æ±‚ URI ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„åŸºäºä»¤ç‰Œæ¡¶æ–¹å¼çš„ URL é™æµã€‚

##### 16.3.2.4 é™æµè§„åˆ™ â€” IPé™æµ

åœ¨ä¸Šé¢æˆ‘ä»¬é€šè¿‡ åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°äº†URLé™æµï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹å¦‚ä½•é€šè¿‡ IP è¿›è¡Œé™æµã€‚

```java
@Configuration
public class KeyResolverConfig {
    @Bean
    public KeyResolver pathKeyResolver(){
        // IP é™æµ
        return exchange -> Mono.just(exchange.getRequest().getpxoteAddress().getHostName());
    }
}
```

åŒæ ·çš„æ‰“å¼€ Postman æ¨¡æ‹Ÿå¤§é‡è¯·æ±‚æ‰“è¿›æ¥ï¼Œç»“æœå¦‚ä¸‹ï¼š

![image-20241224140813989](./assets/image-20241224140813989.png)

Redisæƒ…å†µå¦‚ä¸‹ï¼š

![image-20241224140912726](./assets/image-20241224140912726.png)

##### 16.3.2.5 é™æµè§„åˆ™ â€” å‚æ•°é™æµ

<div style="border: 1px solid #1d63edb5;
    padding: 10px;
    border-left: 5px solid #1d63edb5;
    background: #bed2fa63;
    border-radius: 0 3px 3px 0;
    color: #1d63ed;
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" style="flex-shrink: 0;" width="14px" height="14px" fill="none" xmlns="http://www.w3.org/2000/svg" class="MuiSvgIcon-root MuiSvgIcon-colorInfo MuiSvgIcon-fontSizeSmall css-1bqouqa" focusable="false" aria-hidden="true" data-testid="InfoCircleIcon"><path d="M12 16V12M12 8H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <span style="line-height: 16px;">å‚æ•°é™æµä¸€èˆ¬ç”¨äºæ ¹æ®ç”¨æˆ·åã€ç”¨æˆ·ID ç­‰æ ‡è¯†é’ˆå¯¹ç”¨æˆ·è¿›è¡Œé™æµã€‚</span>
</div>

```java
@Configuration
public class KeyResolverConfig {
    @Bean
    public KeyResolver pathKeyResolver(){
        // å‚æ•°é™æµ ç”¨æˆ·idé™æµ
        return exchange -> Mono.just(exchange.getRequest().getQueryParams().getFirst("userId"));
    }
}
```

æ‰“å¼€ Postman ï¼Œæ¨¡æ‹Ÿå¤§é‡è¯·æ±‚ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241224143935816](./assets/image-20241224143935816.png)

Redisç»“æœå¦‚ä¸‹ï¼š

![image-20241224144016209](./assets/image-20241224144016209.png)

##### 16.3.2.6 è‡ªå®šä¹‰é™é€Ÿå™¨

åœ¨ä¸Šä¸‰èŠ‚é™æµè§„åˆ™æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ä¸Šä¸‹æ–‡é…ç½®éƒ½æ˜¯ä¸€æ ·çš„ï¼š

```yml
spring:
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/system/**
          filters:
            - name: RequestRateLimiter              # é™æµè¿‡æ»¤å™¨
              args:
                redis-rate-limiter.replenishRate: 1 # ä»¤ç‰Œæ¡¶æ¯ç§’å¡«å……é€Ÿç‡
                redis-rate-limiter.burstCapacity: 2 # ä»¤ç‰Œæ¡¶æ€»å®¹é‡
                redis-rate-limiter.requestedTokens: 1 # è¯·æ±‚èŠ±è´¹çš„ä»¤ç‰Œæ•°,æ¯ä¸ªè¯·æ±‚ä»å­˜å‚¨æ¡¶ä¸­è·å–çš„ä»¤ç‰Œæ•°ï¼Œé»˜è®¤ä¸º 1
                key-resolver: "#{@keyResolver}" # ä½¿ç”¨ SpEL è¡¨è¾¾å¼æŒ‰åç§°å¼•ç”¨
```

åœ¨ Spring Cloud Gateway ä¸­ï¼Œæ”¯æŒå°†é€Ÿç‡é™åˆ¶å™¨å®šä¹‰ä¸ºå®ç°  `RateLimiter`  æ¥å£çš„ Beanã€‚

åœ¨é…ç½®ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ SpEL æŒ‰åç§°å¼•ç”¨ Beanã€‚ `#{@customRateLimiter}` æ˜¯ä¸€ä¸ªSpELè¡¨è¾¾å¼ï¼Œå®ƒå¼•ç”¨äº†ä¸€ä¸ªåä¸º  `rateLimiter`  çš„ Beanã€‚

å¦‚ä¸‹æ‰€ç¤ºï¼š

```yml
spring:
  cloud:
    gateway:
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/system/**
          filters:
            - name: RequestRateLimiter              # é™æµè¿‡æ»¤å™¨
              args:
                key-resolver: "#{@keyResolver}"         # ä½¿ç”¨ SpEL è¡¨è¾¾å¼æŒ‰åç§°å¼•ç”¨
                rate-limiter: "#{@customRateLimiter}"   # ä½¿ç”¨ SpEL è¡¨è¾¾å¼æŒ‰åç§°å¼•ç”¨
```

æ‚¨è¿˜å¯ä»¥å°†é€Ÿç‡é™åˆ¶å™¨å®šä¹‰ä¸ºå®ç°  `RateLimiter`  æ¥å£çš„ Beanã€‚ åœ¨é…ç½®ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ SpEL æŒ‰åç§°å¼•ç”¨ Beanã€‚  `#{@customRateLimiter}`  æ˜¯ä¸€ä¸ª SPEL è¡¨è¾¾å¼ï¼Œå®ƒå¼•ç”¨ä¸€ä¸ªåä¸º `customRateLimiter` çš„ Beanã€‚ä¸‹é¢çš„æ¸…å•å®šä¹‰äº†ä¸€ä¸ªé€Ÿç‡é™åˆ¶å™¨ï¼Œå®ƒä½¿ç”¨ä¸Šä¸€ä¸ªå°èŠ‚é‡Œå®šä¹‰çš„  `KeyResolver` ï¼š

æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰é™é€Ÿå™¨å»å®ç°ï¼š

```java
public class CustomRateLimiter implements RateLimiter<CustomRateLimiter.Config> {

    @Override
    public Mono<Response> isAllowed(String routeId, String id) {
        // æ ¸å¿ƒæ–¹æ³•...é™æµé€»è¾‘
        return null;
    }

    @Override
    public Map<String, Config> getConfig() {
        return null;
    }

    @Override
    public Class<Config> getConfigClass() {
        return null;
    }

    @Override
    public Config newConfig() {
        return null;
    }

    public static class Config {
        @Min(1)
        private int replenishRate;
        @Min(2)
        private int burstCapacity = 1;
        @Min(1)
        private int requestedTokens = 1;
        public int getReplenishRate() {
            return replenishRate;
        }
        public Config setReplenishRate(int replenishRate) {
            this.replenishRate = replenishRate;
            return this;
        }
        public int getBurstCapacity() {
            return burstCapacity;
        }
        public Config setBurstCapacity(int burstCapacity) {
            this.burstCapacity = burstCapacity;
            return this;
        }
        public int getRequestedTokens() {
            return requestedTokens;
        }
        public Config setRequestedTokens(int requestedTokens) {
            this.requestedTokens = requestedTokens;
            return this;
        }
        
        @Override
        public String toString() {
            return new ToStringCreator(this).append("replenishRate", replenishRate)
                    .append("burstCapacity", burstCapacity).append("requestedTokens", requestedTokens).toString();
        }
    }
}
```

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;">ä»¥ä¸Šä»£ç å¹¶ä¸å®Œæ•´ï¼Œå…·ä½“é™æµé€»è¾‘è‡ªè¡ŒæŒ‰ä¸šåŠ¡éœ€æ±‚ç¼–å†™ã€‚</span>
</div>

### 16.4 Sentinel é™æµ

Sentinel æ”¯æŒå¯¹ Spring Cloud Gateway ã€NetFlix Zuul ç­‰ä¸»æµçš„ API Gateway è¿›è¡Œé™æµã€‚

![image-20241224155220773](./assets/image-20241224155220773.png)

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;">å®˜æ–¹æ–‡æ¡£ï¼šhttps://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel</span>
</div>

#### 16.4.2 å•ç‹¬ä½¿ç”¨

Sentinel æä¾›äº†ä¸ Spring Cloud Gateway çš„é›†æˆæ¨¡å—ã€‚é›†æˆæ¨¡å—åŸºäº Sentinel Reactor é€‚é…å™¨ã€‚

åœ¨  `pom.xml`  ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–é¡¹ï¼ˆå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Mavenï¼‰ï¼š

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-spring-cloud-gateway-adapter</artifactId>
</dependency>
```

ä¸Šä¸‹æ–‡é…ç½®ï¼š

```yml
server:
  port: 30000

spring:
  application:
    name: bettytsai-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        - id: bettytsai-system
          uri: lb://bettytsai-system
          predicates:
            - Path=/system/**
            
eureka:
  client:
    # æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚
    fetch-registry: true
    # æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚
    register-with-eureka: true
    # æŒ‡ç¤ºä» eureka æœåŠ¡å™¨è·å–æ³¨å†Œè¡¨ä¿¡æ¯çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    registry-fetch-interval-seconds: 30
    # å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚
    # æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚
    # é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
    # ç¤ºä¾‹ï¼šhttps://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/
    # æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚
    service-url:
      defaultZone: http://admin:123456@127.0.0.1:8761/eureka/
  instance:
    # æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚
    prefer-ip-address: true
    # è·å–è¦å‘ eureka æ³¨å†Œçš„æ­¤å®ä¾‹çš„å”¯ä¸€ IDï¼ˆåœ¨ appName èŒƒå›´å†…ï¼‰
    instance-id: ${spring.cloud.client.ip-address}:${server.port}
    # æŒ‡ç¤º eureka å®¢æˆ·ç«¯éœ€è¦å‘ eureka æœåŠ¡å™¨å‘é€å¿ƒè·³ä»¥æŒ‡ç¤ºå®ƒä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    # å¦‚æœåœ¨ leaseExpirationDurationInSeconds ä¸­æŒ‡å®šçš„æ—¶é—´æ®µå†…æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ eureka æœåŠ¡å™¨å°†ä»å…¶è§†å›¾ä¸­åˆ é™¤è¯¥å®ä¾‹ï¼Œ
    # ä»è€Œç¦æ­¢æµå‘æ­¤å®ä¾‹çš„æµé‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœå®ä¾‹å®ç° HealthCheckCallbackï¼Œç„¶åå†³å®šä½¿è‡ªèº«ä¸å¯ç”¨ï¼Œåˆ™å®ä¾‹ä»ç„¶æ— æ³•è·å–æµé‡ã€‚
    lease-renewal-interval-in-seconds: 10
    # å¿…é¡»ä¸Dockerå®¹å™¨åä¿æŒä¸€è‡´
    hostname: ${spring.application.name}
```

ç„¶åï¼Œæ‚¨åªéœ€åœ¨ Spring é…ç½®ä¸­æ³¨å…¥ç›¸åº”çš„  `SentinelGatewayFilter`  å’Œ  `SentinelGatewayBlockExceptionHandler`  å®ä¾‹å³å¯ã€‚ä¾‹å¦‚ï¼š

```java
@Configuration
public class SentinelConfig {
    private final List<ViewResolver> viewResolvers;
    private final ServerCodecConfigurer serverCodecConfigurer;

    public SentinelConfig(ObjectProvider<List<ViewResolver>> viewResolversProvider,
                          ServerCodecConfigurer serverCodecConfigurer) {
        this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);
        this.serverCodecConfigurer = serverCodecConfigurer;
    }

    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() {
        // Register the block exception handler for Spring Cloud Gateway.
        return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);
    }

    @Bean
    @Order(-1)
    public GlobalFilter sentinelGatewayFilter() {
        return new SentinelGatewayFilter();
    }

    @PostConstruct
    protected void doInit() {
        initGatewayRules();
    }

    protected void initGatewayRules() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        // é™æµè§„åˆ™
        GatewayFlowRule rule = new GatewayFlowRule();
        rule.setResource("bettytsai-system");//èµ„æºåç§°æˆ–è€…æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„APIåˆ†ç»„åç§°
        rule.setCount(3);// é™æµé˜ˆå€¼ï¼Œè¡¨ç¤ºåœ¨ç»Ÿè®¡æ—¶é—´çª—å£å†…ï¼Œè¶…è¿‡é™æµé˜ˆå€¼ï¼Œè¿”å› HTTP 429
        rule.setIntervalSec(60);//ç»Ÿè®¡æ—¶é—´çª—å£ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤ 1 ç§’
        rules.add(rule);
        // åŠ è½½ç½‘å…³é™æµè§„åˆ™
        GatewayRuleManager.loadRules(rules);
    }
}
```

æ‰“å¼€ Postman æ¨¡æ‹Ÿå¤§é‡è¯·æ±‚æµ‹è¯•åï¼Œç»“æœå¦‚ä¸‹ï¼š

![image-20241224170731441](./assets/image-20241224170731441.png)

ç½‘å…³é€‚é…å™¨ä¼šå°†æ‰€æœ‰  `routeId` ï¼ˆåœ¨ Spring å±æ€§ä¸­å®šä¹‰ï¼‰å’Œæ‰€æœ‰è‡ªå®šä¹‰çš„ API å®šä¹‰ï¼ˆåœ¨æ¨¡å—çš„  `sentinel-api-gateway-adapter-common`  çš„ç±» `GatewayApiDefinitionManager`  ä¸­å®šä¹‰ï¼‰è§†ä¸ºèµ„æºã€‚

æ‚¨å¯ä»¥åœ¨  `GatewayCallbackManager`  ä¸­æ³¨å†Œå„ç§è‡ªå®šä¹‰å›è°ƒï¼š

-  `setBlockHandler` ï¼šæ³¨å†Œä¸€ä¸ªè‡ªå®šä¹‰çš„  `BlockRequestHandler`  æ¥å¤„ç†è¢«æ‹¦æˆªçš„è¯·æ±‚ã€‚é»˜è®¤å®ç°æ˜¯  `DefaultBlockRequestHandler` ï¼Œå®ƒè¿”å›é»˜è®¤æ¶ˆæ¯ï¼Œå¦‚   `Blocked by Sentinel: FlowException`  ã€‚

#### 16.4.3 ç»“åˆStartä½¿ç”¨ï¼ˆæ¨èï¼‰

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;">å¦‚æœéœ€è¦åœ¨Sentinel æ§åˆ¶å°ç®¡ç† ç½‘å…³æ¨¡å—çš„é™æµï¼Œé‚£ä¹ˆæ¨èè¿™ç§é…ç½®æ–¹å¼ã€‚</span>
</div>

å¦‚æœè¦å°† Sentinel Starter ä¸ Spring Cloud Gateway ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™éœ€è¦æ·»åŠ   `spring-cloud-alibaba-sentinel-gateway`  ä¾èµ–é¡¹å¹¶æ·»åŠ   `spring-cloud-starter-gateway`  ä¾èµ–é¡¹ï¼Œä»¥ä½¿æ¨¡å—ä¸­çš„ Spring Cloud Gateway AutoConfiguration ç±»ç”Ÿæ•ˆï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>

<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-sentinel-gateway</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

åŒæ—¶è¯·å°†  `spring.cloud.sentinel.filter.enabled`  é…ç½®é¡¹ç½®ä¸º falseï¼ˆè‹¥åœ¨ç½‘å…³æµæ§æ§åˆ¶å°ä¸Šçœ‹åˆ°äº† URL èµ„æºï¼Œå°±æ˜¯æ­¤é…ç½®é¡¹æ²¡æœ‰ç½®ä¸º falseï¼‰ã€‚Sentinel ç½‘å…³æµæ§é»˜è®¤çš„ç²’åº¦æ˜¯ route ç»´åº¦ä»¥åŠè‡ªå®šä¹‰ API åˆ†ç»„ç»´åº¦ï¼Œé»˜è®¤ä¸æ”¯æŒ URL ç²’åº¦ã€‚å¦‚éœ€ç»†åŒ–åˆ° URL ç²’åº¦ï¼Œè¯·å‚è€ƒ [ç½‘å…³æµæ§æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/api-gateway-flow-control.html) è‡ªå®šä¹‰ API åˆ†ç»„ã€‚

**æ³¨æ„** ï¼šç½‘å…³æµæ§è§„åˆ™æ•°æ®æºç±»å‹æ˜¯  `gw-flow` ï¼Œè‹¥å°†ç½‘å…³æµæ§è§„åˆ™æ•°æ®æºæŒ‡å®šä¸º flow åˆ™ä¸ç”Ÿæ•ˆã€‚

å¦‚æœé€‰æ‹©é€šè¿‡Javaä»£ç å®ç°é…ç½®é™æµ-ç†”æ–­è§„åˆ™ï¼Œåˆ™æˆ‘ä»¬éœ€è¦ç¼–å†™é™æµé…ç½®ç±»ï¼š

```java
@Configuration
public class SentinelConfig {
    @PostConstruct
    protected void doInit() {
        initGatewayRules();
    }

    protected void initGatewayRules() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        // é™æµè§„åˆ™
        GatewayFlowRule rule = new GatewayFlowRule();
        rule.setResource("bettytsai-system");//èµ„æºåç§°æˆ–è€…æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„APIåˆ†ç»„åç§°
        rule.setCount(3);// é™æµé˜ˆå€¼ï¼Œè¡¨ç¤ºåœ¨ç»Ÿè®¡æ—¶é—´çª—å£å†…ï¼Œè¶…è¿‡é™æµé˜ˆå€¼ï¼Œè¿”å› HTTP 429
        rule.setIntervalSec(60);//ç»Ÿè®¡æ—¶é—´çª—å£ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤ 1 ç§’
        rules.add(rule);
        // åŠ è½½ç½‘å…³é™æµè§„åˆ™
        GatewayRuleManager.loadRules(rules);
    }
}
```

å¦‚æœé€‰æ‹©ä½¿ç”¨ Sentinel æ§åˆ¶å°é…ç½®é™æµ-ç†”æ–­è§„åˆ™ï¼Œé‚£ä¹ˆè¿˜éœ€è¦åœ¨ gateway çš„é…ç½®æ–‡ä»¶ä¸­åšå‡ºå¦‚ä¸‹é…ç½®ï¼š

```yaml
spring:
  cloud:
    # Sentinel æ§åˆ¶å°è¿æ¥é…ç½®
    sentinel:
      transport:
       # å½“å‰æœåŠ¡ä¸æ§åˆ¶å°äº¤äº’çš„ç«¯å£å·,é»˜è®¤ä¸º8719,åŒä¸€ä¸ªæœºå™¨ä¸Šè‹¥æœ‰å¤šä¸ªåº”ç”¨äºæ§åˆ¶å°äº¤äº’æ—¶éœ€è¦è®¾ç½®æˆä¸åŒçš„ç«¯å£
        port: 8739
        dashboard: 10.*.*.77:9090
      # æœåŠ¡å¯åŠ¨æ—¶ç›´æ¥å»ºç«‹å¿ƒè·³è¿æ¥
      eager: true
      # Sentinel å‚¨å­˜è§„åˆ™çš„æ•°æ®æºé…ç½®(ä½¿ç”¨çš„æ˜¯Nacosæ¥å­˜å‚¨Sentinelçš„é™æµè§„åˆ™)
      #datasource:
      #  ds:
      #    nacos:
            # Nacos æœåŠ¡åœ°å€ï¼ˆå¯é…ç½®å•ç‚¹ï¼Œæˆ–è€…é›†ç¾¤çš„VIPåœ°å€ï¼‰
      #      server-addr: 10.1.3.76:8848
      #      dataId: ${spring.application.name}-sentinel
      #      groupId: DEFAULT_GROUP
      #      namespace: sms-dev
      #      rule-type: flow
# Sentinel æ§åˆ¶å°é‰´æƒé…ç½®
sentinel:
  dashboard:
    auth:
      username: sentinel
      password: sentinel
```

#### 16.4.3 è‡ªå®šä¹‰é™æµå¼‚å¸¸å¤„ç†å™¨

GatewayCallbackManager çš„  `setBlockHandler()`  æ³¨å†Œå‡½æ•°ç”¨äºå®ç°è‡ªå®šä¹‰å¼‚å¸¸çš„é€»è¾‘ï¼Œç”¨äºå¤„ç†è¢«é™æµçš„è¯·æ±‚ã€‚

```java
@Configuration
public class SentinelConfig {
    private final List<ViewResolver> viewResolvers;
    private final ServerCodecConfigurer serverCodecConfigurer;

    public SentinelConfig(ObjectProvider<List<ViewResolver>> viewResolversProvider,
                                ServerCodecConfigurer serverCodecConfigurer) {
        this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);
        this.serverCodecConfigurer = serverCodecConfigurer;
    }

    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() {
        // Register the block exception handler for Spring Cloud Gateway.
        return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);
    }

    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public GlobalFilter sentinelGatewayFilter() {
        return new SentinelGatewayFilter();
    }

    @PostConstruct
    protected void doInit() {
        initBlockHandler();
        initGatewayRules();
    }

    protected void initGatewayRules() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        // é™æµè§„åˆ™
        GatewayFlowRule rule = new GatewayFlowRule();
        rule.setResource("bettytsai-system");//èµ„æºåç§°æˆ–è€…æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„APIåˆ†ç»„åç§°
        rule.setCount(3);// é™æµé˜ˆå€¼ï¼Œè¡¨ç¤ºåœ¨ç»Ÿè®¡æ—¶é—´çª—å£å†…ï¼Œè¶…è¿‡é™æµé˜ˆå€¼ï¼Œè¿”å› HTTP 429
        rule.setIntervalSec(60);//ç»Ÿè®¡æ—¶é—´çª—å£ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤ 1 ç§’
        rules.add(rule);
        // åŠ è½½ç½‘å…³é™æµè§„åˆ™
        GatewayRuleManager.loadRules(rules);
    }

    protected void initBlockHandler(){
        // åŠ è½½è‡ªå®šä¹‰é™æµå¼‚å¸¸å¤„ç†å™¨
        GatewayCallbackManager.setBlockHandler((serverWebExchange, throwable) -> {
            Map<String,String> result = new HashMap<>();
            result.put("code", String.valueOf(HttpStatus.TOO_MANY_REQUESTS.value()));
            result.put("message", HttpStatus.TOO_MANY_REQUESTS.getReasonPhrase());
            result.put("route", "bettytsai-system");
            return ServerResponse.status(HttpStatus.TOO_MANY_REQUESTS)
                    .contentType(MediaType.APPLICATION_JSON)
                    .body(BodyInserters.fromValue(result));
        });
    }
}
```

æ‰“å¼€ Postman ï¼Œæ¨¡æ‹Ÿå¤§é‡è¯·æ±‚ï¼Œç»“æœå¦‚ä¸‹ï¼š

![image-20241224173807552](./assets/image-20241224173807552.png)

#### 16.4.4 åˆ†ç»„é™æµ

<div style="border: 1px solid #1d63edb5;
    padding: 10px;
    border-left: 5px solid #1d63edb5;
    background: #bed2fa63;
    border-radius: 0 3px 3px 0;
    color: #1d63ed;
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" style="flex-shrink: 0;" width="14px" height="14px" fill="none" xmlns="http://www.w3.org/2000/svg" class="MuiSvgIcon-root MuiSvgIcon-colorInfo MuiSvgIcon-fontSizeSmall css-1bqouqa" focusable="false" aria-hidden="true" data-testid="InfoCircleIcon"><path d="M12 16V12M12 8H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <span style="line-height: 16px;">Sentinel æ”¯æŒåˆ†ç»„é™æµé…ç½®ï¼Œä¸‹é¢ç®€å•æ¼”ç¤ºå¦‚ä½•è¿›è¡Œåˆ†ç»„é™æµã€‚</span>
</div>

```java
@Configuration
public class SentinelConfig {
    private final List<ViewResolver> viewResolvers;
    private final ServerCodecConfigurer serverCodecConfigurer;

    public SentinelConfig(ObjectProvider<List<ViewResolver>> viewResolversProvider,
                          ServerCodecConfigurer serverCodecConfigurer) {
        this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);
        this.serverCodecConfigurer = serverCodecConfigurer;
    }

    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() {
        // Register the block exception handler for Spring Cloud Gateway.
        return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);
    }

    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public GlobalFilter sentinelGatewayFilter() {
        return new SentinelGatewayFilter();
    }

    @PostConstruct
    protected void doInit() {
        initBlockHandler();
        initGatewayRules();
    }

    protected void initGatewayRules() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        rules.add(new GatewayFlowRule("bettytsai-system-group").setCount(3).setIntervalSec(60));
        rules.add(new GatewayFlowRule("bettytsai-test-group").setCount(3).setIntervalSec(60));
        // åŠ è½½ç½‘å…³é™æµè§„åˆ™
        GatewayRuleManager.loadRules(rules);
        // åŠ è½½é™æµåˆ†ç»„
        initSentinelGroup();
    }

    protected void initBlockHandler() {
        // åŠ è½½è‡ªå®šä¹‰é™æµå¼‚å¸¸å¤„ç†å™¨
        GatewayCallbackManager.setBlockHandler((serverWebExchange, throwable) -> {
            Map<String, String> result = new HashMap<>();
            result.put("code", String.valueOf(HttpStatus.TOO_MANY_REQUESTS.value()));
            result.put("message", HttpStatus.TOO_MANY_REQUESTS.getReasonPhrase());
            result.put("route", "bettytsai-system");
            return ServerResponse.status(HttpStatus.TOO_MANY_REQUESTS)
                    .contentType(MediaType.APPLICATION_JSON)
                    .body(BodyInserters.fromValue(result));
        });
    }

    protected void initSentinelGroup() {
        Set<ApiDefinition> definitions = new HashSet<>();
        // ç»„ bettytsai-system-group
        ApiDefinition api1 = new ApiDefinition("bettytsai-system-group")
                .setPredicateItems(new HashSet<ApiPredicateItem>() {{
                    // åŒ¹é… /bettytsai-system/system/** ä»¥åŠå…¶å­è·¯å¾„çš„æ‰€æœ‰è¯·æ±‚
                    add(new ApiPathPredicateItem().setPattern("/bettytsai-system/system/**")
                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));
                }});
        // ç»„ bettytsai-test-group
        ApiDefinition api2 = new ApiDefinition("bettytsai-test-group")
                .setPredicateItems(new HashSet<ApiPredicateItem>() {{
                    // åŒ¹é… /bettytsai-test/test/** ä»¥åŠå…¶å­è·¯å¾„çš„æ‰€æœ‰è¯·æ±‚
                    add(new ApiPathPredicateItem().setPattern("/bettytsai-test/test/**")
                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));
                }});
        definitions.add(api1);
        definitions.add(api2);
        // åŠ è½½é™æµåˆ†ç»„
        GatewayApiDefinitionManager.loadApiDefinitions(definitions);
    }
}
```

æ‰“å¼€ Postman æ¨¡æ‹Ÿå¤§é‡è¯·æ±‚è¿›æ¥ï¼Œç»“æœå¦‚ä¸‹ï¼š

![image-20241224175358104](./assets/image-20241224175358104.png)

## 17 é«˜å¯ç”¨ç½‘å…³æ­å»º

ä¸šå†…é€šå¸¸ç”¨å¤šå°‘ä¸ª 9 æ¥è¡¡é‡ç½‘ç«™çš„å¯ç”¨æ€§ï¼Œä¾‹å¦‚ QQ çš„å¯ç”¨æ€§æ˜¯ 4 ä¸ª 9 ï¼Œå°±æ˜¯è¯´ QQ èƒ½å¤Ÿä¿è¯åœ¨ä¸€å¹´é‡Œï¼ŒæœåŠ¡åœ¨ 99.99% çš„æ—¶é—´æ˜¯å¯ç”¨çš„ï¼Œåªæœ‰ 0.01% çš„æ—¶é—´ä¸å¯ç”¨ï¼Œå¤§çº¦æœ€å¤š53åˆ†é’Ÿï¼Œè¿™æ˜¯ååˆ†ç‰›é€¼çš„ã€‚

å¯¹äºå¤§å¤šæ•°ç½‘ç«™æ¥è¯´ï¼Œ2ä¸ª 9 æ˜¯åŸºæœ¬å¯ç”¨ã€3 ä¸ª 9 å°±ä»£è¡¨é«˜å¯ç”¨ã€4 ä¸ª 9 å°±æ˜¯æ‹¥æœ‰è‡ªåŠ¨æ¢å¤èƒ½åŠ›çš„é«˜å¯ç”¨ã€‚

å®ç°é«˜å¯ç”¨çš„ä¸»è¦æ‰‹æ®µå°±æ˜¯ æ•°æ®çš„å†—ä½™å¤‡ä»½å’Œ æœåŠ¡æ•…éšœè½¬ç§»ï¼Œè¿™ä¸¤ä¸ªæ‰‹æ®µå…·ä½“å¯ä»¥æ€ä¹ˆåšï¼Œåœ¨ç½‘å…³ä¸­å¦‚ä½•å®ç°ï¼Ÿä¸»è¦é’ˆå¯¹ä»¥ä¸‹å‡ ä¸ªæ–¹å‘ï¼š

- é›†ç¾¤éƒ¨ç½²
- è´Ÿè½½å‡è¡¡
- å¥åº·æ£€æŸ¥
- èŠ‚ç‚¹è‡ªåŠ¨é‡å¯
- ç†”æ–­
- æœåŠ¡é™çº§
- æ¥å£é‡è¯•

### 17.1 Nginx + ç½‘å…³é›†ç¾¤å®ç°é«˜å¯ç”¨ç½‘å…³

<img src="./assets/image-20241224200645668.png" alt="image-20241224200645668" style="zoom:80%;" />

#### 17.1.1 ä¸‹è½½å®‰è£… Nginx

è¯¦è§ [ç¬¬ä¹ç«  Nginx å®ç°API ç½‘å…³]()ã€‚

#### 17.1.2 é…ç½®ç½‘å…³é›†ç¾¤

*nginx.conf*

```shell
worker_processes  1;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    sendfile        on;
    keepalive_timeout  65;

    # é…ç½®ç½‘å…³é›†ç¾¤
    upstream gateway {
		server 127.0.0.1:30000;
		server 127.0.0.1:30001;
    }

    server {
        listen       80;
        server_name  localhost;
        
        # nginx å°†è¯·æ±‚åˆ†å‘è‡³ç½‘å…³é›†ç¾¤
        location / {
			proxy_pass http://gateway;
        }
        
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
```

#### 17.1.3 éªŒè¯é«˜å¯ç”¨ç½‘å…³

æˆ‘ä»¬æŠŠæˆ‘ä»¬çš„ç½‘å…³æœåŠ¡æ‰“æˆ  `jar`  åŒ…é€šè¿‡æ§åˆ¶å°ä¿®æ”¹å‚æ•°  `-Dserver.port`  å»å¯åŠ¨ï¼Œè¿™æ ·æˆ‘å°±ä¸éœ€è¦å†å»ºä¸€ä¸ªæ¨¡å—å»å‡‘é›†ç¾¤æœåŠ¡äº†ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š

![image-20241224202710253](./assets/image-20241224202710253.png)

ç„¶åæˆ‘ä»¬å†å¯åŠ¨ Nginx æœåŠ¡ï¼ŒIDEA ä¸­ä»…å¯åŠ¨ æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡æä¾›è€…ï¼š

![image-20241224202845465](./assets/image-20241224202845465.png)

æ‰“å¼€ Postman è¿›è¡Œæµ‹è¯•ï¼Œæ¨¡æ‹Ÿå¤§é‡è¯·æ±‚è®¿é—®ï¼š

![image-20241224203008409](./assets/image-20241224203008409.png)

è¯·æ±‚è½¬å‘æˆåŠŸçš„æƒ…å†µå¦‚ä¸Šæ‰€ç¤ºï¼Œè¯·æ±‚é™æµç»“æœå¦‚ä¸‹ï¼š

![image-20241224203056346](./assets/image-20241224203056346.png)
