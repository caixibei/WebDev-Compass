<div style="width:100%;display:flex;"><img src="assets/640.gif" alt="640" style="width:200px;margin-left:auto;" /></div>

# Spring Cloud Eureka æ³¨å†Œä¸­å¿ƒ

## 1. ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒ

æ³¨å†Œä¸­å¿ƒå¯ä»¥è¯´æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„ â€œé€šè®¯å½•â€ ï¼Œå®ƒè®°å½•äº†æœåŠ¡å’ŒæœåŠ¡åœ°å€çš„ä¸€ä¸ªæ˜ å°„å…³ç³»ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„å½“ä¸­ï¼ŒæœåŠ¡ä¼šæ³¨å†Œåˆ°è¿™é‡Œï¼Œå½“æŸä¸€ä¸ªæœåŠ¡éœ€è¦è°ƒç”¨å…¶ä»–æœåŠ¡æ—¶ï¼Œå°±éœ€è¦åˆ°æ³¨å†Œä¸­å¿ƒä¸­å»æ‰¾åˆ°å¯¹åº”æœåŠ¡çš„åœ°å€ï¼Œè¿›è¡Œè°ƒç”¨ã€‚

<img src="./assets/image-20240901204614428.png" alt="image-20240901204614428" style="zoom: 60%; border-radius: 15px;" />



ä¸¾ä¸€ä¸ªæ˜¾ç¤ºç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼Œæ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æ‰‹æœºä¸­é€šè®¯å½•çš„ä¸¤ä¸ªä½¿ç”¨åœºæ™¯ï¼š

- **æœåŠ¡å‘ç°ï¼š** å½“æˆ‘æƒ³ç»™æ³•å¤–ç‹‚å¾’å¼ ä¸‰æ‰“ç”µè¯æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨é€šè®¯å½•ä¸­æŒ‰ç…§åå­—å»æ‰¾åˆ°å¼ ä¸‰ï¼Œç„¶åæ‰¾åˆ°ä»–çš„æ‰‹æœºå·ç è¿›è¡Œæ‹¨å·ï¼›   
- **æœåŠ¡æ³¨å†Œï¼š** æœ‰ä¸€å¤©æ­¦å¤§åŠäº†æ–°çš„æ‰‹æœºå·ç å¹¶å‘Šè¯‰æˆ‘ä»¬ï¼Œæˆ‘ä»¬å°†æ­¦å¤§çš„ç”µè¯å·ç å­˜è¿›é€šè®¯å½•ï¼Œåç»­æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡é€šè®¯å½•å»æ‰¾åˆ°ä»–ï¼› 

**æ€»ç»“ï¼š** æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„ä½œç”¨å°±æ˜¯æœåŠ¡çš„æ³¨å†Œå’ŒæœåŠ¡çš„å‘ç°ã€‚

## 2. å¸¸è§çš„æ³¨å†Œä¸­å¿ƒ

æˆ‘ä»¬æ¥äº†è§£ä¸‹å¸‚é¢ä¸Šå¸¸è§çš„æ³¨å†Œä¸­å¿ƒæœ‰å“ªäº›ï¼š

- Netflix Eureka
- Alibaba Nacos
- HashiCorp Consul
- Apache Zookeeper
- CoreOS Etcd
- CNCF CoreDNS

ä»–ä»¬ä¹‹é—´çš„åŒºåˆ«å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

|       ç‰¹æ€§       |   Eureka    |              Nacos               |         Consul          | Zookeeper  |
| :--------------: | :---------: | :------------------------------: | :---------------------: | :--------: |
|       CAP        |     AP      |             CP + AP              |           CP            |     CP     |
|     å¥åº·æ£€æŸ¥     | Client Beat | TCP / HTTP / MySQL / Client Beat | TCP / HTTP / gRPC / Cmd | Keep Alive |
|     é›ªå´©ä¿æŠ¤     |      âœ…      |                âœ…                 |            âŒ            |     âŒ      |
|   è‡ªåŠ¨æ³¨é”€å®ä¾‹   |      âœ…      |                âœ…                 |            âŒ            |     âœ…      |
|     è®¿é—®åè®®     |    HTTP     |            HTTP / DNS            |       HTTP / DNS        |    TCP     |
|     ç›‘å¬æ”¯æŒ     |      âœ…      |                âœ…                 |            âœ…            |     âœ…      |
|    å¤šæ•°æ®ä¸­å¿ƒ    |      âœ…      |                âœ…                 |            âœ…            |     âŒ      |
|  è·¨æ³¨å†Œä¸­å¿ƒåŒæ­¥  |      âŒ      |                âœ…                 |            âœ…            |     âŒ      |
| Spring Cloudé›†æˆ |      âœ…      |                âœ…                 |            âœ…            |     âœ…      |

**CAP è§£é‡Šï¼š** 

-   C ä»£è¡¨ Consistency ï¼ˆä¸€è‡´æ€§ï¼‰

-   A ä»£è¡¨ Availabilityï¼ˆå¯ç”¨æ€§ï¼‰

-   P ä»£è¡¨ Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰

CAP å®šç†ç”± Eric Brewer åœ¨ 2000 å¹´ PODC ä¼šè®®ä¸Šæå‡ºã€‚è¯¥çŒœæƒ³åœ¨æå‡ºåä¸¤å¹´è¢«è¯æ˜æˆç«‹ï¼Œæˆä¸ºæˆ‘ä»¬ç†ŸçŸ¥çš„ CAP å®šç†ï¼ŒCAPä¸‰è€…ä¸å¯å…¼å¾—ã€‚

## 3. ä¸ºä»€ä¹ˆéœ€è¦æ³¨å†Œä¸­å¿ƒ

<div style="border: 1px solid #1d63edb5;
    padding: 10px;
    border-left: 5px solid #1d63edb5;
    background: #bed2fa63;
    border-radius: 0 3px 3px 0;
    color: #1d63ed;
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" style="flex-shrink: 0;" width="14px" height="14px" fill="none" xmlns="http://www.w3.org/2000/svg" class="MuiSvgIcon-root MuiSvgIcon-colorInfo MuiSvgIcon-fontSizeSmall css-1bqouqa" focusable="false" aria-hidden="true" data-testid="InfoCircleIcon"><path d="M12 16V12M12 8H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <span style="line-height: 16px;">æˆ‘ä»¬åœ¨ä¸Šé¢å·²ç»ç¨å¾®äº†è§£äº†ä»€ä¹ˆæ˜¯æ³¨å†Œä¸­å¿ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬ç»§ç»­è°ˆè°ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦æ³¨å†Œä¸­å¿ƒ?</span>
</div>

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå½“ä¸­ï¼Œæˆ‘ä»¬ä¸ä»…ä»…æ˜¯éœ€è¦åœ¨æ³¨å†Œä¸­å¿ƒæ‰¾åˆ°æœåŠ¡å’ŒæœåŠ¡åœ°å€çš„æ˜ å°„å…³ç³»è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘æ›´ä¸ºå¤æ‚çš„é—®é¢˜ï¼š

- æœåŠ¡æ³¨å†Œä¹‹åï¼Œå¦‚ä½•è¢«åŠæ—¶çš„å‘ç°ï¼Ÿ
- æœåŠ¡å®•æœºä¹‹åï¼Œå¦‚ä½•åŠæ—¶çš„ä¸‹çº¿ï¼Ÿ
- æœåŠ¡å¦‚ä½•æœ‰æ•ˆçš„æ°´å¹³æ‰©å±•ï¼Ÿ
- æœåŠ¡å‘ç°æ—¶ï¼Œå¦‚ä½•è¿›è¡Œè·¯ç”±ï¼Ÿ
- æœåŠ¡å¼‚å¸¸æ—¶å¦‚ä½•è¿›è¡Œé™çº§ï¼Ÿ
- æ³¨å†Œä¸­å¿ƒå¦‚ä½•å®ç°è‡ªèº«çš„é«˜å¯ç”¨ï¼Ÿ

è¿™äº›é—®é¢˜çš„è§£å†³éƒ½ä¾èµ–äºæ³¨å†Œä¸­å¿ƒã€‚ç®€å•çœ‹ï¼Œæ³¨å†Œä¸­å¿ƒçš„åŠŸèƒ½å¯èƒ½ç±»ä¼¼DNSæœåŠ¡å™¨æˆ–è€…è´Ÿè½½å‡è¡¡å™¨ã€‚å®é™…ä¸Šï¼Œæ³¨å†Œä¸­å¿ƒä½œä¸ºå¾®æœåŠ¡çš„åŸºç¡€ç»„ä»¶ï¼Œå¯èƒ½ä¼šæ›´åŠ çš„å¤æ‚ï¼Œä¹Ÿéœ€è¦æ›´å¤šçš„çµæ´»æ€§å’Œæ—¶æ•ˆæ€§ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å­¦ä¹ æ›´å¤šçš„Spring Cloudå¾®æœåŠ¡ç»„ä»¶å»ååŒå®Œæˆåº”ç”¨å¼€å‘ã€‚

## 4. æ³¨å†Œä¸­å¿ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜?

æ³¨å†Œä¸­å¿ƒä¸»è¦è§£å†³äº†ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

- æœåŠ¡çš„ç®¡ç†
- æœåŠ¡çš„ä¾èµ–å…³ç³»ç®¡ç†

## 5. ä»€ä¹ˆæ˜¯EurekaæœåŠ¡æ³¨å†Œä¸­å¿ƒ?

Eureka æ˜¯ Netflix å¼€å‘çš„æœåŠ¡å‘ç°ç»„ä»¶ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªåŸºäºRESTçš„æœåŠ¡ã€‚Spring Cloud å°†å®ƒé›†æˆåœ¨å…¶å­é¡¹ç›®Spring Cloud Netflixä¸­ï¼Œå®ç°Spring Cloudçš„æœåŠ¡æ³¨å†Œå’Œå‘ç°ï¼ŒåŒæ—¶è¿˜æä¾›äº†è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»ç­‰èƒ½åŠ›ã€‚

## 6. Eureka æ³¨å†Œä¸­å¿ƒä¸‰ç§è§’è‰²

<img src="./assets/image-20240901215327953.png" alt="image-20240901215327953" style="zoom: 67%;" />

ä»¥ä¸‹å¯¹ä¸Šé¢ä¸‰ç§è§’è‰²åšä¸ªç®€å•çš„ä»‹ç»ï¼š

- æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼šæä¾›æœåŠ¡çš„æ³¨å†Œã€å‘ç°ã€æ•…éšœè½¬ç§»ç­‰åŠŸèƒ½ï¼›

- æœåŠ¡æ¶ˆè´¹è€…ï¼šè·å–æœåŠ¡çš„åœ°å€ï¼Œä½¿ç”¨æœåŠ¡ï¼›
- æœåŠ¡æä¾›è€…ï¼šå°†æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¾›æœåŠ¡æ¶ˆè´¹è€…ä½¿ç”¨ï¼›

### 6.1 Eureka Server

é€šè¿‡Registerã€Getã€Renewç­‰æ¥å£æä¾›æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ã€‚

### 6.2 Service Provider

æœåŠ¡æä¾›æ–¹ï¼Œå°†è‡ªèº«çš„æœåŠ¡å®ä¾‹æ³¨å†Œåˆ°Eureka Serverä¸­ã€‚

### 6.3 Service Consumer

æœåŠ¡è°ƒç”¨æ–¹ï¼Œé€šè¿‡Eureka Serverè·å–æœåŠ¡åˆ—è¡¨ï¼Œæ¶ˆè´¹æœåŠ¡ã€‚

<img src="./assets/image-20240901220432204.png" alt="image-20240901220432204" style="zoom:67%;" />



å…·ä½“çš„æ­¥éª¤è§£é‡Šï¼š

1.   å®ä¾‹åŒ–æœåŠ¡

2.   å°†æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ

- xx1-service 127.0.0.1:8080

- xx2-service 127.0.0.1:8080

3.   ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åˆ—è¡¨
4.   åŸºäºè´Ÿè½½å‡è¡¡ç®—æ³•ä»åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªæœåŠ¡åœ°å€è¿›è¡ŒæœåŠ¡è°ƒç”¨
5.   å®šæœŸå‘é€å¿ƒè·³
6.   æ£€æŸ¥æ²¡æœ‰å®šæœŸå‘é€å¿ƒè·³çš„æœåŠ¡å¹¶åœ¨ä¸€å®šçš„æ—¶é—´å†…å‰”é™¤æœåŠ¡åœ°å€åˆ—è¡¨

## 7. Eurekaå…¥é—¨æ¡ˆä¾‹

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;">è¿™é‡Œæˆ‘ä»¬ä¸ä¼šå†æ ¼å¤–çš„å¼ºè°ƒ Mavenã€JDKã€POM ç­‰åŸºç¡€çŸ¥è¯†çš„è¯´æ˜ï¼Œå¦‚éœ€è¦è¯·å„ä½è‡ªè¡Œå»å­¦ä¹ ï¼Œæœ¬ç³»åˆ—ä¸åšè®²è§£ã€‚</span>
</div>

### 7.1 åˆ›å»ºé¡¹ç›®

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¾®æœåŠ¡çš„èšåˆé¡¹ç›®æ¥ç®€å•è¯´è¯´Eurekaï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªpomçˆ¶å·¥ç¨‹ã€‚ä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨IDEAåˆ›å»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨STSåˆ›å»ºï¼Œä½†æ˜¯æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢ä½¿ç”¨ç½‘é¡µåˆ›å»ºï¼Œæˆ‘ä»¬ä½¿ç”¨é˜¿é‡Œçš„åˆ›å»ºåœ°å€ [https://start.aliyun.com/](https://start.aliyun.com/)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Spring å®˜æ–¹åœ°å€åˆ›å»º [https://start.spring.io/](https://start.spring.io/)ã€‚

<img src="./assets/image-20240901221358798.png" alt="image-20240901221358798" style="zoom:80%;" />

<span style="color:#ff6000;">åœ¨åˆ›å»º Spring Cloud é¡¹ç›®ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¨å¾®å»æ³¨æ„ä¸‹Spring Bootã€Spring Cloudã€Spring Cloud Alibabaä¸‰è€…ä¹‹é—´çš„ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ã€‚</span>

### 7.2 æœåŠ¡æ³¨å†Œä¸­å¿ƒ

1. åˆ›å»ºå­é¡¹ç›® eureka-server

<img src="./assets/image-20240902223942099.png" alt="image-20240902223942099" style="zoom:67%;" />



2.   æ·»åŠ pomä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

3.   é…ç½®æ–‡ä»¶ä¿®æ”¹

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 12px;">åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®æ‰“å¼€å¿ƒè·³æ£€æµ‹ã€‚å³ï¼šeureka.server.enable-self-preservation = true ã€‚</span>
</div>

```yaml
server:
  port: 8765
spring:
  application:
    name: bettytsai-eureka
  profiles:
  active: dev

# Eurekaé…ç½®
eureka:
  instance:
    # ä¸»æœºåï¼ˆå¦‚æœå¯ä»¥åœ¨é…ç½®æ—¶ç¡®å®šï¼‰ï¼ˆå¦åˆ™å°†ä» OS åŸè¯­ä¸­çŒœæµ‹ï¼‰ã€‚
    hostname: bettytsai-eureka
    # æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚
    prefer-ip-address: false
  client:
    # æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚
    fetch-registry: false
    # æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚
    register-with-eureka: false
    # å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚
    # æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
    # ç¤ºä¾‹ï¼šhttps:ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka
    # æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚
    # å¯ä»¥ç†è§£ä¸ºæ³¨å†Œä¸­å¿ƒå¯¹å¤–æš´éœ²çš„æ³¨å†Œåœ°å€
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
  server:
    # å¿ƒè·³æ£€æµ‹
    enable-self-preservation: false
```

1. å¯åŠ¨ç±»ä¿®æ”¹ï¼Œæ·»åŠ  `@EnableEurekaServer` æ³¨è§£


```java
@Slf4j
@EnableEurekaServer
@SpringBootApplication
public class EurekaServerApplication {
    public static void main(String[] args) {
        ApplicationContext context = SpringApplication.run(EurekaServerApplication.class, args);
        Environment environment = context.getEnvironment();
        String port = environment.getProperty("server.port");
        log.info(String.format(":::Eurekaæ³¨å†Œä¸­å¿ƒå¯åŠ¨æˆåŠŸ....ç«¯å£å·::: %s",port));
    }
}
```

2.   å¯åŠ¨eureka-serverï¼Œé€šè¿‡  `http://127.0.0.1:8765/` è®¿é—®å³å¯ã€‚

![image-20240902224644510](./assets/image-20240902224644510-17252884057572-17351890365071.png)

çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒå°±æˆåŠŸå¯åŠ¨äº†ï¼Œå…¥é—¨æ¡ˆä¾‹å°±ç»“æŸå•¦ã€‚

## 8. é«˜å¯ç”¨EurekaæœåŠ¡æ³¨å†Œä¸­å¿ƒ

### 8.1 æ³¨å†Œä¸­å¿ƒ ï¼ˆEureka Serverï¼‰

#### 8.1.1 åˆ›å»ºé¡¹ç›®

æˆ‘ä»¬ç”±äºæ²¡æœ‰æœåŠ¡å™¨ï¼Œæš‚æ—¶å°±åªèƒ½æœ¬åœ°è¿›è¡Œé¡¹ç›®çš„æ­å»ºå’Œ**ä¸»ä»æœåŠ¡** çš„æ­å»ºï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯åŸºäºä¸Šä¸€ç« èŠ‚ã€ŠEurekaå…¥é—¨æ¡ˆä¾‹ã€‹å½“ä¸­çš„é¡¹ç›®ç»§ç»­æ‹“å±•ã€‚å†ç»§ç»­æ­å»ºä¸€ä¸ª**ä»æ³¨å†Œä¸­å¿ƒæœåŠ¡** å»è¿›è¡Œæ¼”ç¤ºï¼Œå…·ä½“é…ç½®åŸºæœ¬åŒ**ä¸»æ³¨å†Œä¸­å¿ƒæœåŠ¡** ï¼Œä¸ä¸€æ ·çš„åœ°æ–¹å°±æ˜¯ä¸»ä»é…ç½®é—®é¢˜ã€‚

ä½†å¦‚æœæ˜¯å¤šæœºå™¨éƒ¨ç½²æˆ‘ä»¬å®Œå…¨å¯ä»¥ä¸éœ€è¦å»ä¿®æ”¹ç«¯å£ï¼Œé€šè¿‡IPå»åŒºåˆ†å³å¯ï¼Œä½†æˆ‘ä»¬ç°åœ¨æ˜¯åŸºäºä¸€å°æœºå™¨å»åšæ¼”ç¤ºæ•ˆæœï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å‡†å¤‡å¤åˆ¶ä¸€ä¸ªæ–°çš„æ³¨å†Œä¸­å¿ƒã€‚

<img src="./assets/image-20240904221259844.png" alt="image-20240904221259844" style="zoom:77%;" />

æ­£å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­æ–°å»ºäº†ä¸€ä¸ª `bettytsai-eureka-slave` ä»æœåŠ¡ï¼Œä½ å¯èƒ½å‘ç°å’Œã€ŠEurekaå…¥é—¨æ¡ˆä¾‹ã€‹ä¸­çš„é¡¹ç›®åä¸ä¸€æ ·ï¼Œåˆ«æ‹…å¿ƒï¼Œæˆ‘åªæ˜¯ä¸ºäº†åŒºåˆ†æ–°å»ºçš„æ³¨å†Œä¸­å¿ƒï¼Œæ”¹äº†ä¸ªåå­—ã€‚

#### 8.1.2 æ·»åŠ ä¾èµ–

è¿˜æ˜¯åŒ `bettytsai-eureka-master` æ¨¡å—ä¸€æ ·ï¼Œé¡¹ç›®ä¾èµ–æ²¡æœ‰å˜åŒ–ã€‚

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

#### 8.1.3 é…ç½®æ–‡ä»¶

ä¸ºäº†æ›´å¥½çš„åŒºåˆ†ä¸»æœåŠ¡å’Œä»æœåŠ¡ä¹‹é—´çš„åŒºåˆ«ï¼Œæˆ‘ä»¬è¿˜æ˜¯å€ŸåŠ©ä¸‹å·¥å…·ç»™å¤§å®¶çœ‹çœ‹äºŒè€…é…ç½®çš„åŒºåˆ«ï¼š

- é…ç½®æ–‡ä»¶ application.yml çš„åŒºåˆ«



<img src="./assets/image-20240904222245180.png" alt="image-20240904222245180" style="zoom:80%;" />



- é…ç½®æ–‡ä»¶ application-eureka-dev.yml çš„åŒºåˆ«

![image-20240904223002774](./assets/image-20240904223002774-17254602045823.png)

ä»é…ç½®ä¸Šçœ‹åˆ°ï¼Œä¸»ä»æ³¨å†Œä¸­å¿ƒéœ€è¦å»è¿›è¡Œç›¸äº’æ³¨å†Œï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯ç³»ç»ŸHostæ˜ å°„é…ç½®ï¼š

```bash
# è‹¥æ˜¯å¤šæœºå™¨éƒ¨ç½²ï¼Œå»ºè®®eureka.instance.hostnameä¿æŒä¸€è‡´
# è¿™é‡Œæˆ‘åŒºåˆ†ä¸»è¦æ˜¯æ‹…å¿ƒæ··æ·†åˆå­¦è€…è®¤çŸ¥
127.0.0.1  bettytsai-eureka-slave
127.0.0.1  bettytsai-eureka-master
```

#### 8.1.4 å¯åŠ¨æœåŠ¡

åœ¨ä¸Šé¢æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œç°åœ¨æˆ‘ä»¬æ‰“å¼€eurekaæœåŠ¡çœ‹çœ‹å…·ä½“æƒ…å†µã€‚

<img src="./assets/image-20240904223347322.png" alt="image-20240904223347322" style="zoom:80%;" />

å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯è®¿é—®ä¸»æœåŠ¡è¿˜æ˜¯ä»æœåŠ¡ï¼Œæˆ‘ä»¬åœ¨æ³¨å†Œåˆ—è¡¨ä¸­éƒ½èƒ½çœ‹åˆ°ä¸¤ä¸ªeurekaæœåŠ¡å®ä¾‹ï¼Œå¯è§æˆ‘ä»¬çš„eurekaé›†ç¾¤éƒ¨ç½²æˆåŠŸäº†ã€‚

#### 8.1.5 IP +ç«¯å£æ³¨å†Œ

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ³¨å†Œçš„eurekaå®ä¾‹ï¼Œéƒ½æ˜¯æ“ä½œç³»ç»ŸåŸè¯­æ³¨å†Œï¼š

![image-20240905003521758](./assets/image-20240905003521758-17254677244995.png)

ä¸€ä¸ªæ™®é€šçš„Netflix Eurekaå®ä¾‹æ³¨å†Œçš„IDç­‰äºå…¶ä¸»æœºåï¼ˆå³ï¼šæ¯ä¸ªä¸»æœºä»…æä¾›ä¸€é¡¹æœåŠ¡ï¼‰ã€‚Spring Cloud Eurekaæä¾›äº†åˆç†çš„é»˜è®¤å€¼ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```bash
${spring.cloud.client.hostname}:${spring.application.name}:${spring.application.instance_id:${server.port}}
```

ä¹Ÿå°±æ˜¯:

```bash
ä¸»æœºå:åº”ç”¨å:ç«¯å£
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è¿›è¡Œä¿®æ”¹ï¼š

```yaml
eureka:
  instance:
    # ä¸»æœºåï¼ˆå¦‚æœå¯ä»¥åœ¨é…ç½®æ—¶ç¡®å®šï¼‰ï¼ˆå¦åˆ™å°†ä» OS åŸè¯­ä¸­çŒœæµ‹ï¼‰ã€‚
    hostname: bettytsai-eureka
    # æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚
    # å¯ä»¥ç†è§£ä¸ºæ˜¯å¦ä½¿ç”¨IPåœ°å€æ³¨å†Œ
    prefer-ip-address: true
    # å®ä¾‹id
    instance-id: ${spring.cloud.client.ip-address}:${server.port}
```

é‡æ–°å¯åŠ¨æœåŠ¡ä¹‹åï¼Œå®ä¾‹IDå°±å˜æˆäº†IP+ç«¯å£çš„æ–¹å¼æ³¨å†Œï¼š

![image-20240905005450640](./assets/image-20240905005450640.png)

### 8.2 æœåŠ¡æä¾›è€…ï¼ˆService Providerï¼‰

#### 8.2.1 åˆ›å»ºé¡¹ç›®

åœ¨ä¸Šä¸€èŠ‚å½“ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªé«˜å¯ç”¨çš„EurekaæœåŠ¡é›†ç¾¤ï¼Œä¸çŸ¥é“æ˜¯å¦è¿˜è®°å¾—åœ¨ç¬¬å…­ç« çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ›¾ç»è¯´è¿‡ï¼ŒEurekaä¸­å¿ƒçš„ä¸‰ç§è§’è‰²ï¼š

- æœåŠ¡æ³¨å†Œä¸­å¿ƒ
- æœåŠ¡æä¾›è€…
- æœåŠ¡æ¶ˆè´¹è€…

ç°åœ¨æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆæ ·å»æ­å»ºæœåŠ¡æä¾›è€…ï¼Œè¿˜æ˜¯åœ¨åŸæœ‰çš„æ¡ˆä¾‹ä¸­æ·»åŠ æ–°çš„æ¨¡å—ï¼Œæˆ‘ä»¬å‘½åä¸ºï¼šbettytsai-systemã€‚

<img src="./assets/image-20240905101025532.png" alt="image-20240905101025532" style="zoom:87%;" />

#### 8.2.2 æ·»åŠ ä¾èµ–

ä¸æœåŠ¡æ³¨å†Œä¸­å¿ƒä¸ä¸€æ ·çš„æ˜¯ï¼Œé’ˆå¯¹æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ï¼Œæ‰€ä½¿ç”¨çš„ä¾èµ–å¦‚ä¸‹æ‰€ç¤ºã€‚

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
<!--...å…¶ä½™ä¾èµ–ä¸ä½œå±•ç¤º-->
```

è‹¥æ§åˆ¶å°æŠ¥é”™æƒ…å†µå¦‚ä¸‹ï¼Œè¯·æ·»åŠ ä»¥ä¸‹ä¾èµ–è§£å†³ï¼ŒæŠ¥é”™å¤§è‡´ä¸ºï¼š

```c
Caused by: java.lang.NoClassDefFoundError: javax/inject/Provider
```

ä¿®å¤ä¾èµ–:

```xml
<dependency>
    <groupId>javax.inject</groupId>
    <artifactId>javax.inject</artifactId>
</dependency>
```

#### 8.2.3 é…ç½®æ–‡ä»¶

æœåŠ¡æä¾›è€…çš„é…ç½®å’Œæ³¨å†Œä¸­å¿ƒçš„é…ç½®å¤§å·®ä¸å·®ï¼ŒåŸºæœ¬éƒ½å·®ä¸å¤šï¼Œå…·ä½“å¦‚ä¸‹ã€‚

```yml
eureka:
  client:
    # æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚
    fetch-registry: true
    # æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚
    register-with-eureka: true
    # æŒ‡ç¤ºä» eureka æœåŠ¡å™¨è·å–æ³¨å†Œè¡¨ä¿¡æ¯çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    registry-fetch-interval-seconds: 30
    # å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚
    # æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚
    # é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
    # ç¤ºä¾‹ï¼šhttps://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/
    # æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚
    service-url:
      defaultZone:
        - http://bettytsai-eureka:8761/eureka
        - http://bettytsai-eureka:8762/eureka
  instance:
    # æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚
    prefer-ip-address: true
    # è·å–è¦å‘ eureka æ³¨å†Œçš„æ­¤å®ä¾‹çš„å”¯ä¸€ IDï¼ˆåœ¨ appName èŒƒå›´å†…ï¼‰
    instance-id: ${spring.cloud.client.ip-address}:${server.port}
    # æŒ‡ç¤º eureka å®¢æˆ·ç«¯éœ€è¦å‘ eureka æœåŠ¡å™¨å‘é€å¿ƒè·³ä»¥æŒ‡ç¤ºå®ƒä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    # å¦‚æœåœ¨ leaseExpirationDurationInSeconds ä¸­æŒ‡å®šçš„æ—¶é—´æ®µå†…æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ eureka æœåŠ¡å™¨å°†ä»å…¶è§†å›¾ä¸­åˆ é™¤è¯¥å®ä¾‹ï¼Œ
    # ä»è€Œç¦æ­¢æµå‘æ­¤å®ä¾‹çš„æµé‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœå®ä¾‹å®ç° HealthCheckCallbackï¼Œç„¶åå†³å®šä½¿è‡ªèº«ä¸å¯ç”¨ï¼Œåˆ™å®ä¾‹ä»ç„¶æ— æ³•è·å–æµé‡ã€‚
    lease-renewal-interval-in-seconds: 10
    # å¿…é¡»ä¸Dockerå®¹å™¨åä¿æŒä¸€è‡´
    hostname: ${spring.application.name}
```

éœ€è¦ç¨å¾®æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢é…ç½®äº†é›†ç¾¤æ³¨å†Œä¸­å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æœåŠ¡æä¾›è€…éœ€è¦åœ¨ `eureka.client.service-url.defaultZone` ä¸­åˆ—ä¸¾æ‰€æœ‰çš„æ³¨å†Œä¸­å¿ƒï¼Œå¯ä»¥ä»¥ `,` åˆ†å‰²ï¼Œä¹Ÿå¯ä»¥å¦‚ä¸Šé…ç½®ã€‚

#### 8.2.4 ç¼–å†™æœåŠ¡

é‰´äºåˆå­¦è€…å¯èƒ½æ²¡æœ‰ç›¸å…³ORMæ¡†æ¶çš„ç»éªŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¸å»æ¼”ç¤ºç›¸å…³çš„JDBCæ“ä½œã€‚ç¼–å†™ä¸€ä¸ªè™šå‡çš„æµ‹è¯•æœåŠ¡å»æ¼”ç¤ºå¾®æœåŠ¡çš„åŠŸèƒ½ï¼Œè®©è¯»è€…æ›´åŠ é›†ä¸­ç²¾åŠ›å»å­¦ä¹ å¾®æœåŠ¡çš„ç»„ä»¶ã€‚éƒ¨åˆ†ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@RestController
@RequestMapping(value = "/system/test")
public class TestController {

    @GetMapping(value = "/getDefaultString")
    public String getDefaultString() {
        return "hello eureka! I'm system.";
    }
}
```

#### 8.2.5 æ³¨è§£è¯´æ˜

æˆ‘ä»¬å·²ç»çŸ¥é“åœ¨æœåŠ¡æ³¨å†Œä¸­å¿ƒæ­å»ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨ç±»ä¸­æ·»åŠ äº† `@EnableEurekaServer` æ³¨è§£ã€‚éœ€è¦ç®€å•çš„æä¸€å˜´ï¼Œå°±æ˜¯åœ¨æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…æ¥è¯´ï¼Œæˆ‘ä»¬ä¸æ²¡æœ‰å¼ºåˆ¶è¦æ±‚è¯´æ·»åŠ  `@EnableEurekaClient` æ³¨è§£ã€‚

åœ¨SpringBootå½“ä¸­ï¼Œæœ‰ä¸€ä¸ªé»˜è®¤çš„**çº¦å®šå¤§äºé…ç½®** è¯´æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨æˆ‘ä»¬çš„ä¾èµ–ä¸­ï¼Œå¦‚æœå¼•å…¥äº† `spring-cloud-starter-netflix-eureka-client` ä¾èµ–ï¼Œå®ƒå°±ä¼šè®¤ä¸ºæˆ‘ä»¬è‚¯å®šæ˜¯æƒ³è¦å»æ³¨å†ŒæœåŠ¡ï¼Œé»˜è®¤ä¼šæ‰“å¼€ `@EnableEurekaClient` æ³¨è§£åŠŸèƒ½ã€‚ä½†ä¸ºäº†ä»£ç çš„å¯è¯»æ€§ï¼Œå»ºè®®æ·»åŠ ä¸Šè¯¥æ³¨è§£ã€‚

```java
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.context.ApplicationContext;
import org.springframework.core.env.Environment;
@Slf4j
@EnableEurekaClient
@SpringBootApplication
public class SystemApplication {
    public static void main(String[] args) {
        ApplicationContext context = SpringApplication.run(SystemApplication.class, args);
        Environment environment = context.getEnvironment();
        String port = environment.getProperty("server.port");
        log.info(String.format(":::ç³»ç»Ÿå¯åŠ¨æˆåŠŸ....ç«¯å£å·::: %s",port));
    }
}
```

#### 8.2.6 å¯åŠ¨æœåŠ¡

ç¼–å†™å®Œæµ‹è¯•æœåŠ¡ä¹‹åï¼Œæˆ‘ä»¬ä¾æ¬¡å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼ŒæœåŠ¡æä¾›è€…ï¼Œæ‰“å¼€æ³¨å†Œä¸­å¿ƒæœåŠ¡é¡µçœ‹åˆ°æˆ‘ä»¬çš„æœåŠ¡æä¾›è€…å·²ç»æ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒäº†ã€‚

<img src="./assets/image-20240905104806042.png" alt="image-20240905104806042" style="zoom:90%;" />

#### 8.2.7 éªŒè¯æœåŠ¡

é¡µé¢è®¿é—®æœåŠ¡åœ°å€ï¼ŒéªŒè¯æˆ‘ä»¬çš„æœåŠ¡æ˜¯å¦æˆåŠŸå¯åŠ¨ã€‚

<img src="./assets/image-20240905105822330.png" alt="image-20240905105822330" style="zoom:90%;" />

### 8.3 æœåŠ¡æ¶ˆè´¹è€…ï¼ˆService Consumerï¼‰

#### 8.3.1 åˆ›å»ºé¡¹ç›®

æ­å»ºå¥½æœåŠ¡æä¾›è€…ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†ç»§ç»­æ­å»ºæˆ‘ä»¬çš„æœåŠ¡æ¶ˆè´¹è€… bettytsai-test æ¨¡å—ï¼ŒåŒæ ·è¿˜æ˜¯å€ŸåŠ©æˆ‘ä»¬çš„å…¥é—¨æ¡ˆä¾‹ï¼Œå¤§è‡´é¡¹ç›®å¦‚ä¸‹ã€‚

<img src="./assets/image-20240905131357088.png" alt="image-20240905131357088" style="zoom:80%;" />

#### 8.3.2 æ·»åŠ ä¾èµ–

åŒæ ·çš„æ­¥éª¤ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ·»åŠ ç›¸åº”çš„ä¾èµ–ã€‚

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

#### 8.3.3 é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶åŸºæœ¬å’ŒæœåŠ¡æä¾›è€…ä¸€æ ·ã€‚

```yml
eureka:
  client:
    # æŒ‡ç¤ºæ­¤å®¢æˆ·ç«¯æ˜¯å¦åº”ä» eureka æœåŠ¡å™¨è·å– eureka æ³¨å†Œè¡¨ä¿¡æ¯ã€‚
    fetch-registry: true
    # æŒ‡ç¤ºæ­¤å®ä¾‹æ˜¯å¦åº”å°†å…¶ä¿¡æ¯æ³¨å†Œåˆ° eureka æœåŠ¡å™¨ä»¥ä¾›å…¶ä»–äººå‘ç°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨ä¸å¸Œæœ›å‘ç°æ‚¨çš„å®ä¾‹ï¼Œè€Œæ‚¨åªæƒ³å‘ç°å…¶ä»–å®ä¾‹ã€‚
    register-with-eureka: true
    # æŒ‡ç¤ºä» eureka æœåŠ¡å™¨è·å–æ³¨å†Œè¡¨ä¿¡æ¯çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    registry-fetch-interval-seconds: 30
    # å°†å¯ç”¨åŒºæ˜ å°„åˆ°ç”¨äºä¸ eureka æœåŠ¡å™¨é€šä¿¡çš„å®Œå…¨é™å®š URL åˆ—è¡¨ã€‚
    # æ¯ä¸ªå€¼å¯ä»¥æ˜¯å•ä¸ª URL æˆ–é€—å·åˆ†éš”çš„å¤‡ç”¨ä½ç½®åˆ—è¡¨ã€‚
    # é€šå¸¸ï¼Œeureka æœåŠ¡å™¨ URL æºå¸¦åè®®ã€ä¸»æœºã€ç«¯å£ã€ä¸Šä¸‹æ–‡å’Œç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
    # ç¤ºä¾‹ï¼šhttps://ec2-256-156-243-129.compute-1.amazonaws.com:7001/eureka/
    # æ›´æ”¹åœ¨è¿è¡Œæ—¶åœ¨ eurekaServiceUrlPollIntervalSeconds æŒ‡å®šçš„ä¸‹ä¸€ä¸ªæœåŠ¡ url åˆ·æ–°å‘¨æœŸç”Ÿæ•ˆã€‚
    service-url:
      defaultZone:
        - http://bettytsai-eureka:8761/eureka
        - http://bettytsai-eureka:8762/eureka
  instance:
    # æ ‡å¿—è¡¨ç¤ºï¼Œåœ¨çŒœæµ‹ä¸»æœºåæ—¶ï¼Œåº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»ŸæŠ¥å‘Šçš„ä¸»æœºåã€‚
    prefer-ip-address: true
    # è·å–è¦å‘ eureka æ³¨å†Œçš„æ­¤å®ä¾‹çš„å”¯ä¸€ IDï¼ˆåœ¨ appName èŒƒå›´å†…ï¼‰
    instance-id: ${spring.cloud.client.ip-address}:${server.port}
    # æŒ‡ç¤º eureka å®¢æˆ·ç«¯éœ€è¦å‘ eureka æœåŠ¡å™¨å‘é€å¿ƒè·³ä»¥æŒ‡ç¤ºå®ƒä»ç„¶å¤„äºæ´»åŠ¨çŠ¶æ€çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
    # å¦‚æœåœ¨ leaseExpirationDurationInSeconds ä¸­æŒ‡å®šçš„æ—¶é—´æ®µå†…æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ eureka æœåŠ¡å™¨å°†ä»å…¶è§†å›¾ä¸­åˆ é™¤è¯¥å®ä¾‹ï¼Œ
    # ä»è€Œç¦æ­¢æµå‘æ­¤å®ä¾‹çš„æµé‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœå®ä¾‹å®ç° HealthCheckCallbackï¼Œç„¶åå†³å®šä½¿è‡ªèº«ä¸å¯ç”¨ï¼Œåˆ™å®ä¾‹ä»ç„¶æ— æ³•è·å–æµé‡ã€‚
    lease-renewal-interval-in-seconds: 10
    # å¿…é¡»ä¸Dockerå®¹å™¨åä¿æŒä¸€è‡´
    hostname: ${spring.application.name}
```

#### 8.3.4 ç¼–å†™æœåŠ¡

æˆ‘ä»¬è¿˜æ˜¯ç¼–å†™ä¸€ä¸ªæµ‹è¯•æœåŠ¡å»éªŒè¯æ¶ˆè´¹è€…æ¨¡å—æ˜¯å¦æ­£å¸¸ã€‚

```java
@RestController
@RequestMapping(value = "/test/test")
public class DemoController {

    @GetMapping(value = "/test")
    public String get_test() {
        return "GET:: Hello World!";
    }

    @PostMapping(value = "/test")
    public String post_test() {
        return "POST:: Hello World!";
    }

}
```

#### 8.3.5 å¯åŠ¨æœåŠ¡

ç„¶åå¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡æ¶ˆè´¹è€…æ¨¡å—ï¼Œæ‰“å¼€eurekaæ³¨å†Œä¸­å¿ƒé¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°ä¹ŸåŒæ ·æ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒäº†ã€‚

<img src="./assets/image-20240905132944510.png" alt="image-20240905132944510" style="zoom:99%" />

#### 8.3.6 éªŒè¯æœåŠ¡

åŒæ ·çš„æˆ‘ä»¬éªŒè¯ä¸‹æ¶ˆè´¹è€…æœåŠ¡æ˜¯å¦å¯ç”¨ã€‚

<img src="./assets/image-20240905133110338.png" alt="image-20240905133110338" style="zoom:80%;" />

#### 8.3.7 æœåŠ¡è°ƒç”¨

ä¸ºäº†è®©åˆå­¦è€…æ›´å¥½çš„ç†è§£æä¾›è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æ¶ˆè´¹è€…è¿˜æœ‰å¿…è¦æ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒå—ï¼Ÿ æ²¡å¿…è¦ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒæ•´é…ç½®æ–‡ä»¶ï¼š

```yml
eureka:
  client:
    # ä¸æ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒï¼ŒæœåŠ¡æ¶ˆè´¹è€…åªæ‹‰å–æœåŠ¡ï¼Œä¸æä¾›æœåŠ¡
    register-with-eureka: false
```

è¿™æ ·å†æ³¨å†Œä¸­å¿ƒé¡µé¢ä¸­æˆ‘ä»¬å°†çœ‹ä¸åˆ°ç›¸å…³çš„å®ä¾‹åˆ—è¡¨ã€‚

é‚£æˆ‘æˆ‘ä»¬ç©¶ç«Ÿæ€ä¹ˆæ ·æ‰èƒ½è®©æ¶ˆè´¹è€…å»è¿œç¨‹è°ƒç”¨æœåŠ¡æä¾›è€…æä¾›çš„æœåŠ¡å‘¢ï¼Œä»¥ä¸‹æœ‰ä¸‰ç§æ–¹æ¡ˆï¼š

- DiscoveryClient é€šè¿‡å…ƒæ•°æ®è·å–æœåŠ¡ä¿¡æ¯
- LoadBalancerClient é€šè¿‡Ribbonçš„è´Ÿè½½å‡è¡¡å™¨å®ç°
- @LoadBalanced é€šè¿‡æ³¨è§£å¼€å¯Ribbonè´Ÿè½½å‡è¡¡å™¨

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸‹é¢ä¸‰ç§æ–¹æ¡ˆè¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚

##### 8.3.7.1 DiscoveryClient

Spring Bootä¸æä¾›ä»»ä½•è‡ªåŠ¨é…ç½®çš„ `RestTemplate` Beanå®ä¾‹ï¼Œæ‰€ä»¥éœ€è¦åœ¨é¡¹ç›®ä¸­è‡ªè¡Œæ³¨å…¥ `RestTemplate` å®ä¾‹ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¨å¾®æ”¹é€ ä¸‹æœåŠ¡æä¾›è€…ï¼Œå¤§è‡´ç»“æœå¦‚ä¸‹ã€‚

![image-20240905141225237](./assets/image-20240905141225237-17255167484144.png)

ç„¶åæˆ‘ä»¬æ”¹é€ æœåŠ¡æ¶ˆè´¹è€…æ¨¡å—ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ³¨å…¥ `RestTemplate` å®ä¾‹ã€‚

```java
@Configuration
public class RestConfig {
    @Bean
    public RestTemplate restTemplate(){
        return new RestTemplate();
    }
}
```

ç„¶åé€šè¿‡ `RestTemplate` è°ƒç”¨ bettytsai-systemæ¨¡å—æä¾›çš„æœåŠ¡ã€‚

```java
@RestController
@RequestMapping(value = "/test/test")
@SuppressWarnings(WarningsConstants.SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION)
public class DemoController {

    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    private DiscoveryClient discoveryClient;

    @GetMapping(value = "/test")
    public String getTest() {
        // è·å–eureka serveræœåŠ¡åˆ—è¡¨
        List<String> services = discoveryClient.getServices();
        ExceptionUtil.throwException(CollUtil.isEmpty(services), "æœªèƒ½æ‰¾åˆ°ä»»ä½•æœåŠ¡!");
        // æ ¹æ®æœåŠ¡åç§°è·å–æœåŠ¡
        String serviceName = "bettytsai-system";
        List<ServiceInstance> instances = discoveryClient.getInstances(serviceName);
        ExceptionUtil.throwException(CollUtil.isEmpty(instances), String.format("æœªèƒ½æ‰¾åˆ°ä»»ä½•åç§°ä¸º%sçš„æœåŠ¡å®ä¾‹!", serviceName));
        // è·å–æœåŠ¡å®ä¾‹
        ServiceInstance instance = instances.get(0);
        String url = "http://" + instance.getHost() + ":" + instance.getPort() + "/system/test/getDefaultString";
        // è°ƒç”¨æœåŠ¡æ¥å£ï¼ŒResponseEntityå°è£…äº†è¿”å›æ•°æ®
        ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, null,
                new ParameterizedTypeReference<String>() {}
        );
        return response.getBody();
    }
}
```

æœ€åï¼Œæˆ‘ä»¬å¯åŠ¨æ¶ˆè´¹è€…ï¼ŒéªŒè¯ä¸‹æœåŠ¡æ˜¯å¦æˆåŠŸè°ƒç”¨ã€‚

<img src="./assets/image-20240905143729417-17255182510065.png" alt="image-20240905143729417" style="zoom:90%;" />

##### 8.3.7.2 LoadBalancerClient 

æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹çœ‹é€šè¿‡ `LoadBalancerClient` è´Ÿè½½å‡è¡¡å™¨å»è·å–æœåŠ¡åˆ—è¡¨å¹¶è°ƒç”¨çš„å®ç°æ–¹å¼ã€‚

```java
@RestController
@RequestMapping(value = "/test/test")
@SuppressWarnings(WarningsConstants.SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION)
public class DemoController {
    
    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    private LoadBalancerClient loadBalancerClient;

    @GetMapping(value = "/test2")
    public String getTest() {
        // æ ¹æ®æœåŠ¡åç§°è·å–æœåŠ¡
        String serviceName = "bettytsai-system";
        ServiceInstance instance = loadBalancerClient.choose(serviceName);
        ExceptionUtil.throwException(ObjectUtil.isNull(instance),"è·å–æœåŠ¡å®ä¾‹å¤±è´¥!");
        // è°ƒç”¨æœåŠ¡æ¥å£ï¼ŒResponseEntityå°è£…äº†è¿”å›æ•°æ®
        String url = "http://" + instance.getHost() + ":" + instance.getPort() + "/system/test/getDefaultString";
        ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, null,
                new ParameterizedTypeReference<String>() {}
        );
        return response.getBody();
    }
}
```

æœ€åï¼Œæˆ‘ä»¬å¯åŠ¨æ¶ˆè´¹è€…ï¼ŒéªŒè¯ä¸‹æœåŠ¡æ˜¯å¦æˆåŠŸè°ƒç”¨ã€‚

<img src="./assets/image-20240905145318892-17351891057162.png" alt="image-20240905145318892" style="zoom:90%;" />

##### 8.3.7.3 @LoadBalanced ï¼ˆæ¨èï¼‰

æœ€åæˆ‘ä»¬å†çœ‹çœ‹é€šè¿‡ `@LoadBalanced` æ³¨è§£çš„æ–¹å¼å»å¯åŠ¨è´Ÿè½½å‡è¡¡å™¨è·å–æœåŠ¡åˆ—è¡¨å¹¶è°ƒç”¨ç›®æ ‡æœåŠ¡ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ³¨å…¥ `RestTemplate` å®ä¾‹çš„æ—¶å€™ï¼Œæ·»åŠ  `@LoadBalanced` æ³¨è§£ï¼š

```java
@Configuration
public class RestConfig {
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate(){
        return new RestTemplate();
    }
}
```

ç„¶åï¼Œå¯¹åº”çš„ `RestTemplate` å®ä¾‹ä¹Ÿå°±æœ‰äº†è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚

```java
@RestController
@RequestMapping(value = "/test/test")
@SuppressWarnings(WarningsConstants.SPRING_JAVA_AUTOWIRED_FIELDS_WARNING_INSPECTION)
public class DemoController {
    
    @Autowired
    private RestTemplate restTemplate;

    @GetMapping(value = "/test3")
    public String getTest() {
        // ä¸å†é€šè¿‡ip + port è°ƒç”¨äº†
        String serviceName = "bettytsai-system";
        String url = "http://" + serviceName + "/system/test/getDefaultString";
        ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, null,
                new ParameterizedTypeReference<String>() {}
        );
        return response.getBody();
    }
}
```

æœ€åæˆ‘ä»¬å¯åŠ¨æœåŠ¡ï¼ŒéªŒè¯ä¸‹æœåŠ¡èƒ½å¦æ­£å¸¸è°ƒç”¨ã€‚

<img src="./assets/image-20240905145951936.png" alt="image-20240905145951936" style="zoom:90%;" />

<span style="color:#ff6000;">é€šè¿‡ @LoadBalanced æ³¨è§£å»å¯åŠ¨è´Ÿè½½å‡è¡¡æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œæ•…æ¯”è¾ƒæ¨èè¯¥æ–¹æ³•ã€‚</span>

## 9. Eurekaæ¶æ„åŸç†



![image-20240914151639090](./assets/image-20240914151639090-17262982012241.png)



ä¸‹é¢æˆ‘ä»¬ç¨å¾®è§£é‡Šä¸‹ä¸Šå›¾ä¸€äº›æœ¯è¯­çš„å«ä¹‰ï¼š

- **register - æœåŠ¡æ³¨å†Œ** ï¼šè¡¨ç¤ºå°†è‡ªå·±çš„IPå’Œç«¯å£æ³¨å†Œè¿›æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚
- **renew - æœåŠ¡ç»­çº¦** ï¼šå‘é€å¿ƒè·³åŒ…ï¼Œæ¯30så‘é€ä¸€æ¬¡ï¼Œå‘ŠçŸ¥eurekaæœåŠ¡è¿˜å­˜æ´»è€…ã€‚å¦‚æœ90sä»æœªå‘é€å¿ƒè·³ï¼Œå®•æœºã€‚
- **cancel - æœåŠ¡ä¸‹çº¿** ï¼šå½“Providerå…³é—­ä¹‹æ—¶å‘eurekaå‘é€æ¶ˆæ¯ï¼Œå°†è‡ªå·±ä»æœåŠ¡åˆ—è¡¨ä¸­åˆ é™¤ã€‚é˜²æ­¢consumerè°ƒç”¨åˆ°ä¸å­˜åœ¨çš„æœåŠ¡ã€‚
- **get register - è·å–æœåŠ¡åˆ—è¡¨** ï¼šè·å–å…¶ä»–æœåŠ¡åˆ—è¡¨ã€‚
- **replicate - é›†ç¾¤æ•°æ®åŒæ­¥** ï¼šeurekaé›†ç¾¤ä¸­çš„æ•°æ®å¤åˆ¶ä¸åŒæ­¥ã€‚
- **make pxote call - è¿œç¨‹è°ƒç”¨** ï¼šå®ŒæˆæœåŠ¡çš„è¿œç¨‹è°ƒç”¨ã€‚ 



<img src="./assets/image-20240914173854215.png" alt="image-20240914173854215" style="zoom:77%;" />



## 10. CAPåŸåˆ™



<img src="./assets/image-20240914173951827.png" alt="image-20240914173951827" style="zoom:80%;" />



<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;">CAPç”±Eric Breweråœ¨2000å¹´PODCä¼šè®®ä¸Šæå‡ºã€‚è¯¥çŒœæƒ³åœ¨æå‡ºåä¸¤å¹´è¢«è¯æ˜æˆç«‹ï¼Œæˆä¸ºæˆ‘ä»¬ç†ŸçŸ¥çš„CAPå®šç†ï¼ŒCAPä¸‰è€…ä¸å¯å…¼å¾—ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿç®€å•çš„è®²å°±æ˜¯æˆ‘ä»¬åœ¨æ„å»ºä¸€ä¸ªåº”ç”¨çš„æ—¶å€™ï¼Œåœ¨ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§ä¸‰è€…å½“ä¸­åªèƒ½é€‰æ‹©ä¸¤ä¸ªï¼Œä¸å¯èƒ½åšåˆ°ä¸‰è€…éƒ½æ»¡è¶³ã€‚</span>
</div>
CAPåŸåˆ™åˆç§°ä¸ºCAPåŸç†ï¼ŒæŒ‡çš„æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å…·æœ‰ä»¥ä¸‹å…¶ä¸­ä¸¤ä¸ªç‰¹æ€§ï¼š

- C ä»£è¡¨ Consistency ï¼ˆä¸€è‡´æ€§ï¼‰
- A ä»£è¡¨ Availabilityï¼ˆå¯ç”¨æ€§ï¼‰
- P ä»£è¡¨ Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰

|        ç‰¹æ€§         | å®šç†                                                         |
| :-----------------: | ------------------------------------------------------------ |
|     Consistency     | ä¹Ÿå«åšæ•°æ®åŸå­æ€§ï¼Œç³»ç»Ÿåœ¨æ‰§è¡ŒæŸé¡¹æ“ä½œåå¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ›´æ–°æ“ä½œæ‰§è¡ŒæˆåŠŸåæ‰€æœ‰çš„ç”¨æˆ·éƒ½åº”è¯¥è·å–åˆ°æœ€æ–°çš„å€¼ï¼Œè¿™æ ·çš„ç³»ç»Ÿè¢«è®¤ä¸ºæ˜¯å…·æœ‰å¼ºä¸€è‡´æ€§çš„ã€‚ç­‰åŒäºæ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬ã€‚ |
|    Availability     | æ¯ä¸€ä¸ªæ“ä½œæ€»æ˜¯èƒ½å¤Ÿåœ¨ä¸€å®šçš„æ—¶é—´å†…è¿”å›ç»“æœï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯â€œä¸€å®šçš„æ—¶é—´å†…â€å’Œâ€œè¿”å›ç»“æœâ€ã€‚ |
| Partition tolerance | åœ¨ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹ï¼Œè¢«åˆ†éš”çš„èŠ‚ç‚¹ä»ç„¶èƒ½å¤Ÿæ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ï¼ˆåˆ†å¸ƒå¼é›†ç¾¤ï¼Œæ•°æ®è¢«åˆ†å¸ƒå­˜å‚¨åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œæ— è®ºä»€ä¹ˆæƒ…å†µï¼ŒæœåŠ¡å™¨éƒ½èƒ½å¤Ÿè¢«æ­£å¸¸è®¿é—®ï¼‰ã€‚ |

### 10.1 ä¸€è‡´æ€§

åœ¨å¾®æœåŠ¡ä¸­çš„ä¸€è‡´æ€§å°±æ˜¯æ— è®ºæˆ‘ä»¬çš„èŠ‚ç‚¹æœ‰å¤šå°‘ä¸ªï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸­æœ€ç»ˆæ‹¿åˆ°çš„æ•°æ®ï¼Œå’Œå…¶ä»–èŠ‚ç‚¹çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯è¿™ä¸ªæ•°æ®åœ¨å¤šä¸ªèŠ‚ç‚¹ç”šè‡³è¯´æ•´ä¸ªåˆ†å¸ƒå¼é›†ç¾¤å½“ä¸­æ˜¯ä¸€è‡´çš„ã€‚

### 10.2 å¯ç”¨æ€§

å¯ç”¨æ€§å¤§è‡´å°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦å»ä¿è¯æˆ‘ä»¬çš„æœåŠ¡ä¿æŒä¸€ä¸ªé«˜å¯ç”¨ã€é«˜å“åº”ã€é«˜å®¹ç¾æ€§ï¼ˆä¸å®•æœºï¼‰ã€‚

### 10.3 å®¹é”™æ€§

è¯´åˆ°åˆ†åŒºå®¹é”™æ€§ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸æä¸€ä¸‹IKFæ‹†åˆ†åŸåˆ™ï¼Œ**IKFï¼ˆInter-Kernel File Systemï¼‰æ‹†åˆ†åŸåˆ™** ä¸»è¦å…³æ³¨äºåœ¨å¤šå†…æ ¸ç¯å¢ƒä¸­é«˜æ•ˆç®¡ç†å’Œå­˜å‚¨æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®åŸåˆ™ï¼š

1. **æ¨¡å—åŒ–è®¾è®¡** ï¼šIKFé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œå°†æ–‡ä»¶ç³»ç»Ÿçš„ä¸åŒåŠŸèƒ½ï¼ˆå¦‚å­˜å‚¨ã€æ£€ç´¢ã€æƒé™ç®¡ç†ç­‰ï¼‰æ‹†åˆ†ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚
2. **æ•°æ®åˆ†ç‰‡** ï¼šå°†å¤§æ–‡ä»¶åˆ†å‰²æˆå¤šä¸ªå°ç‰‡æ®µè¿›è¡Œå­˜å‚¨ï¼Œå…è®¸å¹¶è¡Œå¤„ç†å’Œä¼ è¾“ï¼Œæé«˜è®¿é—®é€Ÿåº¦å’Œå­˜å‚¨æ•ˆç‡ã€‚
3. **å»ä¸­å¿ƒåŒ–å­˜å‚¨** ï¼šæ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªå†…æ ¸ä¸Šï¼Œé¿å…å•ç‚¹æ•…éšœï¼Œæé«˜ç³»ç»Ÿçš„å¯é æ€§å’Œå¯ç”¨æ€§ã€‚
4. **ä¸€è‡´æ€§ç®¡ç†** ï¼šé€šè¿‡ä¸€è‡´æ€§åè®®ç¡®ä¿åœ¨å¤šä¸ªå†…æ ¸ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…æ•°æ®å†²çªå’Œä¸¢å¤±ã€‚
5. **åŠ¨æ€æ‰©å±•** ï¼šæ”¯æŒåŠ¨æ€æ·»åŠ æˆ–ç§»é™¤å­˜å‚¨èŠ‚ç‚¹ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´èµ„æºåˆ†é…ï¼Œä¼˜åŒ–æ€§èƒ½ã€‚
6. **å®‰å…¨æ€§ä¸æƒé™æ§åˆ¶** ï¼šå®ç°ç»†ç²’åº¦çš„æƒé™ç®¡ç†ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·èƒ½å¤Ÿè®¿é—®ç‰¹å®šæ•°æ®ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨ã€‚

è¿™äº›åŸåˆ™æ—¨åœ¨æé«˜IKFåœ¨å¤šå†…æ ¸ç¯å¢ƒä¸­çš„æ€§èƒ½ã€å¯é æ€§å’Œå®‰å…¨æ€§ã€‚

>   **ğŸ¤“ ä¸ºä»€ä¹ˆæåˆ°IKFæ‹†åˆ†åŸåˆ™å‘¢ï¼Ÿ** 
>
>   å¦‚æœæˆ‘ä»¬çš„é›†ç¾¤å®ç°äº†IKFæ‹†åˆ†åŸåˆ™ï¼Œå°±æ˜¯æˆ‘ä»¬å°±æ˜¯éœ€è¦è·å–å¤šå—åŒºåŸŸçš„æ•°æ®ï¼Œé‚£ä¹ˆä¸ºäº†è·å–å¤šå—åŒºåŸŸçš„æ•°æ®ï¼Œæˆ‘ä»¬å°±éœ€è¦è‡ªå·±å†…éƒ¨è¿›è¡Œä¸€äº›è€—æ—¶æ“ä½œï¼Œæ€ä¹ˆä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ï¼Ÿ
>
>   è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ»¡è¶³CAçš„åŒæ—¶æ— æ³•æ»¡è¶³Pçš„åŸå› ã€‚

### 10.4 å–èˆç­–ç•¥

CAPä¸‰ä¸ªç‰¹æ€§åªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ªï¼Œé‚£ä¹ˆå–èˆçš„ç­–ç•¥å°±å…±æœ‰ä¸‰ç§ï¼š

- **CA:**  å¦‚æœä¸è¦æ±‚Pï¼ˆä¸å…è®¸åˆ†åŒºï¼‰åˆ™Cï¼ˆå¼ºä¸€è‡´æ€§ï¼‰å’ŒAï¼ˆå¯ç”¨æ€§ï¼‰æ˜¯å¯ä»¥ä¿è¯çš„ã€‚ä½†æ˜¯æ”¾å¼ƒPçš„åŒæ—¶å°±æ„å‘³ç€æ”¾å¼ƒäº†ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼èŠ‚ç‚¹å—é™ï¼Œæ²¡åŠæ³•éƒ¨ç½²å­èŠ‚ç‚¹ï¼Œè¿™æ˜¯è¿èƒŒäº†åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡åˆè¡·çš„ã€‚
- **CP:**  å¦‚æœä¸è¦æ±‚A ï¼ˆå¯ç”¨æ€§ï¼‰ï¼Œç›¸å½“äºæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åœ¨æœåŠ¡å™¨ä¹‹é—´ä¿æŒå¼ºä¸€è‡´æ€§ï¼Œè€ŒPï¼ˆåˆ†åŒºï¼‰ä¼šå¯¼è‡´åŒæ­¥æ—¶é—´æ— é™å»¶é•¿ï¼ˆä¹Ÿå°±æ˜¯ç­‰å¾…æ•°æ®åŒæ­¥å®Œæˆæ‰èƒ½æ­£å¸¸è®¿é—®æœåŠ¡ï¼‰ã€‚ä¸€æ—¦å‘ç”Ÿç½‘ç»œæ•…éšœæˆ–è€…ä¿¡æ¯ä¸¢å¤±ç­‰æƒ…å†µï¼Œå°±è¦ç‰ºç‰²ç”¨æˆ·çš„ä½“éªŒï¼Œç­‰å¾…æ‰€æœ‰æ•°æ®å…¨éƒ¨ä¸€è‡´ä¹‹åï¼Œå†è®©ç”¨æˆ·è®¿é—®ç³»ç»Ÿã€‚è®¾è®¡æˆCPçš„ç³»ç»Ÿå…¶å®ä¸å°‘ï¼Œå…¸å‹çš„å°±æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚Redisã€HBaseç­‰ã€‚å¯¹äºè¿™äº›åˆ†å¸ƒå¼æ•°æ®åº“æ¥è¯´ï¼Œæ•°æ®çš„ä¸€è‡´æ€§æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ï¼Œå› ä¸ºè¿è¿™ä¸ªéƒ½è¾¾ä¸åˆ°ï¼Œé‚£ä¹ˆç›´æ¥é‡‡ç”¨å…³ç³»å‹æ•°æ®åº“å°±å¥½ï¼Œæ²¡å¿…è¦å†æµªè´¹èµ„æºéƒ¨ç½²åˆ†å¸ƒå¼æ•°æ®åº“ã€‚
- **AP:**  è¦é«˜å¯ç”¨å¹¶å…è®¸åˆ†åŒºï¼Œåˆ™éœ€è¦æ”¾å¼ƒä¸€è‡´æ€§ã€‚ä¸€æ—¦å‘ç”Ÿåˆ†åŒºï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯èƒ½å¤±å»è”ç³»ï¼Œä¸ºäº†é«˜å¯ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æœ¬åœ°æ•°æ®æä¾›æœåŠ¡ï¼Œè€Œè¿™æ ·ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚å…¸å‹çš„å°±æ˜¯æŸç±³çš„æŠ¢è´­æ‰‹æœºåœºæ™¯ï¼Œå¯èƒ½å‰å‡ ç§’æµè§ˆå•†å“çš„æ—¶å€™é¡µé¢æç¤ºæœ‰åº“å­˜ï¼Œå½“ä½ é€‰æ‹©å®Œå•†å“å‡†å¤‡ä¸‹å•çš„æ—¶å€™ï¼Œç³»ç»Ÿæç¤ºä½ ä¸‹å•å¤±æ•ˆï¼Œå•†å“å”®å®Œã€‚è¿™å…¶å®å°±æ˜¯å…ˆåœ¨Aï¼ˆå¯ç”¨æ€§ï¼‰æ–¹é¢ä¿è¯ç³»ç»Ÿå¯ä»¥æ­£å¸¸çš„æœåŠ¡ï¼Œç„¶ååœ¨æ•°æ®çš„ä¸€è‡´æ€§æ–¹é¢åšäº†ä¸€äº›ç‰ºç‰²ï¼Œè™½ç„¶å¤šå°‘ä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Œä½†ä¹Ÿä¸è‡³äºé€ æˆç”¨æˆ·è´­ç‰©æµç¨‹çš„ä¸¥é‡é˜»å¡ã€‚

### 10.5 æ€»ç»“

ç°å¦‚ä»Šï¼Œå¯¹äºå¤šæ•°å¤§å‹äº’è”ç½‘åº”ç”¨çš„åœºæ™¯ï¼Œä¸»æœºä¼—å¤šã€éƒ¨ç½²åˆ†æ•£ï¼Œè€Œä¸”ç°åœ¨çš„é›†ç¾¤è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼ŒèŠ‚ç‚¹åªä¼šè¶Šæ¥è¶Šå¤šï¼Œæ‰€ä»¥èŠ‚ç‚¹æ•…éšœã€ç½‘ç»œæ•…éšœæ˜¯å¸¸æ€ï¼Œå› æ­¤åˆ†åŒºå®¹é”™æ€§å°±æˆä¸ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¿…ç„¶è¦é¢å¯¹çš„é—®é¢˜ã€‚é‚£ä¹ˆå°±åªèƒ½åœ¨Cå’ŒAä¹‹é—´è¿›è¡Œå–èˆã€‚è€Œå¯¹äºä¼ ç»Ÿé¡¹ç›®å°±å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œå¯¹äºé“¶è¡Œè½¬è´¦ç³»ç»Ÿæ¥è¯´ï¼Œæ¶‰åŠåˆ°é‡‘é’±çš„å¯¹äºæ•°æ®ä¸€è‡´æ€§ä¸èƒ½åšå‡ºä¸€ä¸çš„è®©æ­¥ï¼ŒCå¿…é¡»ä¿è¯ï¼Œå‡ºç°ç½‘ç»œæ•…éšœçš„è¯ï¼Œå®å¯åœæ­¢æœåŠ¡ï¼Œå¯ä»¥åœ¨Aå’ŒPä¹‹é—´è¿›è¡Œå–èˆã€‚

æ€»è€Œè¨€ä¹‹ï¼Œæ²¡æœ‰æœ€å¥½çš„ç­–ç•¥ï¼Œå¥½çš„ç³»ç»Ÿåº”è¯¥æ ¹æ®ä¸šåŠ¡åœºæ™¯è¿›è¡Œæ¶æ„è®¾è®¡ï¼Œåªæœ‰é€‚åˆæ‰æ˜¯æœ€å¥½çš„ã€‚

## 11. Eurekaè‡ªæˆ‘ä¿æŠ¤

### 11.1 å¯åŠ¨è‡ªæˆ‘ä¿æŠ¤æ¡ä»¶

ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒæœåŠ¡åœ¨Eurekaä¸Šæ³¨å†Œä¹‹åï¼Œä¼šæ¯30så‘é€å¿ƒè·³åŒ…ï¼ŒEurekaé€šè¿‡å¿ƒè·³æ¥åˆ¤æ–­æœåŠ¡æ˜¯å¦å¥åº·ï¼ŒåŒæ—¶ä¼šå®šæœŸåˆ é™¤è¶…è¿‡90sæ²¡æœ‰å‘é€å¿ƒè·³çš„æœåŠ¡ã€‚

![image-20241008160929163](./assets/image-20241008160929163-17283749709912.png)

æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´Eureka Serveræ”¶ä¸åˆ°å¾®æœåŠ¡çš„å¿ƒè·³

- å¾®æœåŠ¡è‡ªèº«çš„åŸå› 
- å¾®æœåŠ¡ä¸Eurekaä¹‹é—´çš„ç½‘ç»œæ•…éšœ

### 11.2 è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼

Eureka Serveråœ¨è¿è¡ŒæœŸé—´ä¼šå»ç»Ÿè®¡å¿ƒè·³å¤±è´¥æ¯”ä¾‹åœ¨15åˆ†é’Ÿä¹‹å†…æ˜¯å¦ä½äº85%ï¼Œå¦‚æœä½äº85%ï¼ŒEureka Serverä¼šå°†è¿™äº›å®ä¾‹ä¿æŠ¤èµ·æ¥ï¼Œè®©è¿™äº›å®ä¾‹ä¸ä¼šè¿‡æœŸï¼ŒåŒæ—¶æç¤ºä¸€ä¸ªè­¦å‘Šã€‚è¿™ç§ç®—æ³•å«åšEureka Serverçš„è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚

è¿™æ ·å°±å¯ä»¥é˜²æ­¢ç”±äºç½‘ç»œæ•…éšœå¯¼è‡´çš„EurekaçŸ­æš‚æ”¶ä¸åˆ°å¿ƒè·³å°†æœåŠ¡åˆ é™¤ã€‚

![image-20241008161815528](./assets/image-20241008161815528-17283754969004.png)

### 11.3 ä¸ºä»€ä¹ˆè¦å¯åŠ¨è‡ªæˆ‘ä¿æŠ¤

å¯åŠ¨è‡ªæˆ‘ä¿æŠ¤çš„åŸå› æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š

- åŒæ—¶ä¿ç•™â€œå¥½æ•°æ®â€ä¸â€œåæ•°æ®â€æ€»æ¯”ä¸¢æ‰ä»»ä½•æ•°æ®è¦å¥½ï¼Œå½“ç½‘ç»œæ•…éšœæ¢å¤ä¹‹åï¼Œè¿™ä¸ªEurekaèŠ‚ç‚¹ä¼šé€€å‡ºè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼
- Eurekaè¿˜æœ‰å®¢æˆ·ç«¯ç¼“å­˜åŠŸèƒ½ï¼ˆä¹Ÿå°±æ˜¯å¾®æœåŠ¡çš„ç¼“å­˜åŠŸèƒ½ï¼‰ã€‚å³ä½¿Eurekaé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½å®•æœºå¤±æ•ˆï¼Œå¾®æœåŠ¡çš„Providerå’ŒConsumeréƒ½æ­£å¸¸é€šä¿¡ã€‚
- å¾®æœåŠ¡çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ä¼šè‡ªåŠ¨å‰”é™¤æ­»äº¡çš„å¾®æœåŠ¡èŠ‚ç‚¹ã€‚

### 11.4 å¦‚ä½•å…³é—­è‡ªæˆ‘ä¿æŠ¤

æ³¨å†Œä¸­å¿ƒé…ç½®è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼š

```yaml
eureka:
  server:
    # å¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼Œå¿ƒè·³æ£€æµ‹ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®æ‰“å¼€
    enable-self-preservation: true
    # å¾®æœåŠ¡æ¸…ç†é—´éš”ï¼ˆå•ä½ï¼šms é»˜è®¤ï¼š60 * 1000ï¼‰
    eviction-interval-timer-in-ms: 60000
```

## 12. Eurekaä¼˜é›…åœæœ

é…ç½®äº†ä¼˜é›…åœæœä¹‹åï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦Eureka Serverä¸­é…ç½®å…³é—­è‡ªæˆ‘ä¿æŠ¤ï¼Œæˆ‘ä»¬é€šè¿‡actuatorå®ç°ã€‚

### 12.1 æ·»åŠ ä¾èµ–

æœåŠ¡æä¾›è€…æ·»åŠ actuatorä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

### 12.2 é…ç½®æ–‡ä»¶

æœåŠ¡æä¾›è€…é…ç½®åº¦é‡æŒ‡æ ‡ç›‘æ§ä¸å¥åº·æ£€æŸ¥ï¼š

```yml
# åº¦é‡æŒ‡æ ‡ç›‘æ§ä¸å¥åº·æ£€æŸ¥
management:
  endpoints:
    web:
      exposure:
        include: info,shutdown
  # éœ€è¦é¢å¤–å¼ºè°ƒå¯ç”¨shutdownèŠ‚ç‚¹ï¼Œå› ä¸ºå®˜æ–¹è®¤ä¸ºè¿™ä¸ªshutdownèŠ‚ç‚¹é£é™©æœ‰ç‚¹å¤§
  # å³ä¾¿ä½ åœ¨include: "*" ä¹Ÿæ²¡ç”¨ï¼Œéœ€è¦ä½ äºŒæ¬¡ç¡®è®¤ä½ è¦å¼€å¯ä¼˜é›…åœæœçš„åŠŸèƒ½
  endpoint:
    shutdown:
      enabled: true
```

### 12.3 ä¼˜é›…åœæœ

ä½¿ç”¨POSTè¯·æ±‚è®¿é—®ï¼šhttp://192.168.100.100:9000/actuator/shutdown æ•ˆæœå¦‚ä¸‹ï¼š

<img src="./assets/image-20241008165030844-17283774320795.png" alt="image-20241008165030844" style="zoom:67%;" />



![image-20241008165044644](./assets/image-20241008165044644-17283774457426.png)

## 13. Eurekaå®‰å…¨è®¤è¯

<div style="border: 1px solid rgba(254, 40, 87,.1);
    padding: 10px;
    border-left: 5px solid rgba(254, 40, 87);
    background: rgba(254, 40, 87,.1);
    border-radius: 0 3px 3px 0;
    color:rgba(254, 40, 87);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" style="flex-shrink: 0;" width="14px" height="14px" fill="none" xmlns="http://www.w3.org/2000/svg" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-8l52ux" focusable="false" aria-hidden="true" data-testid="ErrorIcon"><path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    <span style="line-height: 12px;">åœ¨å®é™…å¼€å‘ã€ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè®¿é—® Eureka æœåŠ¡ä¸å¯èƒ½ç›´æ¥å…è®¸ä½ ç›´æ¥è®¿é—®ï¼Œæˆ‘ä»¬éœ€è¦è®©ä»–é€šè¿‡ä¸€å®šçš„å®‰å…¨è®¤è¯æ‰èƒ½å¤Ÿæ”¾è¡Œã€‚</span>
</div>

### 13.1 æ·»åŠ ä¾èµ–

æ³¨å†Œä¸­å¿ƒæ·»åŠ securityä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

### 13.2 é…ç½®æ–‡ä»¶

æ³¨å†Œä¸­å¿ƒé…ç½®å®‰å…¨è®¤è¯ï¼š

```yml
spring:
  security:
    user:
      name: admin
      password: 123456
```

æ³¨å†Œä¸­å¿ƒæ³¨å†Œåœ°å€ä¿®æ”¹ï¼š

```yaml
eureka:
  client:
    service-url:
      defaultZone: http://${spring.security.user.name}:${spring.security.user.password}@${eureka.instance.hostname}:8762/eureka/
```

æœåŠ¡æä¾›è€…æ³¨å†Œåœ°å€ä¿®æ”¹ï¼š

```yaml
eureka:
  client:
    service-url:
      defaultZone: http://admin:123456@127.0.0.1:8761/eureka/,http://admin:123456@127.0.0.1:8762/eureka
```

è®¿é—®æ³¨å†Œä¸­å¿ƒï¼šhttp://127.0.0.1:8762/ ï¼Œéœ€è¦ç™»å½•ï¼š

![image-20241008171918147](./assets/image-20241008171918147-17283791600547.png)

æœåŠ¡åˆ—è¡¨ä¸ºç©ºï¼Œæ³¨å†Œå¤±è´¥ï¼Œéœ€è¦è¿›è¡Œè¿‡æ»¤CSRF

![image-20241008171945934](./assets/image-20241008171945934-17283791872638.png)

### 13.3 è¿‡æ»¤CSRF

Eurekaä¼šè‡ªåŠ¨åŒ–é…ç½®CSRFé˜²å¾¡æœºåˆ¶ï¼Œè€ŒSecurityè®¤ä¸ºPOSTã€PUTã€DELETEç­‰è¯·æ±‚éƒ½æ˜¯æœ‰é£é™©çš„ï¼Œå¦‚æœè¿™äº›è¯·æ±‚å‘é€è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰æºå¸¦CSRFçš„Tokenå€¼ï¼Œä¼šè¢«ç›´æ¥æ‹¦æˆªå¹¶è¿”å›403ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸ŠèŠ‚ä¸­æ³¨å†Œåˆ—è¡¨ä¸ºç©ºçš„åŸå› ã€‚

å®˜æ–¹æä¾›äº†è§£å†³çš„æ–¹æ³•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ[spring cloud issue 2754]()é‡Œé¢æœ‰å¤§é‡çš„è®¨è®ºï¼Œè¿™é‡Œæä¾›ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚

é¦–å…ˆæ³¨å†Œä¸­å¿ƒé…ç½®ä¸€ä¸ª*@EnableWebSecurity*é…ç½®ç±»ï¼Œç»§æ‰¿*WebSecurityConfigurerAdapter*å¹¶é‡å†™*configure()*æ–¹æ³•ã€‚

#### 13.3.1 æ–¹æ¡ˆä¸€

ä½¿CSRFå¿½ç•¥ `/eureka/**` æ‰€æœ‰è¯·æ±‚ï¼š

```java
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    public void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.csrf().ignoringAntMatchers("/eureka/**");
    }
}
```

å†æ¬¡è®¿é—®æ³¨å†Œä¸­å¿ƒï¼šhttp://127.0.0.1:8761/ æ•ˆæœï¼š

![image-20241008173320060](./assets/image-20241008173320060.png)

#### 13.3.2 æ–¹æ¡ˆäºŒ

ä¿æŒå¯†ç éªŒè¯çš„åŒæ—¶ç¦ç”¨CSRFé˜²å¾¡æœºåˆ¶ã€‚

```java
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http.csrf().disable()
                .authorizeRequests()
                .anyRequest()
                .authenticated()
                .and()
                .httpBasic();
    }
}
```

å†æ¬¡è®¿é—®æ³¨å†Œä¸­å¿ƒï¼šhttp://127.0.0.1:8762/ æ•ˆæœï¼š

![image-20241008173320060](./assets/image-20241008173320060-17351891540443.png)
