<div style="display:flex;">
    <div style="margin-left:auto;color:#3795f7;"><strong>作者：</strong>蔡熙贝</div>
</div>

本章节主要介绍 YAML 语法和 Kubernetes 的资源管理方式

## 资源管理介绍

在 Kubernetes 中，所有的内容都抽象为资源，用户需要通过操作资源来管理 Kubernetes 。

Kubernetes 的本质上就是一个集群系统，用户可以在集群中部署各种服务，所谓的部署服务，其实就是在 Kubernetes 集群中运行一个个的容器，并将指定的程序跑在容器中。

Kubernetes 的最小管理单元是 Pod 而不是容器，所以只能将容器放在 Pod 中，而 Kubernetes 一般也不会直接管理 Pod，而是通过 **Pod控制器** 来管理 Pod 的。

Pod 可以提供服务之后，就要考虑如何访问 Pod 中服务，Kubernetes 提供了 Service 资源实现这个功能。当然，如果 Pod 中程序的数据需要持久化，Kubernetes 还提供了各种 **存储系统** 。

![image-20251111155548230](assets/image-20251111155548230.png)

学习 Kubernetes 的核心，就是学习如何对集群上的 **Pod** 、**Pod控制器** 、**Service** 、**存储** 等各种资源进行操作。

## YAML 语言介绍

YAML 是一个类似 XML、JSON 的标记性语言。它强调以 **数据** 为中心，并不是以标识语言为重点。因而 YAML 本身的定义比较简单，号称 **一种人性化的数据格式语言**。

YAML 的语法比较简单，主要有下面几个：

- 大小写敏感
- 使用缩进表示层级关系
- 缩进不允许使用 TAB ，只允许空格 (低版本限制)
- 缩进的空格数不重要，只要相同层级的元素左对齐即可
- `#` 表示注释

YAML 支持以下几种数据类型：

- 纯量：单个的、不可再分的值;

```yaml
# 纯量, 就是指的一个简单的值，字符串、布尔值、整数、浮点数、Null、时间、日期
# 1 布尔类型
c1: true (或者True)
# 2 整型
c2: 234
# 3 浮点型
c3: 3.14
# 4 null类型 
c4: ~  # 使用~表示null
# 5 日期类型
c5: 2018-02-17    # 日期必须使用ISO 8601格式，即yyyy-MM-dd
# 6 时间类型
c6: 2018-02-17T15:02:31+08:00  # 时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区
# 7 字符串类型
c7: heima     # 简单写法，直接写值 , 如果字符串中间有特殊字符，必须使用双引号或者单引号包裹 
c8: line1
    line2     # 字符串过多的情况可以拆成多行，每一行会被转化成一个空格
```

- 对象：键值对的集合，又称为映射（mapping）/ 哈希（hash） / 字典（dictionary）;

```yaml
# 对象
# 形式一(推荐):
heima:
  age: 15
  address: Beijing
# 形式二(了解):
heima: {age: 15,address: Beijing}
```

- 数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）;

```yaml
# 数组
# 形式一(推荐):
address:
  - 顺义
  - 昌平	
# 形式二(了解):
address: [顺义,昌平]
```

> **🤓 提示：**
>
> - 书写 yaml 切记 `:`  后面要加一个空格
>
> -  如果需要将多段 yaml 配置放在一个文件中，中间要使用 `---` 分隔
>
> - 下面是一个 yaml 转 json 的网站，可以通过它验证 yaml 是否书写正确
>
>   https://www.json2yaml.com/convert-yaml-to-json

## 资源管理方式

Kubernetes 提供了三种不同的操作资源的方式。

- 命令式对象管理：直接使用命令去操作 Kubernetes 资源

```bash
kubectl run nginx-pod --image=nginx:1.17.1 --port=80
```

- 命令式对象配置：通过命令配置和配置文件去操作 Kubernetes 资源

```bash
kubectl create/patch -f nginx-pod.yaml
```

- 声明式对象配置：通过 apply 命令和配置文件去操作 Kubernetes 资源

```bash
kubectl apply -f nginx-pod.yaml
```

三种方式的优缺点及适用场景也大不一样。

| 类型           | 操作对象 | 适用环境 | 优点           | 缺点                             |
| -------------- | -------- | -------- | -------------- | -------------------------------- |
| 命令式对象管理 | 对象     | 测试     | 简单           | 只能操作活动对象，无法审计、跟踪 |
| 命令式对象配置 | 文件     | 开发     | 可以审计、跟踪 | 项目大时，配置文件多，操作麻烦   |
| 声明式对象配置 | 目录     | 开发     | 支持目录操作   | 意外情况下难以调试               |

### 命令式对象管理

#### kubectl 命令

`kubectl` 是 Kubernetes 集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。

命令的语法如下：

```bash
kubectl [command] [type] [name] [flags]
```

- **command：** 指定要对资源执行的操作，例如 create 、get 、delete

- **type：** 指定资源类型，比如 deployment 、pod 、service

- **name：** 指定资源的名称，名称大小写敏感

- **flags：** 指定额外的可选参数

举例：

```bash
# 查看所有pod
kubectl get pod 

# 查看某个pod
kubectl get pod <pod_name>

# 查看某个 pod,以 yaml 格式展示结果
kubectl get pod <pod_name> -o yaml
```

#### 资源类型

Kubernetes 中所有的内容都抽象为资源，可以通过下面的命令进行查看。

~~~shell
kubectl api-resources
~~~

经常使用的资源有如下表格所示。

<table style="table-layout: auto; border-collapse: collapse;width:100%;display: inline-table;">
	<tr>
	    <th align="center">资源分类</th>
	    <th align="center">资源名称</th>
		<th align="center">缩写</th>
		<th align="center">资源作用</th>
	</tr>
	<tr>
	    <td rowspan="2" align="center">集群级别资源</td>
        <td align="center">nodes</td>
	    <td align="center">no</td>
		<td align="center">集群组成部分</td>
	</tr>
	<tr>
		<td align="center">namespaces</td>
	    <td align="center">ns</td>
		<td align="center">隔离Pod</td>
	</tr>
	<tr>
		<td align="center">pod资源</td>
	    <td align="center">pods</td>
	    <td align="center">po</td>
		<td align="center">装载容器</td>
	</tr>
	<tr>
		<td align="center" rowspan="8">pod资源控制器</td>
	    <td align="center">replicationcontrollers</td>
	    <td align="center">rc</td>
		<td align="center">控制pod资源</td>
	</tr>
	<tr>
	    <td align="center">replicasets</td>
	    <td align="center">rs</td>
		<td align="center">控制pod资源</td>
	</tr>
	<tr>
	    <td align="center">deployments</td>
	    <td align="center">deploy</td>
		<td align="center">控制pod资源</td>
	</tr>
	<tr>
	    <td align="center">daemonsets</td>
	    <td align="center">ds</td>
		<td align="center">控制pod资源</td>
	</tr>
	<tr>
	    <td align="center">jobs</td>
	    <td align="center"></td>
		<td align="center">控制pod资源</td>
	</tr>	
	<tr>
	    <td align="center">cronjobs</td>
	    <td align="center">cj</td>
		<td align="center">控制pod资源</td>
	</tr>	
	<tr>
	    <td align="center">horizontalpodautoscalers</td>
	    <td align="center">hpa</td>
		<td align="center">控制pod资源</td>
	</tr>	
	<tr>
	    <td align="center">statefulsets</td>
	    <td align="center">sts</td>
		<td align="center">控制pod资源</td>
	</tr>
	<tr>
		<td align="center" rowspan="2">服务发现资源</td>
	    <td align="center">services</td>
	    <td align="center">svc</td>
		<td align="center">统一pod对外接口</td>
	</tr>
    <tr>
	    <td align="center">ingress</td>
	    <td align="center">ing</td>
		<td align="center">统一pod对外接口</td>
	</tr>
	<tr>
		<td align="center" rowspan="3">存储资源</td>
	    <td align="center">volumeattachments</td>
	    <td align="center"></td>
		<td align="center">存储</td>
	</tr>
	<tr>
	    <td align="center">persistentvolumes</td>
	    <td align="center">pv</td>
		<td align="center">存储</td>
	</tr>
	<tr>
	    <td align="center">persistentvolumeclaims</td>
	    <td align="center">pvc</td>
		<td align="center">存储</td>
	</tr>
	<tr>
		<td align="center" rowspan="2">配置资源</td>
	    <td align="center">configmaps</td>
	    <td align="center">cm</td>
		<td align="center">配置</td>
	</tr>
	<tr>
	    <td align="center">secrets</td>
	    <td align="center"></td>
		<td align="center">配置</td>
	</tr>
</table>

#### 操作

Kubernetes 允许对资源进行多种操作，可以通过 `--help` 查看详细的操作命令。

~~~shell
kubectl --help
~~~

经常使用的操作如表格所示。

<table style="table-layout: auto; border-collapse: collapse;width:100%;display: inline-table;">
	<tr>
	    <th align="center">命令分类</th>
	    <th align="center">命令</th>
		<th align="center">翻译</th>
		<th align="center">命令作用</th>
	</tr>
	<tr>
	    <td align="center" rowspan="6">基本命令</td>
	    <td align="center">create</td>
	    <td align="center">创建</td>
		<td align="center">创建一个资源</td>
	</tr>
	<tr>
		<td align="center">edit</td>
	    <td align="center">编辑</td>
		<td align="center">编辑一个资源</td>
	</tr>
	<tr>
		<td align="center">get</td>
	    <td align="center">获取</td>
	    <td align="center">获取一个资源</td>
	</tr>
   <tr>
		<td align="center">patch</td>
	    <td align="center">更新</td>
	    <td align="center">更新一个资源</td>
	</tr>
	<tr>
	    <td align="center">delete</td>
	    <td align="center">删除</td>
		<td align="center">删除一个资源</td>
	</tr>
	<tr>
	    <td align="center">explain</td>
	    <td align="center">解释</td>
		<td align="center">展示资源文档</td>
	</tr>
	<tr>
	    <td align="center" rowspan="10">运行和调试</td>
	    <td align="center">run</td>
	    <td align="center">运行</td>
		<td align="center">在集群中运行一个指定的镜像</td>
	</tr>
	<tr>
	    <td align="center">expose</td>
	    <td align="center">暴露</td>
		<td align="center">暴露资源为Service</td>
	</tr>
	<tr>
	    <td align="center">describe</td>
	    <td align="center">描述</td>
		<td align="center">显示资源内部信息</td>
	</tr>
	<tr>
	    <td align="center">logs</td>
	    <td align="center">日志</td>
		<td align="center">输出容器在 pod 中的日志</td>
	</tr>	
	<tr>
	    <td align="center">attach</td>
	    <td align="center">缠绕</td>
		<td align="center">进入运行中的容器</td>
	</tr>	
	<tr>
	    <td align="center">exec</td>
	    <td align="center">执行</td>
		<td align="center">执行容器中的一个命令</td>
	</tr>	
	<tr>
	    <td align="center">cp</td>
	    <td align="center">复制</td>
		<td align="center">在Pod内外复制文件</td>
	</tr>
		<tr>
		<td align="center">rollout</td>
	    <td align="center">首次展示</td>
		<td align="center">管理资源的发布</td>
	</tr>
	<tr>
		<td align="center">scale</td>
	    <td align="center">规模</td>
		<td align="center">扩(缩)容Pod的数量</td>
	</tr>
	<tr>
		<td align="center">autoscale</td>
	    <td align="center">自动调整</td>
		<td align="center">自动调整Pod的数量</td>
	</tr>
	<tr>
		<td align="center" rowspan="2">高级命令</td>
	    <td align="center">apply</td>
	    <td align="center">rc</td>
		<td align="center">通过文件对资源进行配置</td>
	</tr>
	<tr>
	    <td align="center">label</td>
	    <td align="center">标签</td>
		<td align="center">更新资源上的标签</td>
	</tr>
	<tr>
		<td align="center" rowspan="2">其他命令</td>
	    <td align="center">cluster-info</td>
	    <td align="center">集群信息</td>
		<td align="center">显示集群信息</td>
	</tr>
	<tr>
	    <td align="center">version</td>
	    <td align="center">版本</td>
		<td align="center">显示当前Server和Client的版本</td>
	</tr>
</table>

下面以一个 namespace 及 pod 的创建和删除简单演示下命令的使用。

~~~powershell
# 创建一个namespace
kubectl create namespace dev

# 获取 namespace
kubectl get ns

# 在此 namespace 下创建并运行一个 nginx 的 Pod
kubectl run pod --image=nginx -n dev

# 查看新创建的pod
kubectl get pod -n dev

# 删除指定的pod
kubectl delete pod pod-864f9875b9-pcw7x

# 删除指定的 namespace
kubectl delete ns dev
~~~

###  命令式对象配置

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;"><b>总结: </b>命令式对象配置的方式操作资源，可以简单的认为：命令  +  yaml配置文件（里面是命令需要的各种参数）。</span>
</div>

命令式对象配置就是使用命令配合配置文件一起来操作 Kubernetes 资源。

1. 创建一个 nginx-pod.yaml，内容如下。

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: dev

---

apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  namespace: dev
spec:
  containers:
  - name: nginx-containers
    image: nginx:1.17.1
```

2. 执行 create 命令，创建资源。

```bash
kubectl create -f nginx-pod.yaml
```

此时发现创建了两个资源对象，分别是 namespace 和 pod 。

3. 执行 get 命令，查看资源。

```bash
kubectl get -f nginx-pod.yaml
```

这样就显示了两个资源对象的信息。

4. 执行 delete 命令，删除资源。

```bash
kubectl delete -f nginx-pod.yaml
```

此时发现两个资源对象被删除了。

### 声明式对象配置

声明式对象配置跟命令式对象配置很相似，但是它只有一个命令 apply 。

~~~powershell
# 首先执行一次，发现创建了资源
kubectl apply -f nginx-pod.yaml

# 再次执行一次，提示资源没有变动
kubectl apply -f nginx-pod.yaml
~~~

> **🤓 总结：** 其实声明式对象配置就是使用 apply 描述一个资源最终的状态（在 YAML 中定义状态）。
>
> 使用apply操作资源：
>
> - 如果资源不存在，就创建，相当于 kubectl create
> - 如果资源已存在，就更新，相当于 kubectl patch

<div style="border: 1px solid rgba(255, 165, 0,.1);
    padding: 10px;
    border-left: 5px solid rgba(255, 165, 0);
    background: rgba(255, 165, 0,.1);
    border-radius: 0 3px 3px 0;
    color: rgba(255, 165, 0);
    font-family: menlo;
    font-size: 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;">
    <svg viewBox="0 0 24 24" width="14px" height="14px" fill="none" style="flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 8.00008V12.0001M12 16.0001H12.01M3 7.94153V16.0586C3 16.4013 3 16.5726 3.05048 16.7254C3.09515 16.8606 3.16816 16.9847 3.26463 17.0893C3.37369 17.2077 3.52345 17.2909 3.82297 17.4573L11.223 21.5684C11.5066 21.726 11.6484 21.8047 11.7985 21.8356C11.9315 21.863 12.0685 21.863 12.2015 21.8356C12.3516 21.8047 12.4934 21.726 12.777 21.5684L20.177 17.4573C20.4766 17.2909 20.6263 17.2077 20.7354 17.0893C20.8318 16.9847 20.9049 16.8606 20.9495 16.7254C21 16.5726 21 16.4013 21 16.0586V7.94153C21 7.59889 21 7.42756 20.9495 7.27477C20.9049 7.13959 20.8318 7.01551 20.7354 6.91082C20.6263 6.79248 20.4766 6.70928 20.177 6.54288L12.777 2.43177C12.4934 2.27421 12.3516 2.19543 12.2015 2.16454C12.0685 2.13721 11.9315 2.13721 11.7985 2.16454C11.6484 2.19543 11.5066 2.27421 11.223 2.43177L3.82297 6.54288C3.52345 6.70928 3.37369 6.79248 3.26463 6.91082C3.16816 7.01551 3.09515 7.13959 3.05048 7.27477C3 7.42756 3 7.59889 3 7.94153Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    </path>
</svg>
    <span style="line-height: 16px;"><b>扩展：</b>kubectl 可以在 node 节点上运行吗 ?</span>
</div>

kubectl 的运行是需要进行配置的，它的配置文件是 `\$HOME/.kube`，如果想要在node节点运行此命令，需要将 master 上的 `.kube` 文件复制到 node 节点上，即在master 节点上执行下面操作。

```bash
scp -r HOME/.kube k8s-node-1:HOME/
```

**🤓 使用推荐：三种方式应该怎么用 ?**

- 创建/更新资源： 使用声明式对象配置

```bash
 kubectl apply -f nginx-pod.yaml
```

- 删除资源 ：使用命令式对象配置

```bash
 kubectl delete -f nginx-pod.yaml
```

- 查询资源 ：使用命令式对象管理

```bash
kubectl get <资源名称>
kubectl describe <资源名称>
```

